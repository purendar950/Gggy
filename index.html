<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VocabMaster Pro</title>
<meta name="application-name" content="VocabMaster Pro">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="VocabMaster">
<meta name="theme-color" content="#0e0e14" id="themeColorMeta">
<link rel="manifest" id="pwaManifest">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=DM+Sans:wght@300;400;500;600&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ═══════════════════ BASE THEME (Dark Gold — Default) ═══════════════════ */
:root {
  /* ── Dark Gold (Default) ── */
  --bg:#0c0c1e; --bg2:#131328; --card:#1a1a36; --card2:#22224a;
  --gold:#f5c842; --gold2:#d4960f; --goldLight:#ffe082;
  --accent:#7c6af7; --accent2:#b09cff;
  --green:#2ecc8a; --red:#f06e6e; --blue:#5ab4f8; --orange:#f5923c; --pink:#f472b6;
  --text:#f4f3ff; --textSub:#a8a8d0; --textMuted:#6868a0;
  --border:rgba(255,255,255,0.12);
  --r:16px; --rsm:10px; --nav-h:62px;
  --hero-grad:linear-gradient(135deg,#1a1640 0%,#251a50 50%,#182040);
  --pwa-bg:#0c0c1e;
}

/* ── Midnight Steel ── */
[data-theme="midnight"] {
  --bg:#06090f; --bg2:#0c1220; --card:#101c30; --card2:#162438;
  --gold:#7ecfff; --gold2:#3aabf0; --goldLight:#b8e8ff;
  --accent:#2d8cff; --accent2:#7ec8ff;
  --green:#3de89a; --red:#ff6b7a; --blue:#7ecfff; --orange:#ffb347; --pink:#d87fff;
  --text:#eaf5ff; --textSub:#7eaaca; --textMuted:#3e6a90;
  --border:rgba(126,207,255,0.15);
  --hero-grad:linear-gradient(135deg,#0a1830 0%,#0d2040 50%,#081228);
  --pwa-bg:#06090f;
}

/* ── Navy Intel ── deep navy like the screenshot */
[data-theme="navypro"] {
  --bg:#080e1c; --bg2:#0d1528; --card:#0f1e34; --card2:#152540;
  --gold:#00d4f0; --gold2:#0098c0; --goldLight:#80eaff;
  --accent:#ff8a00; --accent2:#ffb347;
  --green:#00e5a0; --red:#ff4d6a; --blue:#00d4f0; --orange:#ff8a00; --pink:#d070ff;
  --text:#ffffff; --textSub:#7aa8cc; --textMuted:#3a6080;
  --border:rgba(0,212,240,0.13);
  --hero-grad:linear-gradient(135deg,#0c1c34 0%,#102240 50%,#081428);
  --pwa-bg:#080e1c;
}

/* ── Arctic Light ── */
[data-theme="light"] {
  --bg:#f5f5f5; --bg2:#eeeeee; --card:#ffffff; --card2:#e8e8e8;
  --gold:#2196f3; --gold2:#1976d2; --goldLight:#64b5f6;
  --accent:#3f51b5; --accent2:#5c6bc0;
  --green:#4caf50; --red:#f44336; --blue:#2196f3; --orange:#ff9800; --pink:#e91e63;
  --text:#212121; --textSub:#424242; --textMuted:#757575;
  --border:rgba(0,0,0,0.12);
  --hero-grad:linear-gradient(135deg,#ffffff 0%,#f5f5f5 50%,#eeeeee);
  --pwa-bg:#f5f5f5;
}

/* ── Pure White ── Clean white theme with blue accents */
[data-theme="white"] {
  --bg:#ffffff; --bg2:#fafafa; --card:#ffffff; --card2:#f0f0f0;
  --gold:#1565c0; --gold2:#0d47a1; --goldLight:#42a5f5;
  --accent:#5c6bc0; --accent2:#7986cb;
  --green:#2e7d32; --red:#c62828; --blue:#1976d2; --orange:#ef6c00; --pink:#ad1457;
  --text:#212121; --textSub:#424242; --textMuted:#757575;
  --border:rgba(0,0,0,0.08);
  --hero-grad:linear-gradient(180deg,#ffffff 0%,#f5f5f5 100%);
  --pwa-bg:#ffffff;
}

/* ── Clean Black ── Pure black theme with white text */
[data-theme="black"] {
  --bg:#000000; --bg2:#121212; --card:#1a1a1a; --card2:#2a2a2a;
  --gold:#ffc107; --gold2:#ffb300; --goldLight:#ffe082;
  --accent:#bb86fc; --accent2:#9c27b0;
  --green:#03dac6; --red:#cf6679; --blue:#2196f3; --orange:#ff9800; --pink:#f48fb1;
  --text:#ffffff; --textSub:#e0e0e0; --textMuted:#9e9e9e;
  --border:rgba(255,255,255,0.15);
  --hero-grad:linear-gradient(180deg,#1a1a1a 0%,#000000 100%);
  --pwa-bg:#000000;
}

/* ── Soft Gray ── Easy on eyes gray theme */
[data-theme="gray"] {
  --bg:#1e1e1e; --bg2:#2d2d2d; --card:#383838; --card2:#424242;
  --gold:#ffca28; --gold2:#ffb300; --goldLight:#ffe082;
  --accent:#9575cd; --accent2:#7e57c2;
  --green:#4db6ac; --red:#ef5350; --blue:#4fc3f7; --orange:#ffb74d; --pink:#f06292;
  --text:#f5f5f5; --textSub:#e0e0e0; --textMuted:#9e9e9e;
  --border:rgba(255,255,255,0.1);
  --hero-grad:linear-gradient(180deg,#2d2d2d 0%,#1e1e1e 100%);
  --pwa-bg:#1e1e1e;
}

/* ── Ocean Blue ── Simple solid blue */
[data-theme="blue"] {
  --bg:#0d47a1; --bg2:#1565c0; --card:#1976d2; --card2:#1e88e5;
  --gold:#ffeb3b; --gold2:#ffc107; --goldLight:#fff59d;
  --accent:#ce93d8; --accent2:#ba68c8;
  --green:#80cbc4; --red:#ef9a9a; --blue:#81d4fa; --orange:#ffcc80; --pink:#f48fb1;
  --text:#ffffff; --textSub:#e3f2fd; --textMuted:#90caf9;
  --border:rgba(255,255,255,0.15);
  --hero-grad:linear-gradient(180deg,#1565c0 0%,#0d47a1 100%);
  --pwa-bg:#0d47a1;
}

/* ══════════════════════════════════════════════════════
   THEME TOGGLE BUTTON (on hero title)
══════════════════════════════════════════════════════ */
.theme-toggle-wrap{display:inline-flex;align-items:center;gap:7px;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;position:relative}
.theme-orb{width:32px;height:32px;border-radius:50%;border:2px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .35s cubic-bezier(.34,1.56,.64,1);flex-shrink:0;position:relative;overflow:hidden;box-shadow:0 3px 14px rgba(0,0,0,.5)}
.theme-orb::after{content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(255,255,255,.4),transparent 65%);pointer-events:none}
.theme-toggle-wrap:active .theme-orb{transform:scale(.85) rotate(30deg)}
@keyframes orbPop{0%{transform:scale(1)}50%{transform:scale(1.28) rotate(22deg)}100%{transform:scale(1) rotate(0)}}
.orb-pop{animation:orbPop .45s cubic-bezier(.34,1.56,.64,1)}

/* ── Redesigned Theme Drawer ── */
.theme-drawer{
  position:fixed;top:0;left:0;
  z-index:9999;
  background:var(--bg2);
  border:1.5px solid var(--border);
  border-radius:18px;
  padding:0;
  display:none;
  flex-direction:column;
  box-shadow:0 20px 60px rgba(0,0,0,.7),0 0 0 1px rgba(255,255,255,.04);
  width:240px;
  overflow:hidden;
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
}
.theme-drawer.open{display:flex;animation:tdSlide .22s cubic-bezier(.34,1.3,.64,1)}
@keyframes tdSlide{from{opacity:0;transform:scale(.93) translateY(-8px)}to{opacity:1;transform:scale(1) translateY(0)}}

/* Drawer header */
.td-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 14px 10px;
  border-bottom:1px solid var(--border);
  background:rgba(255,255,255,.03);
}
.td-title{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.2px;color:var(--textMuted)}
.td-close{width:22px;height:22px;border-radius:50%;background:var(--card2);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--textSub);transition:all .15s;line-height:1}
.td-close:hover{background:var(--card);color:var(--text)}

/* Category label */
.td-cat{font-size:8.5px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--textMuted);padding:8px 14px 4px;opacity:.7}

/* Theme grid */
.td-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:0 10px 10px}

/* Theme card */
.theme-opt{
  display:flex;flex-direction:column;align-items:center;gap:6px;
  padding:10px 8px 8px;border-radius:12px;cursor:pointer;
  transition:all .18s;border:1.5px solid transparent;
  background:var(--card);position:relative;overflow:hidden;
}
.theme-opt::before{content:'';position:absolute;inset:0;border-radius:12px;opacity:0;transition:opacity .2s;background:radial-gradient(circle at 50% 0%,rgba(255,255,255,.06),transparent 70%)}
.theme-opt:hover::before{opacity:1}
.theme-opt:hover{background:var(--card2);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.theme-opt.active{border-color:var(--gold);background:var(--card2);box-shadow:0 0 0 1px var(--gold),0 4px 16px rgba(0,0,0,.4)}
.theme-opt.active::after{content:'✓';position:absolute;top:5px;right:7px;font-size:9px;font-weight:900;color:var(--gold);background:rgba(0,0,0,.3);border-radius:50%;width:14px;height:14px;display:flex;align-items:center;justify-content:center;line-height:14px;text-align:center}

/* Swatch — mini app preview */
.theme-swatch{
  width:100%;height:36px;border-radius:8px;overflow:hidden;position:relative;
  border:1px solid rgba(255,255,255,.08);flex-shrink:0;
}
.ts-bg{position:absolute;inset:0}
.ts-bar{position:absolute;bottom:0;left:0;right:0;height:8px;opacity:.6}
.ts-dot{position:absolute;top:5px;left:5px;width:6px;height:6px;border-radius:50%}
.ts-line1{position:absolute;top:5px;left:14px;height:2px;border-radius:1px;width:28px;opacity:.8}
.ts-line2{position:absolute;top:10px;left:14px;height:2px;border-radius:1px;width:18px;opacity:.45}
.ts-pill{position:absolute;top:4px;right:5px;height:7px;width:14px;border-radius:4px;opacity:.9}

.theme-name{font-size:10px;font-weight:700;color:var(--text);text-align:center;line-height:1.2}
.theme-sub{font-size:8.5px;color:var(--textMuted);text-align:center;margin-top:1px;line-height:1.2}

/* ══════════════════════════════════════════════════════
   SM-2 STATS PANEL (on card back)
══════════════════════════════════════════════════════ */
.sm2-panel{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin-top:6px;display:grid;grid-template-columns:1fr 1fr;gap:6px}
.sm2-stat{display:flex;flex-direction:column;gap:2px}
.sm2-lbl{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--textMuted)}
.sm2-val{font-size:13px;font-weight:700;color:var(--text);font-family:'Playfair Display',serif}
.sm2-bar-wrap{height:3px;background:var(--card2);border-radius:2px;overflow:hidden;margin-top:3px;grid-column:1/-1}
.sm2-bar-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--gold),var(--gold2));transition:width .5s ease}
/* Rate button dynamic interval badge */
.rbtn-next{font-size:9px;opacity:.7;font-weight:600;margin-top:2px;transition:all .3s}
.rbtn-next.loading{opacity:.35;font-style:italic}

/* ══════════════════════════════════════════════════════
   PWA INSTALL BANNER
══════════════════════════════════════════════════════ */
#pwaBanner{position:fixed;bottom:calc(var(--nav-h) + 10px);left:12px;right:12px;z-index:600;background:var(--card2);border:1.5px solid var(--border);border-radius:14px;padding:12px 14px;display:none;align-items:center;gap:10px;box-shadow:0 8px 28px rgba(0,0,0,.4);animation:fadeUp .3s ease}
.pwa-icon{font-size:28px;flex-shrink:0}
.pwa-text{flex:1;min-width:0}
.pwa-title{font-size:13px;font-weight:700;color:var(--text)}
.pwa-sub{font-size:11px;color:var(--textMuted);margin-top:2px}
.pwa-install-btn{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;border:none;border-radius:8px;padding:8px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;white-space:nowrap;flex-shrink:0}
.pwa-close-btn{background:none;border:none;color:var(--textMuted);font-size:18px;cursor:pointer;padding:2px 6px;flex-shrink:0}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;height:100dvh;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;overflow-y:auto;overscroll-behavior:none;max-width:100vw}
#app{width:100%;height:100%;height:100dvh;display:flex;flex-direction:column;max-width:100%;margin:0;position:relative;overflow-y:auto;background:var(--bg);padding-top:env(safe-area-inset-top,0)}

/* SCREENS */
.screen{position:absolute;inset:0;bottom:var(--nav-h);overflow-y:auto;overflow-x:clip;display:none;flex-direction:column;scrollbar-width:none;padding-bottom:16px}
.screen::-webkit-scrollbar{display:none}
.screen.active{display:flex}
/* Home screen uses block layout to prevent flex overlap */
#homeScreen{display:none;flex-direction:unset}
#homeScreen.active{display:block}

/* BOTTOM NAV */
#nav{position:absolute;bottom:0;left:0;right:0;height:var(--nav-h);background:var(--bg2);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom,0)}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:none;border:none;cursor:pointer;color:var(--textMuted);transition:all .2s;padding:6px 2px;min-width:0}
.nb.active{color:var(--gold)}
.nb .ni{font-size:20px;line-height:1}
.nb .nl{font-size:11px;font-weight:700;letter-spacing:.4px;text-transform:uppercase;white-space:nowrap}
.nb.active .ni{transform:translateY(-2px)}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:10px 16px;border-radius:50px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;transition:all .2s;white-space:nowrap;flex-shrink:0}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000}
.btn-ghost{background:var(--card2);color:var(--text)}
.btn-danger{background:rgba(248,113,113,.12);color:var(--red);border:1px solid rgba(248,113,113,.25)}
.btn-accent{background:var(--accent);color:#fff}
.btn-sm{padding:7px 12px;font-size:12px}
.btn:active{transform:scale(.95)}
.icon-btn{width:36px;height:36px;padding:0;border-radius:50%}

/* INPUTS */
.inp{width:100%;background:var(--card2);border:1px solid var(--border);border-radius:var(--rsm);padding:11px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;-webkit-appearance:none;appearance:none}
.inp:focus{border-color:var(--gold)}
.inp::placeholder{color:var(--textMuted)}
select.inp{cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239898b8' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}

/* PROGRESS BAR */
.pbar{height:5px;background:var(--card2);border-radius:3px;overflow:hidden}
.pfill{height:100%;border-radius:3px;transition:width .6s ease;background:linear-gradient(90deg,var(--gold),var(--gold2))}

/* BADGE */
.badge{display:inline-block;padding:3px 9px;border-radius:50px;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.b-noun{background:rgba(96,165,250,.2);color:var(--blue)}
.b-verb{background:rgba(52,211,153,.2);color:var(--green)}
.b-adj{background:rgba(167,139,250,.2);color:var(--accent2)}
.b-adv{background:rgba(251,146,60,.2);color:var(--orange)}
.b-other{background:rgba(244,114,182,.2);color:var(--pink)}

/* TAG */
.tag{display:inline-block;padding:3px 9px;border-radius:50px;font-size:11px;background:var(--card2);color:var(--textSub);border:1px solid var(--border);margin:2px}

/* CARD BASE */
.card{background:var(--card);border-radius:var(--r);border:1px solid var(--border);padding:16px}

/* SPINNER */
.spin{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}


/* SECTION TITLE */
.stitle{font-size:11px;font-weight:700;color:var(--textMuted);text-transform:uppercase;letter-spacing:1px;padding:14px 12px 8px;display:block}

/* Quiz score bar */
.quiz-score{background:var(--card);border:1px solid rgba(245,200,66,.25);border-radius:var(--rsm);padding:10px 12px;margin:0 12px 8px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.qs-num{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--gold)}
.qs-lbl{font-size:11px;color:var(--textSub)}


/* ── LIST VIEW ── */
.lv-item{display:flex;align-items:center;gap:8px;padding:7px 12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;min-height:36px}
.lv-item:active{background:var(--card2)}
.lv-num{font-size:10px;color:var(--textMuted);font-weight:700;width:18px;flex-shrink:0;text-align:right}
.lv-word{font-family:'Playfair Display',serif;font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;max-width:120px}
.lv-sep{color:var(--textMuted);font-size:11px;flex-shrink:0;opacity:.5}
.lv-pron{font-size:12px;color:var(--gold);font-family:'Noto Sans Devanagari',sans-serif;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0}
.lv-arrow{font-size:12px;color:var(--textMuted);flex-shrink:0;padding-left:4px}
.lv-due{width:5px;height:5px;border-radius:50%;background:var(--red);flex-shrink:0}
.lv-badge{font-size:8px;padding:2px 6px;border-radius:50px;font-weight:700;flex-shrink:0;white-space:nowrap}

/* View toggle button */
.view-toggle{display:flex;gap:2px;background:var(--card2);border-radius:8px;padding:2px;border:1px solid var(--border)}
.vtb{width:28px;height:28px;border-radius:6px;border:none;background:none;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;color:var(--textMuted);transition:all .2s}
.vtb.vt-active{background:var(--card);color:var(--gold);box-shadow:0 1px 4px rgba(0,0,0,.3)}


/* ── CARD FRONT QUIZ ── */
.cq-wrap{padding:6px 10px 4px;flex:1;display:flex;flex-direction:column;gap:5px;min-height:0;overflow-y:auto;overflow-x:hidden}
.cq-lbl{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--textMuted);display:flex;align-items:center;justify-content:space-between}
.cq-type{font-size:9px;padding:2px 7px;border-radius:50px;font-weight:700;text-transform:uppercase;letter-spacing:.4px}
.cq-q{font-size:11px;color:var(--textSub);line-height:1.4;font-weight:500;margin-bottom:2px}
.cq-grid{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:5px;flex:1;min-height:120px}
.cq-opt{padding:5px 5px;border-radius:8px;border:1.5px solid var(--border);background:var(--card2);cursor:pointer;font-size:10px;font-weight:500;color:var(--text);text-align:center;transition:all .2s;font-family:'DM Sans',sans-serif;line-height:1.3;word-break:break-word;display:flex;align-items:center;justify-content:center;min-height:0;overflow:hidden}
.cq-opt:active{transform:scale(.96)}
.cq-opt.cq-correct{background:rgba(52,211,153,.18)!important;border-color:var(--green)!important;color:var(--green)!important;font-weight:700}
.cq-opt.cq-wrong{background:rgba(248,113,113,.18)!important;border-color:var(--red)!important;color:var(--red)!important}
.cq-opt:disabled{cursor:default}
.cq-loading{display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;font-size:11px;color:var(--textMuted)}
.cq-skip{font-size:10px;color:var(--textMuted);text-align:center;cursor:pointer;padding:2px;text-decoration:underline;opacity:.6}


/* ── IMPORT IMPROVEMENTS ── */
.fmt-detect{font-size:11px;padding:6px 10px;border-radius:8px;margin-top:8px;font-weight:600;display:flex;align-items:center;gap:6px}
.fmt-json{background:rgba(52,211,153,.1);color:var(--green);border:1px solid rgba(52,211,153,.25)}
.fmt-text{background:rgba(96,165,250,.1);color:var(--blue);border:1px solid rgba(96,165,250,.25)}
.fmt-partial{background:rgba(245,200,66,.1);color:var(--gold);border:1px solid rgba(245,200,66,.25)}
.fmt-error{background:rgba(248,113,113,.1);color:var(--red);border:1px solid rgba(248,113,113,.25)}
.enrich-prog{background:var(--card);border:1px solid var(--border);border-radius:var(--rsm);padding:12px;margin-top:10px}
.enrich-bar-wrap{height:6px;background:var(--card2);border-radius:3px;overflow:hidden;margin:8px 0 6px}
.enrich-bar-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--gold),var(--gold2));transition:width .4s ease}
.enrich-word-chip{display:inline-flex;align-items:center;gap:4px;font-size:10px;padding:2px 8px;border-radius:50px;margin:2px;font-weight:600}
.ew-done{background:rgba(52,211,153,.15);color:var(--green);border:1px solid rgba(52,211,153,.3)}
.ew-fail{background:rgba(248,113,113,.15);color:var(--red);border:1px solid rgba(248,113,113,.3)}
.ew-pending{background:var(--card2);color:var(--textMuted);border:1px solid var(--border)}
.ew-active{background:rgba(245,200,66,.15);color:var(--gold);border:1px solid rgba(245,200,66,.4)}
.imp-fmt-row{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.imp-fmt-pill{padding:5px 11px;border-radius:50px;border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;color:var(--textMuted);background:var(--card2);transition:all .2s}
.imp-fmt-pill.active{background:rgba(245,200,66,.15);border-color:var(--gold);color:var(--gold)}

/* IMPORT/EXPORT */
.imp-zone{border:2px dashed rgba(245,200,66,.35);border-radius:var(--rsm);padding:20px 16px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(245,200,66,.03)}
.imp-zone:hover,.imp-zone.drag{border-color:var(--gold);background:rgba(245,200,66,.07)}
.imp-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.imp-preview{background:var(--card);border-radius:var(--rsm);border:1px solid var(--border);padding:12px;font-size:12px;max-height:140px;overflow-y:auto;font-family:monospace;color:var(--textSub);line-height:1.5;word-break:break-all;white-space:pre-wrap}
.imp-pill-row{display:flex;gap:5px;flex-wrap:wrap;margin-top:8px}
.imp-pill{padding:5px 12px;border-radius:50px;background:var(--card);border:1.5px solid var(--border);font-size:11px;font-weight:600;cursor:pointer;color:var(--textSub);transition:all .2s;user-select:none}
.imp-pill.sel{background:rgba(245,200,66,.15);border-color:var(--gold);color:var(--gold)}
.imp-pill.sel-type{background:rgba(124,106,247,.1);border-color:rgba(124,106,247,.35);color:var(--textSub)}
.imp-pill.sel-type.sel{background:rgba(124,106,247,.28);border-color:var(--accent);color:var(--accent2);font-weight:800;box-shadow:0 0 0 2px rgba(124,106,247,.3)}
.quiz-src-badge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:50px;text-transform:uppercase;letter-spacing:.5px}
.quiz-src-badge.from-words{background:rgba(52,211,153,.15);color:var(--green);border:1px solid rgba(52,211,153,.3)}
.quiz-src-badge.from-ai{background:rgba(96,165,250,.15);color:var(--blue);border:1px solid rgba(96,165,250,.3)}

@media(max-width:360px){
  .hero-title{font-size:19px}
  .stat-n{font-size:17px}
  .eq-opts{grid-template-columns:1fr}
  .mgrid{grid-template-columns:1fr 1fr}
  .mcard .mi{font-size:20px}
  .rrow{grid-template-columns:1fr 1fr 1fr}
  .rbtn{font-size:11px;padding:9px 6px}
}
@media(min-width:481px){#app{max-width:480px;margin:0 auto;border-left:1px solid var(--border);border-right:1px solid var(--border)}}

/* TOAST */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--card2);color:var(--text);padding:10px 20px;border-radius:50px;font-size:13px;font-weight:500;z-index:999;opacity:0;transition:all .3s;border:1px solid var(--border);white-space:nowrap;pointer-events:none;max-width:90vw}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* MODAL */
.moverlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s;backdrop-filter:blur(4px)}
.moverlay.open{opacity:1;pointer-events:all}
.msheet{background:var(--bg2);width:100%;max-width:480px;border-radius:22px 22px 0 0;padding:18px;max-height:92vh;max-height:92dvh;overflow-y:auto;overflow-x:hidden;transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);padding-bottom:calc(24px + env(safe-area-inset-bottom,0));-webkit-overflow-scrolling:touch}
.moverlay.open .msheet{transform:translateY(0)}
.mhandle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px}

/* XP POPUP */

/* CONFETTI */
.conf{position:fixed;pointer-events:none;font-size:22px;animation:cfall 1.5s ease forwards;z-index:999}
@keyframes cfall{0%{opacity:1;transform:translateY(0) rotate(0)}100%{opacity:0;transform:translateY(80vh) rotate(720deg)}}

/* ========= HOME ========= */
.hero{margin:12px 12px 0;background:var(--hero-grad);border-radius:var(--r);padding:16px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.08);box-shadow:0 8px 32px rgba(0,0,0,.5)}
.hero::before{content:'';position:absolute;top:-40%;right:-15%;width:180px;height:180px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,.07),transparent 70%)}
.hero::after{content:'';position:absolute;bottom:-30px;left:-20px;width:120px;height:120px;border-radius:50%;background:radial-gradient(circle,var(--gold),transparent 70%);opacity:.06;pointer-events:none}
.hero-greeting{font-size:11px;color:var(--textSub);margin-bottom:3px;letter-spacing:.3px}
.hero-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;color:var(--gold);line-height:1.2;margin-bottom:8px;word-break:break-word;text-shadow:0 2px 12px rgba(0,0,0,.3)}
.chips-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.chip{display:flex;align-items:center;gap:4px;border-radius:50px;padding:5px 10px;font-size:11px;font-weight:600;flex-shrink:0}
.chip-gold{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:var(--gold)}
.chip-accent{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:var(--accent2)}

.stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin:8px 12px 0}
.stat{background:var(--card);border-radius:var(--rsm);padding:10px 8px;text-align:center;border:1px solid var(--border);position:relative;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.stat::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.03),transparent);pointer-events:none}
.stat-n{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--gold)}
.stat-l{font-size:9px;color:var(--textSub);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}

.daily-card{margin:0 12px}
.daily-hdr{display:flex;justify-content:space-between;margin-bottom:8px;font-size:13px;font-weight:600}

/* MODES GRID */
.mgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:0 12px}
.mgrid .mcard:last-child:nth-child(odd){grid-column:1/-1}
.mcard{background:var(--card);border-radius:var(--r);padding:14px;border:1px solid var(--border);cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:5px;position:relative;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.3)}
.mcard:active{transform:scale(.97)}
.mcard::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.mcard::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.03),transparent 50%);pointer-events:none}
.mcard[dc=gold]::before{background:linear-gradient(90deg,var(--gold),var(--gold2))}
.mcard[dc=accent]::before{background:linear-gradient(90deg,var(--accent),var(--accent2))}
.mcard[dc=green]::before{background:linear-gradient(90deg,var(--green),#059669)}
.mcard[dc=red]::before{background:linear-gradient(90deg,var(--red),#dc2626)}
.mcard[dc=blue]::before{background:linear-gradient(90deg,var(--blue),#2563eb)}
.mcard[dc=orange]::before{background:linear-gradient(90deg,var(--orange),#ea580c)}
.mcard[dc=pink]::before{background:linear-gradient(90deg,var(--pink),#db2777)}
.mcard .mi{font-size:22px}
.mcard .mn{font-size:12px;font-weight:700;color:var(--text)}
.mcard .md{font-size:10px;color:var(--textSub)}

/* EXAM SECTION */
.exam-row{display:flex;gap:6px;overflow-x:auto;padding:0 12px 8px;scrollbar-width:none}
.exam-row::-webkit-scrollbar{display:none}
.exam-pill{flex-shrink:0;padding:7px 14px;border-radius:50px;background:var(--card);border:1px solid var(--border);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;color:var(--text)}
.exam-pill.active{background:var(--gold);color:#000;border-color:var(--gold)}

.cat-row{display:flex;gap:6px;overflow-x:auto;padding:0 12px 8px;scrollbar-width:none}
.cat-row::-webkit-scrollbar{display:none}
.cat-pill{flex-shrink:0;padding:6px 12px;border-radius:50px;background:var(--card2);border:1px solid var(--border);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;color:var(--textSub)}
.cat-pill.active{background:var(--accent);color:#fff;border-color:var(--accent)}

.year-row{display:flex;gap:6px;overflow-x:auto;padding:0 12px 4px;scrollbar-width:none}
.year-row::-webkit-scrollbar{display:none}
.year-pill{flex-shrink:0;padding:5px 11px;border-radius:50px;background:var(--card2);border:1px solid var(--border);font-size:11px;font-weight:600;cursor:pointer;color:var(--textMuted);white-space:nowrap;transition:all .2s}
.year-pill.active{background:rgba(245,200,66,.15);color:var(--gold);border-color:rgba(245,200,66,.4)}

.exam-q-card{margin:0 12px 8px;background:var(--card);border-radius:var(--r);border:1px solid var(--border);padding:16px;cursor:pointer;transition:all .2s}
.exam-q-card:active{transform:scale(.99)}
.eq-num{font-size:10px;color:var(--textMuted);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.eq-q{font-size:13px;font-weight:600;line-height:1.5;margin-bottom:12px;word-break:break-word}
.eq-opts{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.eq-opt{padding:9px 8px;background:var(--card2);border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-weight:500;cursor:pointer;transition:all .2s;text-align:center;font-family:'DM Sans',sans-serif;color:var(--text);word-break:break-word;line-height:1.4}
.eq-opt.correct{background:rgba(52,211,153,.15)!important;border-color:var(--green)!important;color:var(--green)!important}
.eq-opt.wrong{background:rgba(248,113,113,.15)!important;border-color:var(--red)!important;color:var(--red)!important}
.eq-opt:not([disabled]):active{background:var(--bg2)}
.eq-tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
.eq-tag.syn{background:rgba(52,211,153,.15);color:var(--green)}
.eq-tag.ant{background:rgba(248,113,113,.15);color:var(--red)}
.eq-tag.iop{background:rgba(96,165,250,.15);color:var(--blue)}
.eq-tag.ows{background:rgba(167,139,250,.15);color:var(--accent2)}
.eq-tag.hom{background:rgba(251,146,60,.15);color:var(--orange)}

/* ========= WORDS SCREEN ========= */
#wordsScreen{display:none}
#wordsScreen.active{display:block}

/* 3-level filter */
.wfilter-wrap{background:var(--bg);position:sticky;top:0;z-index:10;padding-bottom:4px;border-bottom:1px solid var(--border)}
.wfrow{display:flex;gap:5px;overflow-x:auto;padding:4px 12px 4px;scrollbar-width:none}
.wfrow::-webkit-scrollbar{display:none}
.wfpill{flex-shrink:0;padding:6px 12px;border-radius:50px;border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;background:var(--card2);color:var(--textMuted);user-select:none}
.wfpill.active-exam{background:rgba(245,200,66,.18);border-color:var(--gold);color:var(--gold)}
.wfpill.active-year{background:rgba(96,165,250,.18);border-color:var(--blue);color:var(--blue)}
.wfpill.active-type{background:rgba(124,106,247,.2);border-color:var(--accent);color:var(--accent2)}
.wf-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;padding:4px 12px 0;color:var(--textMuted);display:flex;align-items:center;gap:6px}
.wf-lbl::after{content:'';flex:1;height:1px;background:var(--border)}
.year-custom-row{display:flex;align-items:center;gap:6px;padding:4px 12px 2px}
.year-cin{background:var(--card2);border:1.5px solid var(--border);border-radius:50px;padding:7px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;outline:none;width:90px;text-align:center}
.year-cin:focus{border-color:var(--blue)}
.year-cin::placeholder{color:var(--textMuted)}

.witem{margin:0 12px 8px;background:var(--card);border-radius:var(--rsm);border:1px solid var(--border);overflow:hidden;cursor:pointer;transition:all .2s}
.witem:active{transform:scale(.99)}
.wtop{display:flex;align-items:center;gap:10px;padding:12px;min-width:0}
.wimg{width:44px;height:44px;border-radius:8px;object-fit:cover;background:var(--card2);flex-shrink:0}
.wph{width:44px;height:44px;border-radius:8px;background:var(--card2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:16px}
.winfo{flex:1;min-width:0;overflow:hidden}
.wword{font-family:'Playfair Display',serif;font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.whindi{font-size:13px;color:var(--textSub);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Noto Sans Devanagari',sans-serif}
.wdef{font-size:11px;color:var(--textMuted);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wacts{display:flex;gap:5px;padding:0 12px 10px;flex-wrap:wrap}
.sdot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.sdot.weak{background:var(--red)}
.sdot.medium{background:var(--orange)}
.sdot.strong{background:var(--green)}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 20px;gap:10px;text-align:center}
.empty-icon{font-size:52px;opacity:.3}
.empty-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--textSub)}

/* REMEMBER BUTTONS */
.btn-remember{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.3)}
.btn-forget{background:rgba(248,113,113,.12);color:var(--red);border:1px solid rgba(248,113,113,.3)}
.rmem-badge{display:inline-flex;align-items:center;gap:3px;font-size:9px;padding:2px 8px;border-radius:50px;font-weight:700}
.rmem-yes{background:rgba(52,211,153,.15);color:var(--green);border:1px solid rgba(52,211,153,.3)}
.rmem-no{background:rgba(248,113,113,.15);color:var(--red);border:1px solid rgba(248,113,113,.3)}

/* Card front: phonetic Devanagari of how English word sounds — e.g. ग्रेट */
.chindi{font-size:14px;color:var(--gold);font-weight:600;font-family:'Noto Sans Devanagari',sans-serif;line-height:1.5;letter-spacing:.3px}
/* Card front: Hindi meaning shown subtly below phonetic */
.chindi-roman{font-size:11px;color:var(--textSub);font-family:'Noto Sans Devanagari',sans-serif;margin-top:1px;min-height:14px}
.chindi-roman.loading{opacity:.35;font-family:'DM Sans',sans-serif;font-style:italic}

/* PRONUNCIATION BUTTON */
.speak-btn{background:rgba(245,200,66,.12);border:1px solid rgba(245,200,66,.25);color:var(--gold);border-radius:50px;padding:4px 11px;font-size:12px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;font-weight:600;display:inline-flex;align-items:center;gap:4px;margin-top:6px}
.ask-chip{padding:7px 13px;border-radius:50px;background:var(--card2);border:1.5px solid var(--border);font-size:12px;font-weight:600;cursor:pointer;color:var(--text);font-family:'DM Sans',sans-serif;transition:all .2s;white-space:nowrap}
.ask-chip:active{background:rgba(124,106,247,.2);border-color:var(--accent);color:var(--accent2);transform:scale(.95)}
.ask-ai-section{margin-bottom:12px}
.ask-ai-label{font-size:9px;font-weight:700;color:var(--textMuted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.ask-ai-content{font-size:13px;line-height:1.75;color:var(--text)}
.ask-ai-content b{color:var(--gold)}
.ask-ai-quiz-opt{width:100%;padding:10px 14px;background:var(--card2);border:1.5px solid var(--border);border-radius:var(--rsm);cursor:pointer;font-size:13px;font-weight:500;transition:all .2s;text-align:left;font-family:'DM Sans',sans-serif;color:var(--text);margin-bottom:6px;display:block}
.ask-ai-quiz-opt.correct{background:rgba(52,211,153,.15)!important;border-color:var(--green)!important;color:var(--green)!important}
.ask-ai-quiz-opt.wrong{background:rgba(248,113,113,.15)!important;border-color:var(--red)!important;color:var(--red)!important}
.speak-btn:active{transform:scale(.93);background:rgba(245,200,66,.22)}

/* HINDI ON CARD BACK */
.cb-hindi{font-size:15px;color:var(--gold);margin-top:2px;margin-bottom:4px;font-weight:600;opacity:.95;font-family:'Noto Sans Devanagari',sans-serif;line-height:1.5}
.cb-hindi-roman{font-size:12px;color:var(--textSub);font-style:italic;margin-bottom:10px;font-family:'DM Sans',sans-serif}

/* ========= FLASHCARD ========= */
#cardScreen{align-items:center;overflow:hidden}
.cmode-bar{width:100%;padding:10px 14px 0;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.ccounter{font-size:11px;color:var(--textSub);font-weight:600}
.cmode-lbl{font-size:10px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px}
.cprog{width:100%;padding:6px 14px 0;flex-shrink:0}

/* Exam filter bar inside study screen */
.cef-bar{width:100%;padding:5px 12px 0;flex-shrink:0}
.cef-scroll{display:flex;gap:5px;overflow-x:auto;scrollbar-width:none;padding-bottom:5px}
.cef-scroll::-webkit-scrollbar{display:none}
.cef-pill{flex-shrink:0;padding:5px 12px;border-radius:50px;border:1.5px solid var(--border);font-size:10px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;background:var(--card2);color:var(--textMuted);user-select:none}
.cef-pill.ce-active{background:rgba(245,200,66,.15);border-color:var(--gold);color:var(--gold)}
.ai-health-row{display:flex;flex-direction:column;gap:7px;margin-top:4px}
.ai-health-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-radius:12px;background:var(--card);border:1px solid var(--border);transition:all .2s}
.ai-health-left{display:flex;align-items:center;gap:10px}
.ai-health-icon{font-size:18px;width:28px;text-align:center;flex-shrink:0}
.ai-health-name{font-size:13px;font-weight:700;color:var(--text)}
.ai-health-model{font-size:10px;color:var(--textMuted);margin-top:1px}
.ai-health-status{font-size:11px;font-weight:700;padding:3px 10px;border-radius:50px;flex-shrink:0}
.ai-hs-idle{background:var(--card2);color:var(--textMuted)}
.ai-hs-testing{background:rgba(96,165,250,.15);color:var(--blue);animation:pulse 1s ease infinite}
.ai-hs-ok{background:rgba(46,204,138,.15);color:var(--green);border:1px solid rgba(46,204,138,.3)}
.ai-hs-fail{background:rgba(240,110,110,.12);color:var(--red);border:1px solid rgba(240,110,110,.3)}
.ai-health-latency{font-size:9px;color:var(--textMuted);margin-top:2px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.ai-btn-active{background:rgba(124,106,247,.2) !important;border-color:var(--accent) !important;color:var(--accent2) !important;box-shadow:0 0 0 1px rgba(124,106,247,.3)}
.cef-pill.ce-due{border-color:rgba(248,113,113,.4);color:var(--red);background:rgba(248,113,113,.08)}
.cef-pill.ce-due.ce-active{background:rgba(248,113,113,.15)}

/* CARD FLIP - ENHANCED */
.fc-area{width:100%;flex:1;display:flex;align-items:center;justify-content:center;padding:6px 12px;perspective:1500px;min-height:0;overflow:hidden}
.fc-wrapper{width:100%;max-width:420px;height:100%;max-height:74vh;position:relative;user-select:none}
.fc{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .6s cubic-bezier(.34,1.56,.64,1);border-radius:var(--r)}
.fc.flipped{transform:rotateY(180deg)}
.fc.flipped .cf-front{box-shadow:0 25px 50px -12px rgba(0,0,0,0.6)}
.fc:not(.flipped):active{transform:scale(1.02)}
.cf{position:absolute;inset:0;border-radius:var(--r);border:1px solid var(--border);backface-visibility:hidden;-webkit-backface-visibility:hidden}

/* Progress bar for flashcards */
.fc-progress{width:100%;height:4px;background:var(--card2);border-radius:2px;margin-bottom:8px;overflow:hidden}
.fc-progress-bar{height:100%;background:linear-gradient(90deg,var(--gold),#fcd34d);border-radius:2px;transition:width .4s ease}

/* STAGGERED REVEAL ANIMATIONS */
@keyframes fadeSlideUp{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
.cf-back .cb-body > div{animation:fadeSlideUp .4s ease forwards;opacity:0}
.cf-back .cb-body > div:nth-child(1){animation-delay:.1s}
.cf-back .cb-body > div:nth-child(2){animation-delay:.18s}
.cf-back .cb-body > div:nth-child(3){animation-delay:.26s}
.cf-back .cb-body > div:nth-child(4){animation-delay:.34s}
.cf-back .cb-body > div:nth-child(5){animation-delay:.42s}
.cf-back .cb-body > div:nth-child(6){animation-delay:.5s}

/* FRONT — fixed height, no scroll */
.cf-front{background:linear-gradient(145deg,var(--card) 0%,#1e1a38 100%);display:flex;flex-direction:column;overflow:hidden;box-shadow:0 10px 30px -5px rgba(0,0,0,0.4),0 0 0 1px rgba(255,255,255,0.05)}
.cimg-zone{width:100%;height:120px;position:relative;overflow:hidden;flex-shrink:0}
.cimg{width:100%;height:100%;object-fit:cover;object-position:center;display:block}
.cimg-overlay{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.08) 0%,transparent 35%,var(--card) 100%)}
.cimg-ph{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--card2),#1a1a2e);font-size:48px;opacity:.4}
.card-top-btns{position:absolute;top:8px;right:8px;display:flex;gap:4px;z-index:10}
.ctbtn{width:30px;height:30px;border-radius:50%;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.5);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;color:#fff}
.cf-body{padding:10px 12px 8px;flex:1;display:flex;flex-direction:column;gap:4px;min-height:0;overflow:hidden}
.cword{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;line-height:1.1;color:var(--text)}
.chindi{font-size:15px;color:var(--gold);font-weight:600;font-family:'Noto Sans Devanagari',sans-serif;line-height:1.5}
.cflip-hint{font-size:9px;color:var(--textMuted);text-align:center;margin-top:auto;padding-top:4px}

/* Strength badge on card */
.str-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:50px;font-size:9px;font-weight:800;text-transform:uppercase}
.str-h{background:rgba(248,113,113,.15);color:var(--red);border:1px solid rgba(248,113,113,.4)}
.str-m{background:rgba(251,146,60,.15);color:var(--orange);border:1px solid rgba(251,146,60,.4)}
.str-e{background:rgba(52,211,153,.15);color:var(--green);border:1px solid rgba(52,211,153,.4)}

.swing-l{position:absolute;top:50%;transform:translateY(-50%) translateX(-20px);left:10px;font-size:11px;font-weight:800;letter-spacing:1px;text-transform:uppercase;opacity:0;transition:all .25s cubic-bezier(.4,0,.2,1);color:var(--red);background:rgba(248,113,113,.25);padding:8px 14px;border-radius:8px;pointer-events:none;z-index:20;box-shadow:0 4px 12px rgba(248,113,113,.3)}
.swing-r{position:absolute;top:50%;transform:translateY(-50%) translateX(20px);right:10px;font-size:11px;font-weight:800;letter-spacing:1px;text-transform:uppercase;opacity:0;transition:all .25s cubic-bezier(.4,0,.2,1);color:var(--green);background:rgba(52,211,153,.25);padding:8px 14px;border-radius:8px;pointer-events:none;z-index:20;box-shadow:0 4px 12px rgba(52,211,153,.3)}
.fc:not(.flipped):hover .swing-l,.fc:not(.flipped):hover .swing-r{opacity:.9;transform:translateY(-50%) translateX(0)}

/* BACK — SCROLLABLE, key fix! */
.cf-back{background:linear-gradient(145deg,#1a2635 0%,var(--card) 100%);transform:rotateY(180deg);overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;box-shadow:0 10px 30px -5px rgba(0,0,0,0.4),0 0 0 1px rgba(255,255,255,0.05)}
.cf-back::-webkit-scrollbar{display:none}
.cb-body{padding:10px 12px;display:flex;flex-direction:column;gap:7px;min-height:100%}
.cb-word{font-family:'Playfair Display',serif;font-size:20px;font-weight:900;color:var(--text)}
.lbl{font-size:9px;font-weight:700;color:var(--textMuted);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
.def-text{font-size:12px;line-height:1.6;color:var(--text)}
.ex-text{font-size:11px;color:var(--textSub);line-height:1.55;font-style:italic}
.mnem{background:rgba(245,200,66,.08);border:1px solid rgba(245,200,66,.2);border-radius:8px;padding:8px 10px;font-size:11px;color:var(--goldLight);line-height:1.5}
@keyframes mnemPop{0%{transform:scale(.95);opacity:.5}60%{transform:scale(1.03)}100%{transform:scale(1);opacity:1}}
.tags-row{display:flex;flex-wrap:wrap;gap:3px}

/* RATING ROW — 3 buttons with labels */
.rrow{width:100%;padding:8px 12px 8px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;flex-shrink:0;background:linear-gradient(to top,rgba(0,0,0,0.3),transparent);border-radius:0 0 16px 16px}
.rbtn{padding:10px 6px;border-radius:12px;border:1.5px solid;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);font-family:'DM Sans',sans-serif;display:flex;flex-direction:column;align-items:center;gap:3px}
.rbtn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.3)}
.rbtn-icon{font-size:18px}
.rbtn-lbl{font-size:11px;font-weight:800}
.rbtn-next{font-size:9px;opacity:.7}
.rbtn.hard{background:linear-gradient(135deg,rgba(248,113,113,.2),rgba(248,113,113,.08));border-color:rgba(248,113,113,.5);color:var(--red)}
.rbtn.med{background:linear-gradient(135deg,rgba(251,146,60,.2),rgba(251,146,60,.08));border-color:rgba(251,146,60,.5);color:var(--orange)}
.rbtn.easy{background:linear-gradient(135deg,rgba(52,211,153,.2),rgba(52,211,153,.08));border-color:rgba(52,211,153,.5);color:var(--green)}
.rbtn:active{transform:scale(.94)}

/* NAV ROW */
.cnav{width:100%;padding:8px 12px 10px;display:flex;justify-content:center;gap:16px;flex-shrink:0}
.cnbtn{width:44px;height:44px;border-radius:50%;border:1.5px solid var(--border);background:linear-gradient(135deg,var(--card2),var(--card));color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .25s cubic-bezier(.4,0,.2,1);box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.cnbtn:hover{transform:scale(1.08);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.cnbtn:active{transform:scale(.9)}

/* ========= MEMORY SCIENCE (Home) ========= */
.ms-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin:0 12px}
.ms-box{border-radius:var(--rsm);padding:10px 6px;text-align:center;border:1.5px solid;cursor:pointer;transition:all .2s}
.ms-box:active{transform:scale(.96)}
.ms-box.bh{background:rgba(248,113,113,.07);border-color:rgba(248,113,113,.3)}
.ms-box.bm{background:rgba(251,146,60,.07);border-color:rgba(251,146,60,.3)}
.ms-box.be{background:rgba(52,211,153,.07);border-color:rgba(52,211,153,.3)}
.ms-n{font-family:'Playfair Display',serif;font-size:22px;font-weight:700}
.ms-l{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;margin-top:1px}
.ms-s{font-size:8px;margin-top:2px;opacity:.55}

.due-banner{margin:8px 12px 0;background:var(--card);border-radius:var(--rsm);border:1px solid var(--border);padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;transition:all .2s}
.due-banner:active{transform:scale(.98)}
.due-left{display:flex;align-items:center;gap:10px}
.due-n{font-family:'Playfair Display',serif;font-size:30px;font-weight:900;color:var(--red)}
.due-info .due-title{font-size:13px;font-weight:700;color:var(--text)}
.due-info .due-sub{font-size:10px;color:var(--textMuted);margin-top:2px}

.mm-wrap{margin:8px 12px 0;background:var(--card);border-radius:var(--rsm);border:1px solid var(--border);padding:10px 12px}
.mm-title{font-size:11px;font-weight:700;color:var(--text);margin-bottom:7px;display:flex;justify-content:space-between;align-items:center}
.mm-bar{height:10px;border-radius:5px;background:var(--card2);overflow:hidden;display:flex}
.mm-seg{height:100%;transition:width .7s ease}
.mm-legend{display:flex;justify-content:space-between;margin-top:5px;font-size:9px;font-weight:700}

/* ========= PRACTICE ========= */
#practiceScreen{align-items:stretch}
.ph{padding:14px 16px;display:flex;align-items:center;gap:10px}
.pbk{width:38px;height:38px;border-radius:50%;background:var(--card2);border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;color:var(--text);flex-shrink:0}
.ptitle{font-family:'Playfair Display',serif;font-size:20px;font-weight:700}
.pq{padding:0 16px;flex:1}
.pq-lbl{font-size:11px;color:var(--textMuted);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.pq-text{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;line-height:1.4;margin-bottom:16px}
.mopts{display:flex;flex-direction:column;gap:8px}
.mopt{padding:13px 16px;background:var(--card);border:1.5px solid var(--border);border-radius:var(--rsm);cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;text-align:left;font-family:'DM Sans',sans-serif;color:var(--text)}
.mopt.correct{background:rgba(52,211,153,.15)!important;border-color:var(--green)!important;color:var(--green)!important}
.mopt.wrong{background:rgba(248,113,113,.15)!important;border-color:var(--red)!important;color:var(--red)!important}
.tbar-wrap{height:5px;background:var(--card2);margin:0 16px;overflow:hidden;border-radius:3px}
.tbar{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--gold));transition:width 1s linear}
.score-result{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;gap:14px}
.score-big{font-family:'Playfair Display',serif;font-size:68px;font-weight:900;color:var(--gold)}
.rapid-count{font-family:'Playfair Display',serif;font-size:56px;font-weight:900;color:var(--gold);text-align:center;padding:16px}

/* ========= PROGRESS ========= */
.prog-cards{padding:0 14px;display:flex;flex-direction:column;gap:10px}
.lvl-card{background:linear-gradient(135deg,#1e1a38,#1a2635);border-radius:var(--r);padding:18px;border:1px solid var(--border)}
.lvl-name{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--gold);margin-bottom:4px}
.graph-card{background:var(--card);border-radius:var(--r);padding:18px;border:1px solid var(--border)}
.bar-graph{display:flex;align-items:flex-end;gap:5px;height:70px}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.bar-fill{width:100%;border-radius:4px 4px 0 0;background:linear-gradient(to top,var(--gold2),var(--gold));min-height:4px;transition:height .6s ease}
.bar-lbl{font-size:8px;color:var(--textMuted)}
.ach-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.ach{background:var(--card);border-radius:var(--rsm);padding:12px 8px;text-align:center;border:1px solid var(--border)}
.ach.unlocked{border-color:rgba(245,200,66,.3);background:rgba(245,200,66,.05)}
.ach-icon{font-size:26px;margin-bottom:5px}
.ach.locked .ach-icon{filter:grayscale(1);opacity:.25}
.ach-name{font-size:10px;font-weight:700;color:var(--textSub)}
.ach.unlocked .ach-name{color:var(--goldLight)}
.str-row{display:flex;align-items:center;gap:10px}
.str-lbl{font-size:12px;width:55px;font-weight:600}
.str-ct{font-size:12px;font-weight:700;width:28px;text-align:right}

/* STORY */
.story-text{font-size:14px;line-height:1.85;color:var(--text)}
.story-hl{color:var(--gold);font-weight:700}

/* SENTENCE BUILDER */
.sb-words{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px}
.sb-w{padding:7px 13px;background:var(--card2);border:1px solid var(--border);border-radius:50px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s;user-select:none}
.sb-w.used{opacity:.3;pointer-events:none}
.sb-drop{min-height:54px;background:rgba(245,200,66,.05);border:2px dashed rgba(245,200,66,.3);border-radius:var(--rsm);padding:10px;display:flex;flex-wrap:wrap;gap:6px;align-items:flex-start;margin-bottom:10px}
.sb-placed{padding:5px 11px;background:rgba(245,200,66,.15);border-radius:50px;color:var(--gold);font-size:13px;font-weight:600;cursor:pointer}

/* ADD MODAL EXAM FIELDS */
.add-exam-row{display:flex;gap:6px;overflow-x:auto;padding-bottom:6px;scrollbar-width:none;margin-bottom:2px}
.add-exam-row::-webkit-scrollbar{display:none}
.add-epill{flex-shrink:0;padding:5px 12px;border-radius:50px;background:var(--card);border:1.5px solid var(--border);font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;color:var(--textSub);transition:all .2s;user-select:none}
.add-epill.sel{background:rgba(245,200,66,.18);border-color:var(--gold);color:var(--gold)}
.add-tpill{flex-shrink:0;padding:5px 12px;border-radius:50px;background:var(--card);border:1.5px solid var(--border);font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;color:var(--textSub);transition:all .2s;user-select:none}
.add-tpill.sel{background:rgba(124,106,247,.2);border-color:var(--accent);color:var(--accent2)}

@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.fadein{animation:fadeUp .3s ease forwards}

/* ── WORD ROOTS ── */
.roots-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.root-chip{background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.25);border-radius:8px;padding:7px 10px;min-width:0}
.root-part{font-size:12px;font-weight:700;color:var(--blue);font-family:'Playfair Display',serif}
.root-meaning{font-size:10px;color:var(--textSub);margin-top:1px}
.root-eg{font-size:10px;color:var(--textMuted);margin-top:1px;font-style:italic}

/* ── WORD FAMILY ── */
.wfam-row{display:flex;flex-wrap:wrap;gap:5px;margin-top:4px}
.wfam-chip{background:rgba(167,139,250,.1);border:1px solid rgba(167,139,250,.22);border-radius:50px;padding:4px 10px;font-size:11px;font-weight:600;color:var(--accent2)}

/* ── 3 SENTENCES ── */
.sent-list{display:flex;flex-direction:column;gap:8px;margin-top:4px}
.sent-item{font-size:13px;color:var(--textSub);line-height:1.65;padding:8px 10px;background:var(--bg);border-left:2px solid rgba(245,200,66,.4);border-radius:0 8px 8px 0}
.sent-num{font-size:9px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:.8px;margin-bottom:2px}

/* ── CONFUSABLES ── */
.conf-list{display:flex;flex-direction:column;gap:7px;margin-top:6px}
.conf-item{background:rgba(248,113,113,.07);border:1px solid rgba(248,113,113,.22);border-radius:10px;padding:10px 12px;position:relative;overflow:hidden;transition:all .2s}
.conf-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(180deg,var(--red),rgba(248,113,113,.3));border-radius:3px 0 0 3px}
.conf-word{font-size:13px;font-weight:800;color:var(--red);margin-bottom:4px;display:flex;align-items:center;gap:6px}
.conf-word-badge{font-size:9px;padding:2px 7px;border-radius:50px;background:rgba(248,113,113,.15);color:var(--red);border:1px solid rgba(248,113,113,.3);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.conf-diff{font-size:11.5px;color:var(--textSub);line-height:1.6}
.conf-vs-row{display:flex;align-items:center;gap:8px;margin:8px 0 4px;flex-wrap:wrap}
.conf-vs-pill{font-size:11px;font-weight:700;padding:4px 10px;border-radius:50px;border:1.5px solid var(--border);background:var(--card2);color:var(--text);flex-shrink:0}
.conf-vs-pill.main{background:rgba(245,200,66,.12);border-color:rgba(245,200,66,.4);color:var(--gold)}
.conf-vs-pill.confused{background:rgba(248,113,113,.1);border-color:rgba(248,113,113,.35);color:var(--red)}
.conf-vs-divider{font-size:10px;color:var(--textMuted);font-weight:700}
.conf-gen-btn{width:100%;padding:8px;border-radius:8px;background:rgba(248,113,113,.08);border:1.5px dashed rgba(248,113,113,.3);color:var(--red);font-size:11px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;margin-top:6px;display:flex;align-items:center;justify-content:center;gap:5px}
.conf-gen-btn:hover{background:rgba(248,113,113,.14);border-style:solid}
.conf-gen-btn:disabled{opacity:.5;cursor:not-allowed}
/* ── Mnemonic Maker styles ── */
.mnem-styles-row{display:flex;gap:5px;flex-wrap:wrap;margin:8px 0 6px}
.mnem-style-chip{padding:5px 10px;border-radius:50px;border:1.5px solid var(--border);background:var(--card2);font-size:10px;font-weight:700;color:var(--textSub);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;flex-shrink:0}
.mnem-style-chip.active{background:rgba(245,200,66,.15);border-color:rgba(245,200,66,.45);color:var(--gold)}
.mnem-style-chip:active{transform:scale(.95)}
.mnem-history-wrap{margin-top:8px;display:flex;flex-direction:column;gap:5px}
.mnem-history-item{padding:7px 10px;border-radius:8px;background:var(--card2);border:1px solid var(--border);font-size:11px;color:var(--textSub);line-height:1.5;cursor:pointer;transition:all .2s;position:relative}
.mnem-history-item:active{background:var(--bg2)}
.mnem-history-item.selected{border-color:var(--gold);background:rgba(245,200,66,.07);color:var(--goldLight)}
.mnem-history-lbl{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.7px;color:var(--textMuted);margin-bottom:3px}
@keyframes mnemPop{0%{transform:scale(.97);opacity:0}60%{transform:scale(1.01)}100%{transform:scale(1);opacity:1}}

/* ── TYPE THE WORD ── */
.type-zone{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:4px}
.type-prompt{font-size:12px;color:var(--textSub);margin-bottom:8px;line-height:1.5}
.type-inp-row{display:flex;gap:8px;align-items:center}
.type-inp{flex:1;background:var(--card2);border:1.5px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:border-color .2s;-webkit-appearance:none}
.type-inp:focus{border-color:var(--gold)}
.type-inp.correct{border-color:var(--green);background:rgba(52,211,153,.08)}
.type-inp.wrong{border-color:var(--red);background:rgba(248,113,113,.08)}
.type-submit{background:var(--gold);color:#000;border:none;border-radius:8px;padding:9px 14px;font-weight:700;font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;flex-shrink:0}
.type-submit:active{transform:scale(.95)}
.type-result{font-size:12px;font-weight:700;margin-top:8px;min-height:18px;line-height:1.5}

/* ===== QUIZ MODAL ===== */
#quizModal{position:fixed;inset:0;z-index:9999;display:none;flex-direction:column;background:var(--bg)}
#quizModal.open{display:flex}
.qm-hd{background:var(--bg2);padding:12px 14px 10px;flex-shrink:0;border-bottom:1px solid var(--border)}
.qm-hd-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.qm-title{font-family:'Playfair Display',serif;font-size:15px;font-weight:700;color:var(--gold);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:8px}
.qm-close-btn{width:32px;height:32px;border-radius:50%;background:var(--card2);border:1px solid var(--border);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;color:var(--text);flex-shrink:0}
.qm-prog{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.qm-pbar{flex:1;height:5px;background:var(--card2);border-radius:3px;overflow:hidden}
.qm-pfill{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold2));border-radius:3px;transition:width .3s}
.qm-pcnt{font-size:11px;font-weight:600;color:var(--textSub);white-space:nowrap}
.qm-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.qm-stat{background:var(--card);border-radius:8px;padding:5px 4px;text-align:center;border:1px solid var(--border)}
.qm-stat-n{font-size:17px;font-weight:700;font-family:'Playfair Display',serif;line-height:1.1}
.qm-stat-l{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--textMuted);margin-top:1px}
.qm-body{flex:1;overflow-y:auto;padding:16px 14px;scrollbar-width:none}
.qm-body::-webkit-scrollbar{display:none}
.qm-qtag-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.qm-qtext{font-size:16px;font-weight:600;line-height:1.6;color:var(--text);margin-bottom:18px}
.qm-opts{display:flex;flex-direction:column;gap:10px}
.qm-opt{width:100%;padding:13px 14px;background:var(--card);border:2px solid var(--border);border-radius:12px;cursor:pointer;font-size:14px;font-weight:500;text-align:left;font-family:'DM Sans',sans-serif;color:var(--text);transition:border-color .15s,background .15s;display:flex;align-items:center;gap:12px;line-height:1.4}
.qm-opt:not([disabled]):hover{border-color:rgba(245,200,66,.4)}
.qm-opt:not([disabled]):active{transform:scale(.98)}
.qm-letter{width:28px;height:28px;border-radius:50%;background:var(--card2);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;transition:all .15s}
.qm-opt.q-correct{border-color:var(--green)!important;background:rgba(52,211,153,.1)!important}
.qm-opt.q-correct .qm-letter{background:var(--green);border-color:var(--green);color:#000}
.qm-opt.q-wrong{border-color:var(--red)!important;background:rgba(248,113,113,.1)!important}
.qm-opt.q-wrong .qm-letter{background:var(--red);border-color:var(--red);color:#fff}
.qm-opt[disabled]{cursor:default;opacity:.85}
.qm-exp{margin-top:14px;background:var(--card);border-left:3px solid var(--gold);border-radius:0 10px 10px 0;padding:10px 12px;font-size:12px;line-height:1.7;color:var(--textSub);display:none}
.qm-exp.show{display:block}
.qm-ft{background:var(--bg2);border-top:1px solid var(--border);padding:10px 14px;flex-shrink:0;display:flex;gap:8px;align-items:center}
.qm-btn-skip{flex:1;padding:11px 8px;border-radius:50px;background:var(--card2);border:1px solid var(--border);color:var(--textSub);font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}
.qm-btn-nav{width:40px;height:40px;border-radius:50%;background:var(--card2);border:1px solid var(--border);color:var(--text);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.qm-btn-nav:disabled{opacity:.3;cursor:default}
.qm-btn-action{flex:2;padding:11px 12px;border-radius:50px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;font-size:13px;font-weight:700;cursor:pointer;border:none;font-family:'DM Sans',sans-serif;display:none}
.qm-btn-action.show{display:block}
/* Results */
.qr-wrap{flex:1;overflow-y:auto;padding:16px 14px;scrollbar-width:none}
.qr-wrap::-webkit-scrollbar{display:none}
.qr-hero{text-align:center;padding:16px 0 12px}
.qr-big{font-family:'Playfair Display',serif;font-size:60px;font-weight:900;line-height:1}
.qr-grade{font-size:20px;font-weight:700;margin-top:6px}
.qr-meta{font-size:11px;color:var(--textMuted);margin-top:5px}
.qr-boxes{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:14px 0}
.qr-box{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:11px 6px;text-align:center}
.qr-box-n{font-family:'Playfair Display',serif;font-size:26px;font-weight:700}
.qr-box-l{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--textMuted);margin-top:2px}
.qr-tabs{display:flex;gap:6px;margin:14px 0 10px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px}
.qr-tabs::-webkit-scrollbar{display:none}
.qr-tab{flex-shrink:0;padding:5px 12px;border-radius:50px;background:var(--card2);border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;color:var(--textMuted);transition:all .2s}
.qr-tab.active{background:rgba(245,200,66,.12);border-color:var(--gold);color:var(--gold)}
.qr-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px}
.qr-item.is-correct{border-left:3px solid var(--green)}
.qr-item.is-wrong{border-left:3px solid var(--red)}
.qr-item.is-skipped{border-left:3px solid var(--orange)}
.qr-item-status{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:5px}
.qr-item-q{font-size:13px;font-weight:600;line-height:1.5;color:var(--text);margin-bottom:5px}
.qr-item-a{font-size:11px;color:var(--textSub);line-height:1.6}

/* ── QUIZ AI POPUP MODAL ── */
#qmAiPopup{position:fixed;inset:0;z-index:99999;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s;background:rgba(0,0,0,.72);backdrop-filter:blur(6px)}
#qmAiPopup.open{opacity:1;pointer-events:all}
#qmAiPopup .qm-ai-sheet{background:var(--bg2);width:100%;max-width:480px;border-radius:22px 22px 0 0;padding:18px 18px calc(24px + env(safe-area-inset-bottom,0));max-height:88vh;max-height:88dvh;overflow-y:auto;overflow-x:hidden;transform:translateY(100%);transition:transform .38s cubic-bezier(.4,0,.2,1);-webkit-overflow-scrolling:touch;scrollbar-width:none}
#qmAiPopup .qm-ai-sheet::-webkit-scrollbar{display:none}
#qmAiPopup.open .qm-ai-sheet{transform:translateY(0)}
.qm-ai-panel{display:none} /* inline panel hidden — popup used instead */
.qm-ai-hdr{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--textMuted);margin-bottom:8px;display:flex;align-items:center;gap:5px}
.qm-ai-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
.qm-ai-chip{padding:6px 12px;border-radius:50px;border:1.5px solid rgba(124,106,247,.3);background:rgba(124,106,247,.07);font-size:11px;font-weight:700;cursor:pointer;color:var(--accent2);transition:all .2s;white-space:nowrap;font-family:'DM Sans',sans-serif}
.qm-ai-chip:active{transform:scale(.95);background:rgba(124,106,247,.2)}
.qm-ai-chip.loading{opacity:.5;pointer-events:none}
.qm-nq-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.qm-nq-chip{padding:6px 12px;border-radius:50px;border:1.5px solid rgba(245,200,66,.3);background:rgba(245,200,66,.06);font-size:11px;font-weight:700;cursor:pointer;color:var(--gold);transition:all .2s;white-space:nowrap;font-family:'DM Sans',sans-serif}
.qm-nq-chip:active{transform:scale(.95);background:rgba(245,200,66,.18)}
.qm-ai-response{background:var(--card);border-radius:10px;padding:12px 14px;font-size:12px;line-height:1.8;color:var(--text);margin-top:10px;border:1px solid var(--border);display:none}
.qm-ai-response.show{display:block}
.qm-ai-response b{color:var(--gold)}
.qm-ai-explain-row{display:flex;gap:8px;align-items:flex-start;padding:6px 0;border-bottom:1px solid var(--border)}
.qm-ai-explain-row:last-child{border-bottom:none}
.qm-ai-explain-badge{flex-shrink:0;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;margin-top:1px}
.qm-ai-explain-text{font-size:12px;line-height:1.65;flex:1}
.qm-ai-custom-row{display:flex;gap:6px;margin-top:10px}
.qm-ai-custom-inp{flex:1;background:var(--card2);border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;outline:none;transition:border-color .2s;-webkit-appearance:none}
.qm-ai-custom-inp:focus{border-color:var(--accent)}
.qm-ai-custom-inp::placeholder{color:var(--textMuted)}
.qm-ai-custom-btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 13px;font-weight:700;font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;white-space:nowrap;flex-shrink:0}
.qm-ai-new-q{background:var(--card2);border:2px dashed rgba(245,200,66,.4);border-radius:12px;padding:14px;margin-top:10px;display:none}
.qm-ai-new-q.show{display:block}
.qm-ai-new-q-text{font-size:14px;font-weight:600;line-height:1.55;color:var(--text);margin-bottom:12px}
.qm-ai-new-opts{display:flex;flex-direction:column;gap:7px}
.qm-ai-new-opt{width:100%;padding:10px 14px;background:var(--card);border:2px solid var(--border);border-radius:10px;cursor:pointer;font-size:13px;font-weight:500;text-align:left;font-family:'DM Sans',sans-serif;color:var(--text);transition:all .15s;display:flex;align-items:center;gap:10px}
.qm-ai-new-opt:not([disabled]):active{transform:scale(.98)}
.qm-ai-new-opt.nq-correct{border-color:var(--green)!important;background:rgba(52,211,153,.1)!important;color:var(--green)!important}
.qm-ai-new-opt.nq-wrong{border-color:var(--red)!important;background:rgba(248,113,113,.1)!important;color:var(--red)!important}
/* Ask AI button inside each option */
.qm-opt-ask{flex-shrink:0;padding:2px 8px;border-radius:50px;border:1.5px solid rgba(124,106,247,.4);background:rgba(124,106,247,.1);color:var(--accent2);font-size:10px;font-weight:800;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;white-space:nowrap;line-height:1.6}
.qm-opt-ask:hover{background:rgba(124,106,247,.25)}
.qm-opt-ask:active{transform:scale(.93)}

/* ── SCAN TAB ── */
#scanTab .btn-accent{background:linear-gradient(135deg,var(--accent),#5b4fcf);color:#fff}
#scanTab label .btn{display:flex;align-items:center;justify-content:center;font-size:13px}
</style>
</head>
<body>
<div id="app">

<!-- ===== HOME ===== -->
<div id="homeScreen" class="screen active">
  <div style="padding-bottom:16px">
  <div class="hero">
    <div class="hero-greeting" id="heroGreeting">Welcome back! 👋</div>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <div class="hero-title">VocabMaster Pro</div>
      <!-- Animated Theme Toggle -->
      <div class="theme-toggle-wrap" id="themeToggleBtn" onclick="toggleThemeDrawer(event)" title="Change Theme">
        <div class="theme-orb" id="themeOrb">🌙</div>
        <!-- Theme Drawer -->
        <div class="theme-drawer" id="themeDrawer">
          <div class="td-header">
            <span class="td-title">🎨 Choose Theme</span>
            <button class="td-close" onclick="toggleThemeDrawer(event)">✕</button>
          </div>

          <div class="td-grid" style="padding:12px 10px">
            <!-- Dark Gold -->
            <div class="theme-opt active" id="topt-dark" onclick="applyTheme('dark',this)">
              <div class="theme-swatch">
                <div class="ts-bg" style="background:#0c0c1e"></div>
                <div class="ts-bar" style="background:linear-gradient(90deg,#1a1a36,#131328)"></div>
                <div class="ts-dot" style="background:#f5c842"></div>
                <div class="ts-line1" style="background:#f4f3ff"></div>
                <div class="ts-line2" style="background:#a8a8d0"></div>
                <div class="ts-pill" style="background:linear-gradient(135deg,#f5c842,#d4960f)"></div>
              </div>
              <div class="theme-name">Dark Gold</div>
              <div class="theme-sub">Classic · Elegant</div>
            </div>
            <!-- Midnight Steel -->
            <div class="theme-opt" id="topt-midnight" onclick="applyTheme('midnight',this)">
              <div class="theme-swatch">
                <div class="ts-bg" style="background:#06090f"></div>
                <div class="ts-bar" style="background:linear-gradient(90deg,#101c30,#0c1220)"></div>
                <div class="ts-dot" style="background:#7ecfff"></div>
                <div class="ts-line1" style="background:#eaf5ff"></div>
                <div class="ts-line2" style="background:#7eaaca"></div>
                <div class="ts-pill" style="background:linear-gradient(135deg,#7ecfff,#2d8cff)"></div>
              </div>
              <div class="theme-name">Midnight Steel</div>
              <div class="theme-sub">Cool · Sleek</div>
            </div>
            <!-- Navy Intel -->
            <div class="theme-opt" id="topt-navypro" onclick="applyTheme('navypro',this)">
              <div class="theme-swatch">
                <div class="ts-bg" style="background:#080e1c"></div>
                <div class="ts-bar" style="background:linear-gradient(90deg,#0f1e34,#0d1528)"></div>
                <div class="ts-dot" style="background:#00d4f0"></div>
                <div class="ts-line1" style="background:#ffffff"></div>
                <div class="ts-line2" style="background:#7aa8cc"></div>
                <div class="ts-pill" style="background:linear-gradient(135deg,#ff8a00,#00d4f0)"></div>
              </div>
              <div class="theme-name">Navy Intel</div>
              <div class="theme-sub">Sharp · Pro</div>
            </div>
            <!-- Arctic Light -->
            <div class="theme-opt" id="topt-light" onclick="applyTheme('light',this)">
              <div class="theme-swatch">
                <div class="ts-bg" style="background:#eceff8"></div>
                <div class="ts-bar" style="background:linear-gradient(90deg,#ffffff,#e0e4f4)"></div>
                <div class="ts-dot" style="background:#4848e8"></div>
                <div class="ts-line1" style="background:#141430"></div>
                <div class="ts-line2" style="background:#7070a8"></div>
                <div class="ts-pill" style="background:linear-gradient(135deg,#6068f8,#3030c8)"></div>
              </div>
              <div class="theme-name">Arctic Light</div>
              <div class="theme-sub">Clean · Bright</div>
            </div>
            <!-- Pure White -->
            <div class="theme-opt" id="topt-white" onclick="applyTheme('white',this)">
              <div class="theme-swatch">
                <div class="ts-bg" style="background:#ffffff"></div>
                <div class="ts-bar" style="background:#f0f0f0"></div>
                <div class="ts-dot" style="background:#1565c0"></div>
                <div class="ts-line1" style="background:#212121"></div>
                <div class="ts-line2" style="background:#424242"></div>
                <div class="ts-pill" style="background:#3f51b5"></div>
              </div>
              <div class="theme-name">Pure White</div>
              <div class="theme-sub">Clean · Clear</div>
            </div>
            <!-- Clean Black -->
            <div class="theme-opt" id="topt-black" onclick="applyTheme('black',this)">
              <div class="theme-swatch">
                <div class="ts-bg" style="background:#000000"></div>
                <div class="ts-bar" style="background:#1a1a1a"></div>
                <div class="ts-dot" style="background:#ffc107"></div>
                <div class="ts-line1" style="background:#ffffff"></div>
                <div class="ts-line2" style="background:#e0e0e0"></div>
                <div class="ts-pill" style="background:#bb86fc"></div>
              </div>
              <div class="theme-name">Clean Black</div>
              <div class="theme-sub">Simple · Bold</div>
            </div>
            <!-- Soft Gray -->
            <div class="theme-opt" id="topt-gray" onclick="applyTheme('gray',this)">
              <div class="theme-swatch">
                <div class="ts-bg" style="background:#1e1e1e"></div>
                <div class="ts-bar" style="background:#383838"></div>
                <div class="ts-dot" style="background:#ffca28"></div>
                <div class="ts-line1" style="background:#f5f5f5"></div>
                <div class="ts-line2" style="background:#e0e0e0"></div>
                <div class="ts-pill" style="background:#9575cd"></div>
              </div>
              <div class="theme-name">Soft Gray</div>
              <div class="theme-sub">Easy · Calm</div>
            </div>
            <!-- Ocean Blue -->
            <div class="theme-opt" id="topt-blue" onclick="applyTheme('blue',this)">
              <div class="theme-swatch">
                <div class="ts-bg" style="background:#0d47a1"></div>
                <div class="ts-bar" style="background:#1976d2"></div>
                <div class="ts-dot" style="background:#ffeb3b"></div>
                <div class="ts-line1" style="background:#ffffff"></div>
                <div class="ts-line2" style="background:#e3f2fd"></div>
                <div class="ts-pill" style="background:#ce93d8"></div>
              </div>
              <div class="theme-name">Ocean Blue</div>
              <div class="theme-sub">Fresh · Bright</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- User row: name · sync · logout -->
    <div style="display:flex;align-items:center;gap:6px;margin-top:10px;flex-wrap:wrap">

      <!-- Profile chip (tap to open stats) -->
      <div id="heroUserBtn" onclick="vm_openProfile()" style="
        display:flex;align-items:center;gap:5px;
        background:rgba(124,106,247,.2);border:1.5px solid rgba(124,106,247,.45);
        border-radius:50px;padding:7px 13px;cursor:pointer;flex-shrink:0;
        -webkit-tap-highlight-color:transparent;min-height:36px">
        <span style="font-size:14px">👤</span>
        <span id="heroUserName" style="font-size:12px;font-weight:700;color:var(--accent2);
          max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">—</span>
      </div>

      <!-- My Words button - quick access to saved words -->
      <div id="heroMyWordsBtn" onclick="showScreen('wordsScreen', document.querySelector('.nb:nth-child(2)'))" style="
        display:flex;align-items:center;gap:5px;
        background:rgba(245,200,66,.15);border:1.5px solid rgba(245,200,66,.45);
        border-radius:50px;padding:7px 13px;cursor:pointer;flex-shrink:0;
        -webkit-tap-highlight-color:transparent;min-height:36px">
        <span style="font-size:14px">📚</span>
        <span id="heroWordCount" style="font-size:12px;font-weight:700;color:var(--gold);
          max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">0 Words</span>
      </div>

      <!-- Sync status (tap to sync) -->
      <div id="heroSyncRow" onclick="vm_pushToCloud()" style="
        display:flex;align-items:center;gap:4px;flex:1;min-width:0;
        background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25);
        border-radius:50px;padding:7px 11px;cursor:pointer;
        -webkit-tap-highlight-color:transparent;min-height:36px">
        <span id="heroSyncStatus" style="font-size:10px;color:var(--green);
          font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">🔄 Connecting…</span>
      </div>

      <!-- LOGOUT — big, red, clearly labelled -->
      <div onclick="vm_logout()" style="
        display:flex;align-items:center;gap:5px;
        background:rgba(248,113,113,.15);border:1.5px solid rgba(248,113,113,.45);
        border-radius:50px;padding:7px 13px;cursor:pointer;flex-shrink:0;
        -webkit-tap-highlight-color:transparent;min-height:36px;
        color:var(--red);font-size:12px;font-weight:700;user-select:none">
        🚪 Logout
      </div>

    </div>

    <div class="chips-row" style="margin-top:8px">
      <div class="chip chip-gold">🔥 <span id="streakNum">0</span> day streak</div>
      <div class="chip chip-accent" id="offlineBadge" style="display:none">📵 Offline</div>
    </div>

    <!-- AI Engine Toggle -->
    <div style="display:flex;align-items:center;gap:6px;margin-top:8px">
      <span style="font-size:10px;font-weight:700;color:var(--textMuted);text-transform:uppercase;letter-spacing:.6px;flex-shrink:0">🤖 AI:</span>
      <div style="display:flex;gap:4px;flex:1;flex-wrap:wrap">
        <button class="ai-engine-btn ai-btn-active" data-engine="worker"
          onclick="setAIEngine('worker')"
          style="flex:1;min-width:60px;padding:5px 6px;border-radius:50px;border:1.5px solid var(--border);background:var(--card2);font-size:9px;font-weight:700;color:var(--textSub);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif">
          ⚡ Default
        </button>
        <button class="ai-engine-btn" data-engine="groq"
          onclick="setAIEngine('groq')"
          style="flex:1;min-width:60px;padding:5px 6px;border-radius:50px;border:1.5px solid var(--border);background:var(--card2);font-size:9px;font-weight:700;color:var(--textSub);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif">
          🚀 Llama 3.1
        </button>
        <button class="ai-engine-btn" data-engine="groq3"
          onclick="setAIEngine('groq3')"
          style="flex:1;min-width:60px;padding:5px 6px;border-radius:50px;border:1.5px solid var(--border);background:var(--card2);font-size:9px;font-weight:700;color:var(--textSub);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif">
          🦙 Llama 4
        </button>
        <button class="ai-engine-btn" data-engine="gemini"
          onclick="setAIEngine('gemini')"
          style="flex:1;min-width:60px;padding:5px 6px;border-radius:50px;border:1.5px solid var(--border);background:var(--card2);font-size:9px;font-weight:700;color:var(--textSub);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif">
          ✨ Gemini
        </button>
        <button class="ai-engine-btn" data-engine="groq2"
          onclick="setAIEngine('groq2')"
          style="flex:1;min-width:60px;padding:5px 6px;border-radius:50px;border:1.5px solid var(--border);background:var(--card2);font-size:9px;font-weight:700;color:var(--textSub);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif">
          🧠 GPT-OSS
        </button>
        <button class="ai-engine-btn" data-engine="qwen"
          onclick="setAIEngine('qwen')"
          style="flex:1;min-width:60px;padding:5px 6px;border-radius:50px;border:1.5px solid var(--border);background:var(--card2);font-size:9px;font-weight:700;color:var(--textSub);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif">
          🐉 Qwen3
        </button>
        <button class="ai-engine-btn" data-engine="kimi"
          onclick="setAIEngine('kimi')"
          style="flex:1;min-width:60px;padding:5px 6px;border-radius:50px;border:1.5px solid var(--border);background:var(--card2);font-size:9px;font-weight:700;color:var(--textSub);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif">
          🌙 Kimi K2
        </button>
      </div>
      <button onclick="showAIHealthCheck()" title="Test all AI engines" style="flex-shrink:0;width:30px;height:30px;border-radius:50%;border:1.5px solid var(--border);background:var(--card2);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s" id="aiHealthBtn">🔍</button>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat"><div class="stat-n" id="totalW" style="color:var(--gold)">0</div><div class="stat-l">Words</div></div>
    <div class="stat"><div class="stat-n" id="strongW" style="color:var(--green)">0</div><div class="stat-l">Mastered</div></div>
    <div class="stat"><div class="stat-n" id="dueW" style="color:var(--red)">0</div><div class="stat-l">Due</div></div>
  </div>

  <!-- ===== MY VOCABULARY SECTION ===== -->
  <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 12px 6px">
    <div class="stitle" style="padding:0;margin:0">📚 My Vocabulary</div>
    <button class="btn btn-ghost btn-sm" onclick="showScreen('wordsScreen',document.querySelector('.nb:nth-child(2)'))" style="font-size:11px;padding:5px 12px;border-radius:50px">View All →</button>
  </div>
  <div id="homeVocabSection" style="margin:0 12px 8px;display:flex;flex-direction:column;gap:6px"></div>

  <div class="stitle">📈 Daily Goal</div>
  <div class="card daily-card">
    <div class="daily-hdr">
      <span>Words Reviewed Today</span>
      <span style="color:var(--gold)"><span id="dailyRev">0</span>/<span id="dailyGoalDisplay">10</span></span>
    </div>
    <div class="pbar"><div class="pfill" id="dailyFill" style="width:0%"></div></div>
  </div>

  <!-- ===== MEMORY SCIENCE ===== -->
  <div class="stitle">🧠 Memory Science</div>


  <!-- Due Today Banner -->
  <div class="due-banner" id="dueBanner" onclick="startDueReview()" style="display:none">
    <div class="due-left">
      <div class="due-n" id="dueCount">0</div>
      <div class="due-info">
        <div class="due-title">Words Due Today</div>
        <div class="due-sub">Based on spaced repetition</div>
      </div>
    </div>
    <button class="btn btn-gold btn-sm" style="pointer-events:none">Review Now &#8594;</button>
  </div>
  <div id="dueClear" style="margin:0 12px 8px;padding:10px 14px;background:rgba(52,211,153,.07);border:1px solid rgba(52,211,153,.2);border-radius:var(--rsm);display:none;align-items:center;gap:10px">
    <span style="font-size:20px">&#10003;</span>
    <div><div style="font-size:13px;font-weight:700;color:var(--green)">All caught up!</div><div style="font-size:11px;color:var(--textMuted)">No words due today</div></div>
  </div>
  <!-- Memory Strength Meter -->
  <div class="mm-wrap">
    <div class="mm-title">
      <span>📊 Memory Strength</span>
      <span id="mmPct" style="font-size:11px;color:var(--textSub);font-weight:600">—</span>
    </div>
    <div class="mm-bar">
      <div class="mm-seg" id="mmHard" style="background:var(--red)"></div>
      <div class="mm-seg" id="mmMed" style="background:var(--orange)"></div>
      <div class="mm-seg" id="mmEasy" style="background:var(--green)"></div>
    </div>
    <div class="mm-legend">
      <span style="color:var(--red)">😓 Hard</span>
      <span style="color:var(--orange)">🤔 Medium</span>
      <span style="color:var(--green)">😊 Easy/Mastered</span>
    </div>
  </div>

  <!-- SR Stats Grid -->
  <div class="ms-grid">
    <div class="ms-box bh" onclick="startSRFilter('hard')">
      <div class="ms-n" style="color:var(--red)" id="srHardN">0</div>
      <div class="ms-l" style="color:var(--red)">😓 Hard</div>
      <div class="ms-s">Review daily</div>
    </div>
    <div class="ms-box bm" onclick="startSRFilter('medium')">
      <div class="ms-n" style="color:var(--orange)" id="srMedN">0</div>
      <div class="ms-l" style="color:var(--orange)">🤔 Medium</div>
      <div class="ms-s">Every 3 days</div>
    </div>
    <div class="ms-box be" onclick="startSRFilter('easy')">
      <div class="ms-n" style="color:var(--green)" id="srEasyN">0</div>
      <div class="ms-l" style="color:var(--green)">😊 Mastered</div>
      <div class="ms-s">Every 7 days</div>
    </div>
  </div>

  <div style="margin:8px 12px 0;padding:8px 10px;background:var(--card);border-radius:8px;border:1px solid var(--border);font-size:10px;color:var(--textMuted);line-height:1.7">
    🧠 <b style="color:var(--text)">Spaced Repetition:</b> Mark <span style="color:var(--red)">Hard</span> → shows tomorrow ·
    <span style="color:var(--orange)">Medium</span> → 3 days ·
    <span style="color:var(--green)">Easy</span> → 7 days. Tap a box to study that group.
  </div>

  <div class="stitle">⚡ Study Modes</div>
  <div class="mgrid">
    <div class="mcard" dc="gold" onclick="startMode('flip')"><div class="mi">🃏</div><div class="mn">Flash Cards</div><div class="md">Tap to flip</div></div>
    <div class="mcard" dc="red" onclick="startMode('timed')"><div class="mi">⏱️</div><div class="mn">Timed Quiz</div><div class="md">Beat the clock</div></div>
    <div class="mcard" dc="pink" onclick="startMode('rapid')"><div class="mi">🚀</div><div class="mn">Rapid Fire</div><div class="md">10 in 60 sec</div></div>
    <div class="mcard" dc="accent" onclick="showReviewOnly()"><div class="mi">🔁</div><div class="mn">Review Weak</div><div class="md">Mistakes only</div></div>
    <div class="mcard" dc="green" onclick="showStoryMode()"><div class="mi">📖</div><div class="mn">Mini Story</div><div class="md">AI creates story</div></div>
    <div class="mcard" dc="blue" onclick="showSentenceBuilder()"><div class="mi">🧩</div><div class="mn">Sentence Builder</div><div class="md">Arrange words</div></div>
    <div class="mcard" dc="gold" onclick="startTypeMode()"><div class="mi">✍️</div><div class="mn">Type the Word</div><div class="md">Active recall</div></div>
    <div class="mcard" dc="blue" onclick="showRootsMode()"><div class="mi">🔤</div><div class="mn">Word Roots</div><div class="md">Learn root meanings</div></div>
    <div class="mcard" dc="red" onclick="showConfusablesMode()"><div class="mi">⚠️</div><div class="mn">Confusables</div><div class="md">Don't mix these up</div></div>
  </div>

  <!-- Exam Quiz -->
  <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 12px 6px">
    <div class="stitle" style="padding:0;margin:0">&#127919; Exam Quiz</div>
    <div id="quizMatchBadge" style="font-size:11px;font-weight:700;padding:4px 10px;border-radius:50px;background:var(--card);border:1px solid var(--border);color:var(--textMuted)">0 words</div>
  </div>

  <div style="margin:0 12px 8px;background:var(--card);border-radius:var(--r);border:1px solid var(--border);overflow:hidden">
    <div style="padding:8px 10px 4px">
      <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--textMuted);margin-bottom:5px">&#128203; Exam</div>
      <div class="exam-row" id="examRow" style="padding:0">
        <!-- dynamic exam pills injected by rebuildExamPills() -->
      </div>
    </div>
    <div style="height:1px;background:var(--border);margin:0 10px"></div>
    <div style="padding:8px 10px 4px">
      <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--textMuted);margin-bottom:5px">&#128194; Category</div>
      <div class="cat-row" id="catRow" style="padding:0">
        <div class="cat-pill active" onclick="selectCat('all',this)">All Types</div>
        <div class="cat-pill" onclick="selectCat('Synonyms',this)">Synonyms</div>
        <div class="cat-pill" onclick="selectCat('Antonyms',this)">Antonyms</div>
        <div class="cat-pill" onclick="selectCat('Idioms &amp; Phrases',this)">Idioms &amp; Phrases</div>
        <div class="cat-pill" onclick="selectCat('One Word Substitution',this)">One Word Sub.</div>
        <div class="cat-pill" onclick="selectCat('Homonyms',this)">Homonyms</div>
      </div>
    </div>
    <div style="height:1px;background:var(--border);margin:0 10px"></div>
    <div style="padding:8px 10px 8px">
      <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--textMuted);margin-bottom:5px">&#128197; Year</div>
      <div class="year-row" id="yearRow" style="padding:0">
        <div class="year-pill active" onclick="selectYear('all',this)">All Years</div>
        <!-- dynamic year pills injected by rebuildYearPills() -->
      </div>
    </div>
  </div>

  <div style="padding:0 12px 12px">
    <button class="btn btn-gold" id="quizStartBtn" style="width:100%;padding:13px;font-size:14px" onclick="loadExamQuiz()">&#127919; Start Quiz</button>
    <div id="quizBankHint" style="font-size:10px;color:var(--textMuted);text-align:center;margin-top:6px"></div>
  </div>

  </div><!-- end inner wrapper -->
</div>

<!-- ===== WORDS ===== -->
<div id="wordsScreen" class="screen">

  <!-- Sticky Header + Filters — COMPACT COLLAPSIBLE -->
  <div class="wfilter-wrap" id="wfilterWrap">

    <!-- ── Row 1: Title + Actions ── -->
    <div style="padding:10px 12px 6px;display:flex;align-items:center;gap:8px">
      <div style="flex:1;min-width:0">
        <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;line-height:1.1">My Words</div>
        <div style="font-size:11px;color:var(--textSub);margin-top:1px" id="wcLabel">0 words</div>
      </div>
      <div style="display:flex;gap:5px;align-items:center;flex-shrink:0">
        <div class="view-toggle">
          <button class="vtb" id="vtCard" onclick="setWordsView('card')" title="Card view">⊞</button>
          <button class="vtb" id="vtList" onclick="setWordsView('list')" title="List view">☰</button>
        </div>
        <button class="btn btn-gold btn-sm" onclick="openAddFromFilter()" id="wAddBtn" style="white-space:nowrap;padding:7px 12px">➕ Add</button>
      </div>
    </div>

    <!-- ── Row 2: Search + Filter toggle + Sort ── -->
    <div style="display:flex;gap:6px;padding:0 12px 8px;align-items:center">
      <div style="position:relative;flex:1">
        <input class="inp" id="searchInp" placeholder="🔍 Search words..." oninput="renderWords()"
          style="font-size:12px;padding:9px 12px 9px 32px;height:36px">
        <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none">🔍</span>
      </div>
      <!-- Filter toggle button — shows active filter summary -->
      <button id="filterToggleBtn" onclick="toggleFilters()"
        style="flex-shrink:0;display:flex;align-items:center;gap:4px;padding:8px 10px;border-radius:10px;border:1.5px solid var(--border);background:var(--card2);cursor:pointer;font-size:11px;font-weight:700;color:var(--textSub);white-space:nowrap;transition:all .2s"
        title="Toggle filters">
        <span id="filterIcon">⚙️</span>
        <span id="filterSummary">Filter</span>
      </button>
      <select id="wSortSel" class="inp" onchange="setWSort(this.value)"
        style="width:auto;padding:5px 26px 5px 8px;font-size:11px;height:36px;border-radius:10px;font-weight:600;flex-shrink:0">
        <option value="newest">🕐 Newest</option>
        <option value="oldest">📅 Oldest</option>
        <option value="az">A→Z</option>
        <option value="za">Z→A</option>
        <option value="weak">Weakest</option>
        <option value="strong">Strongest</option>
        <option value="due">Due First</option>
      </select>
    </div>

    <!-- ── Collapsible Filter Panel ── -->
    <div id="wFilterPanel" style="display:none;border-top:1px solid var(--border)">

      <!-- Exam -->
      <div class="wf-lbl" style="padding-top:8px">🎯 Exam</div>
      <div class="wfrow" id="wExamRow">
        <div class="wfpill active-exam" onclick="setWExam('all',this)">📚 All</div>
        <!-- dynamic exam pills injected by rebuildExamPills() -->
      </div>

      <!-- Year (shows when exam selected) -->
      <div id="wYearBlock" style="display:none">
        <div class="wf-lbl">📅 Year</div>
        <div class="wfrow" id="wYearRow">
          <div class="wfpill active-year" onclick="setWYear('all',this)">All Years</div>
          <!-- dynamic year pills injected by rebuildYearPills() -->
        </div>
      </div>

      <!-- Memory -->
      <div class="wf-lbl">🧠 Memory</div>
      <div class="wfrow" id="wMemRow">
        <div class="wfpill" style="background:rgba(52,211,153,.12);border-color:rgba(52,211,153,.3);color:var(--green)" id="memPillAll" onclick="setWMem('all',this)">📚 All</div>
        <div class="wfpill" id="memPillYes" onclick="setWMem('remembered',this)">✅ Remembered</div>
        <div class="wfpill" id="memPillNo" onclick="setWMem('not_remembered',this)">❌ Not Remembered</div>
      </div>

      <!-- Type (shows when exam selected) -->
      <div id="wTypeBlock" style="display:none">
        <div class="wf-lbl">📂 Type</div>
        <div class="wfrow" id="wTypeRow">
          <div class="wfpill active-type" onclick="setWType('all',this)">All Types</div>
          <div class="wfpill" onclick="setWType('Synonyms',this)">Synonyms</div>
          <div class="wfpill" onclick="setWType('Antonyms',this)">Antonyms</div>
          <div class="wfpill" onclick="setWType('Idioms & Phrases',this)">Idioms & Phrases</div>
          <div class="wfpill" onclick="setWType('One Word Substitution',this)">One Word Sub.</div>
          <div class="wfpill" onclick="setWType('Homonyms',this)">Homonyms</div>
        </div>
      </div>

      <!-- Action row inside panel -->
      <div style="display:flex;gap:6px;padding:6px 12px 10px">
        <button class="btn btn-ghost btn-sm" onclick="openM('importModal')" style="flex:1">⬆️ Import</button>
        <button class="btn btn-accent btn-sm" onclick="vm_openShare()" style="flex:1">🔗 Share</button>
      </div>
    </div>

  </div><!-- end wfilter-wrap -->

  <!-- Word list -->
  <div id="wordsList" style="padding-top:8px;padding-bottom:16px"></div>
</div>

<!-- ===== CARD SCREEN ===== -->
<div id="cardScreen" class="screen">
  <div class="cmode-bar">
    <button class="btn btn-ghost btn-sm" onclick="exitCard()">← Back</button>
    <div class="cmode-lbl" id="cmodeLbl">Flash Cards</div>
    <div class="ccounter" id="ccounter">1/1</div>
  </div>
  <div class="cprog"><div class="pbar"><div class="pfill" id="cprogFill" style="width:0%"></div></div></div>

  <!-- Exam Filter Bar -->
  <div class="cef-bar">
    <div class="cef-scroll" id="cardExamRow">
      <div class="cef-pill ce-active" onclick="setCardExam('all',this)">📚 All</div>
      <div class="cef-pill ce-due" onclick="setCardExam('due',this)">📅 Due Today</div>
      <!-- dynamic exam pills injected by rebuildExamPills() -->
    </div>
    <!-- Year sub-filter (shown when exam selected) -->
    <div id="cardYearBlock" style="display:none;border-top:1px solid var(--border);padding-top:4px;margin-top:2px">
      <div style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--textMuted);padding:2px 4px 3px">📅 Year</div>
      <div class="cef-scroll" id="cardYearRow">
        <div class="cef-pill ce-active" onclick="setCardYear('all',this)">All Years</div>
      </div>
    </div>
    <!-- Type sub-filter (shown when exam selected) -->
    <div id="cardTypeBlock" style="display:none;border-top:1px solid var(--border);padding-top:4px;margin-top:2px">
      <div style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--textMuted);padding:2px 4px 3px">📂 Type</div>
      <div class="cef-scroll" id="cardTypeRow">
        <div class="cef-pill ce-active" onclick="setCardType2('all',this)">All Types</div>
        <div class="cef-pill" onclick="setCardType2('Synonyms',this)">Synonyms</div>
        <div class="cef-pill" onclick="setCardType2('Antonyms',this)">Antonyms</div>
        <div class="cef-pill" onclick="setCardType2('Idioms & Phrases',this)">Idioms & Phrases</div>
        <div class="cef-pill" onclick="setCardType2('One Word Substitution',this)">One Word Sub.</div>
        <div class="cef-pill" onclick="setCardType2('Homonyms',this)">Homonyms</div>
      </div>
    </div>
  </div>

  <div class="fc-area" id="fcArea">
    <div class="fc-wrapper" id="fcWrapper">
      <!-- Progress bar -->
      <div class="fc-progress"><div class="fc-progress-bar" id="fcProgressBar" style="width:0%"></div></div>
      <div class="fc" id="fc">
        <!-- FRONT -->
        <div class="cf cf-front" id="cfFront">
          <div class="cimg-zone" id="cimgZone"><div class="cimg-ph">📚</div></div>
          <!-- Image top buttons overlay -->
          <div class="card-top-btns">
            <button class="ctbtn" onclick="retryImg(event)" title="New image">🖼️</button>
            <button class="ctbtn" onclick="retryAI(event)" title="Refresh AI data">🤖</button>
          </div>
          <div class="cf-body" style="padding:5px 10px 2px">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:6px;margin-bottom:2px">
              <div style="min-width:0;flex:1">
                <div class="cword" id="cWord" style="font-size:20px">Word</div>
                <div class="chindi" id="cHindi"></div>
                <div class="chindi-roman" id="cHindiRoman"></div>
                <div style="display:flex;align-items:center;gap:6px;margin-top:3px;flex-wrap:wrap">
                  <button class="speak-btn" id="speakBtn" onclick="speakWord(event)" style="padding:3px 9px;font-size:11px">🔊 Pronounce</button>
                  <button class="speak-btn" id="askAiBtn" onclick="openAskAI(event)" style="padding:3px 9px;font-size:11px;background:rgba(124,106,247,.15);border-color:rgba(124,106,247,.4);color:var(--accent2)">✨ Ask AI</button>
                </div>
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0">
                <span class="badge b-noun" id="cBadge">noun</span>
                <div id="cStrBadge"></div>
              </div>
            </div>
            <div id="cExamMeta" style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:3px"></div>
          </div>
          <!-- QUIZ ZONE on front -->
          <div class="cq-wrap" id="cQuizWrap">
            <div id="cQuizInner"><div class="cq-loading"><div class="spin" style="width:16px;height:16px;border-width:2px"></div> Loading...</div></div>
          </div>
          <div style="padding:1px 10px 3px;flex-shrink:0">
            <div class="cflip-hint" id="cFlipHint">👆 Tap card to see full answer</div>
          </div>
          <div class="swing-l">✗ HARD</div>
          <div class="swing-r">✓ EASY</div>
        </div>
        <!-- BACK (scrollable!) -->
        <div class="cf cf-back" id="cfBack">
          <div class="cb-body">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:6px;flex-wrap:wrap">
              <div>
                <div class="cb-word" id="cWordBack">Word</div>
                <div class="cb-hindi" id="cHindiBack"></div>
                <div class="cb-hindi-roman" id="cHindiRomanBack"></div>
              </div>
              <div id="cStrBadgeBack"></div>
            </div>
            <div>
              <div class="lbl">Definition</div>
              <div class="def-text" id="cDef">—</div>
            </div>
            <div>
              <div class="lbl">Example</div>
              <div class="ex-text" id="cEx"></div>
            </div>
            <div id="cMnemWrap" style="display:none">
              <div class="lbl" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
                <span>🧠 Mnemonic Maker</span>
                <button class="btn btn-ghost btn-sm" id="cMnemRefreshBtn" onclick="refreshMnemonic()" style="font-size:11px;padding:4px 12px;border-radius:50px">🎲 New</button>
              </div>
              <!-- Style chips -->
              <div class="mnem-styles-row" id="cMnemStyles">
                <div class="mnem-style-chip active" data-style="bollywood" onclick="selectMnemStyle(this,'bollywood')">🎬 Bollywood</div>
                <div class="mnem-style-chip" data-style="cricket" onclick="selectMnemStyle(this,'cricket')">🏏 Cricket</div>
                <div class="mnem-style-chip" data-style="rhyme" onclick="selectMnemStyle(this,'rhyme')">🎵 Rhyme</div>
                <div class="mnem-style-chip" data-style="desi" onclick="selectMnemStyle(this,'desi')">☕ Desi</div>
                <div class="mnem-style-chip" data-style="meme" onclick="selectMnemStyle(this,'meme')">😂 Meme</div>
                <div class="mnem-style-chip" data-style="story" onclick="selectMnemStyle(this,'story')">📖 Story</div>
              </div>
              <div id="cMnemImgWrap" style="margin-bottom:8px;border-radius:10px;overflow:hidden;background:var(--card2);min-height:80px;display:flex;align-items:center;justify-content:center">
                <div id="cMnemImgInner" style="width:100%;text-align:center"><span style="font-size:24px;opacity:.3">🖼️</span></div>
              </div>
              <div class="mnem" id="cMnem"></div>
              <div id="cMnemLoading" style="display:none;text-align:center;padding:10px 0">
                <div class="spin" style="width:20px;height:20px;border-width:2px;margin:0 auto 6px"></div>
                <div style="font-size:11px;color:var(--textSub)">Cooking up a fun trick… 🍳</div>
              </div>
              <!-- Previous mnemonics history -->
              <div id="cMnemHistoryWrap" style="display:none;margin-top:8px">
                <div style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.7px;color:var(--textMuted);margin-bottom:4px">📜 Previous Tricks (tap to restore)</div>
                <div class="mnem-history-wrap" id="cMnemHistory"></div>
              </div>
            </div>
            <div>
              <div class="lbl">Synonyms</div>
              <div class="tags-row" id="cSyn"></div>
            </div>
            <div>
              <div class="lbl">Antonyms</div>
              <div class="tags-row" id="cAnt"></div>
            </div>

            <!-- ── WORD ROOTS ── -->
            <div id="cRootsWrap" style="display:none">
              <div class="lbl">🔤 Word Roots</div>
              <div class="roots-row" id="cRoots"></div>
            </div>

            <!-- ── WORD FAMILY ── -->
            <div id="cFamWrap" style="display:none">
              <div class="lbl">👨‍👩‍👧 Word Family</div>
              <div class="wfam-row" id="cFam"></div>
            </div>

            <!-- ── 3 SENTENCES ── -->
            <div id="cSentsWrap" style="display:none">
              <div class="lbl">📝 In Sentences</div>
              <div class="sent-list" id="cSents"></div>
            </div>

            <!-- ── CONFUSABLES ── -->
            <div id="cConfWrap" style="display:none">
              <div class="lbl" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
                <span>⚠️ Confusion Alerts</span>
                <button class="btn btn-ghost btn-sm" id="cConfGenBtn" onclick="generateConfusables()" style="font-size:10px;padding:3px 9px;border-radius:50px">✨ More</button>
              </div>
              <div class="conf-list" id="cConf"></div>
              <div id="cConfLoading" style="display:none;text-align:center;padding:8px 0">
                <div class="spin" style="width:16px;height:16px;border-width:2px;margin:0 auto 4px"></div>
                <div style="font-size:10px;color:var(--textSub)">Finding confusion traps…</div>
              </div>
            </div>

            <!-- ── TYPE THE WORD ── -->
            <div class="type-zone">
              <div class="lbl">✍️ Type the Word</div>
              <div class="type-prompt" id="typePrompt"></div>
              <div class="type-inp-row">
                <input class="type-inp" id="typeInp" placeholder="Type the word..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" onkeydown="if(event.key==='Enter')checkTyped()">
                <button class="type-submit" onclick="checkTyped()">✓</button>
              </div>
              <div class="type-result" id="typeResult"></div>
            </div>

            <!-- ── SM-2 STATS PANEL ── -->
            <div id="sm2Panel" class="sm2-panel" style="display:none">
              <div class="sm2-stat">
                <div class="sm2-lbl">📅 Next Review</div>
                <div class="sm2-val" id="sm2NextReview">—</div>
              </div>
              <div class="sm2-stat">
                <div class="sm2-lbl">📈 Interval</div>
                <div class="sm2-val" id="sm2Interval">—</div>
              </div>
              <div class="sm2-stat">
                <div class="sm2-lbl">🧠 Ease Factor</div>
                <div class="sm2-val" id="sm2EF">—</div>
              </div>
              <div class="sm2-stat">
                <div class="sm2-lbl">🔁 Repetitions</div>
                <div class="sm2-val" id="sm2Reps">—</div>
              </div>
              <div class="sm2-bar-wrap">
                <div class="sm2-bar-fill" id="sm2EFBar" style="width:50%"></div>
              </div>
            </div>
            <div id="cCardMeta" style="display:flex;flex-wrap:wrap;gap:4px;padding-top:2px"></div>
            <div style="height:12px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rating Buttons - shown after flip -->
  <div class="rrow" id="rrow" style="display:none">
    <button class="rbtn hard" onclick="rateCard('hard')">
      <span class="rbtn-icon">😓</span>
      <span class="rbtn-lbl">Hard</span>
      <span class="rbtn-next" id="rbtnHardNext">Tomorrow</span>
    </button>
    <button class="rbtn med" onclick="rateCard('medium')">
      <span class="rbtn-icon">🤔</span>
      <span class="rbtn-lbl">Medium</span>
      <span class="rbtn-next" id="rbtnMedNext">In 3 days</span>
    </button>
    <button class="rbtn easy" onclick="rateCard('easy')">
      <span class="rbtn-icon">😊</span>
      <span class="rbtn-lbl">Easy</span>
      <span class="rbtn-next" id="rbtnEasyNext">In 7 days</span>
    </button>
  </div>
  <div class="cnav">
    <button class="cnbtn" onclick="prevCard()">◀</button>
    <button class="cnbtn" style="color:var(--gold)" onclick="flipCard()">🔄</button>
    <button class="cnbtn" onclick="nextCard()">▶</button>
  </div>
</div>

<!-- ===== PRACTICE ===== -->
<div id="practiceScreen" class="screen">
  <div class="ph">
    <button class="pbk" onclick="exitPractice()">←</button>
    <div><div class="ptitle" id="ptitle">Quiz</div><div style="font-size:12px;color:var(--textSub)" id="psub">Question 1</div></div>
  </div>
  <div class="tbar-wrap" id="tbarWrap" style="display:none"><div class="tbar" id="tbar" style="width:100%"></div></div>
  <div class="pq" id="pContent"></div>
</div>

<!-- ===== PROGRESS ===== -->
<div id="progressScreen" class="screen">
  <div style="padding:14px 12px 0;flex-shrink:0">
    <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:700">📊 Progress</div>
    <div style="font-size:12px;color:var(--textSub)">Your learning analytics</div>
  </div>

  <!-- PROGRESS TABS -->
  <div style="display:flex;gap:6px;padding:12px 12px 0;flex-shrink:0">
    <button id="ptab-stats" onclick="switchProgTab('stats')" class="btn btn-gold btn-sm" style="flex:1;justify-content:center;border-radius:10px">📈 Stats</button>
    <button id="ptab-sr"    onclick="switchProgTab('sr')"    class="btn btn-ghost btn-sm" style="flex:1;justify-content:center;border-radius:10px">🧠 SR Engine</button>
    <button id="ptab-quiz"  onclick="switchProgTab('quiz')"  class="btn btn-ghost btn-sm" style="flex:1;justify-content:center;border-radius:10px">🎯 Quiz Log</button>
  </div>

  <!-- TAB: STATS -->
  <div id="ptab-stats-content" class="prog-cards" style="margin-top:10px;padding:0 12px">
    <div class="lvl-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div class="lvl-name">📊 Overview</div>
        <div id="offlineStatusBadge" style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:50px;background:var(--card2);border:1px solid var(--border)">🟢 Online</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="background:var(--card2);border-radius:10px;padding:12px;text-align:center">
          <div style="font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--gold)" id="pTotalWords">0</div>
          <div style="font-size:10px;color:var(--textSub);margin-top:2px;text-transform:uppercase;letter-spacing:.5px">Total Words</div>
        </div>
        <div style="background:var(--card2);border-radius:10px;padding:12px;text-align:center">
          <div style="font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--green)" id="pMastered">0</div>
          <div style="font-size:10px;color:var(--textSub);margin-top:2px;text-transform:uppercase;letter-spacing:.5px">Mastered</div>
        </div>
        <div style="background:var(--card2);border-radius:10px;padding:12px;text-align:center">
          <div style="font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--orange)" id="pStreak">0</div>
          <div style="font-size:10px;color:var(--textSub);margin-top:2px;text-transform:uppercase;letter-spacing:.5px">Day Streak</div>
        </div>
        <div style="background:var(--card2);border-radius:10px;padding:12px;text-align:center">
          <div style="font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--blue)" id="pDueToday">0</div>
          <div style="font-size:10px;color:var(--textSub);margin-top:2px;text-transform:uppercase;letter-spacing:.5px">Due Today</div>
        </div>
      </div>
    </div>

    <div class="graph-card">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px">🧱 Memory Strength</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="str-row"><div class="str-lbl" style="color:var(--green)">Strong</div><div style="flex:1"><div class="pbar"><div class="pfill" id="strBar" style="width:0%;background:var(--green)"></div></div></div><div class="str-ct" id="strCt" style="color:var(--green)">0</div></div>
        <div class="str-row"><div class="str-lbl" style="color:var(--orange)">Medium</div><div style="flex:1"><div class="pbar"><div class="pfill" id="medBar" style="width:0%;background:var(--orange)"></div></div></div><div class="str-ct" id="medCt" style="color:var(--orange)">0</div></div>
        <div class="str-row"><div class="str-lbl" style="color:var(--red)">Weak</div><div style="flex:1"><div class="pbar"><div class="pfill" id="wkBar" style="width:0%;background:var(--red)"></div></div></div><div class="str-ct" id="wkCt" style="color:var(--red)">0</div></div>
      </div>
    </div>

    <div class="graph-card"><div style="font-size:13px;font-weight:700;margin-bottom:12px">📅 7-Day Activity</div><div class="bar-graph" id="actGraph"></div></div>
    <div><div class="stitle" style="padding-left:0;padding-top:4px">🏆 Achievements</div><div class="ach-grid" id="achGrid"></div></div>
  </div>

  <!-- TAB: SM-2 SPACED REPETITION ENGINE -->
  <div id="ptab-sr-content" class="prog-cards" style="display:none;margin-top:10px;padding:0 12px">

    <!-- SM-2 explainer banner -->
    <div style="background:linear-gradient(135deg,rgba(124,106,247,.12),rgba(96,165,250,.08));border:1px solid rgba(124,106,247,.3);border-radius:14px;padding:14px 14px 12px">
      <div style="font-size:13px;font-weight:700;color:var(--accent2);margin-bottom:6px">🧠 SM-2 Algorithm Active</div>
      <div style="font-size:11px;color:var(--textSub);line-height:1.6">Your reviews use the <b style="color:var(--text)">SuperMemo SM-2</b> algorithm — same as Anki. Each word has its own <b style="color:var(--text)">Ease Factor</b> (EF) and <b style="color:var(--text)">interval</b> that adapt to how well you know it.</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:10px">
        <div style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.25);border-radius:8px;padding:8px;text-align:center">
          <div style="font-size:16px">😓</div>
          <div style="font-size:10px;font-weight:700;color:var(--red);margin-top:2px">HARD</div>
          <div style="font-size:9px;color:var(--textMuted);margin-top:2px">EF −0.2<br>Reset to day 1</div>
        </div>
        <div style="background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.25);border-radius:8px;padding:8px;text-align:center">
          <div style="font-size:16px">🤔</div>
          <div style="font-size:10px;font-weight:700;color:var(--orange);margin-top:2px">MEDIUM</div>
          <div style="font-size:9px;color:var(--textMuted);margin-top:2px">EF −0.14<br>Small boost</div>
        </div>
        <div style="background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.25);border-radius:8px;padding:8px;text-align:center">
          <div style="font-size:16px">✅</div>
          <div style="font-size:10px;font-weight:700;color:var(--green);margin-top:2px">EASY</div>
          <div style="font-size:9px;color:var(--textMuted);margin-top:2px">EF +0.1<br>Max boost</div>
        </div>
      </div>
    </div>

    <!-- Per-word SR stats -->
    <div class="graph-card" style="margin-top:10px">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">📋 Word Review Stats</div>
      <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
        <div onclick="renderSRList('all')" id="srf-all" style="padding:4px 12px;border-radius:50px;background:rgba(245,200,66,.15);border:1.5px solid var(--gold);color:var(--gold);font-size:11px;font-weight:700;cursor:pointer">All</div>
        <div onclick="renderSRList('due')" id="srf-due" style="padding:4px 12px;border-radius:50px;background:var(--card2);border:1.5px solid var(--border);color:var(--textSub);font-size:11px;font-weight:700;cursor:pointer">Due Now</div>
        <div onclick="renderSRList('hard')" id="srf-hard" style="padding:4px 12px;border-radius:50px;background:var(--card2);border:1.5px solid var(--border);color:var(--textSub);font-size:11px;font-weight:700;cursor:pointer">Struggling</div>
        <div onclick="renderSRList('easy')" id="srf-easy" style="padding:4px 12px;border-radius:50px;background:var(--card2);border:1.5px solid var(--border);color:var(--textSub);font-size:11px;font-weight:700;cursor:pointer">Mastered</div>
      </div>
      <div id="srWordList" style="display:flex;flex-direction:column;gap:6px;max-height:360px;overflow-y:auto"></div>
    </div>
  </div>

  <!-- TAB: QUIZ HISTORY LOG -->
  <div id="ptab-quiz-content" class="prog-cards" style="display:none;margin-top:10px;padding:0 12px">

    <!-- Summary row -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">
      <div style="background:var(--card2);border-radius:10px;padding:10px;text-align:center;border:1px solid var(--border)">
        <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--gold)" id="qhTotalSessions">0</div>
        <div style="font-size:9px;color:var(--textSub);margin-top:2px;text-transform:uppercase;letter-spacing:.5px">Sessions</div>
      </div>
      <div style="background:var(--card2);border-radius:10px;padding:10px;text-align:center;border:1px solid var(--border)">
        <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--green)" id="qhAvgScore">—</div>
        <div style="font-size:9px;color:var(--textSub);margin-top:2px;text-transform:uppercase;letter-spacing:.5px">Avg Score</div>
      </div>
      <div style="background:var(--card2);border-radius:10px;padding:10px;text-align:center;border:1px solid var(--border)">
        <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--blue)" id="qhBestScore">—</div>
        <div style="font-size:9px;color:var(--textSub);margin-top:2px;text-transform:uppercase;letter-spacing:.5px">Best Score</div>
      </div>
    </div>

    <!-- Flashcard Review history (from rateCard) -->
    <div class="graph-card" style="margin-bottom:10px">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">🃏 Flashcard Reviews</div>
      <div id="fcReviewLog" style="display:flex;flex-direction:column;gap:5px;max-height:200px;overflow-y:auto">
        <div style="font-size:12px;color:var(--textMuted);text-align:center;padding:16px">No flashcard reviews yet</div>
      </div>
    </div>

    <!-- MCQ Quiz sessions log -->
    <div class="graph-card">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px">🎯 MCQ Quiz Sessions</div>
      <div id="quizHistoryLog" style="display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto">
        <div style="font-size:12px;color:var(--textMuted);text-align:center;padding:16px">No quiz sessions yet</div>
      </div>
    </div>
  </div>
</div>

<!-- GLOBAL AI FETCH STATUS BAR (removed - user prefers manual sync only) -->

<!-- NAV -->
<nav id="nav">
  <button class="nb active" aria-label="Home" onclick="showScreen('homeScreen',this)"><div class="ni">🏠</div><div class="nl">Home</div></button>
  <button class="nb" onclick="showScreen('wordsScreen',this)"><div class="ni">📚</div><div class="nl">Words</div></button>
  <button class="nb" onclick="showScreen('cardScreen',this);startMode('flip')"><div class="ni">🃏</div><div class="nl">Study</div></button>
  <button class="nb" onclick="showScreen('progressScreen',this);updateProgress()"><div class="ni">📊</div><div class="nl">Progress</div></button>
</nav>

<div id="toast"></div>

<!-- ADD MODAL -->
<div class="moverlay" id="addModal">
  <div class="msheet">
    <div class="mhandle"></div>
    <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:16px">✨ Add New Word</div>
    <div style="display:flex;flex-direction:column;gap:12px">

      <!-- Word input -->
      <div>
        <div style="font-size:11px;color:var(--textSub);margin-bottom:6px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">Word *</div>
        <input class="inp" id="addInp" placeholder="e.g. ephemeral" autocomplete="off">
      </div>

      <!-- Collection (hidden, kept for backward compat) -->
      <input type="hidden" id="addColl" value="">

      <!-- Exam Category -->
      <div style="background:var(--card);border-radius:var(--rsm);padding:12px;border:1px solid var(--border)">
        <div style="font-size:11px;color:var(--gold);margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:5px">🎯 Exam Category</div>
        <div class="add-exam-row" id="addExamRow">
          <!-- dynamic exam pills injected by rebuildExamPills() -->
        </div>
        <div style="font-size:9px;color:var(--textMuted);margin-top:6px">← Scroll to see all exams</div>
      </div>

      <!-- Type -->
      <div style="background:var(--card);border-radius:var(--rsm);padding:12px;border:1px solid var(--border)">
        <div style="font-size:11px;color:var(--accent2);margin-bottom:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">📂 Word Type</div>
        <div class="add-exam-row" id="addTypeRow">
          <div class="add-tpill sel" onclick="selAddType('Synonyms',this)">Synonyms</div>
          <div class="add-tpill" onclick="selAddType('Antonyms',this)">Antonyms</div>
          <div class="add-tpill" onclick="selAddType('Idioms & Phrases',this)">Idioms & Phrases</div>
          <div class="add-tpill" onclick="selAddType('One Word Substitution',this)">One Word Sub.</div>
          <div class="add-tpill" onclick="selAddType('Homonyms',this)">Homonyms</div>
        </div>
      </div>

      <!-- Year -->
      <div>
        <div style="font-size:11px;color:var(--textSub);margin-bottom:6px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">📅 Year (for Flashcard)</div>
        <select class="inp" id="addYear">
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
          <option value="2021">2021</option>
          <option value="2020">2020</option>
          <option value="2019">2019</option>
          <option value="2018">2018</option>
        </select>
      </div>

      <!-- Optional Details (collapsible) -->
      <div style="border:1px solid var(--border);border-radius:var(--rsm);overflow:hidden">
        <button onclick="toggleAddOptional()" id="addOptBtn"
          style="width:100%;padding:11px 14px;background:var(--card);border:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-family:'DM Sans',sans-serif;color:var(--textSub);font-size:12px;font-weight:700">
          <span>✏️ Optional Details <span style="font-size:10px;font-weight:400;opacity:.6">(AI fills blanks automatically)</span></span>
          <span id="addOptArrow" style="font-size:14px;transition:transform .2s">▼</span>
        </button>
        <div id="addOptFields" style="display:none;padding:12px;background:var(--card2);display:none;flex-direction:column;gap:10px">

          <!-- Hindi Meaning -->
          <div>
            <div style="font-size:10px;color:var(--textMuted);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">हिंदी अर्थ (Hindi Meaning)</div>
            <input class="inp" id="addHindi" placeholder="e.g. क्षणिक  (leave blank = AI fills)" style="font-family:'Noto Sans Devanagari',sans-serif;font-size:14px" autocomplete="off">
          </div>

          <!-- Definition -->
          <div>
            <div style="font-size:10px;color:var(--textMuted);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">Definition</div>
            <textarea class="inp" id="addDef" rows="2" placeholder="e.g. Lasting for a very short time. (leave blank = AI fills)" style="resize:none;font-size:13px;line-height:1.5"></textarea>
          </div>

          <!-- Example Sentence -->
          <div>
            <div style="font-size:10px;color:var(--textMuted);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">Example Sentence</div>
            <textarea class="inp" id="addExample" rows="2" placeholder="e.g. The ephemeral beauty of cherry blossoms... (leave blank = AI fills)" style="resize:none;font-size:13px;line-height:1.5"></textarea>
          </div>

          <!-- Synonyms -->
          <div>
            <div style="font-size:10px;color:var(--textMuted);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">Synonyms <span style="font-weight:400;opacity:.6">(comma separated)</span></div>
            <input class="inp" id="addSynonyms" placeholder="e.g. transient, fleeting, momentary" autocomplete="off" style="font-size:13px">
          </div>

          <!-- Antonyms -->
          <div>
            <div style="font-size:10px;color:var(--textMuted);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">Antonyms <span style="font-weight:400;opacity:.6">(comma separated)</span></div>
            <input class="inp" id="addAntonyms" placeholder="e.g. permanent, eternal, lasting" autocomplete="off" style="font-size:13px">
          </div>

          <!-- Mnemonic -->
          <div>
            <div style="font-size:10px;color:var(--textMuted);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">🧠 Mnemonic / Memory Trick</div>
            <input class="inp" id="addMnemonic" placeholder="e.g. E-FEM-eral = fashion trends fade fast" autocomplete="off" style="font-size:13px">
          </div>

          <!-- Quiz 4 Options + Correct Answer -->
          <div style="border-top:1px solid var(--border);padding-top:10px;margin-top:2px">
            <div style="font-size:10px;color:var(--gold);margin-bottom:8px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">📝 Quiz Options <span style="font-weight:400;color:var(--textMuted);text-transform:none;letter-spacing:0">(4 choices for card quiz)</span></div>
            <div style="font-size:10px;color:var(--textMuted);margin-bottom:8px;line-height:1.6;padding:7px 9px;background:var(--card);border-radius:8px">
              💡 Enter all 4 options and mark which one is <b style="color:var(--green)">correct</b>.<br>
              Leave all blank → AI generates them automatically.
            </div>
            <div style="display:flex;flex-direction:column;gap:7px">
              <input class="inp" id="addOpt1" placeholder="Option A" autocomplete="off" style="font-size:13px">
              <input class="inp" id="addOpt2" placeholder="Option B" autocomplete="off" style="font-size:13px">
              <input class="inp" id="addOpt3" placeholder="Option C" autocomplete="off" style="font-size:13px">
              <input class="inp" id="addOpt4" placeholder="Option D" autocomplete="off" style="font-size:13px">
              <div style="margin-top:4px">
                <div style="font-size:10px;color:var(--green);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">✅ Correct Answer</div>
                <select class="inp" id="addCorrectOpt" style="font-size:13px">
                  <option value="">— Select correct option (or leave for AI) —</option>
                  <option value="1">Option A</option>
                  <option value="2">Option B</option>
                  <option value="3">Option C</option>
                  <option value="4">Option D</option>
                </select>
              </div>
            </div>
          </div>

          <div style="padding:8px 10px;background:var(--card);border-radius:8px;font-size:10px;color:var(--textMuted);line-height:1.7">
            💡 Fill only what you know — AI automatically fills any blank fields when you tap <b style="color:var(--text)">Add with AI</b>
          </div>
        </div>
      </div>

      <div id="addLoading" style="display:none;text-align:center;padding:18px"><div class="spin" style="margin:0 auto 10px"></div><div style="font-size:12px;color:var(--textSub)">🤖 Fetching word info...</div></div>
      <button class="btn btn-gold" style="width:100%;padding:13px" onclick="addWord()">🚀 Add with AI</button>
      <button class="btn btn-ghost" style="width:100%;padding:13px" onclick="closeM('addModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="moverlay" id="detailModal"><div class="msheet" id="detailContent"></div></div>

<!-- ── SESSION SUMMARY MODAL ── -->
<div class="moverlay" id="sessSummaryModal">
  <div class="msheet" id="sessSummaryContent" style="padding-bottom:32px"></div>
</div>

<!-- ── UNDO RATING BUTTON ── -->
<div id="undoBtn" style="position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--card2);color:var(--text);border:1.5px solid var(--gold);border-radius:50px;padding:9px 20px;font-size:13px;font-weight:700;z-index:500;opacity:0;pointer-events:none;transition:all .35s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;gap:8px;white-space:nowrap;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,.4)" onclick="undoLastRating()">
  ↩️ Undo Rating
</div>

<!-- STORY MODAL -->
<div class="moverlay" id="storyModal">
  <div class="msheet">
    <div class="mhandle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700">📖 Mini Story</div>
      <button class="btn btn-ghost btn-sm" onclick="closeM('storyModal')">✕</button>
    </div>
    <div id="storyContent"></div>
  </div>
</div>

<!-- SENTENCE BUILDER MODAL -->
<div class="moverlay" id="sbModal">
  <div class="msheet">
    <div class="mhandle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700">🧩 Sentence Builder</div>
      <button class="btn btn-ghost btn-sm" onclick="closeM('sbModal')">✕</button>
    </div>
    <div id="sbContent"></div>
  </div>
</div>
<!-- IMPORT / EXPORT MODAL -->
<div class="moverlay" id="importModal">
  <div class="msheet">
    <div class="mhandle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700">📦 Import / Export</div>
      <button class="btn btn-ghost btn-sm" onclick="closeM('importModal')">✕</button>
    </div>

    <!-- TABS — 2x2 grid so all 4 fit on mobile -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:16px">
      <button id="impTabBtn" class="btn btn-gold btn-sm" style="justify-content:center;border-radius:10px;padding:9px 6px" onclick="switchImpTab('import')">⬆️ Import</button>
      <button id="expTabBtn" class="btn btn-ghost btn-sm" style="justify-content:center;border-radius:10px;padding:9px 6px" onclick="switchImpTab('export')">⬇️ Export</button>
      <button id="bulkTabBtn" class="btn btn-ghost btn-sm" style="justify-content:center;border-radius:10px;padding:9px 6px" onclick="switchImpTab('bulk')">📋 Bulk Add</button>
      <button id="scanTabBtn" class="btn btn-ghost btn-sm" style="justify-content:center;border-radius:10px;padding:9px 6px;background:rgba(124,106,247,.15);color:var(--accent2);border:1.5px solid rgba(124,106,247,.3)" onclick="switchImpTab('scan')">📷 Scan Image</button>
    </div>

    <!-- IMPORT TAB -->
    <div id="impTab">
      <p style="font-size:12px;color:var(--textSub);margin-bottom:10px;line-height:1.6">
        Accepts <b style="color:var(--text)">any format</b> — full JSON export, plain word list, partial data. Missing fields are filled by AI automatically.
      </p>

      <!-- File drop zone -->
      <div class="imp-zone" id="impDropZone" style="position:relative;margin-bottom:10px">
        <input type="file" accept=".json,.txt,text/plain,application/json" id="impFileInp" onchange="handleImpFile(this)">
        <div style="font-size:22px;margin-bottom:4px">📁</div>
        <div style="font-size:13px;font-weight:600;color:var(--text)">Tap to select file</div>
        <div style="font-size:11px;color:var(--textMuted);margin-top:2px">JSON or plain text (.txt)</div>
      </div>

      <!-- Paste area -->
      <textarea class="inp" id="impPaste" rows="5"
        placeholder="Paste anything:&#10;• JSON: [{&quot;word&quot;:&quot;ephemeral&quot;,&quot;examCategory&quot;:&quot;SSC CGL&quot;,...}]&#10;• Word list: ephemeral&#10;serendipity&#10;eloquent"
        style="resize:none;font-size:12px;font-family:monospace;line-height:1.5"
        oninput="detectImpFormat(this.value)"></textarea>

      <!-- Format detector -->
      <div id="impFmtDetect" style="display:none"></div>

      <!-- Default exam/type for plain word imports -->
      <div id="impDefaultMeta" style="display:none;margin-top:10px;background:var(--card);border-radius:var(--rsm);padding:12px;border:1px solid var(--border)">
        <div style="font-size:11px;color:var(--textMuted);margin-bottom:8px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">📌 Default Tags for New Words</div>
        <div style="font-size:10px;color:var(--gold);margin-bottom:5px;font-weight:700">🎯 Exam</div>
        <div class="imp-fmt-row" id="impDefExamRow">
          <!-- dynamic exam pills injected by rebuildExamPills() -->
        </div>
        <div style="font-size:10px;color:var(--accent2);margin:8px 0 5px;font-weight:700">📂 Word Type</div>
        <div class="imp-fmt-row" id="impDefTypeRow">
          <div class="imp-fmt-pill active" onclick="selImpMeta('type','Synonyms',this)">Synonyms</div>
          <div class="imp-fmt-pill" onclick="selImpMeta('type','Antonyms',this)">Antonyms</div>
          <div class="imp-fmt-pill" onclick="selImpMeta('type','Idioms & Phrases',this)">Idioms & Phrases</div>
          <div class="imp-fmt-pill" onclick="selImpMeta('type','One Word Substitution',this)">One Word Sub.</div>
          <div class="imp-fmt-pill" onclick="selImpMeta('type','Homonyms',this)">Homonyms</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <div style="font-size:10px;color:var(--textMuted);font-weight:700;white-space:nowrap">📅 Year</div>
          <select class="inp" id="impDefYear" style="flex:1;font-size:11px;padding:6px 10px">
            <option>2025</option><option>2024</option><option>2023</option><option>2022</option>
            <option>2021</option><option>2020</option><option>2019</option><option>2018</option>
          </select>
        </div>
      </div>

      <!-- AI Enrich — always ON, no toggle needed -->
      <div style="display:flex;align-items:center;gap:10px;margin-top:12px;padding:10px 12px;background:rgba(96,165,250,.07);border-radius:var(--rsm);border:1px solid rgba(96,165,250,.25)">
        <span style="font-size:18px;flex-shrink:0">🤖</span>
        <div>
          <div style="font-size:12px;font-weight:700;color:var(--text)">Auto AI Enrichment — Always ON</div>
          <div style="font-size:10px;color:var(--textSub);margin-top:2px;line-height:1.5">After import, AI will automatically fill definition, Hindi, synonyms, antonyms &amp; more for every word — then save &amp; sync to your account.</div>
        </div>
      </div>

      <div id="impPreview" style="display:none;margin-top:10px">
        <div style="font-size:11px;color:var(--textSub);margin-bottom:6px;font-weight:700">Preview:</div>
        <div class="imp-preview" id="impPreviewText"></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-gold" style="flex:1;padding:13px" onclick="doImport()">⬆️ Import Words</button>
        <button class="btn btn-ghost" onclick="clearImpPaste()">Clear</button>
      </div>
      <div id="impResult" style="margin-top:10px;font-size:12px;text-align:center;font-weight:600"></div>
      <div id="enrichProgress" style="display:none"></div>
    </div>

    <!-- EXPORT TAB -->
    <div id="expTab" style="display:none">
      <p style="font-size:12px;color:var(--textSub);margin-bottom:14px;line-height:1.6">Export your entire word bank as a JSON file you can back up, share, or import later.</p>

      <div style="background:var(--card);border-radius:var(--rsm);border:1px solid var(--border);padding:14px;margin-bottom:14px">
        <div style="font-size:13px;font-weight:700;margin-bottom:8px">📊 Your Data</div>
        <div id="expStats" style="font-size:12px;color:var(--textSub);line-height:1.8"></div>
      </div>

      <!-- Filter export by exam -->
      <div style="font-size:11px;color:var(--textMuted);margin-bottom:8px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">Export Filter (optional)</div>
      <div id="expExamRow" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px">
        <div class="imp-pill sel" id="expExamAll" onclick="setExpExam('all',this)">All Exams</div>
        <!-- dynamic exam pills injected by rebuildExamPills() -->
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <button class="btn btn-gold" style="padding:13px;justify-content:center" onclick="doExport()">⬇️ Download</button>
        <button class="btn btn-ghost" style="padding:13px;justify-content:center" onclick="doCopyExport()">📋 Copy JSON</button>
      </div>
      <button class="btn btn-ghost" style="width:100%;padding:11px;margin-top:8px" onclick="doViewExport()">👁️ View &amp; Copy Manually</button>
    </div>

    <!-- BULK ADD TAB -->
    <div id="bulkTab" style="display:none">
      <p style="font-size:12px;color:var(--textSub);margin-bottom:12px;line-height:1.6">Add multiple words at once without AI. Enter one word per line. Set the exam, type, and year for all words in this batch.</p>

      <textarea class="inp" id="bulkWords" rows="6" placeholder="ephemeral&#10;serendipity&#10;melancholy&#10;eloquent&#10;verbose" style="resize:none;font-size:14px;line-height:1.8"></textarea>

      <!-- Exam for batch -->
      <div style="font-size:11px;color:var(--gold);margin:12px 0 8px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">🎯 Exam</div>
      <div style="display:flex;gap:5px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none" id="bulkExamRow">
        <!-- dynamic exam pills injected by rebuildExamPills() -->
      </div>

      <!-- Type for batch -->
      <div style="font-size:11px;color:var(--accent2);margin:12px 0 8px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">📂 Word Type</div>
      <div style="display:flex;gap:5px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none" id="bulkTypeRow">
        <div class="imp-pill sel-type sel" onclick="selBulkType('Synonyms',this)">Synonyms</div>
        <div class="imp-pill sel-type" onclick="selBulkType('Antonyms',this)">Antonyms</div>
        <div class="imp-pill sel-type" onclick="selBulkType('Idioms & Phrases',this)">Idioms & Phrases</div>
        <div class="imp-pill sel-type" onclick="selBulkType('One Word Substitution',this)">One Word Sub.</div>
        <div class="imp-pill sel-type" onclick="selBulkType('Homonyms',this)">Homonyms</div>
      </div>

      <!-- Year -->
      <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
        <div style="font-size:11px;color:var(--textMuted);font-weight:700;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">📅 Year</div>
        <select class="inp" id="bulkYear" style="flex:1">
          <option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option><option value="2022">2022</option>
          <option value="2021">2021</option><option value="2020">2020</option><option value="2019">2019</option><option value="2018">2018</option>
          <option value="2017">2017</option><option value="2016">2016</option>
        </select>
        <input class="inp" id="bulkYearCustom" placeholder="Custom" maxlength="4" type="number" style="width:85px">
      </div>

      <div style="display:flex;align-items:center;gap:10px;margin-top:12px;padding:10px 14px;background:linear-gradient(135deg,rgba(52,211,153,.08),rgba(96,165,250,.08));border-radius:10px;border:1px solid rgba(52,211,153,.2)">
        <div style="font-size:22px;flex-shrink:0">🤖</div>
        <div>
          <div style="font-size:12px;font-weight:700;color:var(--green)">AI Auto-Enrich is ON</div>
          <div style="font-size:10px;color:var(--textMuted);margin-top:2px;line-height:1.5">Hindi meaning, definition, synonyms, antonyms, mnemonic &amp; image will be fetched automatically for every word.</div>
        </div>
      </div>
      <button class="btn btn-gold" style="width:100%;padding:14px;margin-top:14px;font-size:14px;font-weight:700" onclick="doBulkAdd()">🚀 Add &amp; Enrich All Words</button>
      <div id="bulkResult" style="margin-top:10px;font-size:12px;text-align:center;font-weight:600"></div>
      <div id="bulkEnrichProgress" style="display:none"></div>
    </div>


    <!-- SCAN TAB -->
    <div id="scanTab" style="display:none">

      <p style="font-size:12px;color:var(--textSub);margin-bottom:14px;line-height:1.6">
        Pick an image or take a photo of any word list, textbook page, or vocab card — AI will extract the words automatically!
      </p>

      <!-- FILE INPUTS: positioned offscreen, triggered by labels -->
      <input type="file" accept="image/*" capture="environment" id="scanCameraInput" onchange="handleScanImage(this)"
        style="position:fixed;top:-200px;left:-200px;width:1px;height:1px;opacity:0">
      <input type="file" accept="image/*" id="scanGalleryInput" onchange="handleScanImage(this)"
        style="position:fixed;top:-200px;left:-200px;width:1px;height:1px;opacity:0">

      <!-- TWO BIG LABEL BUTTONS — most reliable mobile approach -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
        <label for="scanCameraInput" style="display:block;cursor:pointer">
          <div style="background:linear-gradient(135deg,var(--accent),#5b4fcf);border-radius:14px;padding:18px 10px;text-align:center;border:none">
            <div style="font-size:30px;margin-bottom:6px">📷</div>
            <div style="font-size:13px;font-weight:700;color:#fff">Camera</div>
            <div style="font-size:10px;color:rgba(255,255,255,.65);margin-top:2px">Take photo</div>
          </div>
        </label>
        <label for="scanGalleryInput" style="display:block;cursor:pointer">
          <div style="background:var(--card2);border:1.5px solid var(--border);border-radius:14px;padding:18px 10px;text-align:center">
            <div style="font-size:30px;margin-bottom:6px">🖼️</div>
            <div style="font-size:13px;font-weight:700;color:var(--text)">Gallery</div>
            <div style="font-size:10px;color:var(--textMuted);margin-top:2px">Pick image</div>
          </div>
        </label>
      </div>

      <!-- Image preview (shown after selection) -->
      <div id="scanPreviewWrap" style="display:none;margin-bottom:12px">
        <div style="position:relative;border-radius:12px;overflow:hidden;border:1.5px solid var(--border)">
          <img id="scanPreviewImg" style="width:100%;max-height:200px;object-fit:contain;display:block;background:var(--card2)" alt="">
          <label for="scanGalleryInput" style="position:absolute;bottom:8px;left:8px;cursor:pointer">
            <div style="background:rgba(0,0,0,.65);color:#fff;font-size:11px;font-weight:600;padding:4px 10px;border-radius:50px;backdrop-filter:blur(4px)">🔄 Change</div>
          </label>
          <button onclick="clearScanImage()" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,.65);border:none;color:#fff;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)">✕</button>
        </div>
      </div>

      <!-- Instruction box (shown after image selected) -->
      <div id="scanInstructBox" style="display:none;margin-bottom:10px">
        <div style="font-size:11px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">
          🎯 Guide the AI — What to extract?
        </div>
        <textarea id="scanInstruction" class="inp" rows="3"
          placeholder="Examples:&#10;• Extract only the bold/highlighted words&#10;• Take words from column 2 only&#10;• Extract only words numbered 1–10&#10;• Get words after the bullet points&#10;(Leave blank to extract all vocabulary words)"
          style="resize:none;font-size:12px;line-height:1.6;color:var(--text)"></textarea>
        <!-- Quick instruction chips -->
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:7px">
          <div onclick="setInstruction(this)" data-val="Extract only numbered words (e.g. 1. word, 2. word)"
            style="padding:4px 10px;border-radius:50px;background:var(--card2);border:1px solid var(--border);font-size:10px;font-weight:600;color:var(--textSub);cursor:pointer;transition:all .2s">🔢 Numbered list</div>
          <div onclick="setInstruction(this)" data-val="Extract only the words in bold or ALL CAPS"
            style="padding:4px 10px;border-radius:50px;background:var(--card2);border:1px solid var(--border);font-size:10px;font-weight:600;color:var(--textSub);cursor:pointer;transition:all .2s">🅱️ Bold/Caps only</div>
          <div onclick="setInstruction(this)" data-val="Extract only words from the first column"
            style="padding:4px 10px;border-radius:50px;background:var(--card2);border:1px solid var(--border);font-size:10px;font-weight:600;color:var(--textSub);cursor:pointer;transition:all .2s">📋 Column 1</div>
          <div onclick="setInstruction(this)" data-val="Extract only words from the second column"
            style="padding:4px 10px;border-radius:50px;background:var(--card2);border:1px solid var(--border);font-size:10px;font-weight:600;color:var(--textSub);cursor:pointer;transition:all .2s">📋 Column 2</div>
          <div onclick="setInstruction(this)" data-val="Extract all English vocabulary/dictionary words, ignore page numbers and headers"
            style="padding:4px 10px;border-radius:50px;background:var(--card2);border:1px solid var(--border);font-size:10px;font-weight:600;color:var(--textSub);cursor:pointer;transition:all .2s">📖 All vocab words</div>
          <div onclick="setInstruction(this)" data-val="Extract only the words after bullet points or dashes"
            style="padding:4px 10px;border-radius:50px;background:var(--card2);border:1px solid var(--border);font-size:10px;font-weight:600;color:var(--textSub);cursor:pointer;transition:all .2s">• Bullet points</div>
        </div>
      </div>

      <!-- Extract button -->
      <button id="scanExtractBtn" class="btn btn-gold" style="width:100%;padding:14px;display:none;font-size:14px" onclick="runScanExtract()">
        🔍 Extract Words with AI
      </button>

      <!-- Progress -->
      <div id="scanStatus" style="display:none;margin-top:10px;padding:12px;background:var(--card);border-radius:var(--rsm);border:1px solid var(--border)">
        <div style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--textSub)">
          <div class="spin" style="width:18px;height:18px;border-width:2px;flex-shrink:0"></div>
          <span id="scanStatusText">Processing image…</span>
        </div>
        <div class="pbar" style="margin-top:8px"><div class="pfill" id="scanPFill" style="width:0%"></div></div>
      </div>

      <!-- Results -->
      <div id="scanResultWrap" style="display:none;margin-top:12px">
        <div style="font-size:11px;color:var(--gold);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">✅ Extracted Words — Edit if needed</div>
        <textarea class="inp" id="scanExtractedWords" rows="6" placeholder="Words appear here…" style="resize:none;font-size:14px;line-height:1.8"></textarea>
        <div style="font-size:10px;color:var(--textMuted);margin-top:4px;margin-bottom:12px">One word per line. Edit before adding.</div>

        <div style="font-size:11px;color:var(--gold);margin-bottom:8px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">🎯 Exam</div>
        <div style="display:flex;gap:5px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none" id="scanExamRow">
          <!-- dynamic exam pills injected by rebuildExamPills() -->
        </div>

        <div style="font-size:11px;color:var(--accent2);margin:12px 0 8px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">📂 Word Type</div>
        <div style="display:flex;gap:5px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none" id="scanTypeRow">
          <div class="imp-pill sel-type sel" onclick="selScanType('Synonyms',this)">Synonyms</div>
          <div class="imp-pill sel-type" onclick="selScanType('Antonyms',this)">Antonyms</div>
          <div class="imp-pill sel-type" onclick="selScanType('Idioms & Phrases',this)">Idioms & Phrases</div>
          <div class="imp-pill sel-type" onclick="selScanType('One Word Substitution',this)">One Word Sub.</div>
          <div class="imp-pill sel-type" onclick="selScanType('Homonyms',this)">Homonyms</div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding:10px 12px;background:var(--card);border-radius:var(--rsm);border:1px solid var(--border)">
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--text)">🤖 AI Enrich After Adding</div>
            <div style="font-size:10px;color:var(--textMuted);margin-top:2px">Auto-fill definition, Hindi, synonyms etc.</div>
          </div>
          <label style="position:relative;display:inline-block;width:42px;height:24px;flex-shrink:0;cursor:pointer">
            <input type="checkbox" id="scanAiEnrich" checked style="opacity:0;width:0;height:0;position:absolute">
            <span id="scanAiToggle" onclick="this.previousElementSibling.checked=!this.previousElementSibling.checked;this.style.background=this.previousElementSibling.checked?'var(--gold)':' var(--card2)'"
              style="position:absolute;inset:0;border-radius:12px;background:var(--gold);transition:background .3s;border:1px solid var(--border)">
              <span style="position:absolute;top:2px;width:18px;height:18px;border-radius:50%;background:#000;display:block;left:20px"></span>
            </span>
          </label>
        </div>

        <button class="btn btn-gold" style="width:100%;padding:13px;margin-top:14px" onclick="doScanBulkAdd()">⚡ Add Scanned Words</button>
        <div id="scanAddResult" style="margin-top:10px;font-size:12px;text-align:center;font-weight:600"></div>
        <div id="scanEnrichProgress" style="display:none"></div>
      </div>
    </div>

  </div>
</div>

<!-- ASK AI MODAL -->
<div class="moverlay" id="askAiModal">
  <div class="msheet" id="askAiSheet">
    <div class="mhandle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <div style="font-family:'Playfair Display',serif;font-size:19px;font-weight:700">✨ Ask AI</div>
      <button class="btn btn-ghost btn-sm" onclick="closeM('askAiModal')">✕</button>
    </div>
    <div id="askAiWordLabel" style="font-size:12px;color:var(--textSub);margin-bottom:14px"></div>

    <!-- Quick action chips -->
    <div style="font-size:10px;color:var(--textMuted);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">⚡ Quick Actions</div>
    <div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px" id="askAiChips">
      <button class="ask-chip" onclick="fireAskAI('mnemonic')">🧠 Mnemonic</button>
      <button class="ask-chip" onclick="fireAskAI('story')">📖 Mini Story</button>
      <button class="ask-chip" onclick="fireAskAI('collocations')">🔗 Collocations</button>
      <button class="ask-chip" onclick="fireAskAI('sentences')">📝 3 Sentences</button>
      <button class="ask-chip" onclick="fireAskAI('quiz')">🎯 Quiz Me</button>
      <button class="ask-chip" onclick="fireAskAI('remember')">💡 How to Remember</button>
      <button class="ask-chip" onclick="fireAskAI('roots')">🔤 Word Roots</button>
      <button class="ask-chip" onclick="fireAskAI('confusables')">⚠️ Confusables</button>
      <button class="ask-chip" onclick="fireAskAI('usage')">📚 Usage Tips</button>
      <button class="ask-chip" onclick="fireAskAI('hindi')">🇮🇳 Hindi Deep Dive</button>
    </div>

    <!-- Custom question -->
    <div style="font-size:10px;color:var(--textMuted);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px">💬 Custom Question</div>
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <input class="inp" id="askAiCustomInp" placeholder="e.g. Use this word in a poem..." style="flex:1;font-size:13px"
        onkeydown="if(event.key==='Enter')fireAskAI('custom')">
      <button class="btn btn-accent btn-sm" onclick="fireAskAI('custom')" style="flex-shrink:0">Ask →</button>
    </div>

    <!-- Response area -->
    <div id="askAiResponse" style="display:none;background:var(--card);border-radius:var(--rsm);border:1px solid var(--border);padding:14px;max-height:42vh;overflow-y:auto">
      <div id="askAiResponseInner"></div>
    </div>
  </div>
</div>

</div><!-- end #app -->

<!-- PWA Install Banner -->
<div id="pwaBanner">
  <div class="pwa-icon">📱</div>
  <div class="pwa-text">
    <div class="pwa-title">Install VocabMaster Pro</div>
    <div class="pwa-sub" id="pwaBannerSub">Add to home screen · Works like a native app</div>
  </div>
  <button class="pwa-install-btn" onclick="triggerPWAInstall()">Install ⬇️</button>
  <button class="pwa-close-btn" onclick="dismissPWA()">✕</button>
</div>

<!-- ===== QUIZ MODAL (outside #app to avoid overflow:hidden clipping) ===== -->
<div id="quizModal">

  <!-- QUESTION VIEW -->
  <div id="qvQuestion" style="display:flex;flex-direction:column;height:100%">
    <div class="qm-hd">
      <div class="qm-hd-top">
        <div class="qm-title" id="qmTitle">Exam Quiz</div>
        <button class="qm-close-btn" onclick="qmClose()">&#10005;</button>
      </div>
      <div class="qm-prog">
        <div class="qm-pbar"><div class="qm-pfill" id="qmPfill" style="width:0%"></div></div>
        <div class="qm-pcnt" id="qmPcnt">0%</div>
      </div>
      <div class="qm-stats">
        <div class="qm-stat"><div class="qm-stat-n" id="qmCorrN" style="color:var(--green)">0</div><div class="qm-stat-l">Correct</div></div>
        <div class="qm-stat"><div class="qm-stat-n" id="qmWrongN" style="color:var(--red)">0</div><div class="qm-stat-l">Wrong</div></div>
        <div class="qm-stat"><div class="qm-stat-n" id="qmSkipN" style="color:var(--orange)">0</div><div class="qm-stat-l">Skipped</div></div>
        <div class="qm-stat"><div class="qm-stat-n" id="qmLeftN" style="color:var(--textSub)">0</div><div class="qm-stat-l">Left</div></div>
      </div>
    </div>

    <div class="qm-body" id="qmBody">
      <div class="qm-qtag-row">
        <span class="eq-tag syn" id="qmTag">Synonyms</span>
        <span style="font-size:11px;color:var(--textMuted);font-weight:600" id="qmQNum">Q 1 / 1</span>
        <button class="qm-opt-ask" id="qmAskAiBtn" style="display:none;margin-left:auto" onclick="qmAiOpenForOption()">✨ Ask AI</button>
      </div>
      <div class="qm-qtext" id="qmQText"></div>
      <div class="qm-opts" id="qmOpts"></div>
      <div class="qm-exp" id="qmExp"></div>
      <div class="qm-ai-panel" id="qmAiPanel"></div>
    </div>

    <div class="qm-ft">
      <button class="qm-btn-nav" id="qmPrevBtn" onclick="qmPrev()" disabled>&#9664;</button>
      <button class="qm-btn-skip" id="qmSkipBtn" onclick="qmSkip()">&#9197; Skip</button>
      <button class="qm-btn-action" id="qmNextBtn" onclick="qmNext()">Next &#9654;</button>
      <button class="qm-btn-action" id="qmSubmitBtn" onclick="qmSubmit()">&#9989; Submit Quiz</button>
    </div>
  </div>

  <!-- RESULT VIEW -->
  <div id="qvResult" style="display:none;flex-direction:column;height:100%">
    <div class="qm-hd">
      <div class="qm-hd-top">
        <div class="qm-title">Quiz Results</div>
        <button class="qm-close-btn" onclick="qmClose()">&#10005;</button>
      </div>
    </div>
    <div class="qr-wrap" id="qrWrap"></div>
    <div class="qm-ft" style="gap:10px">
      <button class="btn btn-ghost" style="flex:1;padding:11px" onclick="qmClose()">Close</button>
      <button class="btn btn-gold" style="flex:2;padding:11px" onclick="qmRetry()">&#128260; Retry</button>
    </div>
  </div>

</div><!-- end #quizModal -->

<!-- ===== QUIZ AI POPUP ===== -->
<div id="qmAiPopup" onclick="if(event.target===this)qmAiClose()">
  <div class="qm-ai-sheet">
    <div class="mhandle"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div style="font-size:13px;font-weight:800;color:var(--accent2)" id="qmAiPopupTitle">✨ AI Assistant</div>
      <button onclick="qmAiClose()" style="background:var(--card2);border:1px solid var(--border);border-radius:50%;width:28px;height:28px;font-size:14px;cursor:pointer;color:var(--textSub);display:flex;align-items:center;justify-content:center;flex-shrink:0">&#10005;</button>
    </div>
    <div id="qmAiPopupBody"></div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
// API key removed from client — now stored securely in Cloudflare Worker
// All AI calls go through the Worker proxy at VM_API/api/ai/text and VM_API/api/ai/image

// Vocab loaded from vocab/*.json files
const BUILTIN_VOCAB_INLINE=[];
// ─────────────────────────────────────────────────────────────────────────────

let words = [];

// ═══════════════════════════════════════════════════════════════
// VOCAB BANK LOADER — reads vocab_manifest.json + vocab/*.json
// To add new exams: add a new file to vocab/ and register it in
// vocab_manifest.json, then bump "version". All users auto-update.
// ═══════════════════════════════════════════════════════════════

async function loadVocabBank() {
  // ── Try fetching external vocab files (works when hosted on a server) ───────
  try {
    const manifestRes = await fetch('./vocab_manifest.json');
    if (manifestRes.ok) {
      const manifest = await manifestRes.json();
      const storedVer = localStorage.getItem('vm_vocab_version');

      if (storedVer !== manifest.version) {
        const fetches = manifest.files.map(entry =>
          fetch('./' + entry.file).then(r => r.ok ? r.json() : []).catch(() => [])
        );
        const builtinWords = (await Promise.all(fetches)).flat();
        _mergeBuiltinWords(builtinWords, manifest.version);
        console.log('VocabBank: loaded from server (' + manifest.version + ')');
      } else {
        console.log('VocabBank: server version up to date (' + manifest.version + ')');
      }
      return; // server fetch succeeded — done
    }
  } catch(e) { /* fetch not available (local file) — fall through to inline */ }

  // ── Fallback: use inline embedded vocab (works when opened as local file) ───
  const INLINE_VERSION = 'local-file-mode';
  const storedVer = localStorage.getItem('vm_vocab_version');
  if (storedVer !== INLINE_VERSION) {
    _mergeBuiltinWords(BUILTIN_VOCAB_INLINE, INLINE_VERSION);
    console.log('VocabBank: loaded from inline fallback (' + INLINE_VERSION + ')');
  } else {
    console.log('VocabBank: inline version up to date (' + INLINE_VERSION + ')');
  }
}

function _mergeBuiltinWords(builtinWords, version) {
  const userWords = words.filter(w => !w.isBuiltin);
  const userKeys  = new Set(userWords.map(w => (w.word||'').toLowerCase() + '|' + (w.examCategory||'')));
  const toAdd     = builtinWords.filter(bw =>
    !userKeys.has((bw.word||'').toLowerCase() + '|' + (bw.examCategory||''))
  );
  words = [...toAdd, ...userWords];
  saveWords();
  localStorage.setItem('vm_vocab_version', version);
}

// ── Rebuild ALL exam pill rows from live words + EXAMS list ─────────────────
// Call this after vocab loads or after user adds/deletes words
function rebuildExamPills() {
  // Only show exams that have at least 1 word — nothing else
  // Add/delete a word → pill appears/disappears automatically
  const withWords = [...new Set(words.map(w => w.examCategory).filter(Boolean))].sort();
  EXAMS = withWords; // keep in sync

  // For rows that let user assign exam while adding (addExamRow, bulk, scan, import)
  // we show ALL known exams so user can pick target — use a wider set including defaults
  const DEFAULT_EXAMS = ['SSC CGL','SSC CHSL','SSC STENO','SSC CPO','SSC PHASE','SSC MTS','SSC GD','RRB NTPC','Bank PO','Railway'];
  const forPicker = [...new Set([...withWords, ...DEFAULT_EXAMS])].sort();

  // Count words per exam for badge display on word-filter row
  const examCount = {};
  words.forEach(w => { if(w.examCategory) examCount[w.examCategory] = (examCount[w.examCategory]||0)+1; });

  // ─── Config for each pill row ───────────────────────────────────────────
  // examList = which exams to show in that row
  const rows = [
    {
      id: 'examRow',        examList: withWords,
      make: e => `<div class="exam-pill" onclick="selectExam('${e}',this)">${e}</div>`,
      firstActive: true, activeClass: 'active'
    },
    {
      id: 'wExamRow',       examList: withWords,
      make: e => `<div class="wfpill" onclick="setWExam('${e}',this)">${e} <span style="font-size:9px;opacity:.6">${examCount[e]||''}</span></div>`,
      firstActive: false, activeClass: 'active-exam'
    },
    {
      id: 'cardExamRow',    examList: withWords,
      make: e => `<div class="cef-pill" onclick="setCardExam('${e}',this)">${e}</div>`,
      firstActive: false, activeClass: 'ce-active'
    },
    {
      id: 'addExamRow',     examList: forPicker,
      make: e => `<div class="add-epill" onclick="selAddExam('${e}',this)">${e}</div>`,
      firstActive: false, activeClass: 'sel'
    },
    {
      id: 'impDefExamRow',  examList: forPicker,
      make: e => `<div class="imp-fmt-pill" onclick="selImpMeta('exam','${e}',this)">${e}</div>`,
      firstActive: false, activeClass: 'active'
    },
    {
      id: 'expExamRow',     examList: withWords,
      make: e => `<div class="imp-pill" onclick="setExpExam('${e}',this)">${e}</div>`,
      firstActive: false, activeClass: 'sel'
    },
    {
      id: 'bulkExamRow',    examList: forPicker,
      make: e => `<div class="imp-pill" onclick="selBulkExam('${e}',this)">${e}</div>`,
      firstActive: false, activeClass: 'sel'
    },
    {
      id: 'scanExamRow',    examList: forPicker,
      make: e => `<div class="imp-pill" onclick="selScanExam('${e}',this)">${e}</div>`,
      firstActive: false, activeClass: 'sel'
    },
  ];

  rows.forEach(function(row) {
    const el = document.getElementById(row.id);
    if (!el) return;

    // Remove old dynamic pills
    el.querySelectorAll('[data-dynamic-exam]').forEach(n => n.remove());

    // Inject only the exams relevant for this row
    row.examList.forEach(function(exam, idx) {
      const tmp = document.createElement('template');
      tmp.innerHTML = row.make(exam).trim();
      const node = tmp.content.firstChild;
      node.setAttribute('data-dynamic-exam', exam);
      if (row.firstActive && idx === 0) node.classList.add(row.activeClass);
      el.appendChild(node);
    });
  });

  // Re-highlight the currently active filters so they don't reset visually
  _restoreActiveExamPills();
  rebuildYearPills(wExam);
}

function _restoreActiveExamPills() {
  // examRow
  document.querySelectorAll('#examRow .exam-pill').forEach(function(p) {
    p.classList.toggle('active', p.textContent.trim() === activeExam);
  });
  // wExamRow
  document.querySelectorAll('#wExamRow .wfpill').forEach(function(p) {
    const val = p.getAttribute('onclick') ? (p.getAttribute('onclick').match(/'([^']+)'/) || [])[1] : '';
    p.classList.toggle('active-exam', val === wExam);
  });
  // cardExamRow
  document.querySelectorAll('#cardExamRow .cef-pill[data-dynamic-exam]').forEach(function(p) {
    p.classList.toggle('ce-active', p.getAttribute('data-dynamic-exam') === cardExamFilter);
  });
}
// ─────────────────────────────────────────────────────────────────────────────

// ── Rebuild year pills dynamically from actual word data ─────────────────────
// Call after exam selection changes or after words are added/deleted
function rebuildYearPills(forExam) {
  // Get years that actually have words (optionally filtered by exam)
  const scope = forExam && forExam !== 'all'
    ? words.filter(w => (w.examCategory||'') === forExam)
    : words;

  const yearCount = {};
  scope.forEach(function(w) {
    const y = (w.year||'').trim();
    if (y) yearCount[y] = (yearCount[y]||0) + 1;
  });

  // Sort years descending (newest first)
  const years = Object.keys(yearCount).sort((a,b) => b - a);
  const totalScope = scope.length;

  // ── Exam Quiz yearRow ───────────────────────────────────────────────────
  const examYearRow = document.getElementById('yearRow');
  if (examYearRow) {
    examYearRow.querySelectorAll('[data-dynamic-year]').forEach(n => n.remove());
    years.forEach(function(y) {
      const tmp = document.createElement('template');
      tmp.innerHTML = `<div class="year-pill" data-dynamic-year="${y}" onclick="selectYear('${y}',this)">${y}</div>`;
      examYearRow.appendChild(tmp.content.firstChild);
    });
    // Restore active state
    examYearRow.querySelectorAll('.year-pill').forEach(function(p) {
      const val = p.getAttribute('data-dynamic-year') || 'all';
      if (p.textContent.trim().startsWith('All')) {
        p.classList.toggle('active', activeYear === 'all');
      } else {
        p.classList.toggle('active', val === activeYear);
      }
    });
  }

  // ── Words screen wYearRow ───────────────────────────────────────────────
  const wYearRowEl = document.getElementById('wYearRow');
  if (wYearRowEl) {
    wYearRowEl.querySelectorAll('[data-dynamic-year]').forEach(n => n.remove());

    // "All Years" pill with count badge
    const allPill = wYearRowEl.querySelector('.wfpill');
    if (allPill) {
      allPill.innerHTML = `All Years <span style="display:inline-block;background:rgba(255,255,255,.13);color:inherit;border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:3px">${totalScope}</span>`;
    }

    years.forEach(function(y) {
      const cnt = yearCount[y];
      const tmp = document.createElement('template');
      tmp.innerHTML = `<div class="wfpill" data-dynamic-year="${y}" onclick="setWYear('${y}',this)">${y} <span style="display:inline-block;background:rgba(255,255,255,.13);color:inherit;border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:3px">${cnt}</span></div>`;
      const node = tmp.content.firstChild;
      node.classList.toggle('active-year', y === wYear);
      wYearRowEl.appendChild(node);
    });

    // Mark "All Years" active if wYear === 'all'
    if (allPill) allPill.classList.toggle('active-year', wYear === 'all');
  }
}
// ─────────────────────────────────────────────────────────────────────────────

let userData = {xp:0,level:1,streak:0,lastSeen:'',dailyReviewed:0,lastReviewDate:'',dailyGoal:10,activity:{}};
// Filter state — persisted across sessions via localStorage
let wExam = localStorage.getItem('vm_wExam') || 'all';
let wYear = localStorage.getItem('vm_wYear') || 'all';
let wType = localStorage.getItem('vm_wType') || 'all';
let wMem  = localStorage.getItem('vm_wMem')  || 'all';
let wordsView = localStorage.getItem('vm_wordsView') || 'card'; // 'card' or 'list'
let wSortBy   = localStorage.getItem('vm_wSortBy')   || 'newest'; // sort order
let currentDeck = [], currentIdx = 0, isFlipped = false;
let _sessionStats = { hard: 0, medium: 0, easy: 0 }; // track ratings in current session
let _lastRatedSnapshot = null; // for undo: {wordId, oldState, deckIdx}
let _undoTimer = null;

// Bug Fix 3: Unique ID generator — prevents float/collision IDs from doBulkAdd
let _uidBase = Date.now();
function uid() { return ++_uidBase; }
let practiceMode = '', practiceWords = [], practiceIdx = 0, practiceScore = 0, practiceTotal = 0;
let timerInt = null;
let rapidActive = false, rapidCount = 0, rapidTimer = 60, rapidInt = null;

// Exam quiz state
let activeExam='SSC CGL', activeCat='all', activeYear='all';
let examQuestions=[], qmIdx=0, qmAnswers=[], quizHistory=[];

// Add modal state
let addWordExam = 'SSC CGL', addWordType = 'Synonyms';

// ============================================================
// STORAGE
// ============================================================
// ══════════════════════════════════════════════════════════════
// CLOUD SYNC ENGINE — GitHub Gist via Cloudflare Worker
// ══════════════════════════════════════════════════════════════
const VM_API = 'https://square-feather-ca85.purendarchauhan.workers.dev';

// ── AI Engine Config — NO keys stored here, all proxied via Worker ───────────
const GROQ_MODEL  = 'llama-3.1-8b-instant';
const GROQ_MODEL2 = 'openai/gpt-oss-120b';
const GROQ_MODEL3 = 'meta-llama/llama-4-maverick-17b-128e-instruct';
const GROQ_QWEN   = 'qwen/qwen3-32b';
const GROQ_KIMI   = 'moonshotai/kimi-k2-instruct';
const GEMINI_MODEL = 'gemini-2.5-flash';
let activeAI = localStorage.getItem('vm_ai_engine') || 'worker';
if (activeAI === 'openrouter') { activeAI = 'worker'; localStorage.setItem('vm_ai_engine', 'worker'); }

// ── Single proxy helper — all AI goes through Worker ────────────────────────
async function _proxyCall(engine, prompt, systemPrompt, extra) {
  const res = await fetch(VM_API + '/api/ai/proxy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ engine, prompt, systemPrompt: systemPrompt || null, extra: extra || {} })
  });
  if (!res.ok) {
    if (res.status === 429) {
      const d = await res.json().catch(() => ({}));
      const retry = d.retryAfter || 60;
      throw new Error('RATE_LIMIT|' + retry + '|Rate limit exceeded. Wait ' + Math.ceil(retry/60) + ' min, or switch AI engine.');
    }
    const d = await res.json().catch(() => ({}));
    throw new Error(d.error || 'Proxy error ' + res.status);
  }
  const data = await res.json();
  return data.text || '';
}

async function aiWorker(prompt, systemPrompt)  { return _proxyCall('worker',  prompt, systemPrompt, {}); }
async function aiGroq(prompt, systemPrompt)    { return _proxyCall('groq',    prompt, systemPrompt, { model: GROQ_MODEL }); }
async function aiGroq2(prompt, systemPrompt)   { return _proxyCall('groq2',   prompt, systemPrompt, { model: GROQ_MODEL2, max_completion_tokens: 8192, reasoning_effort: 'medium' }); }
async function aiGroq3(prompt, systemPrompt)   { return _proxyCall('groq3',   prompt, systemPrompt, { model: GROQ_MODEL3, max_completion_tokens: 1024, temperature: 1 }); }
async function aiQwen(prompt, systemPrompt)    { return _proxyCall('groq',    prompt, systemPrompt, { model: GROQ_QWEN,   max_completion_tokens: 4096, temperature: 0.6, top_p: 0.95, reasoning_effort: 'default' }); }
async function aiKimi(prompt, systemPrompt)    { return _proxyCall('groq',    prompt, systemPrompt, { model: GROQ_KIMI,   max_completion_tokens: 4096, temperature: 0.6, top_p: 1 }); }
async function aiGemini(prompt, systemPrompt)  { return _proxyCall('gemini',  prompt, systemPrompt, { model: GEMINI_MODEL }); }

// ── Unified AI entry point ───────────────────────────────────────────────────
async function vmAI(prompt, systemPrompt) {
  let textStr;
  if      (activeAI === 'groq')   textStr = await aiGroq(prompt, systemPrompt);
  else if (activeAI === 'groq2')  textStr = await aiGroq2(prompt, systemPrompt);
  else if (activeAI === 'groq3')  textStr = await aiGroq3(prompt, systemPrompt);
  else if (activeAI === 'qwen')   textStr = await aiQwen(prompt, systemPrompt);
  else if (activeAI === 'kimi')   textStr = await aiKimi(prompt, systemPrompt);
  else if (activeAI === 'gemini') textStr = await aiGemini(prompt, systemPrompt);
  else                            textStr = await aiWorker(prompt, systemPrompt);
  return { text: function() { return Promise.resolve(textStr); }, ok: true };
}

// ── Toggle AI engine ─────────────────────────────────────────────────────────
function setAIEngine(engine) {
  activeAI = engine;
  localStorage.setItem('vm_ai_engine', engine);
  document.querySelectorAll('.ai-engine-btn').forEach(function(b) {
    b.classList.toggle('ai-btn-active', b.dataset.engine === engine);
  });
  const labels = {
    worker: '⚡ Default AI',
    groq:   '🚀 Llama 3.1 8B',
    groq2:  '🧠 GPT-OSS 120B',
    groq3:  '🦙 Llama 4 Maverick',
    qwen:   '🐉 Qwen3-32B',
    kimi:   '🌙 Kimi K2',
    gemini: '✨ Gemini 2.5 Flash'
  };
  showToast(labels[engine] || 'AI switched');
}

async function aiText(prompt) { return vmAI(prompt); }

// All image calls → GET VM_API/api/ai/image  (safe to use as <img src>)
function aiImageUrl(prompt, { width = 400, height = 250, seed, nologo = true, model = 'flux' } = {}) {
  const s = seed != null ? seed : Math.floor(Math.random() * 99999);
  return VM_API + '/api/ai/image' +
    '?prompt='  + encodeURIComponent(prompt) +
    '&model='   + encodeURIComponent(model) +
    '&width='   + width +
    '&height='  + height +
    '&seed='    + s +
    '&nologo='  + nologo;
}
// ─────────────────────────────────────────────────────────────────────────────

let vm_userId       = null;
let vm_userName     = '';
let vm_syncTimer    = null;
let vm_syncing      = false;
let vm_autoSyncEnabled = false; // User can enable auto-sync to reduce API calls
let vm_syncInterval = 300000;  // 5 minutes (300000ms) - reduced from 60s to lower API usage

// ── Local read ────────────────────────────────────────────────
async function sGet(k){
  try{ if(window.storage){const r=await window.storage.get(k);return r?r.value:null;} }catch(e){}
  return localStorage.getItem(k);
}

// ── Local write (manual sync only) ──────────────────────────
async function sSet(k,v){
  try{ if(window.storage){await window.storage.set(k,v);} }catch(e){}
  localStorage.setItem(k,v);
  // Auto-sync disabled - user must manually tap sync button
  // if(vm_userId){ clearTimeout(vm_syncTimer); vm_syncTimer = setTimeout(vm_pushToCloud, 2500); }
}

function saveWords(){ sSet('vm_words', JSON.stringify(words)); }
function saveUser(){  sSet('vm_user',  JSON.stringify(userData)); }

// ── Push all app data → Cloud ─────────────────────────────────
async function vm_pushToCloud(){
  if(!vm_userId || vm_syncing) return;
  vm_syncing = true;
  vm_setBadge('🔄 Syncing…');
  try{
    const payload = {
      words:       JSON.parse(localStorage.getItem('vm_words')        || '[]'),
      userData:    JSON.parse(localStorage.getItem('vm_user')         || '{}'),
      quizHistory: JSON.parse(localStorage.getItem('vm_quiz_history') || '[]'),
      userName:    vm_userName
    };
    const res  = await fetch(`${VM_API}/api/user/${vm_userId}`,{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
    });
    const json = await res.json();
    if(json.success){
      const t = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      vm_setBadge('✅ Synced '+t);
    } else { vm_setBadge('⚠️ Sync error'); }
  } catch(e){ vm_setBadge('🔴 Offline'); }

  // Also sync to GitHub if connected
  if (vm_isGitHubConnected()) {
    await vm_githubPushToCloud();
  }

  vm_syncing = false;
}

// ══════════════════════════════════════════════════════════════
// GITHUB GIST SYNC - Free cloud storage using GitHub
// ══════════════════════════════════════════════════════════════
let vm_githubToken = localStorage.getItem('vm_github_token') || '';
let vm_githubGistId = localStorage.getItem('vm_github_gist_id') || '';
let vm_githubSyncing = false;
const GITHUB_API = 'https://api.github.com';

// Check if GitHub is connected
function vm_isGitHubConnected() {
  return !!vm_githubToken;
}

// Save GitHub token
function vm_saveGitHubToken(token) {
  vm_githubToken = token;
  localStorage.setItem('vm_github_token', token);
  vm_setBadge('✅ GitHub Connected');
}

// Save Gist ID
function vm_saveGistId(gistId) {
  vm_githubGistId = gistId;
  localStorage.setItem('vm_github_gist_id', gistId);
}

// GitHub Gist: Push data to cloud
async function vm_githubPushToCloud() {
  if (!vm_githubToken || vm_githubSyncing) return;
  vm_githubSyncing = true;
  vm_setBadge('🔄 Syncing to GitHub…');
  // Animate sync button
  const syncBtn = document.getElementById('vmBadgeSync');
  if (syncBtn) { syncBtn.style.animation = 'spin .7s linear infinite'; syncBtn.style.display = 'inline-block'; }

  try {
    const payload = {
      words: JSON.parse(localStorage.getItem('vm_words') || '[]'),
      userData: JSON.parse(localStorage.getItem('vm_user') || '{}'),
      quizHistory: JSON.parse(localStorage.getItem('vm_quiz_history') || '[]'),
      lastSync: new Date().toISOString()
    };

    const gistData = {
      description: 'VocabMaster Pro - Vocabulary Data Backup',
      public: false,
      files: {
        'vocabmaster-data.json': {
          content: JSON.stringify(payload, null, 2)
        }
      }
    };

    let url = `${GITHUB_API}/gists`;
    let method = 'POST';

    // If we already have a gist ID, update it
    if (vm_githubGistId) {
      url = `${GITHUB_API}/gists/${vm_githubGistId}`;
      method = 'PATCH';
    }

    const response = await fetch(url, {
      method: method,
      headers: {
        'Authorization': `token ${vm_githubToken}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify(gistData)
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.message || 'GitHub API error');
    }

    const result = await response.json();

    // Save gist ID if this is a new gist
    if (!vm_githubGistId && result.id) {
      vm_saveGistId(result.id);
    }

    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const wordCount = JSON.parse(localStorage.getItem('vm_words') || '[]').length;
    vm_setBadge('✅ Synced ' + time);
    vm_updateGitHubSyncBadge();
    showToast(`✅ Sync done! ${wordCount} word${wordCount !== 1 ? 's' : ''} saved to GitHub · ${time}`, 4000);

  } catch (error) {
    console.error('GitHub sync error:', error);
    if (error.message.includes('Bad credentials') || error.message.includes('Unauthorized')) {
      vm_setBadge('⚠️ Token invalid');
      showToast('GitHub token is invalid. Please check your token.');
    } else if (error.message.includes('Network') || error.message.includes('fetch')) {
      vm_setBadge('🔴 Offline');
    } else {
      vm_setBadge('⚠️ Sync failed');
      showToast('Sync failed: ' + error.message);
    }
  }

  vm_githubSyncing = false;
  // Stop spin animation
  const syncBtnEnd = document.getElementById('vmBadgeSync');
  if (syncBtnEnd) { syncBtnEnd.style.animation = ''; }
}



// GitHub Gist: Pull data from cloud
async function vm_githubPullFromCloud() {
  if (!vm_githubToken || !vm_githubGistId) {
    return false;
  }

  try {
    const response = await fetch(`${GITHUB_API}/gists/${vm_githubGistId}`, {
      headers: {
        'Authorization': `token ${vm_githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!response.ok) {
      throw new Error('Failed to fetch from GitHub');
    }

    const gist = response.json();
    const files = (await gist).files;
    const dataFile = files['vocabmaster-data.json'];

    if (!dataFile || !dataFile.content) {
      return false;
    }

    const data = JSON.parse(dataFile.content);

    if (data.words && data.words.length > 0) {
      localStorage.setItem('vm_words', JSON.stringify(data.words));
    }

    if (data.userData) {
      localStorage.setItem('vm_user', JSON.stringify(data.userData));
    }

    if (data.quizHistory && data.quizHistory.length > 0) {
      localStorage.setItem('vm_quiz_history', JSON.stringify(data.quizHistory));
    }

    const pulledCount = (data.words || []).length;
    const syncTime = data.lastSync ? new Date(data.lastSync).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
    showToast(`📥 Sync done! ${pulledCount} word${pulledCount !== 1 ? 's' : ''} loaded from GitHub${syncTime ? ' · Last saved ' + syncTime : ''}`, 4000);

    return true;

  } catch (error) {
    console.error('GitHub pull error:', error);
    return false;
  }
}

// GitHub login with token
async function vm_doGitHubLogin() {
  const tokenInput = document.getElementById('vmGithubToken');
  const errorEl = document.getElementById('vmGithubErr');
  const btn = document.getElementById('vmGithubBtn');

  const token = tokenInput ? tokenInput.value.trim() : '';

  if (!token) {
    if (errorEl) errorEl.textContent = '⚠️ Please enter your GitHub token';
    return;
  }

  if (errorEl) errorEl.textContent = '';
  if (btn) {
    btn.disabled = true;
    btn.textContent = '⏳ Connecting…';
  }

  try {
    // Test the token by getting user info
    const response = await fetch(`${GITHUB_API}/user`, {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!response.ok) {
      throw new Error('Invalid token');
    }

    const user = await response.json();

    // Save token and username
    vm_saveGitHubToken(token);
    vm_userName = user.login;
    localStorage.setItem('vm_uname', user.login);

    // Try to pull existing data
    if (vm_githubGistId) {
      await vm_githubPullFromCloud();
    }

    // Push initial data
    await vm_githubPushToCloud();

    // Close login and refresh UI
    const loginWrap = document.getElementById('vmGithubLoginWrap');
    if (loginWrap) loginWrap.style.display = 'none';

    vm_updateGitHubSyncBadge();
    vm_buildStats();
    updateHome();
    renderWords();

    if (btn) {
      btn.textContent = '✅ Connected!';
      setTimeout(() => {
        if (btn) btn.textContent = '🚀 Sign In with GitHub';
        btn.disabled = false;
      }, 2000);
    }

    showToast(`Connected as @${user.login}`);

  } catch (error) {
    console.error('GitHub login error:', error);
    if (errorEl) errorEl.textContent = '⚠️ Invalid token. Check your GitHub token.';
    if (btn) {
      btn.textContent = '🚀 Sign In with GitHub';
      btn.disabled = false;
    }
  }
}

// Update GitHub sync badge
function vm_updateGitHubSyncBadge() {
  const badge = document.getElementById('vmSyncBadge');
  if (badge && vm_isGitHubConnected()) {
    badge.innerHTML = `
      <div id="vmBadgeMain" onclick="vm_openProfile()">
        <span id="vmUserLabel">🐙 ${vm_userName || 'GitHub'}</span>
        <span id="vmSyncStatus">✅</span>
      </div>
      <span id="vmBadgeSync" onclick="vm_githubPushToCloud()" title="Sync now">↺</span>
    `;
  }
}

// GitHub logout
function vm_githubLogout() {
  if (!confirm('Disconnect GitHub account? Your local data will remain.')) return;

  vm_githubToken = '';
  vm_githubGistId = '';
  localStorage.removeItem('vm_github_token');
  localStorage.removeItem('vm_github_gist_id');

  const badge = document.getElementById('vmSyncBadge');
  if (badge) {
    badge.innerHTML = `
      <div id="vmBadgeMain" onclick="vm_openProfile()">
        <span id="vmUserLabel">👤</span>
        <span id="vmSyncStatus">🔄</span>
      </div>
    `;
  }

  showToast('GitHub disconnected');
  vm_buildStats();
}

// Auto-sync with GitHub (called periodically)
function vm_autoGitHubSync() {
  if (vm_isGitHubConnected()) {
    vm_githubPushToCloud();
  }
}

// ── Pull cloud data → Local ───────────────────────────────────
async function vm_pullFromCloud(userId){
  const res  = await fetch(`${VM_API}/api/user/${userId}`);
  const data = await res.json();
  if(data.error) throw new Error(data.error);
  if(data.words && data.words.length > 0){
    localStorage.setItem('vm_words',        JSON.stringify(data.words));
    localStorage.setItem('vm_user',         JSON.stringify(data.userData || {}));
    localStorage.setItem('vm_quiz_history', JSON.stringify(data.quizHistory || []));
    if(data.userName) { vm_userName = data.userName; localStorage.setItem('vm_uname', data.userName); }
    // Only update UI if app is already initialized (not during login flow)
    if(window._appReady) {
      words = data.words;
      rebuildExamPills(); updateHome(); renderWords();
    }
    return true;
  }
  return false;
}

function vm_setBadge(msg){
  const el=document.getElementById('vmSyncStatus'); if(el) el.textContent=msg;
  const heroEl=document.getElementById('heroSyncStatus'); if(heroEl) heroEl.textContent=msg;
}

// ── Word stats counter ────────────────────────────────────────
function vm_buildStats(){
  const w = JSON.parse(localStorage.getItem('vm_words') || '[]');
  const total = w.length;

  // By Exam
  const exams = {};
  w.forEach(x=>{ const e=x.examCategory||'Unknown'; exams[e]=(exams[e]||0)+1; });

  // By Type
  const types = {};
  w.forEach(x=>{ const t=x.wordType||'Unknown'; types[t]=(types[t]||0)+1; });

  // By Year
  const years = {};
  w.forEach(x=>{ const y=x.year||'Unknown'; years[y]=(years[y]||0)+1; });

  function makeRows(obj, colorVar){
    return Object.entries(obj).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`
      <div style="display:flex;justify-content:space-between;align-items:center;
        padding:7px 10px;border-radius:8px;background:rgba(255,255,255,.04);margin-bottom:4px">
        <span style="font-size:12px;color:#c8c8e8">${k}</span>
        <span style="font-size:13px;font-weight:700;color:${colorVar};
          background:rgba(255,255,255,.07);padding:2px 10px;border-radius:50px">${v}</span>
      </div>`).join('');
  }

  return `
  <div style="text-align:center;margin-bottom:18px">
    <div style="font-size:48px;font-weight:900;color:#f5c842;font-family:'Playfair Display',serif;line-height:1">${total}</div>
    <div style="font-size:12px;color:#9898b8;margin-top:2px">Total Words Saved</div>
  </div>

  <div style="margin-bottom:14px">
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;
      color:#7c6af7;margin-bottom:8px">📚 By Exam</div>
    ${makeRows(exams,'#f5c842')}
  </div>

  <div style="margin-bottom:14px">
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;
      color:#7c6af7;margin-bottom:8px">🏷️ By Type</div>
    ${makeRows(types,'#a78bfa')}
  </div>

  <div>
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;
      color:#7c6af7;margin-bottom:8px">📅 By Year</div>
    ${makeRows(years,'#34d399')}
  </div>`;
}

// ── Profile Panel ─────────────────────────────────────────────
function vm_openProfile(){
  document.getElementById('vmProfilePanel').style.display='flex';
  document.getElementById('vmProfileStats').innerHTML = vm_buildStats();
  const nameEl = document.getElementById('vmProfileNameDisp');
  if(nameEl) nameEl.textContent = vm_userName || 'No name set';
  const idEl = document.getElementById('vmProfileIdDisp');
  if(idEl) idEl.textContent = vm_userId;

  // Update GitHub connection UI
  const connectedDiv = document.getElementById('vmGitHubConnected');
  const loginDiv = document.getElementById('vmGitHubLogin');
  const userEl = document.getElementById('vmGitHubUser');

  if (vm_isGitHubConnected()) {
    if (connectedDiv) connectedDiv.style.display = 'block';
    if (loginDiv) loginDiv.style.display = 'none';
    if (userEl) userEl.textContent = '@' + (vm_userName || 'user');
  } else {
    if (connectedDiv) connectedDiv.style.display = 'none';
    if (loginDiv) loginDiv.style.display = 'block';
  }
}
function vm_closeProfile(){ document.getElementById('vmProfilePanel').style.display='none'; }

function vm_saveNameFromProfile(){
  const inp = document.getElementById('vmNameEditInp');
  const newName = inp ? inp.value.trim() : '';
  if(!newName){ showToast('Enter a name first!'); return; }
  vm_userName = newName;
  localStorage.setItem('vm_uname', newName);
  const el = document.getElementById('vmProfileNameDisp');
  if(el) el.textContent = newName;
  inp.value = '';
  // Update badge
  const lbl = document.getElementById('vmUserLabel');
  if(lbl) lbl.textContent = '👤 '+ newName;
  const hun = document.getElementById('heroUserName'); if(hun) hun.textContent = newName;
  // vm_pushToCloud(); // Manual sync only
  showToast('✅ Name saved! Tap sync button to sync.');
}

function vm_logout(){
  // Show custom confirm (native confirm() blocked in Android WebView)
  document.getElementById('vmLogoutConfirm').style.display='flex';
}

function vm_logoutConfirmed(){
  document.getElementById('vmLogoutConfirm').style.display='none';
  vm_userId   = null;
  vm_userName = '';
  localStorage.removeItem('vm_uid');

  // Remove existing login overlay if present
  const existing = document.getElementById('vmLoginWrap');
  if(existing) existing.remove();

  // Re-build login overlay using DOM (no template literals = no syntax errors)
  const savedName = localStorage.getItem('vm_uname') || '';
  const div = document.createElement('div');
  div.id = 'vmLoginWrap';
  div.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.93);display:flex;align-items:center;justify-content:center;z-index:999999;font-family:DM Sans,sans-serif';

  const box = document.createElement('div');
  box.id = 'vmBox';

  const icon = document.createElement('div');
  icon.style.cssText = 'font-size:52px;margin-bottom:4px';
  icon.textContent = '📚';

  const title = document.createElement('h2');
  title.textContent = 'VocabMaster Pro';

  const sub = document.createElement('p');
  sub.className = 'sub';
  sub.innerHTML = 'Sign in with your <b style="color:#f0eff8">10-digit User ID</b><br>to sync your vocabulary across all devices.<br><span class="hl">🆕 New? Just invent any 10-digit number!</span>';

  const nameInp = document.createElement('input');
  nameInp.id = 'vmNameInp'; nameInp.className = 'vm-inp'; nameInp.type = 'text';
  nameInp.maxLength = 30; nameInp.placeholder = 'Your name (e.g. Purendar)'; nameInp.value = savedName;

  const idInp = document.createElement('input');
  idInp.id = 'vmIdInp'; idInp.className = 'vm-inp'; idInp.type = 'tel';
  idInp.maxLength = 10; idInp.placeholder = '_ _ _ _ _ _ _ _ _ _';
  idInp.addEventListener('input', function(){ this.value = this.value.replace(/\D/g,'').slice(0,10); });

  const errDiv = document.createElement('div');
  errDiv.id = 'vmErr';

  const btn = document.createElement('button');
  btn.id = 'vmBtn'; btn.className = ''; btn.textContent = '🚀 Sign In & Sync';
  btn.style.cssText = 'width:100%;padding:14px;background:linear-gradient(135deg,#f5c842,#e8a020);color:#000;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:12px;font-family:DM Sans,sans-serif';
  btn.onclick = vm_doLogin;

  const note = document.createElement('div');
  note.className = 'vm-note'; note.textContent = 'Your 10-digit ID keeps your data private.';

  box.appendChild(icon); box.appendChild(title); box.appendChild(sub);
  box.appendChild(nameInp); box.appendChild(idInp); box.appendChild(errDiv);
  box.appendChild(btn); box.appendChild(note);
  div.appendChild(box);
  document.body.appendChild(div);

  // Close panels
  const pp = document.getElementById('vmProfilePanel');
  if(pp) pp.style.display='none';
  const hun = document.getElementById('heroUserName');
  if(hun) hun.textContent = '—';
  vm_setBadge('🔄 Connecting…');
}

function vm_logoutCancelled(){
  document.getElementById('vmLogoutConfirm').style.display='none';
}

// ══════════════════════════════════════════════════════════════
// LOGIN OVERLAY + PROFILE PANEL  (injected into DOM)
// ══════════════════════════════════════════════════════════════
(function vm_buildUI(){
  // ── Styles ────────────────────────────────────────────────
  const style = document.createElement('style');
  style.textContent = `
#vmLoginWrap{position:fixed;inset:0;background:rgba(0,0,0,.93);display:flex;
  align-items:center;justify-content:center;z-index:999999;font-family:'DM Sans',sans-serif}
#vmBox{background:#141420;border:2px solid #7c6af7;border-radius:22px;
  padding:36px 28px;max-width:400px;width:92%;text-align:center;color:#f0eff8;
  box-shadow:0 20px 60px rgba(124,106,247,.4)}
#vmBox h2{margin:8px 0 4px;color:#f5c842;font-family:'Playfair Display',serif;font-size:26px}
#vmBox .sub{color:#9898b8;font-size:13px;line-height:1.7;margin-bottom:18px}
#vmBox .hl{color:#f5c842}
.vm-inp{width:100%;padding:13px 16px;border-radius:12px;border:2px solid #7c6af7;
  background:#0e0e14;color:#f0eff8;font-size:15px;box-sizing:border-box;
  margin-bottom:10px;outline:none;font-family:'DM Sans',sans-serif;transition:border-color .2s}
.vm-inp:focus{border-color:#f5c842}
.vm-inp::placeholder{color:#5a5a78}
#vmIdInp{font-size:22px;text-align:center;letter-spacing:6px}
#vmErr{color:#f87171;font-size:13px;min-height:20px;margin-bottom:10px}
#vmBtn{width:100%;padding:14px;background:linear-gradient(135deg,#f5c842,#e8a020);
  color:#000;border:none;border-radius:12px;font-size:16px;font-weight:700;
  cursor:pointer;margin-bottom:12px;font-family:'DM Sans',sans-serif;transition:opacity .2s}
#vmBtn:hover{opacity:.88} #vmBtn:disabled{opacity:.45;cursor:default}
.vm-note{color:#5a5a78;font-size:11px}

#vmSyncBadge{position:fixed;bottom:72px;right:12px;z-index:99998;
  background:#1e1e30;border:1.5px solid #7c6af7;border-radius:10px;
  padding:8px 14px;color:#f0eff8;font-family:'DM Sans',sans-serif;font-size:11px;
  display:none;gap:8px;align-items:center;box-shadow:0 4px 20px rgba(124,106,247,.3)}
#vmBadgeMain{display:flex;gap:8px;align-items:center;cursor:pointer;flex:1}
#vmBadgeMain:hover .vmUserLabel{text-decoration:underline}
#vmBadgeSync{cursor:pointer;opacity:.6;font-size:13px;padding:2px 4px}
#vmBadgeSync:hover{opacity:1}

/* Profile panel */
#vmProfilePanel{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;
  align-items:flex-end;justify-content:center;z-index:999998;font-family:'DM Sans',sans-serif}
#vmProfileSheet{background:#141420;border:1px solid rgba(124,106,247,.4);
  border-radius:22px 22px 0 0;width:100%;max-width:480px;
  max-height:90vh;overflow-y:auto;padding:20px 20px 36px}
#vmProfileSheet::-webkit-scrollbar{display:none}
.vmp-handle{width:36px;height:4px;background:rgba(255,255,255,.12);border-radius:2px;margin:0 auto 18px}
.vmp-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.vmp-title{font-size:17px;font-weight:700;color:#f0eff8}
.vmp-close{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.08);
  border:none;color:#9898b8;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.vmp-close:hover{background:rgba(255,255,255,.14);color:#f0eff8}
.vmp-card{background:#1e1e30;border-radius:14px;border:1px solid rgba(255,255,255,.07);padding:14px 16px;margin-bottom:12px}
.vmp-lbl{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:#7c6af7;margin-bottom:6px}
.vmp-val{font-size:14px;color:#f0eff8;font-weight:600}
.vmp-id{font-size:13px;color:#9898b8;letter-spacing:3px;font-family:monospace}
.vmp-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.vmp-name-inp{flex:1;padding:9px 12px;border-radius:8px;border:1.5px solid rgba(124,106,247,.4);
  background:#0e0e14;color:#f0eff8;font-size:13px;outline:none;font-family:'DM Sans',sans-serif}
.vmp-name-inp:focus{border-color:#f5c842}
.vmp-name-inp::placeholder{color:#5a5a78}
.vmp-save-btn{padding:9px 16px;border-radius:8px;background:rgba(245,200,66,.15);
  border:1.5px solid rgba(245,200,66,.4);color:#f5c842;font-size:13px;font-weight:700;
  cursor:pointer;white-space:nowrap;font-family:'DM Sans',sans-serif}
.vmp-save-btn:hover{background:rgba(245,200,66,.25)}
.vmp-logout{width:100%;padding:13px;margin-top:6px;border-radius:12px;
  background:rgba(248,113,113,.1);border:1.5px solid rgba(248,113,113,.3);
  color:#f87171;font-size:14px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif}
.vmp-logout:hover{background:rgba(248,113,113,.2)}
`;
  // Logout confirm styles
  style.textContent += `
#vmLogoutConfirm{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;
  align-items:center;justify-content:center;z-index:9999999;font-family:'DM Sans',sans-serif}
#vmLogoutBox{background:#141420;border:2px solid rgba(248,113,113,.4);border-radius:18px;
  padding:28px 24px;max-width:320px;width:88%;text-align:center;color:#f0eff8;
  box-shadow:0 20px 50px rgba(0,0,0,.6)}
#vmLogoutBox .lob-icon{font-size:42px;margin-bottom:10px}
#vmLogoutBox .lob-title{font-size:17px;font-weight:700;margin-bottom:6px}
#vmLogoutBox .lob-sub{font-size:13px;color:#9898b8;line-height:1.6;margin-bottom:20px}
.lob-yes{width:100%;padding:13px;background:rgba(248,113,113,.15);border:1.5px solid rgba(248,113,113,.4);
  color:#f87171;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;
  font-family:'DM Sans',sans-serif;margin-bottom:8px}
.lob-yes:hover{background:rgba(248,113,113,.25)}
.lob-no{width:100%;padding:13px;background:rgba(52,211,153,.1);border:1.5px solid rgba(52,211,153,.3);
  color:#34d399;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;
  font-family:'DM Sans',sans-serif}
.lob-no:hover{background:rgba(52,211,153,.2)}
`;
  document.head.appendChild(style);

  // Logout confirm modal
  const logoutConfirm = document.createElement('div');
  logoutConfirm.id = 'vmLogoutConfirm';
  logoutConfirm.innerHTML = `
<div id="vmLogoutBox">
  <div class="lob-icon">🚪</div>
  <div class="lob-title">Log Out?</div>
  <div class="lob-sub">Your data is safely saved in<br>the cloud. You can sign back in<br>anytime with your 10-digit ID.</div>
  <button class="lob-yes" onclick="vm_logoutConfirmed()">Yes, Log Out</button>
  <button class="lob-no" onclick="vm_logoutCancelled()">Cancel — Stay In</button>
</div>`;
  document.body.appendChild(logoutConfirm);

  // ── Login overlay ─────────────────────────────────────────
  const loginDiv = document.createElement('div');
  loginDiv.id = 'vmLoginWrap';
  loginDiv.innerHTML = `
<div id="vmBox">
  <div style="font-size:52px;margin-bottom:4px">📚</div>
  <h2>VocabMaster Pro</h2>
  <p class="sub">
    Sign in with your <b style="color:#f0eff8">10-digit User ID</b><br>
    to sync your vocabulary across all devices.<br>
    <span class="hl">🆕 New? Just invent any 10-digit number!</span>
  </p>
  <input id="vmNameInp" class="vm-inp" type="text" maxlength="30"
    placeholder="Your name (e.g. Purendar)" />
  <input id="vmIdInp" class="vm-inp" type="tel" maxlength="10"
    placeholder="_ _ _ _ _ _ _ _ _ _"
    oninput="this.value=this.value.replace(/\\D/g,'').slice(0,10)" />
  <div id="vmErr"></div>
  <button id="vmBtn" onclick="vm_doLogin()">🚀 Sign In &amp; Sync</button>
  <div class="vm-note">Your 10-digit ID keeps your data private.</div>
</div>`;
  document.body.appendChild(loginDiv);

  // ── Sync badge ────────────────────────────────────────────
  const badge = document.createElement('div');
  badge.id = 'vmSyncBadge';
  badge.innerHTML = `
    <div id="vmBadgeMain" onclick="vm_openProfile()">
      <span id="vmUserLabel">👤</span>
      <span id="vmSyncStatus">🔄</span>
    </div>
    <span id="vmBadgeSync" onclick="vm_pushToCloud()" title="Sync now">↺</span>`;
  document.body.appendChild(badge);

  // ── Profile panel ─────────────────────────────────────────
  const panel = document.createElement('div');
  panel.id = 'vmProfilePanel';
  panel.onclick = e => { if(e.target===panel) vm_closeProfile(); };
  panel.innerHTML = `
<div id="vmProfileSheet">
  <div class="vmp-handle"></div>
  <div class="vmp-hdr">
    <div class="vmp-title">👤 My Profile</div>
    <button class="vmp-close" onclick="vm_closeProfile()">✕</button>
  </div>

  <div class="vmp-card">
    <div class="vmp-lbl">Name</div>
    <div class="vmp-val" id="vmProfileNameDisp">—</div>
    <div class="vmp-row">
      <input class="vmp-name-inp" id="vmNameEditInp" type="text" maxlength="30" placeholder="Change name…" />
      <button class="vmp-save-btn" onclick="vm_saveNameFromProfile()">Save</button>
    </div>
  </div>

  <div class="vmp-card">
    <div class="vmp-lbl">User ID</div>
    <div class="vmp-id" id="vmProfileIdDisp">—</div>
  </div>

  <!-- GitHub Sync Section -->
  <div class="vmp-card" id="vmGitHubCard">
    <div class="vmp-lbl">🐙 GitHub Sync</div>
    <div id="vmGitHubConnected" style="display:none;">
      <div class="vmp-val" id="vmGitHubUser">@username</div>
      <div style="font-size:11px;color:#9898b8;margin-top:4px;">Your data syncs to GitHub Gist</div>
      <button class="vmp-logout" onclick="vm_githubLogout()" style="margin-top:10px;">🔌 Disconnect GitHub</button>
    </div>
    <div id="vmGitHubLogin">
      <div style="font-size:11px;color:#9898b8;margin-bottom:8px;">Connect with GitHub to sync across devices</div>
      <input class="vmp-name-inp" id="vmGithubToken" type="password" placeholder="Paste your GitHub token..." />
      <div id="vmGithubErr" style="color:#f87171;font-size:11px;margin-top:4px;"></div>
      <button id="vmGithubBtn" onclick="vm_doGitHubLogin()" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;background:linear-gradient(135deg,#238636,#2ea043);border:none;color:#fff;font-size:13px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif">🚀 Connect GitHub</button>
      <div style="font-size:10px;color:#6868a0;margin-top:8px;line-height:1.4;">
        Don't have a token?<br/>
        <a href="https://github.com/settings/tokens/new?scopes=gist&description=VocabMaster" target="_blank" style="color:#58a6ff;">Create one here</a> (gist scope)
      </div>
    </div>

    <!-- Manual sync toggle -->
    <div style="margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);">
      <div style="font-size:11px;color:#9898b8;margin-bottom:8px;">⚙️ Sync Settings</div>
      <label style="display:flex;align-items:center;cursor:pointer;margin-bottom:8px;">
        <input type="checkbox" id="vmAutoSyncToggle" style="margin-right:8px;width:16px;height:16px;" />
        <span style="color:#ccc;font-size:12px;">Enable auto-sync (optional)</span>
      </label>
      <div style="font-size:10px;color:#6868a0;line-height:1.4;">
        Currently: Manual sync only. Tap the sync button to save your data.
      </div>
    </div>
  </div>

  <div class="vmp-card">
    <div class="vmp-lbl">📊 Word Count Stats</div>
    <div id="vmProfileStats" style="margin-top:8px"></div>
  </div>

  <button class="vmp-logout" onclick="vm_logout()">🚪 Log Out</button>
</div>`;
  document.body.appendChild(panel);

  // Pre-fill saved values
  const savedId   = localStorage.getItem('vm_uid');
  const savedName = localStorage.getItem('vm_uname');
  if(savedId)   document.getElementById('vmIdInp').value   = savedId;
  if(savedName) document.getElementById('vmNameInp').value = savedName;

  // Initialize auto-sync toggle (default: disabled for manual sync)
  const autoSyncToggle = document.getElementById('vmAutoSyncToggle');
  const savedAutoSync = localStorage.getItem('vm_autoSync');
  vm_autoSyncEnabled = savedAutoSync === null ? false : savedAutoSync === 'true';
  if(autoSyncToggle) {
    autoSyncToggle.checked = vm_autoSyncEnabled;
    autoSyncToggle.addEventListener('change', function() {
      vm_autoSyncEnabled = this.checked;
      localStorage.setItem('vm_autoSync', vm_autoSyncEnabled);
      showToast(vm_autoSyncEnabled ? '✅ Auto-sync enabled' : '⏸️ Manual sync mode');
    });
  }

  document.addEventListener('keydown', e => {
    if(e.key==='Enter' && document.getElementById('vmLoginWrap')) vm_doLogin();
  });

  // ── Auto-login on page refresh (if already logged in) ──────
  // This ensures page refresh does NOT log the user out
  const _autoId = localStorage.getItem('vm_uid');
  if(_autoId && /^\d{10}$/.test(_autoId)){
    // Auto login silently — show brief loading state
    const _btn = document.getElementById('vmBtn');
    if(_btn){ _btn.disabled=true; _btn.textContent='⏳ Reconnecting…'; }
    setTimeout(async ()=>{
      // Always set user identity immediately from localStorage
      vm_userId   = _autoId;
      vm_userName = localStorage.getItem('vm_uname') || '';

      try{
        const hadCloud = await vm_pullFromCloud(_autoId);
        vm_setBadge('✅ Reconnected');
        // if(!hadCloud) await vm_pushToCloud(); // Manual sync only
      } catch(e){
        // Server unreachable — continue with local data, sync later
        vm_setBadge('📵 Offline — local data loaded');
        console.warn('Auto-reconnect failed:', e.message);
      }

      // Always proceed to app regardless of server status
      const loginWrap = document.getElementById('vmLoginWrap');
      if(loginWrap) loginWrap.remove();
      const badge = document.getElementById('vmSyncBadge');
      if(badge) badge.style.display='none';
      const ul = document.getElementById('vmUserLabel');
      if(ul) ul.textContent = '👤 '+(vm_userName||_autoId);
      const hun = document.getElementById('heroUserName');
      if(hun) hun.textContent = vm_userName||_autoId;

      // Auto-sync with longer interval (5 minutes) to reduce API calls
      if (vm_autoSyncEnabled) {
        setInterval(vm_pushToCloud, vm_syncInterval);
      }
      setTimeout(vm_checkIncomingShares, 2000);
      setInterval(vm_checkIncomingShares, 120000);

      // GitHub auto-sync with longer interval (5 minutes) to reduce API calls
      if (vm_autoSyncEnabled) {
        setInterval(vm_autoGitHubSync, vm_syncInterval);
      }

      // Check for existing GitHub connection on load
      if (vm_isGitHubConnected()) {
        vm_updateGitHubSyncBadge();
        if (vm_githubGistId) {
          vm_githubPullFromCloud().then(success => {
            if (success) {
              showToast('📥 Synced from GitHub');
              renderWords();
              updateHome();
            }
          });
        }
      }

      init();
    }, 300);
  }
})();

async function vm_doLogin(){
  const idInp   = document.getElementById('vmIdInp');
  const nameInp = document.getElementById('vmNameInp');
  const errEl   = document.getElementById('vmErr');
  const btn     = document.getElementById('vmBtn');
  const id      = idInp.value.trim();
  const name    = nameInp.value.trim();

  if(!/^\d{10}$/.test(id)){ errEl.textContent='⚠️ Please enter exactly 10 digits.'; return; }

  errEl.textContent='';
  btn.disabled=true;
  btn.textContent='⏳ Connecting…';

  // Always save identity immediately
  vm_userId   = id;
  vm_userName = name || vm_userName || localStorage.getItem('vm_uname') || '';
  localStorage.setItem('vm_uid', id);
  if(vm_userName) localStorage.setItem('vm_uname', vm_userName);

  try{
    const hadCloud = await vm_pullFromCloud(id);
    vm_setBadge('✅ Connected');
    // if(!hadCloud) await vm_pushToCloud(); // Manual sync only
  } catch(e){
    // Server unreachable — continue with local data, retry sync later
    vm_setBadge('📵 Offline — using local data');
    errEl.textContent='⚠️ Server unreachable — loaded local data. Will sync when online.';
    console.warn('Login sync failed:', e.message);
  }

  // Always enter the app regardless of server status
  const loginWrap = document.getElementById('vmLoginWrap');
  if(loginWrap) loginWrap.remove();
  const badge = document.getElementById('vmSyncBadge');
  if(badge) badge.style.display = 'none';
  const ul = document.getElementById('vmUserLabel');
  if(ul) ul.textContent = '👤 ' + (vm_userName || id);
  const hun = document.getElementById('heroUserName');
  if(hun) hun.textContent = vm_userName || id;

  // Auto-sync with longer interval (5 minutes) to reduce API calls
  if (vm_autoSyncEnabled) {
    setInterval(vm_pushToCloud, vm_syncInterval);
  }
  setTimeout(vm_checkIncomingShares, 2000);
  setInterval(vm_checkIncomingShares, 120000);

  // GitHub auto-sync with longer interval (5 minutes) to reduce API calls
  if (vm_autoSyncEnabled) {
    setInterval(vm_autoGitHubSync, vm_syncInterval);
  }

  // Check for existing GitHub connection on load
  if (vm_isGitHubConnected()) {
    vm_updateGitHubSyncBadge();
    // Pull latest data from GitHub on page load
    if (vm_githubGistId) {
      vm_githubPullFromCloud().then(success => {
        if (success) {
          showToast('📥 Synced from GitHub');
          renderWords();
          updateHome();
        }
      });
    }
  }

  init();
}

// ============================================================
// OFFLINE AI CACHE  (IndexedDB, max 200 entries, 7-day TTL)
// ============================================================
const AI_CACHE_DB   = 'vmAICache';
const AI_CACHE_VER  = 1;
const AI_CACHE_MAX  = 200;
const AI_CACHE_TTL  = 7 * 24 * 60 * 60 * 1000; // 7 days in ms

// In-memory mirror for instant sync reads
const aiCache = new Map();

let _cacheDB = null;
function openCacheDB() {
  if (_cacheDB) return Promise.resolve(_cacheDB);
  return new Promise((res, rej) => {
    const req = indexedDB.open(AI_CACHE_DB, AI_CACHE_VER);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('words')) {
        const store = db.createObjectStore('words', { keyPath: 'word' });
        store.createIndex('ts', 'ts', { unique: false });
      }
    };
    req.onsuccess = e => { _cacheDB = e.target.result; res(_cacheDB); };
    req.onerror   = e => rej(e.target.error);
  });
}

async function cacheGet(word) {
  // Check in-memory first
  if (aiCache.has(word)) {
    const entry = aiCache.get(word);
    if (Date.now() - entry.ts < AI_CACHE_TTL) return entry.data;
    aiCache.delete(word);
  }
  try {
    const db    = await openCacheDB();
    const tx    = db.transaction('words', 'readonly');
    const store = tx.objectStore('words');
    const entry = await new Promise((res, rej) => {
      const req = store.get(word);
      req.onsuccess = e => res(e.target.result);
      req.onerror   = e => rej(e.target.error);
    });
    if (entry && Date.now() - entry.ts < AI_CACHE_TTL) {
      aiCache.set(word, entry);   // warm in-memory cache
      return entry.data;
    }
  } catch(e) { /* IndexedDB unavailable */ }
  return null;
}

async function cachePut(word, data) {
  const entry = { word, data, ts: Date.now() };
  aiCache.set(word, entry);
  try {
    const db    = await openCacheDB();
    const tx    = db.transaction('words', 'readwrite');
    const store = tx.objectStore('words');
    store.put(entry);
    // Evict oldest entries if over max
    const countReq = store.count();
    countReq.onsuccess = async () => {
      if (countReq.result > AI_CACHE_MAX) {
        const idx     = store.index('ts');
        const cursor  = idx.openCursor();
        let   removed = 0;
        const toRemove = countReq.result - AI_CACHE_MAX;
        cursor.onsuccess = e => {
          const cur = e.target.result;
          if (cur && removed < toRemove) { cur.delete(); removed++; cur.continue(); }
        };
      }
    };
  } catch(e) { /* IndexedDB unavailable, in-memory only */ }
}

// Preload entire cache into memory on startup
async function preloadCache() {
  try {
    const db    = await openCacheDB();
    const tx    = db.transaction('words', 'readonly');
    const store = tx.objectStore('words');
    const all   = await new Promise((res, rej) => {
      const req = store.getAll();
      req.onsuccess = e => res(e.target.result || []);
      req.onerror   = e => rej(e.target.error);
    });
    const now = Date.now();
    all.forEach(entry => {
      if (now - entry.ts < AI_CACHE_TTL) aiCache.set(entry.word, entry);
    });
    updateOfflineUI();
  } catch(e) { /* ignore */ }
}

// Online/offline detection
let isOnline = navigator.onLine;
window.addEventListener('online',  () => { isOnline = true;  updateOfflineUI(); showToast('🌐 Back online!'); scheduleAutoEnrich(); });
window.addEventListener('offline', () => { isOnline = false; updateOfflineUI(); showToast('📵 You are offline — using cached data'); });

function updateOfflineUI() {
  const badge  = document.getElementById('offlineBadge');
  const status = document.getElementById('offlineStatusBadge');
  if (badge)  badge.style.display  = isOnline ? 'none' : 'flex';
  if (status) status.innerHTML = isOnline
    ? '🟢 Online'
    : '🔴 Offline · ' + aiCache.size + ' cached';
  const pCache = document.getElementById('pCacheCount');
  if (pCache) pCache.textContent = aiCache.size;
}

function offlineError(word) {
  return {
    hindi: '—', hindiPhonetic: '', pos: 'unknown',
    definition: '📵 Offline — no cached data for "' + word + '". Connect to internet and re-open.',
    example: '', synonyms: [], antonyms: [], mnemonic: '',
    imagePrompt: word, roots: [], wordFamily: [], sentences: [], confusables: []
  };
}

// ============================================================
// API - POLLINATIONS  (with cache + offline fallback)
// ============================================================
async function fetchWordData(word) {
  // 1. Check cache first
  const cached = await cacheGet(word);
  if (cached) {
    console.log('[Cache HIT]', word);
    // Strip bad old Roman-script hindiPhonetic from cache
    if (cached.hindiPhonetic && !/[\u0900-\u097F]/.test(cached.hindiPhonetic)) cached.hindiPhonetic = '';
    return cached;
  }

  // 2. Offline with no cache
  if (!isOnline) { console.warn('[Offline]', word); return offlineError(word); }

  // 3. Fetch from AI
  const prompt = 'Return ONLY a raw JSON object for the English word "' + word + '". No markdown, no backticks, no explanation. Use this exact structure: {"hindi":"pure Devanagari MEANING only e.g. क्षणिक","hindiPhonetic":"how the English word SOUNDS in Devanagari e.g. एफेमरल / एफेमरेल (use / for variants)","pos":"noun","definition":"clear 1-2 sentence definition","example":"natural example sentence","synonyms":["s1","s2","s3"],"antonyms":["a1","a2"],"mnemonic":"creative memory trick","imagePrompt":"vivid visual scene","roots":[{"part":"prefix/root/suffix e.g. bene","meaning":"its meaning e.g. good","example":"another word using it e.g. benefit"}],"wordFamily":["' + word + ' (noun)","related form (verb)","related form (adj)","related form (adv)"],"sentences":["natural sentence 1 using ' + word + '","natural sentence 2 using ' + word + ' in different context","natural sentence 3 using ' + word + ' in exam-style context"],"confusables":[{"word":"similar-looking or similar-sounding word","difference":"one-line difference between it and ' + word + '"}]}';
  const hindiSys = 'You are a vocabulary assistant for Indian learners. Return ONLY raw JSON. The "hindi" field MUST be Devanagari meaning (e.g. क्षणिक). The "hindiPhonetic" field MUST be the English word written phonetically in Devanagari characters only (e.g. एफेमरल) — NEVER use Roman/English letters for these two fields. All other fields in English.';
  const res = await vmAI(prompt, hindiSys);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const text = await res.text();
  const match = text.match(/\{[\s\S]*\}/);
  if (!match) throw new Error('No JSON found');
  const parsed = JSON.parse(match[0]);
  if (!parsed.definition) throw new Error('Missing definition');

  // 4. Store in cache
  await cachePut(word, parsed);
  updateOfflineUI();
  return parsed;
}

function getImageUrl(prompt, seed) {
  return aiImageUrl(prompt + ' artistic illustration', { width: 400, height: 250, seed, model: 'flux' });
}

// Fetch phonetic Devanagari of how the English word SOUNDS (not its meaning)
// Returns format like "पर्फेक्ट / पर्फिक्ट" or "ग्रेट"
async function fetchHindiPronunciation(word) {
  const cacheKey = '__phonetic_' + word;
  const cached = await cacheGet(cacheKey);
  if (cached) {
    const hp = cached.hindiPhonetic || '';
    // Bad old cache with Roman script — fall through to re-fetch
    if (hp && !/[\u0900-\u097F]/.test(hp)) { /* re-fetch */ }
    else return hp;
  }
  if (!isOnline) return '';
  const prompt = 'Write the English word "' + word + '" phonetically in Devanagari script — exactly how a Hindi speaker would pronounce it, NOT its meaning. Give 1-2 phonetic variants separated by " / " if common variations exist. Examples: perfect → पर्फेक्ट / पर्फिक्ट, great → ग्रेट, ephemeral → एफेमरल, serendipity → सेरेन्डिपिटी. Return ONLY raw JSON: {"hindiPhonetic":"पर्फेक्ट / पर्फिक्ट"}. No markdown, no explanation.';
  const systemPrompt = 'You are a Hindi phonetics expert. Respond ONLY with a raw JSON object. The "hindiPhonetic" value MUST be written entirely in Devanagari script (e.g. पर्फेक्ट, ग्रेट, एफेमरल). NEVER use English or Roman letters for the phonetic value. No markdown, no backticks, no explanation.';
  const res = await vmAI(prompt, systemPrompt);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const text = (await res.text()).trim();
  const match = text.match(/\{[\s\S]*?\}/);
  if (!match) throw new Error('No JSON');
  const parsed = JSON.parse(match[0]);
  const hindiPhonetic = parsed.hindiPhonetic || '';
  // Validate: must contain Devanagari characters — discard if Roman
  if (hindiPhonetic && !/[\u0900-\u097F]/.test(hindiPhonetic)) return '';
  await cachePut(cacheKey, parsed);
  return hindiPhonetic;
}

async function fetchExamQuestions(exam, category, year) {
  const prompt = 'Generate 5 multiple choice questions for ' + exam + ' exam, category: ' + category + ', year: ' + year + '. Return ONLY a raw JSON array, no markdown, no backticks. Each item: {"question":"...","options":["a","b","c","d"],"answer":"correct option text","explanation":"brief explanation"}';
  const res = await vmAI(prompt);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const text = await res.text();
  const match = text.match(/\[[\s\S]*\]/);
  if (!match) throw new Error('No JSON array found');
  return JSON.parse(match[0]);
}

// ============================================================
// NAV & SCREENS
// ============================================================
function showScreen(id, btn) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nb').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  // Scroll to top for word/home screens
  const el = document.getElementById(id);
  if (el) el.scrollTop = 0;
}

// ============================================================
// HOME STATS
// ============================================================
function updateHome() {
  // levelDisplay removed
  document.getElementById('streakNum').textContent = userData.streak || 0;

  const now = Date.now();
  const hardW  = words.filter(w => w.srRating === 'hard'   || (!w.srRating && w.strength === 'weak'));
  const medW   = words.filter(w => w.srRating === 'medium' || (!w.srRating && w.strength === 'medium'));
  const easyW  = words.filter(w => w.srRating === 'easy'   || (!w.srRating && w.strength === 'strong'));
  const dueW   = words.filter(w => !w.nextReview || w.nextReview <= now);

  document.getElementById('totalW').textContent = words.length;

  // FIX: Update heroWordCount in header (was stuck at 0)
  const heroWordCountEl = document.getElementById('heroWordCount');
  if (heroWordCountEl) {
    heroWordCountEl.textContent = words.length + (words.length !== 1 ? ' Words' : ' Word');
  }

  document.getElementById('strongW').textContent = easyW.length;
  document.getElementById('dueW').textContent = dueW.length;

  const _goal = userData.dailyGoal || 10;
  const d = Math.min(userData.dailyReviewed || 0, _goal);
  document.getElementById('dailyRev').textContent = d;
  const _gd = document.getElementById('dailyGoalDisplay');
  if (_gd) _gd.textContent = _goal;
  document.getElementById('dailyFill').style.width = (d/_goal*100) + '%';

  // Memory Science
  const dueEl = document.getElementById('dueCount');
  if (dueEl) dueEl.textContent = dueW.length;
  const dueBanner = document.getElementById('dueBanner');
  const dueClear  = document.getElementById('dueClear');
  if (dueBanner) dueBanner.style.display = dueW.length > 0 ? 'flex' : 'none';
  if (dueClear)  dueClear.style.display  = dueW.length === 0 ? 'flex' : 'none';

  const tot = words.length || 1;
  const hp = (hardW.length/tot*100).toFixed(0);
  const mp = (medW.length/tot*100).toFixed(0);
  const ep = (easyW.length/tot*100).toFixed(0);

  const mmH = document.getElementById('mmHard');
  const mmM = document.getElementById('mmMed');
  const mmE = document.getElementById('mmEasy');
  if (mmH) mmH.style.width = hp + '%';
  if (mmM) mmM.style.width = mp + '%';
  if (mmE) mmE.style.width = ep + '%';

  const mmPct = document.getElementById('mmPct');
  if (mmPct) mmPct.textContent = words.length ? Math.round(easyW.length/tot*100) + '% mastered' : '—';

  const srH = document.getElementById('srHardN');
  const srM = document.getElementById('srMedN');
  const srE = document.getElementById('srEasyN');
  if (srH) srH.textContent = hardW.length;
  if (srM) srM.textContent = medW.length;
  if (srE) srE.textContent = easyW.length;

  updateHomeVocab();
}

function updateHomeVocab() {
  const section = document.getElementById('homeVocabSection');
  if (!section) return;

  // Always read fresh from the live words array
  const allWords = words || [];

  if (!allWords.length) {
    section.innerHTML = `<div style="text-align:center;padding:18px;background:var(--card);border-radius:var(--r);border:1px solid var(--border);color:var(--textMuted);font-size:12px">No words yet — import or add words to get started!</div>`;
    return;
  }

  // Group by exam — count total, mastered, and by type
  const examMap = {};
  allWords.forEach(function(w) {
    const exam = (w.examCategory || '').trim() || 'Uncategorized';
    if (!examMap[exam]) examMap[exam] = { total: 0, mastered: 0, types: {} };
    examMap[exam].total++;
    if (w.srRating === 'easy' || (!w.srRating && w.strength === 'strong')) examMap[exam].mastered++;
    const t = (w.wordType || '').trim() || 'General';
    examMap[exam].types[t] = (examMap[exam].types[t] || 0) + 1;
  });

  const examColors = {
    'SSC CGL':'#f5c842','SSC CHSL':'#5ab4f8','SSC CPO':'#f5923c',
    'SSC STENO':'#b09cff','SSC MTS':'#2ecc8a','SSC GD':'#f472b6',
    'SSC PHASE':'#60a5fa','RRB NTPC':'#f06e6e','Bank PO':'#7c6af7',
    'Railway':'#34d399','Uncategorized':'#a8a8d0'
  };
  const typeShort = {
    'Synonyms':'SYN','Antonyms':'ANT','Idioms & Phrases':'IDP',
    'One Word Substitution':'OWS','Homonyms':'HOM','General':'GEN'
  };

  // Sort exams by word count (most first)
  const sorted = Object.entries(examMap).sort(function(a,b){ return b[1].total - a[1].total; });

  let html = '';
  sorted.forEach(function(entry) {
    const exam = entry[0];
    const data = entry[1];
    const color = examColors[exam] || '#7c6af7';
    const mastPct = data.total > 0 ? Math.round(data.mastered / data.total * 100) : 0;

    // Type pills
    const typePills = Object.entries(data.types)
      .sort(function(a,b){ return b[1]-a[1]; })
      .map(function(te) {
        const tName = te[0], tCnt = te[1];
        const lbl = typeShort[tName] || tName.slice(0,3).toUpperCase();
        return '<span style="display:inline-flex;align-items:center;gap:3px;font-size:9px;padding:3px 8px;border-radius:50px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.13);color:var(--textSub);font-weight:700">'
          + lbl + ' <b style="color:var(--text)">' + tCnt + '</b></span>';
      }).join('');

    html += '<div onclick="goToExamWords(\'' + exam.replace(/'/g,"\\'") + '\')" '
      + 'style="background:var(--card);border:1.5px solid var(--border);border-left:3px solid ' + color + ';'
      + 'border-radius:var(--r);padding:12px 14px;cursor:pointer;-webkit-tap-highlight-color:transparent;"'
      + ' ontouchstart="this.style.opacity=\'.75\'" ontouchend="this.style.opacity=\'1\'">'

      // Row 1: exam name + count
      + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px">'
        + '<div style="display:flex;align-items:center;gap:8px;min-width:0;flex:1">'
          + '<div style="width:9px;height:9px;border-radius:50%;background:' + color + ';flex-shrink:0"></div>'
          + '<div style="font-size:14px;font-weight:800;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + exam + '</div>'
        + '</div>'
        + '<div style="display:flex;align-items:baseline;gap:4px;flex-shrink:0;margin-left:8px">'
          + '<span style="font-size:22px;font-weight:900;color:' + color + ';line-height:1">' + data.total + '</span>'
          + '<span style="font-size:10px;color:var(--textMuted);font-weight:600">words</span>'
          + '<span style="font-size:14px;color:var(--textMuted);margin-left:2px">›</span>'
        + '</div>'
      + '</div>'

      // Row 2: progress bar
      + '<div style="height:3px;background:var(--card2);border-radius:3px;overflow:hidden;margin-bottom:7px">'
        + '<div style="height:100%;width:' + mastPct + '%;background:' + color + ';border-radius:3px"></div>'
      + '</div>'

      // Row 3: type pills + mastered %
      + '<div style="display:flex;align-items:center;justify-content:space-between;gap:6px;flex-wrap:wrap">'
        + '<div style="display:flex;gap:4px;flex-wrap:wrap">' + (typePills || '<span style="font-size:10px;color:var(--textMuted)">No type set</span>') + '</div>'
        + '<div style="font-size:10px;color:var(--textMuted);font-weight:600;flex-shrink:0">' + mastPct + '% mastered</div>'
      + '</div>'

    + '</div>';
  });

  section.innerHTML = html;
}

function goToExamWords(exam) {
  // Switch to words screen and filter by exam
  showScreen('wordsScreen', document.querySelector('.nb:nth-child(2)'));
  wExam = exam;
  localStorage.setItem('vm_wExam', exam);
  // Open filter panel and highlight exam
  const panel = document.getElementById('wFilterPanel');
  if (panel) panel.style.display = 'block';
  setTimeout(() => {
    document.querySelectorAll('#wExamRow .wfpill').forEach(el => {
      const match = (el.getAttribute('onclick')||'').includes("'"+exam+"'");
      el.classList.toggle('active-exam', match);
    });
    updateFilterSummary();
    renderWords();
  }, 50);
}

// ============================================================
// EXAM QUIZ
// ============================================================
function selectExam(exam, el) {
  activeExam = exam;
  document.querySelectorAll('.exam-pill').forEach(function(e){e.classList.remove('active');});
  el.classList.add('active');
  rebuildYearPills(exam); // show only years with words for this exam
  qmUpdateHint();
}
function selectCat(cat, el) {
  activeCat = cat;
  document.querySelectorAll('.cat-pill').forEach(function(e){e.classList.remove('active');});
  el.classList.add('active');
  qmUpdateHint();
}
function selectYear(year, el) {
  activeYear = year;
  document.querySelectorAll('.year-pill').forEach(function(e){e.classList.remove('active');});
  el.classList.add('active');
  qmUpdateHint();
}
function qmFilteredWords() {
  return words.filter(function(w) {
    return (w.examCategory||'') === activeExam
      && (activeCat==='all' || (w.wordType||'')===activeCat)
      && (activeYear==='all' || (w.year||'')===activeYear);
  });
}
function qmUpdateHint() {
  var n = qmFilteredWords().length;
  var badge = document.getElementById('quizMatchBadge');
  if (badge) {
    badge.textContent = n + ' word' + (n!==1?'s':'');
    badge.style.background  = n>0?'rgba(52,211,153,.1)':'var(--card)';
    badge.style.color       = n>0?'var(--green)':'var(--textMuted)';
    badge.style.borderColor = n>0?'rgba(52,211,153,.3)':'var(--border)';
  }
  var hint = document.getElementById('quizBankHint');
  if (hint) {
    var cl = activeCat==='all'?'All Types':activeCat;
    var yl = activeYear==='all'?'All Years':activeYear;
    hint.innerHTML = n>0
      ? '<span style="color:var(--green)">&#10003; '+n+' words — '+cl+' · '+yl+' · '+activeExam+'</span>'
      : '<span style="color:var(--textMuted)">No words found — AI will generate</span>';
  }
  var btn = document.getElementById('quizStartBtn');
  if (btn) btn.textContent = n>0 ? '&#127919; Start Quiz ('+n+' words)' : '&#129302; Generate with AI';
}

async function loadExamQuiz() {
  var bank = qmFilteredWords();
  var cl = activeCat==='all'?'All Types':activeCat;
  var yl = activeYear==='all'?'All Years':activeYear;

  // Open modal with loading spinner
  document.getElementById('quizModal').classList.add('open');
  document.getElementById('qvQuestion').style.display = 'flex';
  document.getElementById('qvResult').style.display = 'none';
  document.getElementById('qmTitle').textContent = activeExam+' · '+cl+' · '+yl;
  document.getElementById('qmBody').innerHTML =
    '<div style="display:flex;align-items:center;justify-content:center;height:200px;flex-direction:column;gap:14px">'+
    '<div class="spin"></div><div style="font-size:13px;color:var(--textSub)">Building questions...</div></div>';
  document.getElementById('qmSkipBtn').style.display = 'none';
  document.getElementById('qmNextBtn').classList.remove('show');
  document.getElementById('qmSubmitBtn').classList.remove('show');
  document.getElementById('qmPrevBtn').disabled = true;

  var qs = [];
  if (bank.length > 0) {
    qs = qmBuildQuestions(bank);
  } else {
    try {
      var fc = activeCat==='all'?'Synonyms':activeCat;
      var fy = activeYear==='all'?'2024':activeYear;
      var raw = await fetchExamQuestions(activeExam, fc, fy);
      qs = raw.map(function(q){
        return {q:q.question, opts:q.options, ans:q.answer, tag:'syn', exp:q.explanation||''};
      });
    } catch(e) {
      document.getElementById('quizModal').classList.remove('open');
      showToast('Failed to load — add words first!');
      return;
    }
  }
  if (!qs.length) {
    document.getElementById('quizModal').classList.remove('open');
    showToast('No questions generated for this filter.');
    return;
  }

  examQuestions = qs;
  qmIdx = 0;
  qmAnswers = examQuestions.map(function(q){
    return {status:'unanswered', chosen:'', correct:q.ans, exp:q.exp||'', q:q.q, opts:q.opts.slice(), tag:q.tag||'syn'};
  });

  // Restore body DOM before rendering
  document.getElementById('qmBody').innerHTML =
    '<div class="qm-qtag-row"><span class="eq-tag syn" id="qmTag">Synonyms</span>'+
    '<span style="font-size:11px;color:var(--textMuted);font-weight:600" id="qmQNum">Q 1 / 1</span>'+
    '<button class="qm-opt-ask" id="qmAskAiBtn" style="display:none;margin-left:auto" onclick="qmAiOpenForOption()">\u2728 Ask AI</button></div>'+
    '<div class="qm-qtext" id="qmQText"></div>'+
    '<div class="qm-opts" id="qmOpts"></div>'+
    '<div class="qm-exp" id="qmExp"></div>'+
    '<div class="qm-ai-panel" id="qmAiPanel"></div>';

  qmDraw();
  qmSyncHeader();
}

function qmClose() {
  document.getElementById('quizModal').classList.remove('open');
}

var QM_TAGS = {syn:'Synonyms',ant:'Antonyms',iop:'Idioms & Phrases',ows:'One Word Sub.',hom:'Homonyms'};
var QM_ABC  = ['A','B','C','D','E'];

function qmDraw() {
  var q   = examQuestions[qmIdx];
  var ans = qmAnswers[qmIdx];
  var done = (ans.status !== 'unanswered');
  var tag  = q.tag || 'syn';

  var tagEl = document.getElementById('qmTag');
  if (tagEl) { tagEl.textContent = QM_TAGS[tag]||tag; tagEl.className='eq-tag '+tag; }
  var numEl = document.getElementById('qmQNum');
  if (numEl) numEl.textContent = 'Q '+(qmIdx+1)+' / '+examQuestions.length;
  var askBtn = document.getElementById('qmAskAiBtn');
  if (askBtn) askBtn.style.display = done ? '' : 'none';

  document.getElementById('qmQText').innerHTML = q.q||'';

  // Rebuild options using DOM (no inline onclick, no escaping issues)
  var optsEl = document.getElementById('qmOpts');
  optsEl.innerHTML = '';
  (q.opts||[]).forEach(function(opt, i) {
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'qm-opt';

    var ltr = document.createElement('span');
    ltr.className = 'qm-letter';
    ltr.textContent = QM_ABC[i] || String(i+1);
    btn.appendChild(ltr);

    var txt = document.createElement('span');
    txt.style.flex = '1';
    txt.textContent = opt;
    btn.appendChild(txt);

    if (done) {
      btn.disabled = true;
      if (opt === q.ans) btn.classList.add('q-correct');
      else if (opt === ans.chosen) btn.classList.add('q-wrong');
    } else {
      (function(o){ btn.addEventListener('click', function(){ qmAnswer(o); }); })(opt);
    }
    optsEl.appendChild(btn);
  });

  var expEl = document.getElementById('qmExp');
  if (done && q.exp) {
    expEl.innerHTML = '&#128161; ' + q.exp;
    expEl.classList.add('show');
  } else {
    expEl.innerHTML = '';
    expEl.classList.remove('show');
  }

  // Show or hide AI panel
  var aiPanel = document.getElementById('qmAiPanel');
  if (aiPanel) {
    if (done) {
      qmShowAiPanel(q, ans);
    } else {
      aiPanel.innerHTML = '';
      aiPanel.classList.remove('show');
    }
  }

  document.getElementById('qmBody').scrollTop = 0;
  qmSyncFooter();
}

function qmSyncHeader() {
  var total=examQuestions.length, corr=0, wrong=0, skip=0;
  qmAnswers.forEach(function(a){
    if(a.status==='correct') corr++;
    else if(a.status==='wrong') wrong++;
    else if(a.status==='skipped') skip++;
  });
  var left = total - corr - wrong - skip;
  document.getElementById('qmCorrN').textContent = corr;
  document.getElementById('qmWrongN').textContent = wrong;
  document.getElementById('qmSkipN').textContent  = skip;
  document.getElementById('qmLeftN').textContent  = left;
  var done_count = corr+wrong+skip;
  var pct = total>0 ? Math.round(done_count/total*100) : 0;
  document.getElementById('qmPfill').style.width = pct+'%';
  document.getElementById('qmPcnt').textContent  = pct+'%';
}

function qmSyncFooter() {
  var ans    = qmAnswers[qmIdx];
  var done   = ans && ans.status !== 'unanswered';
  var isLast = qmIdx === examQuestions.length - 1;
  var allDone= qmAnswers.every(function(a){ return a.status !== 'unanswered'; });

  document.getElementById('qmPrevBtn').disabled = (qmIdx === 0);
  document.getElementById('qmSkipBtn').style.display = done ? 'none' : '';

  var nextBtn   = document.getElementById('qmNextBtn');
  var submitBtn = document.getElementById('qmSubmitBtn');

  if (done && !isLast) { nextBtn.classList.add('show'); } else { nextBtn.classList.remove('show'); }
  if (allDone) { submitBtn.classList.add('show'); } else { submitBtn.classList.remove('show'); }
}

function qmAnswer(chosen) {
  var ans = qmAnswers[qmIdx];
  if (ans.status !== 'unanswered') return;
  var q  = examQuestions[qmIdx];
  var ok = chosen.trim() === (q.ans||'').trim();
  ans.status = ok ? 'correct' : 'wrong';
  ans.chosen = chosen;
  qmDraw();
  qmSyncHeader();
  showToast(ok ? '&#10003; Correct!' : '&#10060; ' + q.ans);
}

function qmSkip() {
  var ans = qmAnswers[qmIdx];
  if (ans.status !== 'unanswered') return;
  ans.status = 'skipped';
  qmDraw();
  qmSyncHeader();
  var next = -1;
  for (var i = qmIdx+1; i < examQuestions.length; i++) {
    if (qmAnswers[i].status === 'unanswered') { next = i; break; }
  }
  if (next !== -1) {
    setTimeout(function(){ qmIdx = next; qmDraw(); qmSyncHeader(); }, 500);
  }
}

function qmNext() {
  if (qmIdx < examQuestions.length - 1) { qmIdx++; qmDraw(); qmSyncHeader(); }
}
function qmPrev() {
  if (qmIdx > 0) { qmIdx--; qmDraw(); qmSyncHeader(); }
}

function qmSubmit() {
  var cl = activeCat==='all'?'All Types':activeCat;
  var yl = activeYear==='all'?'All Years':activeYear;
  var corr=0, wrong=0, skip=0;
  qmAnswers.forEach(function(a){
    if(a.status==='correct') corr++;
    else if(a.status==='wrong') wrong++;
    else if(a.status==='skipped') skip++;
  });
  var session = {
    id:Date.now(), date:new Date().toLocaleDateString(),
    exam:activeExam, cat:cl, year:yl,
    total:examQuestions.length, corr:corr, wrong:wrong, skip:skip,
    answers:JSON.parse(JSON.stringify(qmAnswers))
  };
  quizHistory.unshift(session);
  if (quizHistory.length > 50) quizHistory.length = 50;
  sSet('vm_quiz_history', JSON.stringify(quizHistory));
  qmShowResult(session);
}

function qmShowResult(session) {
  document.getElementById('qvQuestion').style.display = 'none';
  document.getElementById('qvResult').style.display = 'flex';
  var pct = session.total>0 ? Math.round(session.corr/session.total*100) : 0;
  var col = pct>=70?'var(--green)':pct>=50?'var(--orange)':'var(--red)';
  var grade = pct>=90?'&#127881; Excellent!':pct>=70?'&#129395; Great Job!':pct>=50?'&#128079; Good Effort':'&#128170; Keep Practising';
  var html =
    '<div class="qr-hero">'+
      '<div class="qr-big" style="color:'+col+'">'+session.corr+
        '<span style="font-size:28px;color:var(--textMuted)">/'+session.total+'</span></div>'+
      '<div style="font-size:14px;color:'+col+'">'+pct+'% score</div>'+
      '<div class="qr-grade">'+grade+'</div>'+
      '<div class="qr-meta">'+session.exam+' · '+session.cat+' · '+session.year+' · '+session.date+'</div>'+
    '</div>'+
    '<div class="qr-boxes">'+
      '<div class="qr-box"><div class="qr-box-n" style="color:var(--green)">'+session.corr+'</div><div class="qr-box-l">Correct</div></div>'+
      '<div class="qr-box"><div class="qr-box-n" style="color:var(--red)">'+session.wrong+'</div><div class="qr-box-l">Wrong</div></div>'+
      '<div class="qr-box"><div class="qr-box-n" style="color:var(--orange)">'+session.skip+'</div><div class="qr-box-l">Skipped</div></div>'+
    '</div>'+
    '<div class="qr-tabs" id="qrTabs">'+
      '<div class="qr-tab active" onclick="qmFilter(this,\'all\')">All ('+session.total+')</div>'+
      '<div class="qr-tab" onclick="qmFilter(this,\'correct\')" style="color:var(--green)">&#10003; Correct ('+session.corr+')</div>'+
      '<div class="qr-tab" onclick="qmFilter(this,\'wrong\')" style="color:var(--red)">&#10060; Wrong ('+session.wrong+')</div>'+
      '<div class="qr-tab" onclick="qmFilter(this,\'skipped\')" style="color:var(--orange)">&#9197; Skipped ('+session.skip+')</div>'+
    '</div>'+
    '<div id="qrList"></div>';
  document.getElementById('qrWrap').innerHTML = html;
  window._qmSess = session;
  qmFilterList(session.answers, 'all');
}

function qmFilter(el, f) {
  document.querySelectorAll('.qr-tab').forEach(function(t){t.classList.remove('active');});
  el.classList.add('active');
  qmFilterList(window._qmSess.answers, f);
}

function qmFilterList(answers, f) {
  var list = document.getElementById('qrList');
  if (!list) return;
  var rows = (f==='all') ? answers : answers.filter(function(a){return a.status===f;});
  if (!rows.length) {
    list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--textMuted);font-size:13px">No questions here</div>';
    return;
  }
  list.innerHTML = rows.map(function(a) {
    var col  = a.status==='correct'?'var(--green)':a.status==='wrong'?'var(--red)':'var(--orange)';
    var icon = a.status==='correct'?'&#10003; Correct':a.status==='wrong'?'&#10060; Wrong':'&#9197; Skipped';
    var tname= QM_TAGS[a.tag]||a.tag||'';
    var aline= a.status==='correct'
      ? 'Your answer: <b style="color:var(--green)">'+a.chosen+'</b>'
      : 'Correct: <b style="color:var(--green)">'+a.correct+'</b>'+(a.chosen?' &bull; You chose: <b style="color:var(--red)">'+a.chosen+'</b>':'');
    // Store answer in registry to avoid JSON-in-onclick escaping issues
    var regIdx = (window._qmAnswerReg = window._qmAnswerReg || []).push(a) - 1;
    var aiBtn = (a.status==='wrong'||a.status==='skipped')
      ? '<button onclick="askAIforWrongIdx('+regIdx+')" '+
        'style="margin-top:8px;width:100%;padding:7px 10px;border-radius:8px;border:1.5px solid rgba(124,106,247,.4);background:rgba(124,106,247,.1);color:var(--accent2);font-size:11px;font-weight:700;cursor:pointer;font-family:sans-serif">'+
        '✨ Ask AI — Why is this wrong?</button>'
      : '';
    return '<div class="qr-item is-'+a.status+'">'+
      '<div class="qr-item-status" style="color:'+col+'">'+icon+' · <span style="color:var(--textMuted)">'+tname+'</span></div>'+
      '<div class="qr-item-q">'+(a.q||'')+'</div>'+
      '<div class="qr-item-a">'+aline+(a.exp?'<br><span style="color:var(--textMuted);font-size:10px">&#128161; '+a.exp+'</span>':'')+'</div>'+
      aiBtn+
    '</div>';
  }).join('');
}

function qmRetry() {
  examQuestions = shuffle(examQuestions);
  qmIdx = 0;
  qmAnswers = examQuestions.map(function(q){
    return {status:'unanswered',chosen:'',correct:q.ans,exp:q.exp||'',q:q.q,opts:q.opts.slice(),tag:q.tag||'syn'};
  });
  document.getElementById('qvQuestion').style.display = 'flex';
  document.getElementById('qvResult').style.display = 'none';
  document.getElementById('qmBody').innerHTML =
    '<div class="qm-qtag-row"><span class="eq-tag syn" id="qmTag">Synonyms</span>'+
    '<span style="font-size:11px;color:var(--textMuted);font-weight:600" id="qmQNum">Q 1 / 1</span>'+
    '<button class="qm-opt-ask" id="qmAskAiBtn" style="display:none;margin-left:auto" onclick="qmAiOpenForOption()">\u2728 Ask AI</button></div>'+
    '<div class="qm-qtext" id="qmQText"></div>'+
    '<div class="qm-opts" id="qmOpts"></div>'+
    '<div class="qm-exp" id="qmExp"></div>'+
    '<div class="qm-ai-panel" id="qmAiPanel"></div>';
  qmDraw();
  qmSyncHeader();
}

function qmBuildQuestions(bank) {
  var qs = [];
  bank.forEach(function(w) {
    var t = (activeCat==='all') ? (w.wordType||'other') : activeCat;
    var q = qmMakeQ(w, t);
    if (q) qs.push(q);
  });
  return shuffle(qs).slice(0, 20);
}

function qmMakeQ(w, type) {
  // Use pre-built quiz options when available (builtin vocab has these ready)
  if (w.quizOptions && w.quizOptions.length >= 4 && w.quizCorrect) {
    var tagMap = {'Synonyms':'syn','Antonyms':'ant','One Word Substitution':'ows','Idioms & Phrases':'iop','Homonyms':'hom'};
    var tag = tagMap[w.wordType] || tagMap[type] || 'syn';
    var qt = type === 'Antonyms' ? 'Choose an ANTONYM of "'+w.word+'"' :
             type === 'Synonyms' ? 'Choose a SYNONYM of "'+w.word+'"' :
             type === 'One Word Substitution' ? 'One word substitution: "'+(w.definition && w.definition!=='—' ? w.definition : w.word)+'"' :
             type === 'Idioms & Phrases' ? 'What does "'+w.word+'" mean?' :
             'What is the meaning of "'+w.word+'"?';
    return {word:w.word, q:qt, opts:shuffle(w.quizOptions.slice()), ans:w.quizCorrect, tag:tag, exp:(w.definition && w.definition!=='—'?w.definition:'')};
  }
  var pool = words.filter(function(x){ return x.id !== w.id; });
  if (type === 'Synonyms') {
    if (w.synonyms && w.synonyms.length) {
      var cor = w.synonyms[Math.floor(Math.random()*Math.min(w.synonyms.length,3))];
      var wrg = qmWrongs(pool, cor, 'synonyms');
      if (wrg.length >= 3) return {word:w.word, q:'Choose a SYNONYM of "'+w.word+'"', opts:shuffle([cor,wrg[0],wrg[1],wrg[2]]), ans:cor, tag:'syn', exp:w.word+' synonyms: '+w.synonyms.join(', ')+(w.definition?' | '+w.definition:'')};
    }
    return qmDefQ(w, pool);
  }
  if (type === 'Antonyms') {
    if (w.antonyms && w.antonyms.length) {
      var cor = w.antonyms[Math.floor(Math.random()*Math.min(w.antonyms.length,3))];
      var wrg = qmWrongs(pool, cor, 'antonyms');
      if (wrg.length >= 3) return {word:w.word, q:'Choose an ANTONYM of "'+w.word+'"', opts:shuffle([cor,wrg[0],wrg[1],wrg[2]]), ans:cor, tag:'ant', exp:'Antonyms of '+w.word+': '+w.antonyms.join(', ')};
    }
    return qmDefQ(w, pool);
  }
  if (type === 'One Word Substitution') {
    if (w.definition && w.definition !== '-') {
      var wws = shuffle(pool.filter(function(x){return x.word&&x.word!=='(unknown)';}).map(function(x){return x.word;}));
      if (wws.length >= 3) return {word:w.word, q:'One word substitution: "'+w.definition+'"', opts:shuffle([w.word,wws[0],wws[1],wws[2]]), ans:w.word, tag:'ows', exp:'Answer: "'+w.word+'".'+(w.example?' '+w.example:'')};
    }
    return null;
  }
  if (type === 'Idioms & Phrases') {
    if (w.definition && w.definition !== '-') {
      var dfs = shuffle(pool.filter(function(x){return x.definition&&x.definition!==w.definition;}).map(function(x){return x.definition;}));
      if (dfs.length >= 3) return {word:w.word, q:'What does "'+w.word+'" mean?', opts:shuffle([w.definition,dfs[0],dfs[1],dfs[2]]), ans:w.definition, tag:'iop', exp:w.example?'Example: '+w.example:''};
    }
    return null;
  }
  if (type === 'Homonyms') {
    if (w.definition && w.definition !== '-') {
      var wws = shuffle(pool.filter(function(x){return x.word&&x.word!=='(unknown)';}).map(function(x){return x.word;}));
      if (wws.length >= 3) return {word:w.word, q:'Which word has this meaning: "'+w.definition+'"', opts:shuffle([w.word,wws[0],wws[1],wws[2]]), ans:w.word, tag:'hom', exp:w.example?'Example: '+w.example:''};
    }
    return null;
  }
  return qmDefQ(w, pool);
}

function qmDefQ(w, pool) {
  if (!w.definition || w.definition === '-') return null;
  var dfs = shuffle(pool.filter(function(x){return x.definition&&x.definition!==w.definition;}).map(function(x){return x.definition;}));
  if (dfs.length < 3) return null;
  return {word:w.word, q:'What is the meaning of "'+w.word+'"?', opts:shuffle([w.definition,dfs[0],dfs[1],dfs[2]]), ans:w.definition, tag:'syn', exp:w.word+': '+w.definition+(w.example?' | '+w.example:'')};
}

function qmWrongs(pool, correct, field) {
  var seen = {}, out = [];
  seen[correct] = 1;
  pool.forEach(function(w){
    (w[field]||[]).forEach(function(v){ if(v && !seen[v]){ seen[v]=1; out.push(v); } });
  });
  return shuffle(out);
}

// ============================================================
// QUIZ AI POPUP — explain, new question types, custom ask
// ============================================================
var _qmAiCtx = null;

function qmAiClose() {
  document.getElementById('qmAiPopup').classList.remove('open');
}

// Called when tapping ✨ Ask AI button next to question counter
function qmAiOpenForOption() {
  if (!examQuestions || qmIdx == null) return;
  var q   = examQuestions[qmIdx];
  var ans = qmAnswers[qmIdx];
  _qmAiCtx = { q: q, ans: ans };
  _qmAiBuildPopup(q, ans);
}

// Called by qmDraw after answering — no-op now (popup opened via buttons)
function qmShowAiPanel(q, ans) {
  var panel = document.getElementById('qmAiPanel');
  if (panel) { panel.innerHTML = ''; panel.classList.remove('show'); }
}

function _qmAiBuildPopup(q, ans) {
  var word   = q.word || q.ans || 'this word';
  var popup  = document.getElementById('qmAiPopup');
  var body   = document.getElementById('qmAiPopupBody');
  var titleEl = document.getElementById('qmAiPopupTitle');
  if (!popup || !body) return;

  titleEl.innerHTML = '\u2728 AI \u2014 <b style="color:var(--gold);font-family:\'Playfair Display\',serif">' + word + '</b>';

  body.innerHTML =
    '<div class="qm-ai-hdr">\uD83D\uDD0D Understand This Question</div>' +
    '<div class="qm-ai-chips">' +
      '<button class="qm-ai-chip" onclick="qmAiExplainOptions()">\uD83E\uDDE0 Why each option?</button>' +
      '<button class="qm-ai-chip" onclick="qmAiQuickFire(\'mnemonic\')">\uD83D\uDCA1 Memory trick</button>' +
      '<button class="qm-ai-chip" onclick="qmAiQuickFire(\'usage\')">\uD83D\uDCDA Usage in exam</button>' +
      '<button class="qm-ai-chip" onclick="qmAiQuickFire(\'hindi\')">\uD83C\uDDEE\uD83C\uDDF3 Hindi meaning</button>' +
    '</div>' +
    '<div class="qm-ai-hdr">\uD83C\uDFAF New Question on Same Word</div>' +
    '<div class="qm-nq-chips">' +
      '<button class="qm-nq-chip" onclick="qmAiNewQuestion(\'synonym\')">\uD83D\uDD17 Synonym</button>' +
      '<button class="qm-nq-chip" onclick="qmAiNewQuestion(\'antonym\')">\u2194\uFE0F Antonym</button>' +
      '<button class="qm-nq-chip" onclick="qmAiNewQuestion(\'fill\')">\u270F\uFE0F Fill Blank</button>' +
      '<button class="qm-nq-chip" onclick="qmAiNewQuestion(\'truefalse\')">\u2705 True/False</button>' +
      '<button class="qm-nq-chip" onclick="qmAiNewQuestion(\'sentence\')">\uD83D\uDCDD Spot the Use</button>' +
      '<button class="qm-nq-chip" onclick="qmAiNewQuestion(\'etymology\')">\uD83D\uDD24 Etymology</button>' +
    '</div>' +
    '<div class="qm-ai-hdr">\uD83D\uDCAC Ask Anything</div>' +
    '<div class="qm-ai-custom-row">' +
      '<input class="qm-ai-custom-inp" id="qmAiCustomInp" placeholder="e.g. Why is this wrong? Use in a sentence\u2026" onkeydown="if(event.key===\'Enter\')qmAiCustomAsk()">' +
      '<button class="qm-ai-custom-btn" onclick="qmAiCustomAsk()">Ask \u2192</button>' +
    '</div>' +
    '<div class="qm-ai-response" id="qmAiResponse"></div>' +
    '<div class="qm-ai-new-q" id="qmAiNewQ"></div>';

  popup.classList.add('open');
}

function _qmAiCtxStr() {
  if (!_qmAiCtx) return '';
  var q = _qmAiCtx.q, ans = _qmAiCtx.ans;
  var optsStr = (q.opts||[]).map(function(o,i){ return ['A','B','C','D'][i]+'. '+o; }).join(' | ');
  return 'Word: "' + (q.word||'(unknown)') + '" | Question: ' + q.q + ' | Options: ' + optsStr +
    ' | Correct answer: ' + q.ans + ' | Student chose: ' + (ans.chosen||'skipped') +
    ' | Question type: ' + (q.tag||'general') + ' | Explanation: ' + (q.exp||'');
}

async function _qmAiCall(prompt, loadingMsg) {
  var resp = document.getElementById('qmAiResponse');
  if (!resp) return;
  resp.className = 'qm-ai-response show';
  resp.innerHTML = '<div style="display:flex;align-items:center;gap:8px;padding:4px 0"><div class="spin" style="width:16px;height:16px;border-width:2px;flex-shrink:0"></div><span style="font-size:12px;color:var(--textSub)">' + (loadingMsg||'AI thinking…') + '</span></div>';
  resp.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  if (!isOnline) {
    resp.innerHTML = '<div style="text-align:center;padding:10px"><div style="font-size:24px;margin-bottom:6px">📵</div><div style="font-size:12px;color:var(--textMuted)">You are offline — connect to use AI features.</div></div>';
    return null;
  }
  try {
    const res = await vmAI(prompt);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return (await res.text()).trim();
  } catch(e) {
    resp.innerHTML = '<div style="color:var(--red);font-size:12px">❌ Failed to get AI response. Check your connection.</div>';
    return null;
  }
}

// ── 1. EXPLAIN ALL OPTIONS ──────────────────────────────────
async function qmAiExplainOptions() {
  if (!_qmAiCtx) return;
  var q = _qmAiCtx.q;
  var opts = (q.opts||[]);
  var optsStr = opts.map(function(o,i){ return ['A','B','C','D'][i]+') "'+o+'"'; }).join(', ');

  var prompt = 'Quiz question: ' + q.q + '\nOptions: ' + optsStr + '\nCorrect answer: "' + q.ans + '"\n\n' +
    'For an Indian competitive exam student (SSC/Bank), explain:\n' +
    '1. Why "' + q.ans + '" is CORRECT (2 sentences, clear reasoning)\n' +
    opts.filter(function(o){ return o !== q.ans; }).map(function(o,i){ return (i+2)+'. Why "'+o+'" is WRONG (1 concise sentence)'; }).join('\n') + '\n\n' +
    'Return ONLY raw JSON (no markdown, no backticks): {"correct":{"opt":"'+q.ans+'","why":"..."},"wrong":[{"opt":"option","why":"..."},{"opt":"option","why":"..."},{"opt":"option","why":"..."}]}';

  // Mark chip as loading
  document.querySelectorAll('#qmAiPanel .qm-ai-chip').forEach(function(c){ if(c.textContent.includes('Why each')) c.classList.add('loading'); });

  var text = await _qmAiCall(prompt, 'Analyzing all options…');
  document.querySelectorAll('#qmAiPanel .qm-ai-chip').forEach(function(c){ c.classList.remove('loading'); });
  if (!text) return;

  var resp = document.getElementById('qmAiResponse');
  try {
    var match = text.match(/\{[\s\S]*\}/);
    if (!match) throw new Error('no json');
    var data = JSON.parse(match[0]);
    var html = '<div style="font-size:11px;font-weight:700;color:var(--textMuted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px">📊 Option Analysis</div>';

    // Correct option
    if (data.correct) {
      html += '<div class="qm-ai-explain-row">' +
        '<div class="qm-ai-explain-badge" style="background:rgba(52,211,153,.2);color:var(--green)">✓</div>' +
        '<div class="qm-ai-explain-text"><b style="color:var(--green)">' + data.correct.opt + '</b> — ' + data.correct.why + '</div>' +
        '</div>';
    }
    // Wrong options
    (data.wrong||[]).forEach(function(w) {
      html += '<div class="qm-ai-explain-row">' +
        '<div class="qm-ai-explain-badge" style="background:rgba(248,113,113,.2);color:var(--red)">✗</div>' +
        '<div class="qm-ai-explain-text"><b style="color:var(--red)">' + w.opt + '</b> — ' + w.why + '</div>' +
        '</div>';
    });
    resp.innerHTML = html;
  } catch(e) {
    // Fallback: show plain text formatted
    resp.innerHTML = '<div style="font-size:12px;line-height:1.8">' + text.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<b>$1</b>') + '</div>';
  }
}

// ── 2. QUICK FIRE (mnemonic / usage / hindi) ───────────────
async function qmAiQuickFire(type) {
  if (!_qmAiCtx) return;
  var q = _qmAiCtx.q;
  var word = q.word || q.ans || 'this word';
  var ctx = _qmAiCtxStr();

  var prompts = {
    mnemonic: 'Give 2 vivid, funny mnemonics for an Indian exam student to remember the word "' + word + '" (correct answer: "' + q.ans + '"). Be creative and concise. Context: ' + ctx,
    usage: 'How does "' + word + '" typically appear in SSC CGL / Bank PO exams? Give 2 exam-style sentences and the most common trap. Context: ' + ctx,
    hindi: 'Give the Hindi meaning of "' + word + '" in Devanagari, 2 Hindi synonyms, and a simple Hindi sentence showing usage. Context: ' + ctx,
  };

  var labels = { mnemonic: 'Loading memory trick…', usage: 'Fetching exam tips…', hindi: 'Fetching Hindi…' };
  var chipLabels = { mnemonic: 'Memory trick', usage: 'Usage in exam', hindi: 'Hindi meaning' };

  document.querySelectorAll('#qmAiPanel .qm-ai-chip').forEach(function(c){ if(c.textContent.includes(chipLabels[type])) c.classList.add('loading'); });

  var text = await _qmAiCall(prompts[type], labels[type]);
  document.querySelectorAll('#qmAiPanel .qm-ai-chip').forEach(function(c){ c.classList.remove('loading'); });
  if (!text) return;

  var resp = document.getElementById('qmAiResponse');
  resp.innerHTML = '<div style="font-size:12px;line-height:1.8">' + text.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\*(.*?)\*/g,'<i>$1</i>').replace(/\n/g,'<br>') + '</div>';
}

// ── 3. GENERATE NEW QUESTION TYPE ─────────────────────────
async function qmAiNewQuestion(type) {
  if (!_qmAiCtx) return;
  var q = _qmAiCtx.q;
  var word = q.word || q.ans || 'ephemeral';

  var newQEl = document.getElementById('qmAiNewQ');
  var resp   = document.getElementById('qmAiResponse');
  if (!newQEl) return;

  // Clear previous new-question
  newQEl.className = 'qm-ai-new-q show';
  newQEl.innerHTML = '<div style="display:flex;align-items:center;gap:8px"><div class="spin" style="width:14px;height:14px;border-width:2px;flex-shrink:0"></div><span style="font-size:11px;color:var(--textSub)">Generating new question…</span></div>';
  newQEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  if (resp) { resp.className = 'qm-ai-response'; }

  if (!isOnline) {
    newQEl.innerHTML = '<div style="font-size:12px;color:var(--textMuted);text-align:center;padding:10px">📵 Offline — connect to generate new questions.</div>';
    return;
  }

  var typePrompts = {
    synonym:   'Generate 1 MCQ (4 options, 1 correct) asking a SYNONYM of the word "' + word + '". Return ONLY raw JSON: {"q":"question","opts":["a","b","c","d"],"ans":"correct option","exp":"brief explanation"}',
    antonym:   'Generate 1 MCQ (4 options, 1 correct) asking an ANTONYM of the word "' + word + '". Return ONLY raw JSON: {"q":"question","opts":["a","b","c","d"],"ans":"correct option","exp":"brief explanation"}',
    fill:      'Generate 1 fill-in-the-blank question using the word "' + word + '" in a sentence (blank it out with ___). Return ONLY raw JSON: {"q":"sentence with ___ blank","ans":"' + word + '","exp":"brief explanation why"}',
    truefalse: 'Generate 1 true/false question about the meaning or usage of "' + word + '" (make it challenging). Return ONLY raw JSON: {"q":"True or False: statement","ans":"True","exp":"explanation"}',
    sentence:  'Generate 1 MCQ: show 4 sentences, only one uses "' + word + '" correctly in context. Return ONLY raw JSON: {"q":"Which sentence uses \'' + word + '\' correctly?","opts":["sentence A","sentence B","sentence C","sentence D"],"ans":"correct sentence","exp":"why it is correct"}',
    etymology: 'Give the word roots/etymology of "' + word + '" and 3 related words from the same root family. Return ONLY raw JSON: {"roots":[{"part":"prefix/root","meaning":"its meaning","examples":["word1","word2"]}],"family":["related1","related2","related3"],"tip":"one-line memory tip using the root"}'
  };

  try {
    const res = await vmAI(typePrompts[type]);
    var text = (await res.text()).trim();
    var match = text.match(/\{[\s\S]*\}/);
    if (!match) throw new Error('no json');
    var data = JSON.parse(match[0]);

    var html = '<div style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--gold);margin-bottom:10px">';
    var typeLabels = {synonym:'🔗 Synonym Quiz',antonym:'↔️ Antonym Quiz',fill:'✏️ Fill in the Blank',truefalse:'✅ True / False',sentence:'📝 Spot the Correct Use',etymology:'🔤 Etymology & Roots'};
    html += typeLabels[type] + ' — <span style="color:var(--textSub)">' + word + '</span></div>';

    if (type === 'fill') {
      html += '<div class="qm-ai-new-q-text">' + data.q + '</div>';
      html += '<div style="display:flex;gap:8px;margin-bottom:8px">' +
        '<input class="qm-ai-custom-inp" id="qmFillInp" placeholder="Type the word..." autocorrect="off" autocapitalize="off" style="flex:1" onkeydown="if(event.key===\'Enter\')qmCheckFill(\''+word+'\')">' +
        '<button class="qm-ai-custom-btn" onclick="qmCheckFill(\''+word+'\')">✓</button>' +
        '</div>' +
        '<div id="qmFillResult" style="font-size:12px;font-weight:700;min-height:18px"></div>' +
        (data.exp ? '<div style="font-size:11px;color:var(--textSub);margin-top:6px;padding:6px 8px;background:var(--bg);border-radius:6px">💡 '+data.exp+'</div>' : '');

    } else if (type === 'truefalse') {
      html += '<div class="qm-ai-new-q-text">' + data.q + '</div>';
      html += '<div class="qm-ai-new-opts">';
      ['True','False'].forEach(function(opt) {
        html += '<button class="qm-ai-new-opt" onclick="qmCheckNQ(this,\''+opt+'\',\''+data.ans+'\',\''+data.exp.replace(/'/g,"\\'")+'\')">' +
          '<span style="width:26px;height:26px;border-radius:50%;background:var(--card2);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">' + (opt==='True'?'T':'F') + '</span>' +
          opt + '</button>';
      });
      html += '</div>';

    } else if (type === 'etymology') {
      html += '<div style="font-size:12px;line-height:1.8;color:var(--text)">';
      (data.roots||[]).forEach(function(r) {
        html += '<div style="margin-bottom:8px"><b style="color:var(--blue)">' + r.part + '</b> = ' + r.meaning;
        if (r.examples&&r.examples.length) html += ' <span style="color:var(--textMuted)">(e.g. ' + r.examples.join(', ') + ')</span>';
        html += '</div>';
      });
      if (data.family&&data.family.length) {
        html += '<div style="margin:8px 0 4px;font-size:10px;font-weight:700;color:var(--textMuted);text-transform:uppercase;letter-spacing:.6px">Word Family</div>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:5px">' + data.family.map(function(f){ return '<span class="wfam-chip">'+f+'</span>'; }).join('') + '</div>';
      }
      if (data.tip) html += '<div style="margin-top:10px;padding:8px 10px;background:rgba(245,200,66,.08);border:1px solid rgba(245,200,66,.2);border-radius:8px;font-size:11px;color:var(--goldLight)">💡 '+data.tip+'</div>';
      html += '</div>';

    } else {
      // MCQ-style (synonym, antonym, sentence)
      html += '<div class="qm-ai-new-q-text">' + data.q + '</div>';
      html += '<div class="qm-ai-new-opts">';
      var letters = ['A','B','C','D'];
      (data.opts||[]).forEach(function(opt, i) {
        var escapedOpt = opt.replace(/'/g,"\\'");
        var escapedAns = (data.ans||'').replace(/'/g,"\\'");
        var escapedExp = (data.exp||'').replace(/'/g,"\\'");
        html += '<button class="qm-ai-new-opt" onclick="qmCheckNQ(this,\''+escapedOpt+'\',\''+escapedAns+'\',\''+escapedExp+'\')">' +
          '<span style="width:26px;height:26px;border-radius:50%;background:var(--card2);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">' + letters[i] + '</span>' +
          opt + '</button>';
      });
      html += '</div>';
    }

    newQEl.innerHTML = html;
  } catch(e) {
    newQEl.innerHTML = '<div style="font-size:12px;color:var(--red);text-align:center;padding:8px">❌ Failed to generate question. Try again.</div>';
  }
}

// Check fill-in-the-blank answer
function qmCheckFill(word) {
  var inp = document.getElementById('qmFillInp');
  var res = document.getElementById('qmFillResult');
  if (!inp || !res) return;
  var typed = (inp.value||'').trim().toLowerCase();
  if (!typed) return;
  inp.disabled = true;
  if (typed === word.toLowerCase()) {
    inp.classList.add('correct');
    res.innerHTML = '<span style="color:var(--green)">✅ Correct!</span>';
    confetti();
  } else {
    inp.classList.add('wrong');
    res.innerHTML = '<span style="color:var(--red)">❌ Answer: </span><b style="color:var(--gold)">' + word + '</b>';
  }
}

// Check new MCQ / T-F answer
function qmCheckNQ(btn, chosen, correct, exp) {
  var container = btn.closest('.qm-ai-new-opts');
  if (!container) return;
  container.querySelectorAll('.qm-ai-new-opt').forEach(function(b){ b.disabled = true; });
  var isCorrect = chosen.trim().toLowerCase() === correct.trim().toLowerCase();
  if (isCorrect) {
    btn.classList.add('nq-correct');
    showToast('✅ Correct!');
    confetti();
  } else {
    btn.classList.add('nq-wrong');
    container.querySelectorAll('.qm-ai-new-opt').forEach(function(b){
      if ((b.textContent||'').trim().indexOf(correct.substring(0,20)) !== -1) b.classList.add('nq-correct');
    });
    showToast('❌ ' + correct);
  }
  if (exp) {
    var expDiv = document.createElement('div');
    expDiv.style.cssText = 'font-size:11px;color:var(--textSub);margin-top:10px;padding:8px 10px;background:var(--bg);border-radius:6px;line-height:1.65';
    expDiv.textContent = '💡 ' + exp;
    btn.closest('.qm-ai-new-q').appendChild(expDiv);
  }
}

// ── 4. CUSTOM ASK ──────────────────────────────────────────
async function qmAiCustomAsk() {
  if (!_qmAiCtx) return;
  var inp = document.getElementById('qmAiCustomInp');
  var question = (inp ? inp.value : '').trim();
  if (!question) { showToast('Type a question first!'); return; }

  var ctx = _qmAiCtxStr();
  var prompt = 'Context about the quiz question: ' + ctx + '\n\nStudent asks: ' + question + '\n\nAnswer helpfully in 3-5 sentences for an Indian competitive exam student. Be concise and direct.';

  var text = await _qmAiCall(prompt, 'AI answering…');
  if (!text) return;
  var resp = document.getElementById('qmAiResponse');
  resp.innerHTML = '<div style="font-size:12px;line-height:1.8">' + text.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\*(.*?)\*/g,'<i>$1</i>').replace(/\n/g,'<br>') + '</div>';
  if (inp) inp.value = '';
}

// ============================================================
// ADD MODAL SELECTORS
// ============================================================
function selAddExam(exam, el) {
  addWordExam = exam;
  document.querySelectorAll('#addExamRow .add-epill').forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
}
function selAddType(type, el) {
  addWordType = type;
  document.querySelectorAll('#addTypeRow .add-tpill').forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
}

// ============================================================
// ADD WORD
// ============================================================
function toggleAddOptional() {
  const fields = document.getElementById('addOptFields');
  const arrow  = document.getElementById('addOptArrow');
  const open   = fields.style.display === 'flex';
  fields.style.display = open ? 'none' : 'flex';
  if (arrow) arrow.style.transform = open ? '' : 'rotate(180deg)';
}

function openAdd() {
  document.getElementById('addInp').value = '';
  const yearSel = document.getElementById('addYear');
  if (yearSel) yearSel.value = '2025';
  document.getElementById('addLoading').style.display = 'none';
  // Reset optional fields
  ['addHindi','addDef','addExample','addSynonyms','addAntonyms','addMnemonic','addOpt1','addOpt2','addOpt3','addOpt4'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  // Reset correct option select
  const correctSel = document.getElementById('addCorrectOpt');
  if (correctSel) correctSel.value = '';
  // Collapse the optional section
  const fields = document.getElementById('addOptFields');
  const arrow  = document.getElementById('addOptArrow');
  if (fields) fields.style.display = 'none';
  if (arrow)  arrow.style.transform = '';
  // Reset exam pills
  document.querySelectorAll('#addExamRow .add-epill').forEach((e,i) => e.classList.toggle('sel', i===0));
  document.querySelectorAll('#addTypeRow .add-tpill').forEach((e,i) => e.classList.toggle('sel', i===0));
  addWordExam = 'SSC CGL'; addWordType = 'Synonyms';
  openM('addModal');
}

async function addWord() {
  const word = document.getElementById('addInp').value.trim().toLowerCase();
  if (!word) { showToast('Enter a word!'); return; }
  if (words.find(w => w.word === word)) { showToast('Word already exists!'); return; }

  // Read optional user-entered fields
  const userHindi    = (document.getElementById('addHindi')?.value   || '').trim();
  const userDef      = (document.getElementById('addDef')?.value     || '').trim();
  const userExample  = (document.getElementById('addExample')?.value || '').trim();
  const userSynRaw   = (document.getElementById('addSynonyms')?.value|| '').trim();
  const userAntRaw   = (document.getElementById('addAntonyms')?.value|| '').trim();
  const userMnemonic = (document.getElementById('addMnemonic')?.value|| '').trim();
  const userSyn = userSynRaw ? userSynRaw.split(',').map(s=>s.trim()).filter(Boolean) : null;
  const userAnt = userAntRaw ? userAntRaw.split(',').map(s=>s.trim()).filter(Boolean) : null;

  // Read quiz 4 options + correct answer index
  const o1 = (document.getElementById('addOpt1')?.value || '').trim();
  const o2 = (document.getElementById('addOpt2')?.value || '').trim();
  const o3 = (document.getElementById('addOpt3')?.value || '').trim();
  const o4 = (document.getElementById('addOpt4')?.value || '').trim();
  const correctOptIdx = parseInt(document.getElementById('addCorrectOpt')?.value || '0') || 0;
  const allOpts = [o1, o2, o3, o4];
  const allOptsFilled = allOpts.every(Boolean) && correctOptIdx >= 1 && correctOptIdx <= 4;
  const userQuizOptions  = allOptsFilled ? allOpts : [];
  const userQuizCorrect  = allOptsFilled ? allOpts[correctOptIdx - 1] : '';

  // Check if user filled everything — skip AI if so
  const hasAllData = userDef && userHindi && userExample && userSyn && userAnt;

  document.getElementById('addLoading').style.display = 'block';
  try {
    let data = {};
    if (!hasAllData) {
      // Fetch from AI — user blanks will be filled from AI result
      data = await fetchWordData(word);
    }

    const seed = Math.floor(Math.random() * 9999);
    const nw = {
      id: Date.now(), word,
      // User value takes priority; AI fills any blank
      hindi:        userHindi   ? cleanDevanagari(userHindi) || userHindi : cleanDevanagari(data.hindi) || '—',
      hindiPhonetic: data.hindiPhonetic || '',
      pos:          data.pos || 'other',
      definition:   userDef     || data.definition || '—',
      example:      userExample || data.example    || '—',
      synonyms:     userSyn     || data.synonyms   || [],
      antonyms:     userAnt     || data.antonyms   || [],
      mnemonic:     userMnemonic|| data.mnemonic   || '',
      imagePrompt:  data.imagePrompt || word,
      roots:        data.roots        || [],
      wordFamily:   data.wordFamily   || [],
      sentences:    data.sentences    || [],
      confusables:  data.confusables  || [],
      imgSeed: seed, imageUrl: getImageUrl(data.imagePrompt || word, seed),
      quizOptions: userQuizOptions,
      quizCorrect:  userQuizCorrect,
      collection:   document.getElementById('addColl').value || '',
      examCategory: addWordExam,
      wordType:     addWordType,
      year:         document.getElementById('addYear').value || '2025',
      strength: 'weak', reviewCount: 0, nextReview: Date.now(), addedAt: Date.now()
    };
    words.unshift(nw);
    saveWords(); closeM('addModal'); rebuildExamPills(); updateHome(); renderWords();
    setTimeout(scheduleAutoEnrich, 500);
    // Removed immediate sync - rely on auto-sync to reduce API calls
    // vm_pushToCloud(); // User can manually sync or wait for auto-sync
    const src = hasAllData ? '(your data used, no AI needed)' : '(AI enriched)';
    showToast('✨ "' + word + '" added! ' + src);
  } catch(e) {
    showToast('AI fetch failed: ' + e.message);
  }
  document.getElementById('addLoading').style.display = 'none';
}

// ============================================================
// WORDS 3-LEVEL FILTER
// ============================================================
// EXAMS list is now dynamic — populated by rebuildExamPills() from loaded vocab data
let EXAMS = ['SSC CGL','SSC CHSL','SSC STENO','SSC CPO','SSC PHASE','SSC MTS','SSC GD','RRB NTPC','Bank PO','Railway'];
const TYPES = ['Synonyms','Antonyms','Idioms & Phrases','One Word Substitution','Homonyms'];

function toggleFilters() {
  const panel = document.getElementById('wFilterPanel');
  const btn   = document.getElementById('filterToggleBtn');
  const icon  = document.getElementById('filterIcon');
  const open  = panel.style.display === 'none';
  panel.style.display = open ? 'block' : 'none';
  btn.style.borderColor  = open ? 'var(--gold)' : 'var(--border)';
  btn.style.background   = open ? 'rgba(245,200,66,.1)' : 'var(--card2)';
  btn.style.color        = open ? 'var(--gold)' : 'var(--textSub)';
  icon.textContent       = open ? '✕' : '⚙️';
}

function updateFilterSummary() {
  const parts = [];
  if (wExam !== 'all') parts.push(wExam.replace('SSC ',''));
  if (wYear !== 'all') parts.push(wYear);
  if (wType !== 'all') parts.push(wType === 'One Word Substitution' ? 'OWS' : wType === 'Idioms & Phrases' ? 'Idioms' : wType);
  if (wMem  !== 'all') parts.push(wMem === 'remembered' ? '✅' : '❌');
  const el = document.getElementById('filterSummary');
  const btn = document.getElementById('filterToggleBtn');
  if (el) el.textContent = parts.length ? parts.join(' · ') : 'Filter';
  if (btn) {
    const hasFilter = parts.length > 0;
    btn.style.borderColor = hasFilter ? 'rgba(245,200,66,.5)' : 'var(--border)';
    btn.style.color       = hasFilter ? 'var(--gold)' : 'var(--textSub)';
    btn.style.background  = hasFilter ? 'rgba(245,200,66,.08)' : 'var(--card2)';
  }
}

function setWExam(exam, el) {
  wExam = exam; wYear = 'all'; wType = 'all';
  localStorage.setItem('vm_wExam', exam);
  localStorage.setItem('vm_wYear', 'all');
  localStorage.setItem('vm_wType', 'all');
  updateFilterSummary();
  document.querySelectorAll('#wExamRow .wfpill').forEach(e => e.classList.remove('active-exam'));
  el.classList.add('active-exam');
  // Show/hide year + type blocks
  const showSub = exam !== 'all';
  document.getElementById('wYearBlock').style.display = showSub ? 'block' : 'none';
  document.getElementById('wTypeBlock').style.display = showSub ? 'block' : 'none';
  if (showSub) {
    // Rebuild year pills for this exam only (shows years that have words here)
    rebuildYearPills(exam);
    // Reset type pills
    document.querySelectorAll('#wTypeRow .wfpill').forEach((e,i) => e.classList.toggle('active-type', i===0));
    document.getElementById('wYearCustom').value = '';
  }
  renderWords();
}

function setWYear(year, el) {
  wYear = year;
  localStorage.setItem('vm_wYear', year);
  document.querySelectorAll('#wYearRow .wfpill').forEach(e => e.classList.remove('active-year'));
  el.classList.add('active-year');
  updateFilterSummary();
  renderWords();
}

function applyCustomYear(val) {
  const y = val.trim();
  if (y.length === 4 && /^\d{4}$/.test(y)) {
    wYear = y;
    document.querySelectorAll('#wYearRow .wfpill').forEach(e => e.classList.remove('active-year'));
    renderWords();
  }
}

function setWType(type, el) {
  wType = type;
  localStorage.setItem('vm_wType', type);
  document.querySelectorAll('#wTypeRow .wfpill').forEach(e => e.classList.remove('active-type'));
  el.classList.add('active-type');
  updateFilterSummary();
  renderWords();
}

function setWMem(mem, el) {
  wMem = mem;
  localStorage.setItem('vm_wMem', mem);
  document.querySelectorAll('#wMemRow .wfpill').forEach(e => {
    e.style.background = '';
    e.style.borderColor = '';
    e.style.color = '';
  });
  if (mem === 'remembered') {
    el.style.background = 'rgba(52,211,153,.2)';
    el.style.borderColor = 'var(--green)';
    el.style.color = 'var(--green)';
  } else if (mem === 'not_remembered') {
    el.style.background = 'rgba(248,113,113,.2)';
    el.style.borderColor = 'var(--red)';
    el.style.color = 'var(--red)';
  } else {
    el.style.background = 'rgba(52,211,153,.12)';
    el.style.borderColor = 'rgba(52,211,153,.3)';
    el.style.color = 'var(--green)';
  }
  renderWords();
}

function toggleRemember(id, event) {
  event.stopPropagation();
  const w = words.find(w => String(w.id) === String(id));
  if (!w) return;
  if (w.remembered === true) {
    w.remembered = false;
    showToast('❌ Marked as Not Remembered');
  } else {
    w.remembered = true;
    showToast('✅ Marked as Remembered!');
  }
  saveWords();
  renderWords();
}

// setColl removed — collection filter replaced by wMem/wExam/wYear/wType filters

function openAddFromFilter() {
  // Pre-fill Add modal with current filter selections
  openAdd();
  if (wExam !== 'all') {
    addWordExam = wExam;
    document.querySelectorAll('#addExamRow .add-epill').forEach(e => {
      e.classList.toggle('sel', e.textContent.trim() === wExam);
    });
  }
  if (wType !== 'all') {
    addWordType = wType;
    document.querySelectorAll('#addTypeRow .add-tpill').forEach(e => {
      e.classList.toggle('sel', e.textContent.trim() === wType || e.textContent.trim() === 'One Word Sub.' && wType === 'One Word Substitution');
    });
  }
  if (wYear !== 'all') {
    const yearSel = document.getElementById('addYear');
    if (yearSel) yearSel.value = wYear;
  }
}

function setWordsView(v) {
  wordsView = v;
  localStorage.setItem('vm_wordsView', v);
  document.getElementById('vtCard').classList.toggle('vt-active', v === 'card');
  document.getElementById('vtList').classList.toggle('vt-active', v === 'list');
  renderWords();
}

function setWSort(v) {
  wSortBy = v;
  localStorage.setItem('vm_wSortBy', v);
  renderWords();
}

// ── Update pill counts on all filter rows ─────────────────────
function vm_updatePillCounts() {
  // Count by exam (all words)
  const byExam = {}, byType = {}, byYear = {}, byMem = { remembered: 0, not_remembered: 0 };
  words.forEach(w => {
    const e = w.examCategory || ''; if(e) byExam[e] = (byExam[e]||0)+1;
    const t = w.wordType     || ''; if(t) byType[t] = (byType[t]||0)+1;
    const y = w.year         || ''; if(y) byYear[y] = (byYear[y]||0)+1;
    if(w.remembered === true) byMem.remembered++; else byMem.not_remembered++;
  });

  // Helper: update pill text to "Label COUNT"
  function setPillCount(rowId, labelMap) {
    const row = document.getElementById(rowId);
    if(!row) return;
    row.querySelectorAll('.wfpill').forEach(pill => {
      // Extract base label (strip old count badge if present)
      const base = pill.dataset.baseLabel || pill.textContent.replace(/\s*\d+$/, '').trim();
      pill.dataset.baseLabel = base;
      const key  = pill.dataset.filterKey || base;
      const cnt  = labelMap[key];
      if(cnt !== undefined && cnt > 0) {
        pill.innerHTML = base + ` <span style="
          display:inline-block;background:rgba(255,255,255,.13);
          color:inherit;border-radius:50px;font-size:9px;font-weight:800;
          padding:1px 6px;margin-left:3px;vertical-align:middle;opacity:.9">${cnt}</span>`;
      } else if(cnt === 0 || cnt === undefined) {
        pill.textContent = base; // no count if 0
      }
    });
  }

  // Assign data-filter-key to each pill so we know which key to count
  const examRow = document.getElementById('wExamRow');
  if(examRow) examRow.querySelectorAll('.wfpill').forEach(p => {
    if(!p.dataset.filterKey) p.dataset.filterKey = (p.dataset.baseLabel || p.textContent.trim()).replace(/\s*\d+$/,'').trim();
  });

  // Update exam row — show counts for each exam
  if(examRow) {
    examRow.querySelectorAll('.wfpill').forEach(pill => {
      const base = pill.dataset.baseLabel || pill.textContent.replace(/\s*\d+$/,'').trim();
      pill.dataset.baseLabel = base;
      const key  = base.replace('📚 ','');
      if(key === 'All') {
        pill.innerHTML = `📚 All <span style="display:inline-block;background:rgba(255,255,255,.13);color:inherit;border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:3px;opacity:.9">${words.length}</span>`;
      } else {
        const cnt = byExam[key] || 0;
        pill.innerHTML = cnt > 0
          ? `${base} <span style="display:inline-block;background:rgba(255,255,255,.13);color:inherit;border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:3px;opacity:.9">${cnt}</span>`
          : base;
      }
    });
  }

  // Year pills rebuilt by rebuildYearPills() — called on exam change

  // Type row — filter to current exam+year
  const typeRow = document.getElementById('wTypeRow');
  if(typeRow) {
    const scopeWords = words.filter(w => {
      const me = wExam === 'all' || (w.examCategory||'') === wExam;
      const my = wYear === 'all' || (w.year||'') === wYear;
      return me && my;
    });
    const tc = {}, totalScope = scopeWords.length;
    scopeWords.forEach(w => { const t=w.wordType||''; if(t) tc[t]=(tc[t]||0)+1; });
    typeRow.querySelectorAll('.wfpill').forEach(pill => {
      const base = pill.dataset.baseLabel || pill.textContent.replace(/\s*\d+$/,'').trim();
      pill.dataset.baseLabel = base;
      const typeKey = base === 'All Types' ? null
        : base === 'One Word Sub.' ? 'One Word Substitution'
        : base === 'Idioms & Phrases' ? 'Idioms & Phrases'
        : base;
      if(!typeKey) {
        pill.innerHTML = `All Types <span style="display:inline-block;background:rgba(255,255,255,.13);color:inherit;border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:3px;opacity:.9">${totalScope}</span>`;
      } else {
        const cnt = tc[typeKey] || 0;
        pill.innerHTML = cnt > 0
          ? `${base} <span style="display:inline-block;background:rgba(255,255,255,.13);color:inherit;border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:3px;opacity:.9">${cnt}</span>`
          : base;
      }
    });
  }

  // Memory row
  const memRow = document.getElementById('wMemRow');
  if(memRow) {
    const memPillAll = document.getElementById('memPillAll');
    const memPillYes = document.getElementById('memPillYes');
    const memPillNo  = document.getElementById('memPillNo');
    const badge = c => `<span style="display:inline-block;background:rgba(255,255,255,.13);color:inherit;border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:3px;opacity:.9">${c}</span>`;
    if(memPillAll) memPillAll.innerHTML = `📚 All ${badge(words.length)}`;
    if(memPillYes) memPillYes.innerHTML = `✅ Remembered ${badge(byMem.remembered)}`;
    if(memPillNo)  memPillNo.innerHTML  = `❌ Not Remembered ${badge(byMem.not_remembered)}`;
  }
}

function renderWords() {
  // Always sync toggle buttons to current wordsView (handles page load + navigation)
  const vtCard = document.getElementById('vtCard');
  const vtList = document.getElementById('vtList');
  if (vtCard) vtCard.classList.toggle('vt-active', wordsView === 'card');
  if (vtList) vtList.classList.toggle('vt-active', wordsView === 'list');

  const search = (document.getElementById('searchInp')?.value || '').toLowerCase();
  let filtered = words.filter(w => {
    const ms = !search || w.word.includes(search) || (w.definition||'').toLowerCase().includes(search);
    const me = wExam === 'all' || (w.examCategory || '') === wExam;
    const my = wYear === 'all' || (w.year || '') === wYear;
    const mt = wType === 'all' || (w.wordType || '') === wType;
    const mm = wMem === 'all' || (wMem === 'remembered' ? w.remembered === true : w.remembered !== true);
    return ms && me && my && mt && mm;
  });
  // ── Sort filtered words ────────────────────────────────────────
  const _sortSel = document.getElementById('wSortSel');
  if (_sortSel) _sortSel.value = wSortBy;
  const now_ts = Date.now();
  if      (wSortBy === 'newest')        filtered.sort((a,b) => (b.addedAt||0) - (a.addedAt||0));
  else if (wSortBy === 'oldest')        filtered.sort((a,b) => (a.addedAt||0) - (b.addedAt||0));
  else if (wSortBy === 'az')            filtered.sort((a,b) => (a.word||'').localeCompare(b.word||''));
  else if (wSortBy === 'za')            filtered.sort((a,b) => (b.word||'').localeCompare(a.word||''));
  else if (wSortBy === 'weak')          filtered.sort((a,b) => {const o={hard:0,medium:1,easy:2};return (o[a.srRating]??0)-(o[b.srRating]??0);});
  else if (wSortBy === 'strong')        filtered.sort((a,b) => {const o={hard:0,medium:1,easy:2};return (o[b.srRating]??0)-(o[a.srRating]??0);});
  else if (wSortBy === 'due')           filtered.sort((a,b) => (a.nextReview||0) - (b.nextReview||0));
  else if (wSortBy === 'most_reviewed') filtered.sort((a,b) => (b.reviewCount||0) - (a.reviewCount||0));

  // Update word count label — preserve enrich stop/start button if enrichment is active
  const _wcLbl = document.getElementById('wcLabel');
  if (_wcLbl) {
    const _enrichActive = _enrichRunning || _enrichPaused || _enrichQueue.length > 0;
    if (!_enrichActive) {
      _wcLbl.textContent = filtered.length + ' word' + (filtered.length !== 1 ? 's' : '');
    } else {
      // Just update the count prefix, keep the button intact by calling badge updater
      _updateEnrichBadge(_enrichQueue.length, null);
    }
  }
  vm_updatePillCounts();
  const list = document.getElementById('wordsList');

  // Update Add Word button label based on filter
  const btn = document.getElementById('wAddBtn');
  if (btn) {
    const parts = [];
    if (wExam !== 'all') parts.push(wExam);
    if (wType !== 'all') parts.push(wType.split(' ')[0]);
    btn.textContent = parts.length ? '+ Add ' + parts.join(' · ') : '+ Add Word';
  }

  if (!filtered.length) {
    const hint = (wExam !== 'all')
      ? `No "${wType !== 'all' ? wType : 'words'}" found${wYear !== 'all' ? ' for ' + wYear : ''} in ${wExam}`
      : 'Add your first word using the button above';
    list.innerHTML = `<div class="empty fadein"><div class="empty-icon">📖</div><div class="empty-title">${words.length ? 'No Match' : 'No Words Yet'}</div><div style="font-size:12px;color:var(--textMuted);margin-top:6px;line-height:1.6;max-width:220px">${hint}</div></div>`;
    return;
  }

  // ── RENDER based on view mode ──────────────────────────────
  if (wordsView === 'list') {
    // LIST VIEW — compact, word + pronunciation only
    list.innerHTML = '<div style="background:var(--card);border-radius:var(--rsm);border:1px solid var(--border);margin:0 12px;overflow:hidden">' +
      filtered.map((w, i) => {
        const isDue = !w.nextReview || w.nextReview <= Date.now();
        const sr = w.srRating || (w.strength === 'strong' ? 'easy' : w.strength === 'medium' ? 'medium' : w.strength === 'weak' ? 'hard' : null);
        const srColor = {hard:'var(--red)',medium:'var(--orange)',easy:'var(--green)'}[sr] || 'transparent';
        const hindiMeaning = cleanDevanagari(w.hindi || '') || w.hindi || '';
        const showMeaning = hindiMeaning && hindiMeaning !== '—';
        const showPhonetic = w.hindiPhonetic && w.hindiPhonetic !== '';
        const hindiShort = showPhonetic ? w.hindiPhonetic : (showMeaning ? hindiMeaning : '');
        const owsListWord = (w.wordType === 'One Word Substitution' && w.quizCorrect && w.quizCorrect !== w.word) ? w.quizCorrect : w.word;
        return `<div class="lv-item fadein" onclick="openDetail('${w.id}')">
          <div class="lv-num">${i + 1}</div>
          ${isDue && sr ? '<div class="lv-due"></div>' : '<div style="width:5px;flex-shrink:0"></div>'}
          <div class="lv-word" style="color:${sr==='hard'?'var(--red)':sr==='medium'?'var(--gold)':sr==='easy'?'var(--green)':'var(--text)'}">${owsListWord || '—'}</div>
          ${hindiShort ? `<span class="lv-sep">·</span><div class="lv-pron">${hindiShort}</div>` : (owsListWord !== w.word ? `<span class="lv-sep">·</span><div class="lv-pron" style="color:var(--textMuted);font-family:'DM Sans',sans-serif;font-style:italic">${w.word}</div>` : '<div style="flex:1"></div>')}
          ${sr ? `<span class="lv-badge" style="background:rgba(${sr==='hard'?'248,113,113':sr==='medium'?'251,146,60':'52,211,153'},.12);color:${srColor};border:1px solid rgba(${sr==='hard'?'248,113,113':sr==='medium'?'251,146,60':'52,211,153'},.3)">${sr==='hard'?'H':sr==='medium'?'M':'E'}</span>` : ''}
          <button class="lv-del btn btn-danger btn-sm" onclick="event.stopPropagation();delWord('${w.id}')" title="Delete word" style="padding:4px 8px;font-size:11px;margin-left:4px">🗑️</button>
          <div class="lv-arrow">›</div>
        </div>`;
      }).join('') + '</div>\n';
  } else {
    // CARD VIEW — full detail cards
    list.innerHTML = filtered.map(w => {
      const sr = w.srRating || (w.strength === 'strong' ? 'easy' : w.strength === 'medium' ? 'medium' : w.strength === 'weak' ? 'hard' : null);
      const srBadge = sr ? {
        hard:   '<span class="str-badge str-h">😓 Hard</span>',
        medium: '<span class="str-badge str-m">🤔 Medium</span>',
        easy:   '<span class="str-badge str-e">😊 Easy</span>',
      }[sr] : '';

      const isDue = !w.nextReview || w.nextReview <= Date.now();
      const dueDot = isDue && sr ? '🔴 ' : '';

      const typeColors = {Synonyms:'34,211,153',Antonyms:'248,113,113','Idioms & Phrases':'96,165,250','One Word Substitution':'167,139,250',Homonyms:'251,146,60'};
      const tc = typeColors[w.wordType] || '152,152,184';
      const examTag = w.examCategory ? `<span style="font-size:9px;padding:2px 8px;border-radius:50px;background:rgba(245,200,66,.12);color:var(--gold);border:1px solid rgba(245,200,66,.3);font-weight:700">${w.examCategory}</span>` : '';
      const typeTag = w.wordType ? `<span style="font-size:9px;padding:2px 8px;border-radius:50px;background:rgba(${tc},.12);color:rgb(${tc});border:1px solid rgba(${tc},.3);font-weight:700">${w.wordType}</span>` : '';
      const yearTag = w.year ? `<span style="font-size:9px;padding:2px 8px;border-radius:50px;background:var(--card2);color:var(--textMuted);border:1px solid var(--border);font-weight:600">📅${w.year}</span>` : '';
      const remBadge = w.remembered === true
        ? `<span class="rmem-badge rmem-yes">✅ Remembered</span>`
        : w.remembered === false
          ? `<span class="rmem-badge rmem-no">❌ Not Remembered</span>`
          : '';
      const metaRow = (examTag || typeTag || yearTag || srBadge || remBadge)
        ? `<div style="display:flex;gap:5px;flex-wrap:wrap;padding:0 12px 9px;margin-top:-2px;align-items:center">${srBadge}${remBadge}${examTag}${typeTag}${yearTag}</div>` : '';
      const remBtnLabel = w.remembered === true ? '✅ Remembered' : '☑️ Remember';
      const remBtnClass = w.remembered === true ? 'btn btn-remember btn-sm' : 'btn btn-ghost btn-sm';
      const hindiMeaning = cleanDevanagari(w.hindi||'')||w.hindi||'';
      const ph = w.hindiPhonetic ? ' · <span style="font-family:\'DM Sans\',sans-serif;font-style:italic;font-size:10px;opacity:.7">' + w.hindiPhonetic + '</span>' : '';
      const hindiDisplay = (hindiMeaning && hindiMeaning !== '—') ? hindiMeaning + ph : '<span style="opacity:.35;font-size:11px;font-family:\'DM Sans\',sans-serif">Tap 🤖 AI to enrich</span>';
      const defDisplay = (w.definition && w.definition !== '—') ? w.definition : (w.wordType === 'One Word Substitution' && w.quizCorrect && w.quizCorrect !== w.word ? w.word : '<span style="opacity:.4">No definition yet</span>');
      const owsCardWord = (w.wordType === 'One Word Substitution' && w.quizCorrect && w.quizCorrect !== w.word) ? w.quizCorrect : w.word;
      const owsSubtitle = (w.wordType === 'One Word Substitution' && w.quizCorrect && w.quizCorrect !== w.word) ? `<div style="font-size:10px;color:var(--textMuted);font-style:italic;margin-top:1px;line-height:1.3">${w.word}</div>` : '';
      return `
      <div class="witem fadein" onclick="openDetail('${w.id}')">
        <div class="wtop">
          ${w.imageUrl ? `<img class="wimg" src="${w.imageUrl}" onerror="this.style.display='none'" alt="">` : `<div class="wph">📝</div>`}
          <div class="winfo">
            <div style="display:flex;align-items:center;gap:6px">
              <div class="wword" style="color:${sr==='hard'?'var(--red)':sr==='medium'?'var(--gold)':sr==='easy'?'var(--green)':'var(--text)'}">${dueDot}${owsCardWord}</div>
            </div>
            ${owsSubtitle}
            <div class="whindi">${hindiDisplay}</div>
            <div class="wdef">${defDisplay}</div>
          </div>
          <span class="badge ${posClass(w.pos)}" style="flex-shrink:0;align-self:flex-start;margin-top:2px">${w.pos||'—'}</span>
        </div>
        ${metaRow}
        <div class="wacts" onclick="event.stopPropagation()">
          <button class="${remBtnClass}" onclick="toggleRemember('${w.id}', event)">${remBtnLabel}</button>
          ${w.remembered === true ? `<button class="btn btn-forget btn-sm" onclick="toggleRemember('${w.id}', event)">❌ Forget</button>` : ''}
          <button class="btn btn-ghost btn-sm" onclick="studyOne('${w.id}')">📖 Study</button>
          <button class="btn btn-ghost btn-sm" onclick="quickMnemonic('${w.id}', event)" title="Get memory trick">🧠</button>
          <button class="btn btn-ghost btn-sm" onclick="quickConfusables('${w.id}', event)" title="Find confusing words">⚡</button>
          <button class="btn btn-ghost btn-sm" onclick="retryWordAI('${w.id}')">🤖</button>
          <button class="btn btn-danger btn-sm" onclick="delWord('${w.id}')">🗑️</button>
        </div>
      </div>`;
    }).join('');
  }

    // If exam filter active, show "Study All Filtered" banner
  if (wExam !== 'all' && filtered.length > 1) {
    const banner = document.createElement('div');
    banner.style.cssText = 'margin:0 12px 12px;padding:12px 16px;background:linear-gradient(135deg,rgba(124,106,247,.12),rgba(245,200,66,.08));border:1px solid rgba(124,106,247,.25);border-radius:var(--rsm);display:flex;justify-content:space-between;align-items:center;gap:8px';
    const label = [wExam, wType !== 'all' ? wType : '', wYear !== 'all' ? wYear : ''].filter(Boolean).join(' · ');
    banner.innerHTML = `<div><div style="font-size:12px;font-weight:700;color:var(--accent2)">🃏 Study Filtered</div><div style="font-size:11px;color:var(--textMuted);margin-top:2px">${filtered.length} cards · ${label}</div></div><button class="btn btn-accent btn-sm" onclick="studyFiltered()">Study All →</button>`;
    list.appendChild(banner);
  }
}

function posClass(pos) {
  return {noun:'b-noun',verb:'b-verb',adjective:'b-adj',adverb:'b-adv'}[pos]||'b-other';
}

function delWord(id) {
  if (!confirm('Delete this word?')) return;
  words = words.filter(w => String(w.id) !== String(id));
  saveWords(); rebuildExamPills(); renderWords(); updateHome(); showToast('Deleted.');
}

async function retryWordAI(id) {
  const w = words.find(w => String(w.id) === String(id));
  if (!w) return;
  showToast('🤖 Retrying AI...');
  try {
    const data = await fetchWordData(w.word);
    Object.assign(w, {hindi:cleanDevanagari(data.hindi)||w.hindi,hindiPhonetic:data.hindiPhonetic||w.hindiPhonetic||'',pos:data.pos||w.pos,definition:data.definition||w.definition,example:data.example||w.example,synonyms:data.synonyms||w.synonyms,antonyms:data.antonyms||w.antonyms,mnemonic:data.mnemonic||w.mnemonic,imagePrompt:data.imagePrompt||w.imagePrompt,roots:data.roots||w.roots||[],wordFamily:data.wordFamily||w.wordFamily||[],sentences:data.sentences||w.sentences||[],confusables:data.confusables||w.confusables||[]});
    saveWords(); renderWords(); showToast('✅ Updated!');
    // Reopen detail modal to show updated information
    openDetail(id);
  } catch(e) { showToast('Failed: ' + e.message); }
}

function studyOne(id) {
  const idx = words.findIndex(w => String(w.id) === String(id));
  if (idx < 0) return;
  currentDeck = [words[idx]]; currentIdx = 0;
  showScreen('cardScreen', null);
  document.querySelector('.nb:nth-child(3)').classList.add('active');
  document.getElementById('cmodeLbl').textContent = '🃏 Flash Cards';
  setupSwipe(); renderCard();
}

function studyFiltered() {
  const filtered = words.filter(w => {
    const me = wExam === 'all' || (w.examCategory || '') === wExam;
    const my = wYear === 'all' || (w.year || '') === wYear;
    const mt = wType === 'all' || (w.wordType || '') === wType;
    // Bug Fix 2: wMem was missing here — now properly applied
    const mm = wMem === 'all' || (wMem === 'remembered' ? w.remembered === true : w.remembered !== true);
    return me && my && mt && mm;
  });
  if (!filtered.length) { showToast('No words to study!'); return; }
  currentDeck = [...filtered]; currentIdx = 0; isFlipped = false;
  const label = [wExam, wType !== 'all' ? wType : ''].filter(Boolean).join(' · ');
  showScreen('cardScreen', null);
  document.querySelector('.nb:nth-child(3)').classList.add('active');
  document.getElementById('cmodeLbl').textContent = label || '🃏 Flash Cards';
  setupSwipe(); renderCard();
  showToast(`🃏 ${filtered.length} cards loaded`);
}

function openDetail(id) {
  const w = words.find(w => String(w.id) === String(id));
  if (!w) return;
  const examMeta = (w.examCategory || w.wordType || w.year) ? `
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">
      ${w.examCategory ? `<span style="font-size:11px;padding:4px 10px;border-radius:50px;background:rgba(245,200,66,.1);border:1px solid rgba(245,200,66,.3);color:var(--gold)">${w.examCategory}</span>` : ''}
      ${w.wordType ? `<span style="font-size:11px;padding:4px 10px;border-radius:50px;background:rgba(124,106,247,.12);border:1px solid rgba(124,106,247,.3);color:var(--accent2)">${w.wordType}</span>` : ''}
      ${w.year ? `<span style="font-size:11px;padding:4px 10px;border-radius:50px;background:var(--card2);border:1px solid var(--border);color:var(--textSub)">📅 ${w.year}</span>` : ''}
    </div>` : '';
  document.getElementById('detailContent').innerHTML = `
    <div class="mhandle"></div>
    ${w.imageUrl ? `<img src="${w.imageUrl}" style="width:100%;height:170px;object-fit:cover;border-radius:12px;margin-bottom:14px" onerror="this.style.display='none'">` : ''}
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:8px">
      <div style="min-width:0"><div style="font-family:'Playfair Display',serif;font-size:26px;font-weight:900;word-break:break-word">${w.word}</div><div style="font-size:16px;color:var(--gold);margin-top:3px;font-family:'Noto Sans Devanagari',sans-serif;font-weight:600">${cleanDevanagari(w.hindi)||w.hindi}</div>${w.hindiPhonetic?`<div style="font-size:12px;color:var(--textSub);margin-top:2px;font-family:'Noto Sans Devanagari',sans-serif;">${w.hindiPhonetic}</div>`:''}</div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <span class="badge ${posClass(w.pos)}" style="flex-shrink:0;margin-top:4px">${w.pos}</span>
        <button class="btn btn-ghost btn-sm" onclick="retryWordAI('${w.id}')" style="font-size:10px;padding:3px 8px;border-radius:50px">🔄 Retry</button>
      </div>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
      <div style="font-size:12px;padding:5px 12px;border-radius:50px;background:rgba(52,211,153,.1);color:var(--green)">${w.strength==='strong'?'💪 Strong':w.strength==='medium'?'📈 Medium':'📉 Weak'}</div>
      <div style="font-size:12px;padding:5px 12px;border-radius:50px;background:var(--card2);color:var(--textSub)">👁️ ${w.reviewCount||0}× reviewed</div>
    </div>
    ${examMeta}
    <div style="margin-bottom:12px"><div class="lbl">Definition</div><div style="font-size:14px;line-height:1.65;margin-top:4px">${w.definition}</div></div>
    <div style="margin-bottom:12px"><div class="lbl">Example</div><div style="font-size:13px;color:var(--textSub);font-style:italic;line-height:1.65;margin-top:4px">"${w.example}"</div></div>
    <div style="margin-bottom:12px">
      <div class="lbl" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <span>🧠 Memory Trick</span>
        <button class="btn btn-ghost btn-sm" onclick="refreshDetailMnem('${w.id}')" style="font-size:10px;padding:3px 9px">🎲 New</button>
      </div>
      <div id="detailMnemImg_${w.id}" style="margin-bottom:6px;border-radius:10px;overflow:hidden;background:var(--card2);min-height:70px;display:flex;align-items:center;justify-content:center">
        <div class="spin" style="width:18px;height:18px;border-width:2px"></div>
      </div>
      <div class="mnem" id="detailMnemText_${w.id}">${w.mnemonic ? '🧠 ' + w.mnemonic : '<span style=\"color:var(--textMuted);font-size:11px\">Tap 🎲 New to get a funny trick!</span>'}</div>
    </div>
    <div style="margin-bottom:12px"><div class="lbl">Synonyms</div><div style="margin-top:4px">${(w.synonyms||[]).map(s=>`<span class="tag">${s}</span>`).join('')||'—'}</div></div>
    <div style="margin-bottom:18px"><div class="lbl">Antonyms</div><div style="margin-top:4px">${(w.antonyms||[]).map(s=>`<span class="tag" style="color:var(--red)">${s}</span>`).join('')||'—'}</div></div>
    <div style="display:flex;gap:8px"><button class="btn btn-gold" style="flex:1" onclick="closeM('detailModal');studyOne('${w.id}')">📖 Study</button><button class="btn btn-ghost" onclick="closeM('detailModal')">Close</button></div>
  `;
  openM('detailModal');
  // Must call AFTER innerHTML set — script tags inside innerHTML don't execute
  setTimeout(() => loadDetailMnemImg(w.id, w.imagePrompt || w.word), 50);
}

// ============================================================
// FLASHCARD
// ============================================================
function startMode(mode) {
  if (mode === 'timed' || mode === 'rapid') { startPractice(mode); return; }
  if (!words.length) { showToast('Add words first!'); showScreen('wordsScreen', document.querySelector('.nb:nth-child(2)')); return; }
  if (currentDeck.length !== 1) currentDeck = [...words];
  currentIdx = 0; isFlipped = false;
  _sessionStats = { hard: 0, medium: 0, easy: 0 }; // reset for new session
  document.getElementById('cmodeLbl').textContent = '🃏 Flash Cards';
  showScreen('cardScreen', null);
  document.querySelector('.nb:nth-child(3)').classList.add('active');
  setupSwipe(); renderCard();
}

function showReviewOnly() {
  const weak = words.filter(w => w.strength === 'weak' || !w.strength);
  if (!weak.length) { showToast('No weak words! 🎉'); return; }
  currentDeck = [...weak]; currentIdx = 0; isFlipped = false;
  document.getElementById('cmodeLbl').textContent = '🔁 Review Weak';
  showScreen('cardScreen', null);
  document.querySelector('.nb:nth-child(3)').classList.add('active');
  setupSwipe(); renderCard();
}

function renderCard() {
  if (!currentDeck.length) return;
  const w = currentDeck[currentIdx];
  if (!w) return;

  const fc = document.getElementById('fc');
  fc.classList.remove('flipped');
  isFlipped = false;
  document.getElementById('rrow').style.display = 'none';
  document.getElementById('ccounter').textContent = (currentIdx+1) + '/' + currentDeck.length;
  document.getElementById('cprogFill').style.width = (currentIdx / currentDeck.length * 100) + '%';
  // Update flashcard progress bar
  const fcProgressBar = document.getElementById('fcProgressBar');
  if (fcProgressBar) fcProgressBar.style.width = ((currentIdx + 1) / currentDeck.length * 100) + '%';

  // Build strength badge HTML
  const rating = w.srRating || (w.strength === 'strong' ? 'easy' : w.strength === 'medium' ? 'medium' : null);
  const rBadge = rating ? {
    hard:   '<span class="str-badge str-h">😓 Hard</span>',
    medium: '<span class="str-badge str-m">🤔 Medium</span>',
    easy:   '<span class="str-badge str-e">😊 Mastered</span>',
  }[rating] : '';

  // Build exam meta badges
  const typeColors = {Synonyms:'34,211,153',Antonyms:'248,113,113','Idioms & Phrases':'96,165,250','One Word Substitution':'167,139,250',Homonyms:'251,146,60'};
  const examBadge = w.examCategory ? `<span style="font-size:9px;padding:2px 8px;border-radius:50px;background:rgba(245,200,66,.12);color:var(--gold);border:1px solid rgba(245,200,66,.3);font-weight:700">${w.examCategory}</span>` : '';
  const tc = typeColors[w.wordType] || '152,152,184';
  const typeBadge = w.wordType ? `<span style="font-size:9px;padding:2px 8px;border-radius:50px;background:rgba(${tc},.12);color:rgb(${tc});border:1px solid rgba(${tc},.3);font-weight:700">${w.wordType}</span>` : '';
  const yearBadge = w.year ? `<span style="font-size:9px;padding:2px 8px;border-radius:50px;background:var(--card2);color:var(--textMuted);border:1px solid var(--border);font-weight:600">📅${w.year}</span>` : '';

  // ── OWS helper: detect if this is a description-style OWS card
  // (word = "A humorous poem of five lines", quizCorrect = "Limerick")
  const isOWS = w.wordType === 'One Word Substitution';
  const owsAnswer = isOWS && w.quizCorrect && w.quizCorrect !== w.word ? w.quizCorrect : null;
  const displayWord = owsAnswer || w.word;

  // FRONT
  const cWordEl = document.getElementById('cWord');
  cWordEl.textContent = displayWord;
  // Color word based on rating
  const ratingColorMap = {hard:'var(--red)', medium:'var(--gold)', easy:'var(--green)'};
  cWordEl.style.color = ratingColorMap[rating] || 'var(--text)';
  // Also color the back side word
  const cWordBackEl = document.getElementById('cWordBack');
  if(cWordBackEl){ cWordBackEl.textContent = displayWord; cWordBackEl.style.color = ratingColorMap[rating] || 'var(--text)'; }

  // ── CARD FRONT: Line 1 (gold) = phonetic Devanagari of English word sound e.g. ग्रेट
  //               Line 2 (grey) = Hindi meaning e.g. महान
  const phoneticEl = document.getElementById('cHindi');
  const meaningEl  = document.getElementById('cHindiRoman');
  const hindiMeaning = cleanDevanagari(w.hindi || '') || w.hindi || '';

  if (w.hindiPhonetic) {
    // Already have phonetic — show immediately
    phoneticEl.textContent = w.hindiPhonetic;
    phoneticEl.classList.remove('loading');
    if (meaningEl) { meaningEl.textContent = (hindiMeaning && hindiMeaning !== '—') ? hindiMeaning : ''; meaningEl.classList.remove('loading'); }
  } else {
    // Show meaning in gold slot while fetching phonetic
    phoneticEl.textContent = 'लोड हो रहा है...';
    phoneticEl.classList.add('loading');
    if (meaningEl) { meaningEl.textContent = (hindiMeaning && hindiMeaning !== '—') ? hindiMeaning : ''; }
    // Auto-fetch phonetic Devanagari from AI
    fetchHindiPronunciation(displayWord).then(phonetic => {
      if (!phonetic) { phoneticEl.textContent = ''; phoneticEl.classList.remove('loading'); return; }
      // Save so we never fetch again for this word
      const wd = words.find(x => String(x.id) === String(w.id));
      if (wd) { wd.hindiPhonetic = phonetic; w.hindiPhonetic = phonetic; saveWords(); }
      // Only update DOM if user is still on this card
      if (currentDeck[currentIdx] && String(currentDeck[currentIdx].id) === String(w.id)) {
        phoneticEl.textContent = phonetic;
        phoneticEl.classList.remove('loading');
      }
    }).catch(() => { phoneticEl.textContent = ''; phoneticEl.classList.remove('loading'); });
  }

  // ── CARD BACK: show Hindi meaning (Devanagari) prominently
  const hindiBack = document.getElementById('cHindiBack');
  if (hindiBack) hindiBack.textContent = (hindiMeaning && hindiMeaning !== '—') ? hindiMeaning : '';
  const romanBack = document.getElementById('cHindiRomanBack');
  if (romanBack) romanBack.textContent = w.hindiPhonetic ? w.hindiPhonetic : '';

  // Store current word for speak button
  const speakBtn = document.getElementById('speakBtn');
  if (speakBtn) speakBtn.dataset.word = displayWord;
  const badge = document.getElementById('cBadge');
  if (badge) { badge.textContent = w.pos || 'word'; badge.className = 'badge ' + posClass(w.pos); }

  const sb = document.getElementById('cStrBadge');
  if (sb) sb.innerHTML = rBadge;

  const exMeta = document.getElementById('cExamMeta');
  if (exMeta) exMeta.innerHTML = examBadge;

  const imgZone = document.getElementById('cimgZone');
  if (w.imageUrl) {
    imgZone.innerHTML = `<img class="cimg" src="${w.imageUrl}" onerror="this.parentElement.innerHTML='<div class=cimg-ph>📚</div>'" alt=""><div class="cimg-overlay"></div>`;
  } else {
    imgZone.innerHTML = '<div class="cimg-ph">📚</div>';
  }

  // BACK
  // For OWS description-style cards: show the phrase as the definition
  const backDef = owsAnswer ? (w.word || w.definition || '—') : (w.definition || '—');
  document.getElementById('cDef').textContent = backDef;
  document.getElementById('cEx').textContent = w.example ? `"${w.example}"` : '';
  const mn = document.getElementById('cMnem');
  const mnWrap = document.getElementById('cMnemWrap');
  mnWrap.style.display = 'block'; // Always show Mnemonic Maker
  if (w.mnemonic) {
    mn.textContent = w.mnemonic;
    loadMnemImg(w);
  } else {
    mn.innerHTML = '<span style="color:var(--textMuted);font-size:11px">Tap 🎲 New to generate a memory trick!</span>';
  }
  // Reset style chip selection
  document.querySelectorAll('.mnem-style-chip').forEach(c => c.classList.remove('active'));
  const firstChip = document.querySelector('.mnem-style-chip[data-style="bollywood"]');
  if (firstChip) firstChip.classList.add('active');
  // Load mnemonic history for this word
  renderMnemHistory(w);
  document.getElementById('cSyn').innerHTML = (w.synonyms||[]).map(s=>`<span class="tag">${s}</span>`).join('') || '<span style="color:var(--textMuted);font-size:11px">—</span>';
  document.getElementById('cAnt').innerHTML = (w.antonyms||[]).map(s=>`<span class="tag" style="color:var(--red)">${s}</span>`).join('') || '<span style="color:var(--textMuted);font-size:11px">—</span>';

  // ── WORD ROOTS
  const rootsWrap = document.getElementById('cRootsWrap');
  const rootsEl   = document.getElementById('cRoots');
  if ((w.roots||[]).length) {
    rootsEl.innerHTML = w.roots.map(r=>`<div class="root-chip"><div class="root-part">${r.part||''}</div><div class="root-meaning">${r.meaning||''}</div>${r.example?`<div class="root-eg">e.g. ${r.example}</div>`:''}</div>`).join('');
    rootsWrap.style.display = 'block';
  } else { rootsWrap.style.display = 'none'; }

  // ── WORD FAMILY
  const famWrap = document.getElementById('cFamWrap');
  const famEl   = document.getElementById('cFam');
  if ((w.wordFamily||[]).length) {
    famEl.innerHTML = w.wordFamily.map(f=>`<span class="wfam-chip">${f}</span>`).join('');
    famWrap.style.display = 'block';
  } else { famWrap.style.display = 'none'; }

  // ── 3 SENTENCES
  const sentsWrap = document.getElementById('cSentsWrap');
  const sentsEl   = document.getElementById('cSents');
  if ((w.sentences||[]).length) {
    sentsEl.innerHTML = w.sentences.map((s,i)=>`<div class="sent-item"><div class="sent-num">Sentence ${i+1}</div>${s}</div>`).join('');
    sentsWrap.style.display = 'block';
  } else { sentsWrap.style.display = 'none'; }

  // ── CONFUSABLES
  const confWrap = document.getElementById('cConfWrap');
  const confEl   = document.getElementById('cConf');
  if ((w.confusables||[]).length) {
    confEl.innerHTML = w.confusables.map(c=>`
      <div class="conf-item">
        <div class="conf-vs-row">
          <span class="conf-vs-pill main">${w.word}</span>
          <span class="conf-vs-divider">vs</span>
          <span class="conf-vs-pill confused">⚡ ${c.word||''}</span>
        </div>
        <div class="conf-diff">${c.difference||''}</div>
      </div>`).join('');
    confWrap.style.display = 'block';
  } else {
    // Show the section with just the generate button to encourage use
    confEl.innerHTML = '<div style="font-size:11px;color:var(--textMuted);padding:4px 0">No confusion alerts yet. Tap ✨ More to generate!</div>';
    confWrap.style.display = 'block';
  }

  // ── TYPE THE WORD — pick a random sentence as the prompt, blank the word
  const typeInp    = document.getElementById('typeInp');
  const typeResult = document.getElementById('typeResult');
  const typePrompt = document.getElementById('typePrompt');
  if (typeInp) { typeInp.value = ''; typeInp.className = 'type-inp'; }
  if (typeResult) typeResult.textContent = '';
  if (typePrompt) {
    const hint = owsAnswer
      ? `Type the one word for: "${w.word}"`  // OWS: show description as prompt
      : (w.sentences && w.sentences.length)
        ? w.sentences[0].replace(new RegExp('\\b' + w.word + '\\b', 'gi'), '___')
        : (w.example || '').replace(new RegExp('\\b' + w.word + '\\b', 'gi'), '___') || `Type the word for: "${w.definition}"`;
    typePrompt.textContent = hint || `Definition: ${w.definition}`;
  }

  const sbb = document.getElementById('cStrBadgeBack');
  if (sbb) sbb.innerHTML = rBadge;

  const metaEl = document.getElementById('cCardMeta');
  if (metaEl) {
    const parts = [examBadge];
    if (w.nextReview) {
      const daysLeft = Math.ceil((w.nextReview - Date.now()) / 86400000);
      parts.push(daysLeft > 0
        ? `<span class="tag" style="color:var(--textMuted)">Next: ${daysLeft}d</span>`
        : `<span class="tag" style="color:var(--gold)">⚡ Due!</span>`);
    }
    metaEl.innerHTML = parts.join('');
    metaEl.style.display = parts.some(p=>p) ? 'flex' : 'none';
  }

  // Scroll back to top when new card loads
  const cfBack = document.getElementById('cfBack');
  if (cfBack) cfBack.scrollTop = 0;

  // Reset quiz zone then populate it
  const qInner = document.getElementById('cQuizInner');
  if (qInner) qInner.innerHTML = '<div class="cq-loading"><div class="spin" style="width:16px;height:16px;border-width:2px"></div> Loading...</div>';
  const fh = document.getElementById('cFlipHint');
  if (fh) fh.textContent = owsAnswer ? '👆 Tap card to see description & details' : '👆 Tap card to see full answer';
  renderCardQuiz(w);
}

function flipCard() {
  const fc = document.getElementById('fc');
  isFlipped = !isFlipped;
  fc.classList.toggle('flipped', isFlipped);
  document.getElementById('rrow').style.display = isFlipped ? 'grid' : 'none';
  if (isFlipped) {
    const w = currentDeck[currentIdx];
    if (w) {
      if (typeof renderSM2Panel === 'function') renderSM2Panel(w);
      if (typeof updateRateButtonPreviews === 'function') updateRateButtonPreviews(w);
    }
    // Trigger staggered animations by resetting and re-adding
    const cb = document.querySelector('.cf-back .cb-body');
    if (cb) {
      const children = cb.querySelectorAll('div');
      children.forEach(child => {
        child.style.animation = 'none';
        child.offsetHeight; // Trigger reflow
        child.style.animation = '';
      });
    }
  } else {
    const p = document.getElementById('sm2Panel');
    if (p) p.style.display = 'none';
  }
  // Activity is counted in rateCard() — only real ratings count, not flips
}

// Pronunciation: speaks English word (en-US) then Hindi meaning (hi-IN)
function speakWord(e) {
  e.stopPropagation();
  const w = currentDeck[currentIdx];
  if (!w || !window.speechSynthesis) { showToast('Speech not supported on this device'); return; }
  window.speechSynthesis.cancel();

  const btn = document.getElementById('speakBtn');
  const reset = () => { if (btn) { btn.textContent = '🔊 Pronounce'; btn.style.opacity = '1'; btn.disabled = false; } };
  if (btn) { btn.textContent = '🔊 Speaking...'; btn.style.opacity = '.6'; btn.disabled = true; }

  // Utterance 1: English word
  const uttEn = new SpeechSynthesisUtterance(w.word);
  uttEn.lang = 'en-US';
  uttEn.rate = 0.82;
  uttEn.pitch = 1;

  // Utterance 2: Hindi meaning — speak pure Devanagari using hi-IN voice
  const hindiText = cleanDevanagari(w.hindi);
  const hasHindi = hindiText && hindiText !== '—' && /[\u0900-\u097F]/.test(hindiText);

  if (hasHindi) {
    const uttHi = new SpeechSynthesisUtterance(hindiText);
    uttHi.lang = 'hi-IN';
    uttHi.rate = 0.78;
    uttHi.pitch = 1;
    uttHi.onend = reset;
    uttHi.onerror = reset;
    // Chain: English → pause → Hindi
    uttEn.onend = () => {
      setTimeout(() => window.speechSynthesis.speak(uttHi), 400);
    };
    uttEn.onerror = reset;
  } else {
    uttEn.onend = reset;
    uttEn.onerror = reset;
  }

  window.speechSynthesis.speak(uttEn);
}

// ── TRUE SM-2 SPACED REPETITION (Anki-level) ──
// Based on SuperMemo SM-2 algorithm
// EF = Ease Factor (starts at 2.5, min 1.3)
// interval = days until next review
// q: 0=hard(Again), 3=medium(Hard), 4=easy(Good), 5=very easy(Easy)
function sm2(wd, q) {
  const DAY = 86400000;
  let ef       = typeof wd.ef === 'number' ? wd.ef : 2.5;
  let interval = typeof wd.interval === 'number' ? wd.interval : 0;
  let reps     = typeof wd.reps === 'number' ? wd.reps : 0;

  if (q < 3) {
    // Failed / Hard — reset to beginning
    reps = 0;
    interval = 1;
  } else {
    // Passed
    if (reps === 0)      interval = 1;
    else if (reps === 1) interval = 6;
    else                 interval = Math.round(interval * ef);
    reps++;
    // Update ease factor: EF' = EF + (0.1 − (5−q)×(0.08+(5−q)×0.02))
    ef = ef + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
    ef = Math.max(1.3, Math.min(4.0, ef));
  }

  // Cap interval at 365 days
  interval = Math.max(1, Math.min(365, interval));

  return { ef, interval, reps, nextReview: Date.now() + interval * DAY };
}

function rateCard(rating) {
  const w = currentDeck[currentIdx];
  if (!w) return;
  const wd = words.find(x => x.id === w.id);
  if (!wd) { nextCard(); return; }

  // Snapshot current state for undo (before any changes)
  _lastRatedSnapshot = {
    wordId:      wd.id,
    deckIdx:     currentIdx,
    oldWord:     JSON.parse(JSON.stringify(wd)), // deep copy
    sessionStats: { ..._sessionStats }
  };

  // Map button rating to SM-2 quality score
  const qMap = { hard: 1, medium: 3, easy: 5 };
  const q = qMap[rating] ?? 3;

  const sm = sm2(wd, q);

  const strMap = { hard: 'weak', medium: 'medium', easy: 'strong' };
  _sessionStats[rating] = (_sessionStats[rating] || 0) + 1; // track session

  // Record this review in history
  if (!wd.reviewHistory) wd.reviewHistory = [];
  wd.reviewHistory.push({
    date: Date.now(),
    rating,
    q,
    interval: sm.interval,
    ef: sm.ef
  });
  // Keep last 30 reviews per word
  if (wd.reviewHistory.length > 30) wd.reviewHistory = wd.reviewHistory.slice(-30);

  wd.srRating    = rating;
  wd.strength    = strMap[rating];
  // Immediately update word color on card
  const _rColorMap = {hard:'var(--red)', medium:'var(--gold)', easy:'var(--green)'};
  const _cwEl = document.getElementById('cWord');
  if(_cwEl) _cwEl.style.color = _rColorMap[rating] || 'var(--text)';
  const _cwbEl = document.getElementById('cWordBack');
  if(_cwbEl) _cwbEl.style.color = _rColorMap[rating] || 'var(--text)';
  wd.ef          = sm.ef;
  wd.interval    = sm.interval;
  wd.reps        = sm.reps;
  wd.reviewCount = (wd.reviewCount || 0) + 1;
  wd.lastReview  = Date.now();
  wd.nextReview  = sm.nextReview;
  if (rating === 'easy' && sm.interval >= 21) wd.masteredAt = Date.now();

  Object.assign(w, wd);
  saveWords();
  renderWords(); // update word list colors immediately

  userData.dailyReviewed = (userData.dailyReviewed || 0) + 1;
  // Count REAL reviews (ratings only, not flips) for streak & activity heatmap
  const _today = new Date().toDateString();
  userData.activity[_today] = (userData.activity[_today] || 0) + 1;
  // Trim activity to last 90 days to prevent unbounded growth
  const _cutoff = new Date(Date.now() - 90 * 86400000).toDateString();
  Object.keys(userData.activity).forEach(k => { if (k < _cutoff) delete userData.activity[k]; });
  saveUser(); updateHome();

  // Show interval toast feedback
  const intervalLabel = sm.interval === 1 ? 'tomorrow' : `in ${sm.interval} days`;
  const toastMap = {
    hard:   `😓 Again — review ${intervalLabel}`,
    medium: `🤔 Hard — review ${intervalLabel}`,
    easy:   `✅ Good — review ${intervalLabel}`
  };
  showToast(toastMap[rating]);
  if (rating === 'easy' && sm.interval >= 21) confetti();

  // Show undo button for 4 seconds
  showUndoBtn();
  nextCard();
}
function now(){ return Date.now(); }

function nextCard() {
  if (currentIdx < currentDeck.length - 1) {
    currentIdx++;
    renderCard();
  } else {
    // End of deck — show session summary instead of silent loop
    showSessionSummary();
  }
}

function showSessionSummary() {
  const total        = _sessionStats.easy + _sessionStats.medium + _sessionStats.hard;
  const dueNow       = words.filter(function(w){ return !w.nextReview || w.nextReview <= Date.now(); }).length;
  const masteredCount= words.filter(function(w){ return w.srRating === 'easy'; }).length;
  const pct          = total > 0 ? Math.round((_sessionStats.easy / total) * 100) : 0;
  const medal        = pct >= 80 ? '🏆' : pct >= 50 ? '🥈' : '💪';
  const dueColor     = dueNow > 0 ? 'var(--orange)' : 'var(--green)';

  // Build HTML as a plain string — no template literal to avoid quote conflicts
  var html =
    '<div class="mhandle"></div>' +
    '<div style="text-align:center;margin-bottom:18px">' +
      '<div style="font-size:48px;margin-bottom:6px">' + medal + '</div>' +
      '<div style="font-family:Playfair Display,serif;font-size:22px;font-weight:900;color:var(--gold)">Session Done!</div>' +
      '<div style="font-size:13px;color:var(--textSub);margin-top:4px">' + total + ' cards reviewed</div>' +
    '</div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px">' +
      '<div style="background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.25);border-radius:12px;padding:12px;text-align:center">' +
        '<div style="font-size:26px;font-weight:900;color:var(--green)">' + _sessionStats.easy + '</div>' +
        '<div style="font-size:10px;color:var(--green);font-weight:700;margin-top:2px">&#10003; EASY</div>' +
      '</div>' +
      '<div style="background:rgba(245,200,66,.1);border:1px solid rgba(245,200,66,.25);border-radius:12px;padding:12px;text-align:center">' +
        '<div style="font-size:26px;font-weight:900;color:var(--gold)">' + _sessionStats.medium + '</div>' +
        '<div style="font-size:10px;color:var(--gold);font-weight:700;margin-top:2px">&#129300; MEDIUM</div>' +
      '</div>' +
      '<div style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.25);border-radius:12px;padding:12px;text-align:center">' +
        '<div style="font-size:26px;font-weight:900;color:var(--red)">' + _sessionStats.hard + '</div>' +
        '<div style="font-size:10px;color:var(--red);font-weight:700;margin-top:2px">&#128549; HARD</div>' +
      '</div>' +
    '</div>' +
    '<div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:16px;display:flex;justify-content:space-between">' +
      '<div style="font-size:12px;color:var(--textSub)">&#128197; Due for review</div>' +
      '<div style="font-size:13px;font-weight:700;color:' + dueColor + '">' + dueNow + ' word' + (dueNow !== 1 ? 's' : '') + '</div>' +
    '</div>' +
    '<div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:20px;display:flex;justify-content:space-between">' +
      '<div style="font-size:12px;color:var(--textSub)">&#128170; Total mastered</div>' +
      '<div style="font-size:13px;font-weight:700;color:var(--accent2)">' + masteredCount + ' word' + (masteredCount !== 1 ? 's' : '') + '</div>' +
    '</div>' +
    '<div style="display:flex;gap:8px;margin-bottom:8px">' +
      '<button class="btn btn-ghost" style="flex:1" id="sessStudyAgainBtn">&#128260; Study Again</button>' +
      '<button class="btn btn-gold"  style="flex:1" id="sessHomeBtn">&#127968; Home</button>' +
    '</div>';

  if (_sessionStats.hard > 0) {
    html += '<button class="btn btn-danger" style="width:100%" id="sessHardBtn">&#128549; Retry Hard Words (' + _sessionStats.hard + ')</button>';
  }

  document.getElementById('sessSummaryContent').innerHTML = html;

  // Attach button events AFTER innerHTML (avoids all quote-in-onclick issues)
  var againBtn = document.getElementById('sessStudyAgainBtn');
  if (againBtn) againBtn.onclick = function() {
    closeM('sessSummaryModal');
    currentIdx = 0;
    _sessionStats = { hard: 0, medium: 0, easy: 0 };
    isFlipped = false;
    var fc = document.getElementById('fc');
    if (fc) fc.classList.remove('flipped');
    document.getElementById('rrow').style.display = 'none';
    renderCard();
  };
  var homeBtn = document.getElementById('sessHomeBtn');
  if (homeBtn) homeBtn.onclick = function() { closeM('sessSummaryModal'); exitCard(); };
  var hardBtn = document.getElementById('sessHardBtn');
  if (hardBtn) hardBtn.onclick = function() { closeM('sessSummaryModal'); studyHardOnly(); };

  document.getElementById('sessSummaryModal').classList.add('open');
  confetti();
}

function studyHardOnly() {
  const hardWords = words.filter(w => w.srRating === 'hard' || w.strength === 'weak');
  if (!hardWords.length) { showToast('No hard words!'); return; }
  currentDeck = shuffle([...hardWords]);
  currentIdx = 0; isFlipped = false;
  _sessionStats = { hard: 0, medium: 0, easy: 0 };
  renderCard();
}
function prevCard() { if (currentIdx > 0) { currentIdx--; renderCard(); } }
function exitCard() { showScreen('homeScreen', document.querySelector('.nb:nth-child(1)')); currentDeck=[...words]; }

// ============================================================
// ✍️ TYPE THE WORD — active recall on card back
// ============================================================
function checkTyped() {
  const w = currentDeck[currentIdx]; if (!w) return;
  const inp = document.getElementById('typeInp');
  const result = document.getElementById('typeResult');
  const typed = (inp.value || '').trim().toLowerCase();
  const correct = (w.word || '').toLowerCase();
  if (!typed) return;
  if (typed === correct) {
    inp.classList.add('correct');
    result.innerHTML = `<span style="color:var(--green)">✅ Correct! +5 XP</span>`; confetti();
    inp.disabled = true;
  } else {
    inp.classList.add('wrong');
    result.innerHTML = `<span style="color:var(--red)">❌ Answer: </span><span style="color:var(--gold);font-weight:700">${w.word}</span>`;
    // Shake animation
    inp.style.animation = 'shake .4s ease';
    setTimeout(() => inp.style.animation = '', 400);
  }
}

// ✍️ Type the Word as standalone study mode (shows card back first)
function startTypeMode() {
  const pool = words.filter(w => w.sentences && w.sentences.length || w.example);
  if (!pool.length) { showToast('Add words with AI first to unlock this mode!'); return; }
  currentDeck = shuffle([...pool]); currentIdx = 0; isFlipped = true;
  showScreen('cardScreen', document.querySelector('.nb:nth-child(3)'));
  document.getElementById('cmodeLbl').textContent = '✍️ Type the Word';
  document.querySelectorAll('.cef-pill').forEach(e => e.classList.remove('ce-active'));
  setupSwipe();
  renderCard();
  // Auto-flip to back so type box is visible
  const fc = document.getElementById('fc');
  if (fc) fc.classList.add('flipped');
  document.getElementById('rrow').style.display = 'grid';
  showToast('✍️ Type the word from the sentence clue!');
}

// ============================================================
// 🔤 WORD ROOTS — dedicated roots study mode using practice screen
// ============================================================
function showRootsMode() {
  const pool = words.filter(w => w.roots && w.roots.length);
  if (!pool.length) { showToast('No root data yet — add words with AI first, then tap 🤖 to refresh!'); return; }
  const shuffled = shuffle([...pool]);
  practiceMode = 'roots'; practiceWords = shuffled.slice(0, Math.min(10, shuffled.length));
  practiceIdx = 0; practiceScore = 0; practiceTotal = practiceWords.length;
  showScreen('practiceScreen', null);
  document.getElementById('ptitle').textContent = '🔤 Word Roots';
  renderRootsQ();
}

function renderRootsQ() {
  const w = practiceWords[practiceIdx];
  document.getElementById('psub').textContent = `Word ${practiceIdx+1} of ${practiceTotal}`;
  const allRoots = words.flatMap(x => (x.roots||[]).map(r=>r.part)).filter(Boolean);
  const wrongParts = shuffle(allRoots.filter(r => !w.roots.some(wr=>wr.part===r))).slice(0,3);
  const correctRoot = w.roots[0];
  const options = shuffle([correctRoot.meaning, ...words.filter(x=>x.id!==w.id&&x.roots&&x.roots[0]).slice(0,3).map(x=>x.roots[0].meaning)]);
  document.getElementById('pContent').innerHTML = `
    <div style="padding:16px">
      <div style="font-family:'Playfair Display',serif;font-size:32px;font-weight:900;text-align:center;margin-bottom:4px">${w.word}</div>
      <div style="text-align:center;font-size:13px;color:var(--textSub);margin-bottom:20px">What does the root <span style="color:var(--blue);font-weight:700;background:rgba(96,165,250,.12);padding:2px 8px;border-radius:50px">"${correctRoot.part}"</span> mean?</div>
      <div class="eq-opts">
        ${options.map(opt=>`<button class="eq-opt" onclick="checkRootsAnswer(this,'${opt.replace(/'/g,"\\'")}','${correctRoot.meaning.replace(/'/g,"\\'")}','${w.id}')">${opt}</button>`).join('')}
      </div>
    </div>`;
}

function checkRootsAnswer(btn, chosen, correct, wid) {
  document.querySelectorAll('.eq-opt').forEach(b => b.disabled = true);
  if (chosen === correct) {
    btn.classList.add('correct'); practiceScore++; showToast('✅ Correct!');
  } else {
    btn.classList.add('wrong');
    document.querySelectorAll('.eq-opt').forEach(b => { if (b.textContent === correct) b.classList.add('correct'); });
    showToast('❌ ' + correct);
  }
  setTimeout(() => {
    if (practiceIdx < practiceTotal - 1) { practiceIdx++; renderRootsQ(); }
    else { showPracticeResult('🔤 Roots', practiceScore, practiceTotal); }
  }, 1200);
}

// ============================================================
// ⚠️ CONFUSABLES — quiz on easily confused word pairs
// ============================================================
function showConfusablesMode() {
  const pool = words.filter(w => w.confusables && w.confusables.length);
  if (!pool.length) { showToast('No confusables data yet — add words with AI first!'); return; }
  practiceMode = 'confusables'; practiceWords = shuffle([...pool]).slice(0, Math.min(10, pool.length));
  practiceIdx = 0; practiceScore = 0; practiceTotal = practiceWords.length;
  showScreen('practiceScreen', null);
  document.getElementById('ptitle').textContent = '⚠️ Confusables';
  renderConfQ();
}

function renderConfQ() {
  const w = practiceWords[practiceIdx];
  const conf = w.confusables[0];
  document.getElementById('psub').textContent = `Pair ${practiceIdx+1} of ${practiceTotal}`;
  // Show both words, ask which one matches the definition
  const opts = shuffle([w.word, conf.word]);
  document.getElementById('pContent').innerHTML = `
    <div style="padding:16px">
      <div style="background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:12px;padding:14px;margin-bottom:16px;text-align:center">
        <div style="font-size:11px;color:var(--red);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px">⚠️ Which word fits?</div>
        <div style="font-size:14px;color:var(--text);line-height:1.6">"${w.definition}"</div>
      </div>
      <div style="display:flex;gap:10px;margin-bottom:16px">
        ${opts.map(opt=>`<button class="eq-opt" style="flex:1;font-size:16px;font-weight:700;font-family:'Playfair Display',serif" onclick="checkConfAnswer(this,'${opt}','${w.word}')">${opt}</button>`).join('')}
      </div>
      <div style="background:var(--card);border-radius:10px;padding:12px;font-size:12px;color:var(--textSub);line-height:1.6">
        💡 <span style="color:var(--gold);font-weight:600">${conf.difference}</span>
      </div>
    </div>`;
}

function checkConfAnswer(btn, chosen, correct) {
  document.querySelectorAll('.eq-opt').forEach(b => b.disabled = true);
  if (chosen === correct) {
    btn.classList.add('correct'); practiceScore++; showToast('✅ Correct!');
  } else {
    btn.classList.add('wrong');
    document.querySelectorAll('.eq-opt').forEach(b => { if (b.textContent === correct) b.classList.add('correct'); });
    showToast('❌ ' + correct);
  }
  setTimeout(() => {
    if (practiceIdx < practiceTotal - 1) { practiceIdx++; renderConfQ(); }
    else { showPracticeResult('⚠️ Confusables', practiceScore, practiceTotal); }
  }, 1300);
}

// Shared result screen for roots + confusables modes
function showPracticeResult(mode, score, total) {
  const pct = Math.round(score/total*100);
  const msg = pct===100 ? '🏆 Perfect!' : pct>=70 ? '🎉 Great job!' : pct>=40 ? '📈 Keep going!' : '💪 Keep practising!';
  document.getElementById('pContent').innerHTML = `
    <div style="padding:32px 20px;text-align:center">
      <div style="font-size:56px;margin-bottom:12px">${pct===100?'🏆':pct>=70?'🎉':'📈'}</div>
      <div style="font-family:'Playfair Display',serif;font-size:28px;font-weight:900;margin-bottom:4px">${msg}</div>
      <div style="font-size:15px;color:var(--textSub);margin-bottom:24px">${score} / ${total} correct · ${pct}%</div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-gold" onclick="showScreen('homeScreen',document.querySelector('.nb'))">🏠 Home</button>
        <button class="btn btn-ghost" onclick="${mode.includes('Root')?'showRootsMode':'showConfusablesMode'}()">🔁 Try Again</button>
      </div>
    </div>`;
  if (pct===100) confetti();
}

// Add shake keyframe if not present
(function(){
  if (!document.getElementById('shakeKF')) {
    const s = document.createElement('style');
    s.id = 'shakeKF';
    s.textContent = '@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}';
    document.head.appendChild(s);
  }
})();

// ============================================================
// CARD SCREEN EXAM FILTER
// ============================================================
let cardExamFilter = 'all';

let cardYearFilter = 'all';
let cardTypeFilter2 = 'all';

function rebuildCardYearPills(exam) {
  const scope = exam && exam !== 'all' ? words.filter(w => (w.examCategory||'') === exam) : words;
  const yearCount = {};
  scope.forEach(w => { const y = (w.year||'').trim(); if(y) yearCount[y] = (yearCount[y]||0)+1; });
  const years = Object.keys(yearCount).sort();
  const row = document.getElementById('cardYearRow');
  if (!row) return;
  row.querySelectorAll('[data-card-year]').forEach(n => n.remove());
  // update All Years count
  const allPill = row.querySelector('.cef-pill');
  if (allPill) allPill.innerHTML = 'All Years <span style="background:rgba(255,255,255,.13);border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:2px">' + scope.length + '</span>';
  years.forEach(y => {
    const d = document.createElement('div');
    d.className = 'cef-pill';
    d.setAttribute('data-card-year', y);
    d.innerHTML = y + ' <span style="background:rgba(255,255,255,.13);border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:2px">' + yearCount[y] + '</span>';
    d.onclick = function() { setCardYear(y, d); };
    row.appendChild(d);
  });
  cardYearFilter = 'all';
  row.querySelectorAll('.cef-pill').forEach((e,i) => e.classList.toggle('ce-active', i===0));
  const yearBlock = document.getElementById('cardYearBlock');
  if (yearBlock) yearBlock.style.display = years.length ? 'block' : 'none';
}

function rebuildCardTypeCounts(exam) {
  const scope = exam && exam !== 'all' ? words.filter(w => (w.examCategory||'') === exam) : words;
  const typeCount = {};
  scope.forEach(w => { const t = w.wordType||''; if(t) typeCount[t] = (typeCount[t]||0)+1; });
  const row = document.getElementById('cardTypeRow');
  if (!row) return;
  row.querySelectorAll('.cef-pill').forEach(pill => {
    const onclick = pill.getAttribute('onclick') || '';
    const match = onclick.match(/'([^']+)'/);
    const type = match ? match[1] : '';
    if (type === 'all') {
      pill.innerHTML = 'All Types <span style="background:rgba(255,255,255,.13);border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:2px">' + scope.length + '</span>';
    } else if (type && typeCount[type] !== undefined) {
      const label = type === 'One Word Substitution' ? 'One Word Sub.' : type === 'Idioms & Phrases' ? 'Idioms & Phrases' : type;
      pill.innerHTML = label + ' <span style="background:rgba(255,255,255,.13);border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:2px">' + typeCount[type] + '</span>';
    } else if (type) {
      const label = type === 'One Word Substitution' ? 'One Word Sub.' : type;
      pill.innerHTML = label + ' <span style="background:rgba(255,255,255,.13);border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:2px;opacity:.4">0</span>';
    }
  });
}

function setCardYear(year, el) {
  cardYearFilter = year;
  document.querySelectorAll('#cardYearRow .cef-pill').forEach(e => e.classList.remove('ce-active'));
  el.classList.add('ce-active');
  // update type counts for this exam+year combo
  const examScope = cardExamFilter !== 'all' && cardExamFilter !== 'due' ? words.filter(w => (w.examCategory||'') === cardExamFilter) : words;
  const yearScope = year !== 'all' ? examScope.filter(w => (w.year||'').trim() === year) : examScope;
  const typeCount = {};
  yearScope.forEach(w => { const t = w.wordType||''; if(t) typeCount[t] = (typeCount[t]||0)+1; });
  document.querySelectorAll('#cardTypeRow .cef-pill').forEach(pill => {
    const match = (pill.getAttribute('onclick')||'').match(/'([^']+)'/);
    const type = match ? match[1] : '';
    if (type === 'all') {
      pill.innerHTML = 'All Types <span style="background:rgba(255,255,255,.13);border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:2px">' + yearScope.length + '</span>';
    } else if (type) {
      const label = type === 'One Word Substitution' ? 'One Word Sub.' : type;
      const cnt = typeCount[type] || 0;
      pill.innerHTML = label + ' <span style="background:rgba(255,255,255,.13);border-radius:50px;font-size:9px;font-weight:800;padding:1px 6px;margin-left:2px' + (cnt===0?';opacity:.4':'') + '">' + cnt + '</span>';
    }
  });
  applyCardDeck();
}

function setCardType2(type, el) {
  cardTypeFilter2 = type;
  document.querySelectorAll('#cardTypeRow .cef-pill').forEach(e => e.classList.remove('ce-active'));
  el.classList.add('ce-active');
  applyCardDeck();
}

function applyCardDeck() {
  const t = Date.now();
  let deck;
  if (cardExamFilter === 'all') deck = [...words];
  else if (cardExamFilter === 'due') deck = words.filter(w => !w.nextReview || w.nextReview <= t);
  else deck = words.filter(w => (w.examCategory||'') === cardExamFilter);
  // apply year filter
  if (cardYearFilter !== 'all') deck = deck.filter(w => (w.year||'').trim() === cardYearFilter);
  // apply type filter
  if (cardTypeFilter2 !== 'all') deck = deck.filter(w => (w.wordType||'') === cardTypeFilter2);
  if (!deck.length) { showToast('No words match this filter!'); return; }
  currentDeck = deck; currentIdx = 0; isFlipped = false;
  document.getElementById('fc').classList.remove('flipped');
  document.getElementById('rrow').style.display = 'none';
  renderCard();
  showToast('📚 ' + deck.length + ' cards loaded');
}

function setCardExam(exam, el) {
  cardExamFilter = exam;
  cardYearFilter = 'all';
  cardTypeFilter2 = 'all';
  document.querySelectorAll('#cardExamRow .cef-pill').forEach(e => e.classList.remove('ce-active'));
  el.classList.add('ce-active');
  const showSub = exam !== 'all' && exam !== 'due';
  // Show/hide sub-filters
  const typeBlock = document.getElementById('cardTypeBlock');
  if (typeBlock) typeBlock.style.display = showSub ? 'block' : 'none';
  if (showSub) {
    rebuildCardYearPills(exam);
    rebuildCardTypeCounts(exam);
    // reset type pills
    document.querySelectorAll('#cardTypeRow .cef-pill').forEach((e,i) => e.classList.toggle('ce-active', i===0));
  } else {
    const yearBlock = document.getElementById('cardYearBlock');
    if (yearBlock) yearBlock.style.display = 'none';
  }
  const t = Date.now();
  let deck;
  if (exam === 'all')   deck = [...words];
  else if (exam === 'due') deck = words.filter(w => !w.nextReview || w.nextReview <= t);
  else                  deck = words.filter(w => (w.examCategory||'') === exam);
  if (!deck.length) {
    showToast(exam === 'due' ? '🎉 No words due today!' : 'No words for ' + exam);
    return;
  }
  currentDeck = deck; currentIdx = 0; isFlipped = false;
  document.getElementById('fc').classList.remove('flipped');
  document.getElementById('rrow').style.display = 'none';
  const label = exam === 'due' ? '📅 Due Today' : exam === 'all' ? '🃏 All Cards' : exam;
  document.getElementById('cmodeLbl').textContent = label;
  renderCard();
  showToast('📚 ' + deck.length + ' cards loaded');
}

function startDueReview() {
  const due = words.filter(w => !w.nextReview || w.nextReview <= Date.now());
  if (!due.length) { showToast('🎉 All caught up! No words due today.'); return; }
  currentDeck = due; currentIdx = 0; isFlipped = false;
  showScreen('cardScreen', document.querySelector('.nb:nth-child(3)'));
  document.getElementById('cmodeLbl').textContent = '📅 Due Review';
  document.querySelectorAll('.cef-pill').forEach((e,i) => e.classList.toggle('ce-active', i===1)); // "Due Today" pill
  setupSwipe(); renderCard();
  showToast('📅 ' + due.length + ' words due today!');
}

function startSRFilter(rating) {
  const map = { hard: w => w.srRating==='hard' || (!w.srRating && w.strength==='weak'), medium: w => w.srRating==='medium' || (!w.srRating && w.strength==='medium'), easy: w => w.srRating==='easy' || (!w.srRating && w.strength==='strong') };
  const deck = words.filter(map[rating] || (()=>true));
  if (!deck.length) { showToast('No ' + rating + ' words yet!'); return; }
  currentDeck = deck; currentIdx = 0; isFlipped = false;
  const label = {hard:'😓 Hard Words',medium:'🤔 Medium Words',easy:'😊 Mastered Words'}[rating];
  showScreen('cardScreen', document.querySelector('.nb:nth-child(3)'));
  document.getElementById('cmodeLbl').textContent = label;
  document.querySelectorAll('.cef-pill').forEach(e => e.classList.remove('ce-active'));
  setupSwipe(); renderCard();
  showToast(deck.length + ' ' + rating + ' words loaded');
}

async function retryImg(e) {
  e.stopPropagation(); e.preventDefault();
  const w = currentDeck[currentIdx]; if (!w) return;
  const wd = words.find(x => x.id === w.id); if (!wd) return;
  const seed = Math.floor(Math.random()*9999);
  wd.imgSeed = seed;
  wd.imageUrl = getImageUrl(wd.imagePrompt || wd.word, seed);
  w.imageUrl = wd.imageUrl;
  saveWords(); renderCard(); showToast('🖼️ New image...');
}

async function retryAI(e) {
  e.stopPropagation(); e.preventDefault();
  const w = currentDeck[currentIdx]; if (!w) return;
  showToast('🤖 Refreshing...');
  try {
    const data = await fetchWordData(w.word);
    const wd = words.find(x => x.id === w.id);
    if (wd) {
      Object.assign(wd, {hindi:cleanDevanagari(data.hindi)||wd.hindi,hindiPhonetic:data.hindiPhonetic||wd.hindiPhonetic||'',pos:data.pos||wd.pos,definition:data.definition||wd.definition,example:data.example||wd.example,synonyms:data.synonyms||wd.synonyms,antonyms:data.antonyms||wd.antonyms,mnemonic:data.mnemonic||wd.mnemonic,imagePrompt:data.imagePrompt||wd.imagePrompt,roots:data.roots||wd.roots||[],wordFamily:data.wordFamily||wd.wordFamily||[],sentences:data.sentences||wd.sentences||[],confusables:data.confusables||wd.confusables||[]});
      Object.assign(w, wd);
      saveWords(); renderCard(); showToast('✅ Refreshed!');
    }
  } catch(e) { showToast('Failed: ' + e.message); }
}

// ============================================================
// SWIPE GESTURES — bulletproof tap-to-flip
// RULE: If the gesture is not clearly a horizontal swipe → it is a tap → flip.
// This is far more reliable than time-based checks (timing varies per device).
// Only exception: obvious vertical scroll on the back face is ignored.
// ============================================================
function setupSwipe() {
  const wrapper = document.getElementById('fcWrapper');
  if (!wrapper) return;

  // Always work fresh — re-running setupSwipe replaces old listeners
  if (wrapper._swipeReady) {
    wrapper._startX = 0; wrapper._startY = 0;
    return; // already wired up, just reset coords
  }
  wrapper._swipeReady = true;

  const SWIPE_PX = 70;   // horizontal px needed to count as a swipe
  const SCROLL_PX = 28;  // vertical px on back face = scroll, ignore

  function getFC()  { return document.getElementById('fc'); }
  function getSL()  { return wrapper.querySelector('.swing-l'); }
  function getSR()  { return wrapper.querySelector('.swing-r'); }

  function onStart(x, y, target) {
    wrapper._startX = x;
    wrapper._startY = y;
    // Record what element the touch/click started on
    wrapper._startTarget = target || null;
  }

  function onMove(x, y) {
    const dx = x - wrapper._startX;
    const dy = y - wrapper._startY;
    const absDx = Math.abs(dx), absDy = Math.abs(dy);
    if (isFlipped && absDy > absDx) return; // vertical scroll on back — don't drag
    if (absDx > absDy && absDx > 10) {
      const fc = getFC(); if (!fc) return;
      fc.style.transform = isFlipped
        ? `rotateY(180deg) translateX(${-dx}px) rotate(${-dx * 0.025}deg)`
        : `translateX(${dx}px) rotate(${dx * 0.025}deg)`;
      const sl = getSL(), sr = getSR();
      if (sl) sl.style.opacity = dx < -28 ? Math.min(1, (-dx - 28) / 50) : 0;
      if (sr) sr.style.opacity = dx >  28 ? Math.min(1, ( dx - 28) / 50) : 0;
    }
  }

  function onEnd(x, y) {
    const dx = x - wrapper._startX;
    const dy = y - wrapper._startY;
    const absDx = Math.abs(dx), absDy = Math.abs(dy);

    // Always reset card visual first
    const fc = getFC();
    if (fc) fc.style.transform = '';
    const sl = getSL(), sr = getSR();
    if (sl) sl.style.opacity = 0;
    if (sr) sr.style.opacity = 0;

    // ── If touch started on a button / interactive element → do nothing (let it fire its own onclick)
    const t = wrapper._startTarget;
    if (t && (t.closest('button') || t.closest('a') || t.closest('[onclick]') || t.tagName === 'BUTTON' || t.closest('.cq-grid'))) return;

    // ── SWIPE: clearly horizontal and long enough → navigate or rate
    if (absDx >= SWIPE_PX && absDx > absDy * 1.3) {
      if (dx < 0) { isFlipped ? rateCard('hard') : nextCard(); }
      else        { isFlipped ? rateCard('easy') : nextCard(); }
      return;
    }

    // ── VERTICAL SCROLL on back face: ignore (let cfBack scroll naturally)
    if (isFlipped && absDy >= SCROLL_PX && absDy > absDx * 1.5) return;

    // ── EVERYTHING ELSE = TAP → flip the card
    flipCard();
  }

  // Touch events
  wrapper.addEventListener('touchstart', e => {
    onStart(e.touches[0].clientX, e.touches[0].clientY, e.target);
  }, { passive: true });

  wrapper.addEventListener('touchmove', e => {
    const absDx = Math.abs(e.touches[0].clientX - wrapper._startX);
    const absDy = Math.abs(e.touches[0].clientY - wrapper._startY);
    if (!isFlipped && absDx > absDy && absDx > 12) e.preventDefault();
    onMove(e.touches[0].clientX, e.touches[0].clientY);
  }, { passive: false });

  wrapper.addEventListener('touchend', e => {
    onEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
  }, { passive: true });

  // Mouse events (desktop)
  wrapper.addEventListener('mousedown', e => onStart(e.clientX, e.clientY, e.target));
  wrapper.addEventListener('mousemove', e => { if (e.buttons) onMove(e.clientX, e.clientY); });
  wrapper.addEventListener('mouseup',   e => onEnd(e.clientX, e.clientY));
}

// ============================================================
// PRACTICE MODES (Timed + Rapid Fire only)
// ============================================================
function startPractice(mode) {
  if (words.length < 2) { showToast('Add at least 2 words!'); return; }
  practiceMode = mode; practiceWords = shuffle([...words]).slice(0, Math.min(10, words.length));
  practiceIdx = 0; practiceScore = 0; practiceTotal = practiceWords.length;
  showScreen('practiceScreen', null);
  renderPQ();
}

function renderPQ() {
  const w = practiceWords[practiceIdx];
  if (!w) { showPResult(); return; }
  document.getElementById('psub').textContent = 'Q ' + (practiceIdx+1) + ' of ' + practiceTotal;
  clearInterval(timerInt);
  const cont = document.getElementById('pContent');

  if (practiceMode === 'timed') {
    document.getElementById('ptitle').textContent = '⏱️ Timed Quiz';
    document.getElementById('tbarWrap').style.display = 'block';
    startTimer(15);
    const opts = genOpts(w);
    cont.innerHTML = `<div class="pq-lbl">Meaning of</div><div class="pq-text">"${w.word}"</div>
      <div style="font-size:12px;color:var(--textSub);margin-bottom:14px">${w.hindi}</div>
      <div class="mopts">${opts.map((o,i) => `<button class="mopt" onclick="chkMCQ(this,'${i}','${opts.indexOf(w.definition)}')">${o}</button>`).join('')}</div>`;
  } else if (practiceMode === 'rapid') {
    document.getElementById('ptitle').textContent = '🚀 Rapid Fire';
    document.getElementById('tbarWrap').style.display = 'none';
    startRapid(); return;
  }
}

function genOpts(w) {
  const correct = w.definition;
  const others = shuffle(words.filter(x=>x.id!==w.id&&x.definition)).slice(0,3).map(x=>x.definition);
  return shuffle([correct,...others]);
}

function chkMCQ(btn, sel, corr) {
  clearInterval(timerInt);
  document.querySelectorAll('.mopt').forEach(o=>o.disabled=true);
  const selN = parseInt(sel), corrN = parseInt(corr);
  if (selN===corrN) { btn.classList.add('correct'); practiceScore++; showToast('✅ Correct!'); }
  else { btn.classList.add('wrong'); document.querySelectorAll('.mopt')[corrN].classList.add('correct'); showToast('❌ Wrong!'); }
  const w = practiceWords[practiceIdx];
  const wd = words.find(x=>x.id===w.id);
  if (wd) { wd.strength = sel===corr?'strong':'weak'; saveWords(); }
  setTimeout(advP, 1400);
}

function advP() { practiceIdx++; if (practiceIdx>=practiceTotal) showPResult(); else renderPQ(); }
function showPResult() {
  clearInterval(timerInt);
  document.getElementById('tbarWrap').style.display = 'none';
  const pct = Math.round(practiceScore/practiceTotal*100);
  document.getElementById('pContent').innerHTML = `<div class="score-result"><div style="font-size:56px">${pct>=80?'🎉':pct>=60?'👍':'💪'}</div><div class="score-big">${pct}%</div><div style="font-size:16px;font-weight:600">${practiceScore}/${practiceTotal} correct</div><div style="font-size:13px;color:var(--textSub)">${pct>=80?'Excellent!':pct>=60?'Good effort!':'Keep practicing!'}</div><button class="btn btn-gold" style="margin-top:20px;padding:13px 28px" onclick="exitPractice()">Back to Home</button><button class="btn btn-ghost" style="padding:13px 28px" onclick="startPractice('${practiceMode}')">Try Again</button></div>`;
  if (pct>=80) confetti();
}
function exitPractice() { clearInterval(timerInt); clearInterval(rapidInt); showScreen('homeScreen', document.querySelector('.nb:nth-child(1)')); }

function startTimer(sec) {
  let rem=sec;
  const fill=document.getElementById('tbar');
  fill.style.transition='none'; fill.style.width='100%';
  setTimeout(()=>{ fill.style.transition=`width ${sec}s linear`; fill.style.width='0%'; },50);
  timerInt=setInterval(()=>{ rem--; if(rem<=0){ clearInterval(timerInt); document.querySelectorAll('.mopt').forEach(o=>o.disabled=true); showToast('⏱️ Time\'s up!'); setTimeout(advP,1000); }},1000);
}

function startRapid() {
  rapidActive=true; rapidCount=0; rapidTimer=60;
  const all=shuffle([...words]); let ri=0;
  function show() {
    if(!rapidActive) return;
    const w=all[ri%all.length]; ri++;
    const opts=genOpts(w);
    document.getElementById('pContent').innerHTML = `<div style="text-align:center;padding:16px 16px 0">
      <div style="font-size:12px;color:var(--textSub);margin-bottom:4px">⏱️ ${rapidTimer}s</div>
      <div class="rapid-count">${rapidCount}</div>
      <div style="font-size:11px;color:var(--textMuted);margin-bottom:16px">words correct</div>
      <div style="font-family:'Playfair Display',serif;font-size:26px;font-weight:700;margin-bottom:14px">${w.word}</div>
      <div class="mopts">${opts.map((o,i)=>`<button class="mopt" style="font-size:12px;padding:10px" onclick="rfChk(this,'${o.replace(/'/g,"\\'")}','${w.definition.replace(/'/g,"\\'")}',${w.id})">${o.substring(0,55)}${o.length>55?'...':''}</button>`).join('')}</div>
    </div>`;
  }
  rapidInt=setInterval(()=>{ rapidTimer--; const el=document.querySelector('.rapid-count'); if(el){const ti=el.previousElementSibling; if(ti) ti.textContent='⏱️ '+rapidTimer+'s';} if(rapidTimer<=0){clearInterval(rapidInt);rapidActive=false;showRFResult();}},1000);
  show(); window._rfShow=show; window._rfActive=()=>rapidActive;
}
window.rfChk=function(btn,sel,corr,wid){
  document.querySelectorAll('#pContent .mopt').forEach(o=>o.disabled=true);
  if(sel===corr){btn.classList.add('correct');rapidCount++;}
  else{btn.classList.add('wrong'); document.querySelectorAll('#pContent .mopt').forEach(o=>{if(o.textContent.trim().startsWith(corr.substring(0,10)))o.classList.add('correct');});}
  setTimeout(()=>{if(window._rfActive())window._rfShow();},600);
};
function showRFResult(){document.getElementById('pContent').innerHTML=`<div class="score-result"><div style="font-size:56px">🚀</div><div class="score-big">${rapidCount}</div><div style="font-size:16px;font-weight:600">words in 60 sec!</div><div style="font-size:13px;color:var(--textSub)">${rapidCount>=8?'Outstanding!':rapidCount>=5?'Great job!':'Keep going!'}</div><button class="btn btn-gold" style="margin-top:20px;padding:13px 28px" onclick="exitPractice()">Back</button><button class="btn btn-ghost" style="padding:13px 28px" onclick="startMode('rapid')">Again</button></div>`;if(rapidCount>=5)confetti();}

// ============================================================
// STORY MODE
// ============================================================
async function showStoryMode() {
  if (words.length < 3) { showToast('Add at least 3 words!'); return; }
  openM('storyModal');
  const sw = shuffle([...words]).slice(0,5);
  document.getElementById('storyContent').innerHTML = `<div style="text-align:center;padding:28px"><div class="spin" style="margin:0 auto 10px"></div><div style="font-size:12px;color:var(--textSub)">✨ Creating story...</div><div style="display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin-top:14px">${sw.map(w=>`<span class="tag" style="color:var(--gold)">${w.word}</span>`).join('')}</div></div>`;
  const wl = sw.map(w=>w.word).join(', ');
  const prompt = 'Write a short engaging story (100-150 words) using these vocabulary words naturally: '+wl+'. Be creative. Return ONLY the story text, no title.';
  try {
    const res = await vmAI(prompt);
    let story = (await res.text()).trim();
    sw.forEach(w => { story = story.replace(new RegExp('\\b'+w.word+'\\b','gi'), '<span class="story-hl">'+w.word+'</span>'); });
    document.getElementById('storyContent').innerHTML = `
      <div style="margin-bottom:12px"><div class="lbl">Words used</div><div style="margin-top:6px">${sw.map(w=>`<span class="tag" style="color:var(--gold)">${w.word}</span>`).join('')}</div></div>
      <div class="card" style="margin-bottom:14px"><div class="story-text">${story}</div></div>
      <button class="btn btn-gold" style="width:100%" onclick="showStoryMode()">✨ New Story</button>`;
  } catch(e) {
    document.getElementById('storyContent').innerHTML = `<div style="text-align:center;padding:20px;color:var(--red);font-size:13px">Failed to generate story.</div><button class="btn btn-ghost" style="width:100%" onclick="showStoryMode()">Try Again</button>`;
  }
}

// ============================================================
// SENTENCE BUILDER
// ============================================================
function showSentenceBuilder() {
  if (!words.length) { showToast('Add words first!'); return; }
  openM('sbModal');
  const w = words[Math.floor(Math.random()*words.length)];
  const sentence = w.example || 'The word ' + w.word + ' is used effectively.';
  const parts = sentence.replace(/[.,!?;:]/g,'').split(' ').filter(Boolean);
  const scrambled = shuffle([...parts]);
  let placed=[], remaining=[...scrambled];
  function render() {
    document.getElementById('sbContent').innerHTML = `
      <div style="margin-bottom:12px"><div class="lbl">Word: <span style="color:var(--gold)">${w.word}</span></div><div style="font-size:12px;color:var(--textSub);margin-top:2px">Arrange to form a sentence</div></div>
      <div class="sb-drop">${placed.length?placed.map((wd,i)=>`<div class="sb-placed" onclick="rmW(${i})">${wd} ✕</div>`).join(''):'<span style="color:var(--textMuted);font-size:12px">Tap words below...</span>'}</div>
      <div class="sb-words">${remaining.map((wd,i)=>`<div class="sb-w" onclick="plW(${i})">${wd}</div>`).join('')}</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-gold" style="flex:1" onclick="chkSB()">✓ Check</button>
        <button class="btn btn-ghost" onclick="rstSB()">↺ Reset</button>
      </div>
      <div id="sbRes" style="display:none;margin-top:10px;padding:10px;border-radius:8px;font-size:13px;font-weight:600;text-align:center"></div>
      <button class="btn btn-ghost btn-sm" style="margin-top:10px" onclick="document.getElementById('sbAns').style.display='block'">Show Answer</button>
      <div id="sbAns" style="display:none;font-size:12px;color:var(--textSub);margin-top:6px;font-style:italic">"${sentence}"</div>`;
    window.plW=(i)=>{placed.push(remaining[i]);remaining.splice(i,1);render();};
    window.rmW=(i)=>{remaining.push(placed[i]);placed.splice(i,1);render();};
    window.rstSB=()=>{placed=[];remaining=[...scrambled];render();};
    window.chkSB=()=>{
      const attempt=placed.join(' ').toLowerCase();
      const correct=parts.join(' ').toLowerCase();
      const res=document.getElementById('sbRes');
      res.style.display='block';
      if(attempt===correct){res.style.background='rgba(52,211,153,.15)';res.style.color='var(--green)';res.textContent='✅ Perfect!';confetti();}
      else{res.style.background='rgba(248,113,113,.15)';res.style.color='var(--red)';res.textContent='Not quite, try again!';}
    };
  }
  render();
}

// ============================================================
// XP system removed — stubs kept so existing call sites don't crash
function addXP(n){}
function showXPPop(n){}

// ── PROGRESS TABS ──
function switchProgTab(tab) {
  ['stats','sr','quiz'].forEach(t => {
    const btn = document.getElementById('ptab-'+t);
    const content = document.getElementById('ptab-'+t+'-content');
    if (btn) btn.className = t===tab ? 'btn btn-gold btn-sm' : 'btn btn-ghost btn-sm';
    if (btn) { btn.style.flex='1'; btn.style.justifyContent='center'; btn.style.borderRadius='10px'; }
    if (content) content.style.display = t===tab ? '' : 'none';
  });
  if (tab === 'sr') renderSRList('all');
  if (tab === 'quiz') renderQuizLog();
}

function updateProgress() {
  const el = id => document.getElementById(id);
  const now = Date.now();
  const str = words.filter(w=>w.strength==='strong').length;
  const med = words.filter(w=>w.strength==='medium').length;
  const wk  = words.filter(w=>w.strength==='weak'||!w.strength).length;
  const due = words.filter(w=> !w.nextReview || w.nextReview <= now).length;
  const tot = Math.max(words.length, 1);

  if (el('pTotalWords')) el('pTotalWords').textContent = words.length;
  if (el('pMastered'))   el('pMastered').textContent   = str;
  if (el('pStreak'))     el('pStreak').textContent      = userData.streak || 0;
  if (el('pDueToday'))   el('pDueToday').textContent    = due;

  ['strBar','medBar','wkBar'].forEach((id,i) => {
    const ct = [str,med,wk][i];
    if(el(id)) el(id).style.width=(ct/tot*100)+'%';
  });
  if(el('strCt')) el('strCt').textContent=str;
  if(el('medCt')) el('medCt').textContent=med;
  if(el('wkCt'))  el('wkCt').textContent=wk;

  // Activity graph
  const graph = el('actGraph');
  if (graph) {
    const days=[];
    for(let i=6;i>=0;i--){const d=new Date(now-i*86400000);const k=d.toDateString();days.push({count:userData.activity[k]||0,label:['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()]});}
    const mx=Math.max(...days.map(d=>d.count),1);
    graph.innerHTML=days.map(d=>`<div class="bar-col"><div class="bar-fill" style="height:${Math.max(4,(d.count/mx)*60)}px"></div><div class="bar-lbl">${d.label}</div></div>`).join('');
  }

  // Achievements
  const achGrid = el('achGrid');
  if (achGrid) {
    const totalReviews = words.reduce((s,w)=>(s+(w.reviewCount||0)),0);
    const achs=[
      {i:'🌱',n:'First Word',u:words.length>=1},
      {i:'📚',n:'10 Words',u:words.length>=10},
      {i:'🔥',n:'3-Day Streak',u:(userData.streak||0)>=3},
      {i:'⭐',n:'7-Day Streak',u:(userData.streak||0)>=7},
      {i:'💪',n:'5 Mastered',u:str>=5},
      {i:'🏆',n:'20 Words',u:words.length>=20},
      {i:'🧠',n:'Memory Pro',u:str>=15},
      {i:'🎯',n:'50 Words',u:words.length>=50},
      {i:'📖',n:'100 Reviews',u:totalReviews>=100},
      {i:'🚀',n:'SM-2 User',u:words.some(w=>w.reps>=3)},
      {i:'🏅',n:'Long Interval',u:words.some(w=>(w.interval||0)>=30)},
      {i:'👑',n:'25 Mastered',u:str>=25},
    ];
    achGrid.innerHTML=achs.map(a=>`<div class="ach ${a.u?'unlocked':'locked'}"><div class="ach-icon">${a.i}</div><div class="ach-name">${a.n}</div></div>`).join('');
  }
}

// ── SR ENGINE TAB ──
function renderSRList(filter) {
  // Update filter pills
  ['all','due','hard','easy'].forEach(f => {
    const el = document.getElementById('srf-'+f);
    if (!el) return;
    const active = f===filter;
    el.style.background = active ? 'rgba(245,200,66,.15)' : 'var(--card2)';
    el.style.borderColor = active ? 'var(--gold)' : 'var(--border)';
    el.style.color = active ? 'var(--gold)' : 'var(--textSub)';
  });

  const now = Date.now();
  let list = [...words].filter(w => w.reviewCount > 0);
  if (filter === 'due')  list = list.filter(w => !w.nextReview || w.nextReview <= now);
  if (filter === 'hard') list = list.filter(w => w.srRating === 'hard' || (w.ef && w.ef < 1.8));
  if (filter === 'easy') list = list.filter(w => w.srRating === 'easy' && (w.interval||0) >= 7);

  // Sort by nextReview ascending
  list.sort((a,b) => (a.nextReview||0) - (b.nextReview||0));

  const container = document.getElementById('srWordList');
  if (!container) return;

  if (!list.length) {
    container.innerHTML = `<div style="font-size:12px;color:var(--textMuted);text-align:center;padding:20px">No words match this filter${filter!=='all'?' — keep studying!':''}</div>`;
    return;
  }

  container.innerHTML = list.slice(0,50).map(w => {
    const ef = typeof w.ef === 'number' ? w.ef.toFixed(2) : '2.50';
    const interval = w.interval || 1;
    const reps = w.reps || 0;
    const due = w.nextReview ? w.nextReview : now;
    const daysLeft = Math.round((due - now) / 86400000);
    const dueStr = daysLeft <= 0 ? '<span style="color:var(--red);font-weight:700">Due now!</span>'
                 : daysLeft === 1 ? '<span style="color:var(--orange)">Tomorrow</span>'
                 : `<span style="color:var(--textMuted)">In ${daysLeft}d</span>`;
    const ratingColor = {hard:'var(--red)',medium:'var(--orange)',easy:'var(--green)'}[w.srRating] || 'var(--textMuted)';
    const ratingIcon = {hard:'😓',medium:'🤔',easy:'✅'}[w.srRating] || '⬜';
    const efColor = ef >= 2.5 ? 'var(--green)' : ef >= 1.8 ? 'var(--orange)' : 'var(--red)';
    return `<div style="background:var(--card2);border-radius:10px;padding:10px 12px;border:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-family:'Playfair Display',serif;font-size:14px;font-weight:700;color:var(--text)">${w.word}</div>
        <span style="font-size:13px">${ratingIcon}</span>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
        <div style="font-size:10px;background:var(--card);border-radius:6px;padding:3px 8px;border:1px solid var(--border)">
          EF <b style="color:${efColor}">${ef}</b>
        </div>
        <div style="font-size:10px;background:var(--card);border-radius:6px;padding:3px 8px;border:1px solid var(--border)">
          Interval <b style="color:var(--accent2)">${interval}d</b>
        </div>
        <div style="font-size:10px;background:var(--card);border-radius:6px;padding:3px 8px;border:1px solid var(--border)">
          Reviews <b style="color:var(--gold)">${reps}</b>
        </div>
        <div style="font-size:10px;padding:3px 8px">${dueStr}</div>
      </div>
    </div>`;
  }).join('');
}

// ── QUIZ HISTORY TAB ──
function renderQuizLog() {
  const now = Date.now();
  // MCQ session history
  const qhContainer = document.getElementById('quizHistoryLog');
  const sessions = quizHistory || [];
  if (qhContainer) {
    if (!sessions.length) {
      qhContainer.innerHTML = '<div style="font-size:12px;color:var(--textMuted);text-align:center;padding:20px">No quiz sessions yet — try the MCQ Quiz mode!</div>';
    } else {
      const totalSessions = sessions.length;
      // FIX: field is 'corr' not 'correct'
      const scores = sessions.filter(s=>s.total>0).map(s=>Math.round((s.corr||s.correct||0)/s.total*100));
      const avgScore = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
      const bestScore = scores.length ? Math.max(...scores) : 0;
      if (document.getElementById('qhTotalSessions')) document.getElementById('qhTotalSessions').textContent = totalSessions;
      if (document.getElementById('qhAvgScore')) document.getElementById('qhAvgScore').textContent = avgScore+'%';
      if (document.getElementById('qhBestScore')) document.getElementById('qhBestScore').textContent = bestScore+'%';

      qhContainer.innerHTML = sessions.map((s,si) => {
        const corr = s.corr ?? s.correct ?? 0;
        const pct = s.total > 0 ? Math.round(corr/s.total*100) : 0;
        const pctColor = pct>=80?'var(--green)':pct>=50?'var(--orange)':'var(--red)';
        const wrongCt = s.wrong || (s.total - corr - (s.skip||0));
        // Date formatting - handle both string and timestamp
        let dateStr = '—';
        try {
          const d = typeof s.date === 'number' ? new Date(s.date) : new Date(s.id||Date.now());
          dateStr = d.toLocaleDateString('en-IN',{day:'numeric',month:'short'}) + ' ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
        } catch(e){}
        const grade = pct>=90?'🎉':pct>=70?'😊':pct>=50?'😐':'😓';
        const hasAnswers = s.answers && s.answers.length > 0;
        return `<div style="background:var(--card2);border-radius:14px;padding:13px 14px;border:1px solid var(--border)">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
            <div>
              <div style="font-size:13px;font-weight:700;color:var(--text)">${s.exam||'Quiz'} · ${s.cat||'All'}</div>
              <div style="font-size:10px;color:var(--textMuted);margin-top:2px">${dateStr} · ${s.total||0} questions</div>
            </div>
            <div style="text-align:right">
              <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:${pctColor};line-height:1">${pct}%</div>
              <div style="font-size:11px">${grade}</div>
            </div>
          </div>
          <div style="display:flex;gap:6px;margin-bottom:8px">
            <span style="font-size:11px;color:var(--green);background:rgba(52,211,153,.12);border:1px solid rgba(52,211,153,.25);padding:3px 10px;border-radius:50px;font-weight:700">✓ ${corr} correct</span>
            <span style="font-size:11px;color:var(--red);background:rgba(248,113,113,.12);border:1px solid rgba(248,113,113,.25);padding:3px 10px;border-radius:50px;font-weight:700">✗ ${wrongCt} wrong</span>
          </div>
          <div style="height:5px;background:var(--card);border-radius:3px;overflow:hidden;margin-bottom:8px">
            <div style="height:100%;width:${pct}%;background:${pctColor};border-radius:3px;transition:width .6s"></div>
          </div>
          ${hasAnswers ? `<button onclick="expandQuizSession(${si})" id="qhs-btn-${si}"
            style="width:100%;padding:7px;border-radius:8px;border:1.5px solid var(--border);background:var(--card);color:var(--textSub);font-size:11px;font-weight:700;cursor:pointer">
            🔍 Review All Answers
          </button>
          <div id="qhs-detail-${si}" style="display:none;margin-top:8px"></div>` : ''}
        </div>`;
      }).join('');
    }
  }

  // Flashcard review log (from reviewHistory on each word)
  const fcContainer = document.getElementById('fcReviewLog');
  if (fcContainer) {
    // Collect all individual reviews from word.reviewHistory
    const allReviews = [];
    words.forEach(w => {
      (w.reviewHistory || []).forEach(r => {
        allReviews.push({ word: w.word, ...r });
      });
    });
    allReviews.sort((a,b) => b.date - a.date);
    const recent = allReviews.slice(0, 30);
    if (!recent.length) {
      fcContainer.innerHTML = '<div style="font-size:12px;color:var(--textMuted);text-align:center;padding:16px">No flashcard reviews yet</div>';
    } else {
      const ratingIcon = {hard:'😓 Hard',medium:'🤔 Medium',easy:'✅ Easy'};
      const ratingColor = {hard:'var(--red)',medium:'var(--orange)',easy:'var(--green)'};
      fcContainer.innerHTML = recent.map(r => {
        const dateStr = new Date(r.date).toLocaleDateString('en-IN',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--card2);border-radius:8px;border:1px solid var(--border)">
          <div>
            <span style="font-family:'Playfair Display',serif;font-size:13px;font-weight:700">${r.word}</span>
            <span style="font-size:10px;color:var(--textMuted);margin-left:6px">${dateStr}</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:10px;font-weight:700;color:${ratingColor[r.rating]||'var(--textMuted)'}">${ratingIcon[r.rating]||r.rating}</span>
            <span style="font-size:9px;color:var(--textMuted)">→${r.interval}d</span>
          </div>
        </div>`;
      }).join('');
    }
  }
}

// ============================================================
// MODAL HELPERS
// ============================================================
function openM(id){document.getElementById(id).classList.add('open');}
function closeM(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.moverlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// TOAST
let toastTm;
function showToast(msg, duration){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastTm);toastTm=setTimeout(()=>t.classList.remove('show'),duration||2500);}

// CONFETTI
function confetti(){const em=['🎉','⭐','✨','🌟','💫','🎊'];for(let i=0;i<8;i++){setTimeout(()=>{const el=document.createElement('div');el.className='conf';el.textContent=em[Math.floor(Math.random()*em.length)];el.style.left=Math.random()*80+10+'vw';el.style.top='10%';el.style.animationDelay=Math.random()*.5+'s';document.body.appendChild(el);setTimeout(()=>el.remove(),2000);},i*100);}}

// UTILS
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

// Strips any Latin/ASCII characters from a string, keeping only Devanagari + spaces/punctuation
// Handles cases where AI accidentally returns "एकाकी (Ekaki)" or "क्षणिक - transient"
function cleanDevanagari(str) {
  if (!str || str === '—') return str;
  // Keep Devanagari Unicode block (0900–097F), spaces, and common punctuation
  const devaOnly = str.replace(/[^\u0900-\u097F\s,।॥·]/g, '').trim();
  // If nothing Devanagari survived (old data has romanized only), return original
  return devaOnly.length > 1 ? devaOnly : str;
}

// STREAK & DAILY
// Bug Fix 6: Streak was incrementing just by opening the app — now requires at least 1 review
function checkStreak(){
  const today = new Date().toDateString();
  if (userData.lastSeen === today) return; // already checked today
  const yest = new Date(Date.now() - 86400000).toDateString();
  const hadReviewYesterday = (userData.activity[yest] || 0) > 0;
  // Increment streak only if: last seen was yesterday AND had real ratings yesterday
  if (userData.lastSeen === yest && hadReviewYesterday) {
    userData.streak = (userData.streak || 0) + 1;
  } else if (userData.lastSeen !== yest && userData.lastSeen !== today) {
    // lastSeen is older than yesterday → streak broken
    userData.streak = 0;
  }
  userData.lastSeen = today;
  saveUser();
}

// Check streak again if midnight crosses while app is open
(function setupMidnightStreakCheck() {
  function msUntilMidnight() {
    const now = new Date();
    const midnight = new Date(now); midnight.setHours(24,0,0,0);
    return midnight - now;
  }
  function scheduleNext() {
    setTimeout(() => { checkStreak(); checkDaily(); updateHome(); scheduleNext(); }, msUntilMidnight() + 1000);
  }
  scheduleNext();
})();
function checkDaily(){const today=new Date().toDateString();if(userData.lastReviewDate!==today){userData.dailyReviewed=0;userData.lastReviewDate=today;saveUser();}}

// ============================================================
// IMPORT / EXPORT / BULK ADD
// ============================================================
let expExamFilter = 'all';
let bulkExam = 'SSC CGL', bulkType = 'Synonyms';
let impDefExam = 'SSC CGL', impDefType = 'Synonyms';

function selImpMeta(kind, val, el) {
  if (kind === 'exam') {
    impDefExam = val;
    document.querySelectorAll('#impDefExamRow .imp-fmt-pill').forEach(e => e.classList.toggle('active', e===el));
  } else {
    impDefType = val;
    document.querySelectorAll('#impDefTypeRow .imp-fmt-pill').forEach(e => e.classList.toggle('active', e===el));
  }
}

function switchImpTab(tab) {
  // FIX: tab IDs are impTab/expTab/bulkTab — NOT importTab/exportTab/bulkTab
  const tabIdMap = { import: 'impTab', export: 'expTab', bulk: 'bulkTab', scan: 'scanTab' };
  const btnIdMap = { import: 'impTabBtn', export: 'expTabBtn', bulk: 'bulkTabBtn', scan: 'scanTabBtn' };

  // Hide all tab content panels
  Object.values(tabIdMap).forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  // Reset all tab buttons to ghost style
  Object.values(btnIdMap).forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.className = 'btn btn-ghost btn-sm'; el.style.flex = ''; el.style.justifyContent = 'center'; el.style.background = ''; el.style.color = ''; el.style.border = ''; }
  });
  // Keep scan tab button always tinted even when inactive
  const scanBtnEl = document.getElementById('scanTabBtn');
  if (scanBtnEl) { scanBtnEl.style.background = 'rgba(124,106,247,.15)'; scanBtnEl.style.color = 'var(--accent2)'; scanBtnEl.style.border = '1.5px solid rgba(124,106,247,.3)'; }

  // Show the selected tab panel
  const tabEl = document.getElementById(tabIdMap[tab]);
  if (tabEl) tabEl.style.display = 'block';

  // Highlight the active tab button
  const btnEl = document.getElementById(btnIdMap[tab]);
  if (btnEl) { btnEl.className = 'btn btn-gold btn-sm'; btnEl.style.flex = ''; btnEl.style.justifyContent = 'center'; btnEl.style.background = ''; btnEl.style.color = ''; btnEl.style.border = ''; }

  if (tab === 'export') refreshExpStats();
}

function refreshExpStats() {
  const el = document.getElementById('expStats');
  const exams = {};
  words.forEach(w => { const e = w.examCategory || 'Untagged'; exams[e] = (exams[e] || 0) + 1; });
  const rows = Object.entries(exams).map(([k,v]) => `<div>• ${k}: <b style="color:var(--text)">${v} word${v>1?'s':''}</b></div>`).join('');
  el.innerHTML = `<div>Total: <b style="color:var(--gold)">${words.length} words</b></div>${rows || '<div style="color:var(--textMuted)">No words yet</div>'}`;
}

function setExpExam(exam, el) {
  expExamFilter = exam;
  document.querySelectorAll('#expTab .imp-pill').forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
}

function selBulkExam(exam, el) {
  bulkExam = exam;
  document.querySelectorAll('#bulkExamRow .imp-pill').forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
}
function selBulkType(type, el) {
  bulkType = type;
  document.querySelectorAll('#bulkTypeRow .imp-pill').forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
}
// Also fix import type selection
function selImpType_fixed(el, rowId) {
  document.querySelectorAll('#' + rowId + ' .imp-pill').forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
}

// ── FORMAT DETECTION ──
function detectImpFormat(text) {
  const t = text.trim();
  const detectEl = document.getElementById('impFmtDetect');
  const metaEl = document.getElementById('impDefaultMeta');
  const prevEl = document.getElementById('impPreview');
  if (!t) { detectEl.style.display='none'; metaEl.style.display='none'; prevEl.style.display='none'; return; }

  const parsed = parseImportText(t);
  detectEl.style.display = 'block';

  if (parsed.error) {
    detectEl.innerHTML = `<div class="fmt-detect fmt-error">❌ ${parsed.error}</div>`;
    metaEl.style.display = 'none'; prevEl.style.display = 'none'; return;
  }

  const isPlain = parsed.format === 'plain';
  const isPartial = parsed.format === 'partial';
  const isFull = parsed.format === 'full';

  // Show/hide default meta picker (only for plain text or partial JSON without exam tags)
  const needsMeta = isPlain || (isPartial && parsed.words.some(w => !w.examCategory));
  metaEl.style.display = needsMeta ? 'block' : 'none';

  const fmtClass = isFull ? 'fmt-json' : isPartial ? 'fmt-partial' : 'fmt-text';
  const fmtLabel = isFull ? '✅ Full VocabMaster JSON' : isPartial ? '⚡ Partial JSON / Mixed' : '📝 Plain word list';
  const enrichCount = parsed.words.filter(w => !w.definition || w.definition==='—').length;
  detectEl.innerHTML = `<div class="fmt-detect ${fmtClass}">${fmtLabel} · ${parsed.words.length} word${parsed.words.length!==1?'s':''} found${enrichCount?` · ${enrichCount} need AI enrichment`:''}</div>`;

  // Show preview
  prevEl.style.display = 'block';
  document.getElementById('impPreviewText').textContent = parsed.words.slice(0,8).map((w,i)=>`${i+1}. ${w.word||'?'}  [${w.examCategory||'—'} · ${w.wordType||'—'} · ${w.year||'—'}]${w.definition&&w.definition!=='—'?' ✓':' (no data)'}`).join('\n') + (parsed.words.length>8?`\n… and ${parsed.words.length-8} more`:'');
}

function parseImportText(text) {
  const t = text.trim();
  // Try full/partial JSON
  if (t.startsWith('{') || t.startsWith('[')) {
    try {
      const data = JSON.parse(t);
      const arr = Array.isArray(data) ? data : (data.words || []);
      if (!arr.length) return { error: 'Empty JSON — no words found' };

      // Check if array of strings
      if (typeof arr[0] === 'string') {
        return { format: 'plain', words: arr.map(s => ({ word: s.toLowerCase().trim() })) };
      }

      // Object array
      const hasFull = arr.some(w => w.definition && w.definition !== '—' && w.synonyms);
      return {
        format: hasFull ? 'full' : 'partial',
        words: arr.filter(w => w.word || w.word === '').map(w => ({ ...w, word: (w.word||'').toLowerCase().trim() }))
      };
    } catch(e) { return { error: 'Invalid JSON: ' + e.message }; }
  }

  // Plain text: one word per line (or comma-separated)
  const sep = t.includes('\n') ? '\n' : ',';
  const lines = t.split(sep).map(l => l.trim().toLowerCase()).filter(Boolean);
  if (!lines.length) return { error: 'No words found' };
  return { format: 'plain', words: lines.map(w => ({ word: w })) };
}

function clearImpPaste() {
  document.getElementById('impPaste').value = '';
  document.getElementById('impPreview').style.display = 'none';
  document.getElementById('impFmtDetect').style.display = 'none';
  document.getElementById('impDefaultMeta').style.display = 'none';
  document.getElementById('impResult').textContent = '';
  document.getElementById('enrichProgress').style.display = 'none';
}

async function doImport() {
  const text = document.getElementById('impPaste').value.trim();
  const res = document.getElementById('impResult');
  if (!text) { res.style.color = 'var(--red)'; res.textContent = 'Paste or type words first!'; return; }

  const parsed = parseImportText(text);
  if (parsed.error) { res.style.color = 'var(--red)'; res.textContent = '❌ ' + parsed.error; return; }

  const defYear = document.getElementById('impDefYear').value || '2025';
  let added = 0, skipped = 0, newIds = [];

  parsed.words.forEach(w => {
    if (!w.word) return;
    const wl = w.word.toLowerCase().trim();
    if (words.find(x => x.word === wl)) { skipped++; return; }
    const nw = {
      id: w.id || uid(),
      word: wl,
      hindi: w.hindi || '—',
      hindiPhonetic: w.hindiPhonetic || '',
      pos: w.pos || 'other',
      definition: w.definition || '—',
      example: w.example || '',
      synonyms: Array.isArray(w.synonyms) ? w.synonyms : [],
      antonyms: Array.isArray(w.antonyms) ? w.antonyms : [],
      mnemonic: w.mnemonic || '',
      imagePrompt: w.imagePrompt || wl,
      imageUrl: w.imageUrl || '',
      imgSeed: w.imgSeed || 0,
      roots: w.roots || [],
      wordFamily: w.wordFamily || [],
      sentences: w.sentences || [],
      confusables: w.confusables || [],
      quizOptions: Array.isArray(w.quizOptions) ? w.quizOptions : [],
      quizCorrect:  w.quizCorrect || '',
      examCategory: w.examCategory || impDefExam,
      wordType: w.wordType || impDefType,
      year: w.year || defYear,
      collection: w.collection || '',
      strength: w.strength || 'weak',
      reviewCount: w.reviewCount || 0,
      nextReview: w.nextReview || Date.now(),
      addedAt: w.addedAt || Date.now()
    };
    words.unshift(nw);
    newIds.push(nw.id);
    added++;
  });

  saveWords(); rebuildExamPills(); updateHome(); renderWords();
  res.style.color = added > 0 ? 'var(--green)' : 'var(--orange)';
  res.textContent = added > 0
    ? `✅ Imported ${added} word${added!==1?'s':''}${skipped?' · '+skipped+' skipped':''}! AI enriching now…`
    : `⚠️ All ${skipped} words already exist.`;

  if (added > 0) {
    confetti();
    // Always auto-enrich all imported words that need data — no checkbox needed
    setTimeout(scheduleAutoEnrich, 500);
    // Removed immediate sync - rely on auto-sync to reduce API calls
    // vm_pushToCloud(); // Batch imports will sync during auto-sync cycle
  }
}

// ── AI ENRICH ENGINE (used by both Import and Bulk Add) ──
async function runAIEnrich(toEnrich, progressId, statusId) {
  const prog = document.getElementById(progressId);
  const status = document.getElementById(statusId);
  if (!prog) return;
  prog.style.display = 'block';

  let done = 0, failed = 0;
  const total = toEnrich.length;

  function renderProg() {
    const chips = toEnrich.map((w,i) => {
      const cls = i < done ? 'ew-done' : i === done ? 'ew-active' : 'ew-pending';
      const icon = i < done ? '✅' : i === done ? '⏳' : '○';
      return `<span class="enrich-word-chip ${cls}">${icon} ${w.word}</span>`;
    }).join('');
    prog.innerHTML = `
      <div class="enrich-prog">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <div style="font-size:12px;font-weight:700;color:var(--text)">🤖 AI Enriching…</div>
          <div style="font-size:11px;color:var(--textSub)">${done}/${total}</div>
        </div>
        <div class="enrich-bar-wrap"><div class="enrich-bar-fill" style="width:${Math.round(done/total*100)}%"></div></div>
        <div style="line-height:1.8">${chips}</div>
        ${done===total?`<div style="font-size:12px;color:var(--green);font-weight:700;margin-top:8px;text-align:center">✅ All enriched! ${failed?'('+failed+' failed)':''}</div>`:''}
      </div>`;
  }

  renderProg();

  for (let i = 0; i < toEnrich.length; i++) {
    const w = toEnrich[i];
    try {
      const data = await fetchWordData(w.word);
      Object.assign(w, {
        hindi: cleanDevanagari(data.hindi) || w.hindi,
        hindiPhonetic: data.hindiPhonetic || w.hindiPhonetic || '',
        pos: data.pos || w.pos,
        definition: data.definition || w.definition,
        example: data.example || w.example,
        synonyms: data.synonyms?.length ? data.synonyms : w.synonyms,
        antonyms: data.antonyms?.length ? data.antonyms : w.antonyms,
        mnemonic: data.mnemonic || w.mnemonic,
        imagePrompt: data.imagePrompt || w.imagePrompt,
        roots: data.roots || w.roots || [],
        wordFamily: data.wordFamily || w.wordFamily || [],
        sentences: data.sentences || w.sentences || [],
        confusables: data.confusables || w.confusables || [],
        imgSeed: w.imgSeed || Math.floor(Math.random()*99999),
        imageUrl: getImageUrl(data.imagePrompt || w.word, w.imgSeed || Math.floor(Math.random()*99999))
      });
      saveWords();
    } catch(e) { failed++; }
    done++;
    renderProg();
  }

  renderWords(); updateHome();
  if (status) { status.style.color = 'var(--green)'; status.textContent = `✅ Enriched ${done-failed}/${total} words!`; }
}

// ── FILE IMPORT ──
function handleImpFile(inp) {
  const file = inp.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    document.getElementById('impPaste').value = text;
    detectImpFormat(text);
    showToast('📁 File loaded — click Import Words!');
  };
  reader.onerror = () => showToast('❌ Failed to read file');
  reader.readAsText(file);
}

function previewImport(text) { detectImpFormat(text); }

// ── DRAG AND DROP for import zone ──
function setupDropZone() {
  const zone = document.getElementById('impDropZone');
  if (!zone) return;
  zone.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); zone.classList.add('drag'); });
  zone.addEventListener('dragleave', e => { e.stopPropagation(); zone.classList.remove('drag'); });
  zone.addEventListener('drop', e => {
    e.preventDefault(); e.stopPropagation();
    zone.classList.remove('drag');
    const file = e.dataTransfer?.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      document.getElementById('impPaste').value = ev.target.result;
      detectImpFormat(ev.target.result);
      showToast('📁 File dropped — click Import Words!');
    };
    reader.onerror = () => showToast('❌ Failed to read dropped file');
    reader.readAsText(file);
  });
}
// Called from init() after DOM is ready

// ── EXPORT ──
function doExport() {
  let toExport = expExamFilter === 'all' ? words : words.filter(w => (w.examCategory||'') === expExamFilter);
  if (!toExport.length) { showToast('No words to export!'); return; }
  const json = JSON.stringify({words: toExport, exportedAt: new Date().toISOString(), version: '1.0'}, null, 2);
  const safeName = (expExamFilter||'all').replace(/ /g,'_');
  const fname = 'vocabmaster_' + safeName + '_' + new Date().toISOString().slice(0,10) + '.json';

  // Method 1: Web Share API with file (BEST on Android)
  try {
    if (navigator.share && navigator.canShare) {
      const blob = new Blob([json], {type:'application/json'});
      const file = new File([blob], fname, {type:'application/json'});
      if (navigator.canShare({files:[file]})) {
        navigator.share({files:[file], title:'VocabMaster Export', text:toExport.length + ' words exported'})
          .then(() => showToast('Shared successfully!'))
          .catch(function(err) {
            if (err.name !== 'AbortError') doExportFallback(json, fname);
            // AbortError = user cancelled share sheet intentionally
          });
        return;
      }
    }
  } catch(e) { /* Share API unavailable, fall through */ }

  doExportFallback(json, fname);
}

function doExportFallback(json, fname) {
  // Method 2: Blob URL anchor download
  var triggered = false;
  try {
    var blob = new Blob([json], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = fname;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(function(){ URL.revokeObjectURL(url); }, 3000);
    triggered = true;
    showToast('Downloading… check your Downloads folder');
  } catch(e) { triggered = false; }

  // Method 3: Always show copy sheet (essential for Android local file / WebView)
  setTimeout(function(){ showExportSheet(json); }, triggered ? 1200 : 0);
}

function showExportSheet(json) {
  const existing = document.getElementById('exportViewModal');
  if (existing) existing.remove();
  const modal = document.createElement('div');
  modal.id = 'exportViewModal';
  modal.className = 'moverlay open';
  modal._json = json; // store on element for reliable access
  modal.innerHTML = `<div class="msheet">
    <div class="mhandle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-family:'Playfair Display',serif;font-size:18px;font-weight:700">📋 Export Data</div>
      <button class="btn btn-ghost btn-sm" onclick="this.closest('.moverlay').remove()">✕</button>
    </div>
    <p style="font-size:12px;color:var(--textSub);margin-bottom:10px">Copy the JSON below — paste it into a .json file to save, or import it back later.</p>
    <textarea class="inp" id="exportSheetTA" style="font-size:10px;font-family:monospace;height:200px;resize:none;line-height:1.4" readonly onclick="this.select()">${json.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">
      <button class="btn btn-gold" style="padding:12px;justify-content:center" onclick="copyExportText(this)">📋 Copy All</button>
      <button class="btn btn-ghost" style="padding:12px;justify-content:center" onclick="this.closest('.moverlay').remove()">Close</button>
    </div>
  </div>`;
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  document.body.appendChild(modal);
}

function copyExportText(btn) {
  const modal = btn.closest('.moverlay');
  const json = modal?._json || document.getElementById('exportSheetTA')?.value || '';
  if (!json) { showToast('Nothing to copy!'); return; }
  navigator.clipboard.writeText(json)
    .then(() => { btn.textContent = '✅ Copied!'; setTimeout(()=>btn.textContent='📋 Copy All',2000); })
    .catch(() => {
      try {
        const ta = document.getElementById('exportSheetTA');
        if (ta) { ta.select(); document.execCommand('copy'); }
        btn.textContent = '✅ Copied!'; setTimeout(()=>btn.textContent='📋 Copy All',2000);
      } catch(e) { showToast('Copy failed — please select text manually'); }
    });
}

function doViewExport() {
  let toExport = expExamFilter === 'all' ? words : words.filter(w => (w.examCategory||'') === expExamFilter);
  if (!toExport.length) { showToast('No words to export!'); return; }
  showExportSheet(JSON.stringify({words: toExport, exportedAt: new Date().toISOString()}, null, 2));
}

function doCopyExport() {
  let toExport = expExamFilter === 'all' ? words : words.filter(w => (w.examCategory||'') === expExamFilter);
  if (!toExport.length) { showToast('No words to export!'); return; }
  const json = JSON.stringify({words: toExport, exportedAt: new Date().toISOString()}, null, 2);
  navigator.clipboard.writeText(json)
    .then(() => showToast('📋 Copied to clipboard!'))
    .catch(() => {
      // fallback: show sheet for manual copy
      showToast('Clipboard unavailable — showing data to copy');
      setTimeout(() => showExportSheet(json), 300);
    });
}

// ── BULK ADD ──
async function doBulkAdd() {
  const raw = document.getElementById('bulkWords').value.trim();
  const res = document.getElementById('bulkResult');
  if (!raw) { res.style.color = 'var(--red)'; res.textContent = 'Enter words first!'; return; }
  const customYear = document.getElementById('bulkYearCustom').value.trim();
  const selectedYear = document.getElementById('bulkYear').value || document.getElementById('bulkYear').options[document.getElementById('bulkYear').selectedIndex]?.text || '2025';
  const year = (customYear.length === 4 && /^\d{4}$/.test(customYear)) ? customYear : (selectedYear || '2025');

  const lines = raw.split('\n').map(l => l.trim().toLowerCase()).filter(Boolean);
  let added = 0, skipped = 0, newWords = [];
  lines.forEach(wl => {
    if (words.find(x => x.word === wl)) { skipped++; return; }
    const nw = {
      id: uid(), word: wl, pos: 'other', hindi: '—', hindiPhonetic: '',
      definition: '—', example: '', synonyms: [], antonyms: [],
      mnemonic: '', imagePrompt: wl, imageUrl: '', imgSeed: 0,
      roots: [], wordFamily: [], sentences: [], confusables: [], quizOptions: [], quizCorrect: '',
      examCategory: bulkExam, wordType: bulkType, year,
      collection: '', strength: 'weak', reviewCount: 0,
      nextReview: Date.now(), addedAt: Date.now()
    };
    words.unshift(nw);
    newWords.push(nw);
    added++;
  });
  saveWords(); rebuildExamPills(); updateHome(); renderWords();

  if (added > 0) {
    document.getElementById('bulkWords').value = '';
    // Always auto-enrich — fetch full info for every word
    const progEl = document.getElementById('bulkEnrichProgress');
    if (progEl) progEl.style.display = 'block';
    await runAIEnrich(newWords, 'bulkEnrichProgress', 'bulkResult');
    renderWords(); updateHome();
  }
}

// ============================================================
// CARD FRONT QUIZ
// ============================================================
const CQ_TYPE_CONFIG = {
  'Synonyms':             { q: w => `Synonym of "<b>${w.word}</b>"?`,       label:'SYN',  color:'34,211,153'  },
  'Antonyms':             { q: w => `Antonym of "<b>${w.word}</b>"?`,        label:'ANT',  color:'248,113,113' },
  'Idioms & Phrases':     { q: w => `Meaning of "<b>${w.word}</b>"?`,        label:'IOP',  color:'96,165,250'  },
  'One Word Substitution':{ q: w => `One word for: <i>"${w.definition}"</i>`,label:'OWS',  color:'167,139,250' },
  'Homonyms':             { q: w => `"<b>${w.word}</b>" has this meaning:`,  label:'HOM',  color:'251,146,60'  },
};

function cqGetCorrectAndPool(w) {
  // Returns { correct, pool, questionHTML, label, color }
  const type = w.wordType || '';
  const cfg  = CQ_TYPE_CONFIG[type];

  if (type === 'Synonyms' && (w.synonyms||[]).length) {
    const correct = w.synonyms[0];
    const pool = words.flatMap(x => x.id!==w.id?(x.synonyms||[]):[]).filter(s=>s&&s!==correct);
    return { correct, pool, questionHTML: cfg.q(w), label:cfg.label, color:cfg.color };
  }
  if (type === 'Antonyms' && (w.antonyms||[]).length) {
    const correct = w.antonyms[0];
    const pool = words.flatMap(x => x.id!==w.id?(x.antonyms||[]):[]).filter(s=>s&&s!==correct);
    return { correct, pool, questionHTML: cfg.q(w), label:cfg.label, color:cfg.color };
  }
  if (type === 'One Word Substitution' && w.definition && w.definition!=='—') {
    const correct = w.word;
    const pool = words.filter(x=>x.id!==w.id&&x.word).map(x=>x.word);
    return { correct, pool, questionHTML: cfg.q(w), label:'OWS', color:'167,139,250' };
  }
  if ((type === 'Idioms & Phrases' || type === 'Homonyms') && w.definition && w.definition!=='—') {
    const correct = w.definition;
    const pool = words.filter(x=>x.id!==w.id&&x.definition&&x.definition!=='—').map(x=>x.definition);
    const c = cfg||CQ_TYPE_CONFIG['Idioms & Phrases'];
    return { correct, pool, questionHTML: c.q(w), label:c.label, color:c.color };
  }
  // Default — definition quiz
  if (w.definition && w.definition!=='—') {
    const correct = w.definition;
    const pool = words.filter(x=>x.id!==w.id&&x.definition&&x.definition!=='—').map(x=>x.definition);
    return { correct, pool, questionHTML: `Meaning of "<b>${w.word}</b>"?`, label:'DEF', color:'152,152,184' };
  }
  return null;
}

async function fetchQuizWrongs(w, type, correct, needed) {
  if (!isOnline) return [];   // offline: skip AI, use bank only
  // Ask AI for 3 plausible but wrong options
  const typeMap = {
    Synonyms: `3 words that are NOT synonyms of "${w.word}" but look plausible`,
    Antonyms: `3 words that are NOT antonyms of "${w.word}" but look plausible`,
    'One Word Substitution': `3 English words that do NOT mean "${w.definition}" but could confuse learners`,
    'Idioms & Phrases': `3 meanings that are NOT the correct meaning of "${w.word}" but could confuse learners`,
    Homonyms: `3 meanings that are NOT the meaning of "${w.word}" but could confuse learners`,
  };
  const instruction = typeMap[type] || `3 definitions that are NOT the definition of "${w.word}" but could confuse learners`;
  const prompt = `${instruction}. Return ONLY raw JSON array of 3 strings, no markdown. Example: ["option1","option2","option3"]`;
  const res = await vmAI(prompt);
  const text = await res.text();
  const match = text.match(/\[.*?\]/s);
  if (!match) return [];
  const arr = JSON.parse(match[0]);
  return arr.filter(s => s && s !== correct).slice(0, 3);
}

async function renderCardQuiz(w) {
  const wrap = document.getElementById('cQuizInner');
  if (!wrap) return;

  const info = cqGetCorrectAndPool(w);
  if (!info) {
    wrap.innerHTML = `<div style="text-align:center;padding:10px 8px;font-size:11px;color:var(--textMuted);opacity:.6">👆 Tap card to flip and see definition</div>`;
    return;
  }

  const { correct, pool, questionHTML, label, color } = info;
  const colRGB = color;

  // Priority 1: user-provided 4 options + correct answer (instant, zero AI)
  if ((w.quizOptions || []).length === 4 && w.quizCorrect) {
    const opts = w.quizOptions;
    const correctIdx = opts.indexOf(w.quizCorrect);
    if (correctIdx !== -1 && (!currentDeck[currentIdx] || String(currentDeck[currentIdx].id) !== String(w.id))) return;
    if (correctIdx !== -1) {
      renderQuizOptions(wrap, opts, correctIdx, questionHTML, label, colRGB);
      return;
    }
  }

  // Priority 2: pull 3 wrong options from other words in the bank
  let wrongs = [];
  const bankWrongs = shuffle([...new Set(pool.filter(x => x !== correct))]);
  wrongs = bankWrongs.slice(0, 3);

  // Priority 3: ask AI to fill remaining gaps
  if (wrongs.length < 3) {
    wrap.innerHTML = `<div class="cq-loading"><div class="spin" style="width:16px;height:16px;border-width:2px;flex-shrink:0"></div><span>Loading options…</span></div>`;
    try {
      const aiWrongs = await fetchQuizWrongs(w, w.wordType||'', correct, 3 - wrongs.length);
      const newWrongs = aiWrongs.filter(x => x && x !== correct && !wrongs.includes(x));
      wrongs = [...wrongs, ...newWrongs].slice(0, 3);
      // Cache as quizOptions so AI is never called again for this word
      if (wrongs.length === 3) {
        const allOpts = shuffle([correct, ...wrongs]);
        const wd = words.find(x => String(x.id) === String(w.id));
        if (wd && !(wd.quizOptions||[]).length) {
          wd.quizOptions = allOpts; wd.quizCorrect = correct;
          w.quizOptions  = allOpts; w.quizCorrect  = correct;
          saveWords();
        }
      }
    } catch(e) {}
  }

  if (wrongs.length < 3) {
    wrap.innerHTML = `<div style="text-align:center;padding:8px;font-size:11px;color:var(--textMuted);opacity:.6">Add more words for quiz options</div>`;
    return;
  }

  // Check if still on same card (async guard)
  if (!currentDeck[currentIdx] || String(currentDeck[currentIdx].id) !== String(w.id)) return;

  const opts = shuffle([correct, ...wrongs.slice(0,3)]);
  const correctIdx = opts.indexOf(correct);
  renderQuizOptions(wrap, opts, correctIdx, questionHTML, label, colRGB);
}

function renderQuizOptions(wrap, opts, correctIdx, questionHTML, label, colRGB) {
  const labels = ['A', 'B', 'C', 'D'];
  // Truncate long option text so all 4 always fit visually
  const truncate = (s, n) => s && s.length > n ? s.slice(0, n).trimEnd() + '…' : s;
  const maxLen = opts.some(o => o && o.length > 55) ? 55 : 80;
  wrap.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:3px">
      <div class="cq-lbl" style="flex:1">📝 Choose Correct</div>
      <span class="cq-type" style="background:rgba(${colRGB},.15);color:rgb(${colRGB});border:1px solid rgba(${colRGB},.3)">${label}</span>
    </div>
    <div class="cq-q" style="font-size:10px;margin-bottom:3px">${questionHTML}</div>
    <div class="cq-grid" id="cqGrid">
      ${opts.map((opt, i) => `<button class="cq-opt" id="cqOpt${i}" onclick="checkCardQuiz(${i},${correctIdx},event)"><span style="font-size:9px;font-weight:800;color:var(--textMuted);margin-right:2px">${labels[i]}.</span>${truncate(opt, maxLen)}</button>`).join('')}
    </div>`;
}

function checkCardQuiz(chosen, correct, e) {
  e.stopPropagation();
  const grid = document.getElementById('cqGrid');
  if (!grid) return;
  grid.querySelectorAll('.cq-opt').forEach(b => b.disabled = true);

  const chosenBtn = document.getElementById('cqOpt' + chosen);
  const correctBtn = document.getElementById('cqOpt' + correct);

  if (chosen === correct) {
    chosenBtn.classList.add('cq-correct');
    showToast('✅ Correct!');
    // Auto-flip after short delay to show full answer
    setTimeout(() => { if (!isFlipped) flipCard(); }, 900);
  } else {
    chosenBtn.classList.add('cq-wrong');
    if (correctBtn) correctBtn.classList.add('cq-correct');
    showToast('❌ Wrong — see the answer →');
    setTimeout(() => { if (!isFlipped) flipCard(); }, 1200);
  }

  // Update flip hint
  const hint = document.getElementById('cFlipHint');
  if (hint) hint.textContent = chosen === correct ? '✅ Flipping to full answer…' : '❌ See correct answer on back →';
}

// ============================================================
// INIT
// ============================================================
// ============================================================
// ✨ ASK AI POPUP
// ============================================================
let askAiWord = null;

function openAskAI(e) {
  if (e) e.stopPropagation();
  askAiWord = currentDeck[currentIdx];
  if (!askAiWord) { showToast('No word loaded!'); return; }
  const label = document.getElementById('askAiWordLabel');
  if (label) label.innerHTML = `About: <b style="color:var(--text);font-family:'Playfair Display',serif;font-size:15px">${askAiWord.word}</b> <span style="color:var(--textMuted);font-size:11px">· ${askAiWord.wordType||''} · ${askAiWord.examCategory||''}</span>`;
  // Reset response area
  const resp = document.getElementById('askAiResponse');
  if (resp) resp.style.display = 'none';
  const inp = document.getElementById('askAiCustomInp');
  if (inp) inp.value = '';
  openM('askAiModal');
}

async function fireAskAI(type) {
  const w = askAiWord;
  if (!w) return;
  if (!isOnline && type !== 'custom') {
    const innerEl = document.getElementById('askAiResponseInner');
    const respEl  = document.getElementById('askAiResponse');
    if (respEl) respEl.style.display = 'block';
    if (innerEl) innerEl.innerHTML = '<div style="text-align:center;padding:16px"><div style="font-size:32px;margin-bottom:8px">📵</div><div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px">You are offline</div><div style="font-size:11px;color:var(--textSub)">AI features need internet. Connect and try again.</div></div>';
    return;
  }
  const respEl  = document.getElementById('askAiResponse');
  const innerEl = document.getElementById('askAiResponseInner');
  if (!respEl || !innerEl) return;

  respEl.style.display = 'block';
  innerEl.innerHTML = '<div style="display:flex;align-items:center;gap:8px;padding:8px 0"><div class="spin" style="width:18px;height:18px;border-width:2px;flex-shrink:0"></div><span style="font-size:12px;color:var(--textSub)">AI is thinking…</span></div>';
  respEl.scrollTop = 0;

  const ctx = `Word: "${w.word}" | Type: ${w.wordType||'general'} | Definition: ${w.definition||'—'} | Synonyms: ${(w.synonyms||[]).join(', ')||'—'} | Antonyms: ${(w.antonyms||[]).join(', ')||'—'} | Example: ${w.example||'—'}`;

  const prompts = {
    mnemonic:     `Create 2-3 vivid, funny, memorable mnemonics to remember the word "${w.word}" (${w.definition||''}). Make them easy for Indian students. Format nicely with emoji.`,
    story:        `Write a short engaging story (80-100 words) for an Indian exam student that naturally uses the word "${w.word}" (meaning: ${w.definition||''}). Highlight "${w.word}" in the story. Be creative and fun.`,
    collocations: `List 8-10 common collocations (word combinations) for "${w.word}". Group them: Verb+Word, Adj+Word, Word+Noun. Give one example sentence for each group. Format clearly.`,
    sentences:    `Write 5 varied example sentences using "${w.word}" — easy, medium, hard, exam-style, and creative. Number them 1-5. Bold the word in each sentence.`,
    quiz:         `Create a 3-question mini quiz about "${w.word}". Mix question types: fill-in-blank, true/false, MCQ. Return ONLY raw JSON: [{"type":"mcq","q":"...","opts":["a","b","c","d"],"ans":"correct option","exp":"explanation"},{"type":"tf","q":"True or False: ...","ans":"True","exp":"..."},{"type":"fill","q":"Sentence with ___ blank","ans":"${w.word}","exp":"..."}]`,
    remember:     `Give 3-4 creative techniques to remember the word "${w.word}" forever. Include: visual association, sound trick, story method, body gesture. Make it fun for Indian students preparing for SSC/Bank exams.`,
    roots:        `Explain the word roots, prefix, and suffix of "${w.word}". List 5 related words from the same root family. Show how knowing the root helps remember the meaning.`,
    confusables:  `List 3-4 words that are commonly confused with "${w.word}". For each: explain the difference clearly with a sentence showing correct usage. Format with clear headers.`,
    usage:        `Give practical usage tips for "${w.word}" for Indian exam students: 1) Common mistakes to avoid 2) Register (formal/informal) 3) Exam context tips 4) How it appears in SSC/Bank questions.`,
    hindi:        `Give a deep Hindi explanation of "${w.word}": 1) Hindi meaning in Devanagari 2) 3 Hindi synonyms 3) Use in a Hindi sentence 4) Any Hindi proverb or saying related to this concept.`,
  };

  let prompt = prompts[type];
  if (type === 'custom') {
    const inp = document.getElementById('askAiCustomInp');
    const q = (inp?.value || '').trim();
    if (!q) { innerEl.innerHTML = '<div style="color:var(--red);font-size:13px">Please type a question first!</div>'; return; }
    prompt = `Context about the word: ${ctx}\n\nUser question: ${q}\n\nAnswer helpfully for an Indian student preparing for competitive exams. Be concise and clear.`;
  } else {
    prompt += `\n\nContext: ${ctx}`;
  }

  try {
    const res = await vmAI(prompt);
    const text = (await res.text()).trim();

    if (type === 'quiz') {
      renderAskAiQuiz(text, innerEl, w);
    } else {
      // Format text response nicely
      let formatted = text
        .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
        .replace(/\*(.*?)\*/g, '<i>$1</i>')
        .replace(/^#{1,3}\s+(.+)$/gm, '<div style="font-size:13px;font-weight:700;color:var(--gold);margin:10px 0 4px">$1</div>')
        .replace(/^(\d+\.\s)/gm, '<br><b style="color:var(--accent2)">$1</b>')
        .replace(/^[-•]\s/gm, '<br>• ')
        .replace(/\n\n/g, '<br><br>')
        .replace(/\n/g, '<br>');
      innerEl.innerHTML = `<div class="ask-ai-content">${formatted}</div>`;
    }
  } catch(err) {
    innerEl.innerHTML = '<div style="color:var(--red);font-size:13px">❌ Failed to get AI response. Check your connection.</div>';
  }
}

function renderAskAiQuiz(text, container, w) {
  try {
    const match = text.match(/\[[\s\S]*\]/);
    if (!match) throw new Error('No JSON');
    const qs = JSON.parse(match[0]);
    let html = '<div style="font-size:12px;font-weight:700;color:var(--gold);margin-bottom:10px">🎯 Mini Quiz — ' + w.word + '</div>';
    qs.forEach((q, qi) => {
      if (q.type === 'mcq') {
        html += `<div style="margin-bottom:14px"><div style="font-size:13px;font-weight:600;margin-bottom:7px;line-height:1.5">${qi+1}. ${q.q}</div>`;
        q.opts.forEach((opt,oi) => {
          html += `<button class="ask-ai-quiz-opt" onclick="checkAskQuiz(this,'${opt.replace(/'/g,"\'")}','${q.ans.replace(/'/g,"\'")}','${q.exp.replace(/'/g,"\'")}',${qi})">${['A','B','C','D'][oi]}. ${opt}</button>`;
        });
        html += `<div id="askExp${qi}" style="display:none;font-size:11px;color:var(--textSub);margin-top:4px;padding:6px 8px;background:var(--bg);border-radius:6px;line-height:1.6"></div></div>`;
      } else if (q.type === 'tf') {
        html += `<div style="margin-bottom:14px"><div style="font-size:13px;font-weight:600;margin-bottom:7px;line-height:1.5">${qi+1}. ${q.q}</div>`;
        ['True','False'].forEach(opt => {
          html += `<button class="ask-ai-quiz-opt" onclick="checkAskQuiz(this,'${opt}','${q.ans}','${q.exp.replace(/'/g,"\'")}',${qi})">${opt}</button>`;
        });
        html += `<div id="askExp${qi}" style="display:none;font-size:11px;color:var(--textSub);margin-top:4px;padding:6px 8px;background:var(--bg);border-radius:6px;line-height:1.6"></div></div>`;
      } else if (q.type === 'fill') {
        html += `<div style="margin-bottom:14px"><div style="font-size:13px;font-weight:600;margin-bottom:7px;line-height:1.5">${qi+1}. ${q.q}</div>
          <div style="display:flex;gap:8px"><input class="type-inp" id="fillInp${qi}" placeholder="Type the word..." style="flex:1;font-size:13px" autocorrect="off" autocapitalize="off">
          <button class="type-submit" onclick="checkAskFill(${qi},'${q.ans}','${q.exp.replace(/'/g,"\'")}')">✓</button></div>
          <div id="askExp${qi}" style="display:none;font-size:11px;color:var(--textSub);margin-top:4px;padding:6px 8px;background:var(--bg);border-radius:6px;line-height:1.6"></div></div>`;
      }
    });
    container.innerHTML = html;
  } catch(e) {
    container.innerHTML = '<div style="font-size:13px;line-height:1.7">' + text.replace(/\n/g,'<br>') + '</div>';
  }
}

window.checkAskQuiz = function(btn, chosen, correct, exp, qi) {
  const parent = btn.closest('div');
  parent.querySelectorAll('.ask-ai-quiz-opt').forEach(b => b.disabled = true);
  if (chosen.trim().toLowerCase() === correct.trim().toLowerCase()) {
    btn.classList.add('correct'); showToast('✅ Correct!');
  } else {
    btn.classList.add('wrong');
    parent.querySelectorAll('.ask-ai-quiz-opt').forEach(b => { if (b.textContent.trim().endsWith(correct.trim())) b.classList.add('correct'); });
    showToast('❌ ' + correct);
  }
  const expEl = document.getElementById('askExp' + qi);
  if (expEl) { expEl.style.display = 'block'; expEl.textContent = '💡 ' + exp; }
};

window.checkAskFill = function(qi, correct, exp) {
  const inp = document.getElementById('fillInp' + qi);
  if (!inp) return;
  const typed = (inp.value || '').trim().toLowerCase();
  inp.disabled = true;
  if (typed === correct.toLowerCase()) {
    inp.classList.add('correct'); showToast('✅ Correct!');
  } else {
    inp.classList.add('wrong'); showToast('❌ Answer: ' + correct);
  }
  const expEl = document.getElementById('askExp' + qi);
  if (expEl) { expEl.style.display = 'block'; expEl.textContent = '💡 ' + exp; }
};


// ═══════════════════════════════════════════════════════════════
// BACKGROUND AUTO-ENRICHMENT
// Silently fetches AI data for words that are missing definition/
// hindi. Runs in a low-priority queue so it never blocks the UI.
// Rate-limited to 1 word per 1.5s to avoid hammering the API.
// ═══════════════════════════════════════════════════════════════
let _enrichQueue = [];
let _enrichRunning = false;
let _enrichedCount = 0;
let _enrichPaused = false; // true = user stopped auto-fetch

// Check if ANY field is missing — every field shown on front or back of card
function wordNeedsEnrich(w) {
  const missing = _missingFields(w);
  return missing.length > 0;
}

function _missingFields(w) {
  const bad = v => !v || v === '—' || v === '-' || v === '';
  const emptyArr = v => !Array.isArray(v) || v.length === 0;
  const fields = [];
  if (bad(w.hindi))        fields.push('hindi');
  if (bad(w.hindiPhonetic))fields.push('hindiPhonetic');
  if (bad(w.pos) || w.pos === 'other') fields.push('pos');
  if (bad(w.definition))   fields.push('definition');
  if (bad(w.example))      fields.push('example');
  if (emptyArr(w.synonyms))  fields.push('synonyms');
  if (emptyArr(w.antonyms))  fields.push('antonyms');
  if (bad(w.mnemonic))     fields.push('mnemonic');
  if (bad(w.imagePrompt))  fields.push('imagePrompt');
  if (emptyArr(w.roots))     fields.push('roots');
  if (emptyArr(w.wordFamily))fields.push('wordFamily');
  if (emptyArr(w.sentences)) fields.push('sentences');
  if (emptyArr(w.confusables))fields.push('confusables');
  return fields;
}

function scheduleAutoEnrich() {
  if (!isOnline) return;
  if (_enrichPaused) return; // user stopped it
  // Sort: user-added words first (no isBuiltin), then builtin — so personal words get enriched first
  const need = words.filter(wordNeedsEnrich)
                    .sort((a, b) => (a.isBuiltin ? 1 : 0) - (b.isBuiltin ? 1 : 0));
  if (!need.length) { _updateEnrichBadge(0); return; }
  // Avoid re-queuing words already in queue
  const inQueue = new Set(_enrichQueue.map(x => x.id));
  const toAdd = need.filter(w => !inQueue.has(w.id));
  _enrichQueue.push(...toAdd);
  // Show global bar immediately
  if (toAdd.length > 0) {
    const bar = document.getElementById('globalAiBar');
    if (bar) { bar.style.display = 'flex'; bar.classList.add('bar-open'); }
    const wordEl = document.getElementById('globalAiWord');
    const countEl = document.getElementById('globalAiCount');
    if (wordEl) wordEl.textContent = 'Queuing ' + _enrichQueue.length + ' words…';
    if (countEl) countEl.textContent = _enrichQueue.length + ' left';
  }
  _updateEnrichBadge(_enrichQueue.length);
  if (!_enrichRunning) _runEnrichQueue();
}

async function _runEnrichQueue() {
  _enrichRunning = true;
  while (_enrichQueue.length > 0 && isOnline && !_enrichPaused) {
    const w = _enrichQueue.shift();
    const cur = words.find(x => x.id === w.id);
    if (!cur || !wordNeedsEnrich(cur)) continue; // skip if already complete
    try {
      _updateEnrichBadge(_enrichQueue.length, cur.word); // show which word is being fetched
      const data = await fetchWordData(cur.word);
      const idx = words.findIndex(x => x.id === cur.id);
      if (idx >= 0) {
        const wx = words[idx];
        const bad = v => !v || v === '—' || v === '-' || v === '';
        const emptyArr = v => !Array.isArray(v) || v.length === 0;
        // Only overwrite fields that are still missing — never clobber existing good data
        if (bad(wx.hindi))         wx.hindi         = data.hindi         || wx.hindi;
        if (bad(wx.hindiPhonetic)) wx.hindiPhonetic = data.hindiPhonetic || wx.hindiPhonetic || '';
        if (bad(wx.pos) || wx.pos === 'other') wx.pos = data.pos || wx.pos;
        if (bad(wx.definition))    wx.definition    = data.definition    || wx.definition;
        if (bad(wx.example))       wx.example       = data.example       || wx.example;
        if (emptyArr(wx.synonyms))   wx.synonyms    = data.synonyms      || wx.synonyms  || [];
        if (emptyArr(wx.antonyms))   wx.antonyms    = data.antonyms      || wx.antonyms  || [];
        if (bad(wx.mnemonic))      wx.mnemonic      = data.mnemonic      || wx.mnemonic;
        if (bad(wx.imagePrompt))   wx.imagePrompt   = data.imagePrompt   || wx.imagePrompt;
        if (emptyArr(wx.roots))      wx.roots       = data.roots         || wx.roots       || [];
        if (emptyArr(wx.wordFamily)) wx.wordFamily  = data.wordFamily    || wx.wordFamily  || [];
        if (emptyArr(wx.sentences))  wx.sentences   = data.sentences     || wx.sentences   || [];
        if (emptyArr(wx.confusables))wx.confusables = data.confusables   || wx.confusables || [];
        _enrichedCount++;
      }
      saveWords();
      _updateEnrichBadge(_enrichQueue.length, null); // update count after word completes
      // if (_enrichedCount % 5 === 0) { renderWords(); vm_pushToCloud(); } // Manual sync only
    } catch(e) {
      console.warn('[Enrich fail]', cur.word, e.message);
      // Re-queue at the end to retry — but only once more
      if (!cur._enrichRetried) { cur._enrichRetried = true; _enrichQueue.push(cur); }
    }
    await new Promise(r => setTimeout(r, 1500));
  }
  const finalCount = _enrichedCount;
  if (finalCount > 0 && !_enrichPaused) {
    saveWords();
    renderWords();
    showToast('✅ AI enrichment complete! Tap sync button to save.');
  }
  _enrichRunning = false;
  _enrichedCount = 0;
  if (!_enrichPaused) _enrichQueue = [];
  _updateEnrichBadge(_enrichPaused ? _enrichQueue.length : 0, null, _enrichPaused ? 0 : finalCount);
}

// ── _totalEnrichQueue tracks total words queued this session for progress % ──
let _totalEnrichQueued = 0;

function toggleEnrich() {
  _enrichPaused = !_enrichPaused;
  localStorage.setItem('vm_enrich_paused', _enrichPaused ? '1' : '0');
  if (_enrichPaused) {
    showToast('⏸️ Auto-fetch paused', 2500);
    _updateEnrichBadge(_enrichQueue.length, null);
  } else {
    showToast('▶️ Auto-fetch resumed', 2000);
    _updateEnrichBadge(_enrichQueue.length, null);
    if (!_enrichRunning && _enrichQueue.length > 0) _runEnrichQueue();
    else scheduleAutoEnrich();
  }
}

function _updateEnrichBadge(remaining, currentWord, doneCount) {
  const total = words.length;
  const isPaused = _enrichPaused;
  const hasWork  = remaining > 0 || !!currentWord;

  const lbl = document.getElementById('wcLabel');
  if (lbl) {
    if (isPaused) {
      // Always show Resume button while paused — regardless of remaining count
      const pauseInfo = remaining > 0
        ? `<span style="opacity:.6;font-size:9px"> · ${remaining} queued</span>`
        : '';
      lbl.innerHTML = `<span style="color:var(--text)">${total} word${total!==1?'s':''}</span>${pauseInfo} &nbsp;<button onclick="toggleEnrich()" style="font-size:9px;font-weight:800;padding:2px 9px;border-radius:50px;border:1.5px solid var(--green);background:rgba(46,204,138,.1);color:var(--green);cursor:pointer;font-family:'DM Sans',sans-serif;vertical-align:middle">▶ Resume AI</button>`;
    } else if (hasWork) {
      // Actively fetching — show spinner + word + Stop button
      const wordLabel = currentWord
        ? `<span style="opacity:.75">fetching </span><b style="color:var(--text)">${currentWord}</b><span style="opacity:.6"> · ${remaining} left</span>`
        : `<span style="opacity:.7">${remaining} queuing…</span>`;
      lbl.innerHTML = `<span style="color:var(--text)">${total} word${total!==1?'s':''}</span> &nbsp;<span style="display:inline-flex;align-items:center;gap:4px;font-size:9px;background:rgba(96,165,250,.15);color:var(--blue);border:1px solid rgba(96,165,250,.3);border-radius:50px;padding:2px 8px;font-weight:700"><span style="animation:spin .7s linear infinite;display:inline-block">⟳</span>${wordLabel}</span> <button onclick="toggleEnrich()" style="font-size:9px;font-weight:800;padding:2px 9px;border-radius:50px;border:1.5px solid var(--red);background:rgba(240,110,110,.08);color:var(--red);cursor:pointer;font-family:'DM Sans',sans-serif;vertical-align:middle">⏹ Stop</button>`;
    } else {
      // Idle — plain word count
      lbl.textContent = total + ' word' + (total !== 1 ? 's' : '');
    }
  }

  if (remaining === 0 && !isPaused && doneCount > 0) {
    showToast('✅ AI enrichment complete! Tap sync to save.', 3000);
  }
}
// ─────────────────────────────────────────────────────────────────────────────
async function init() {
  await preloadCache();   // warm IndexedDB cache into memory
  try {
    const w = await sGet('vm_words'); if(w) words=JSON.parse(w);
    const u = await sGet('vm_user'); if(u) userData=JSON.parse(u);
    const qh = await sGet('vm_quiz_history'); if(qh) try{quizHistory=JSON.parse(qh);}catch(e){}
  } catch(e) {}

  // Load external vocab bank (fetches vocab_manifest.json + vocab/*.json)
  // Runs silently — merges new exam words, skips if already up to date
  await loadVocabBank();

  // DATA MIGRATION: repair bulk-added words missing key fields
  // Old doBulkAdd forgot to save word/pos/hindi — recover word from imagePrompt fallback
  let migrated = false;
  words.forEach(w => {
    if (!w.word && w.imagePrompt) { w.word = w.imagePrompt.toLowerCase().trim(); migrated = true; }
    if (!w.word)          { w.word = '(unknown)'; migrated = true; }
    if (w.hindi === undefined) { w.hindi = '—'; migrated = true; }
    if (w.hindiPhonetic === undefined) { w.hindiPhonetic = ''; migrated = true; }
    if (!w.pos)           { w.pos = 'other'; migrated = true; }
    if (!w.definition || w.definition === '') { w.definition = '—'; migrated = true; }
    if (!Array.isArray(w.synonyms))  { w.synonyms = []; migrated = true; }
    if (!Array.isArray(w.antonyms))  { w.antonyms = []; migrated = true; }
    if (!Array.isArray(w.roots))     { w.roots = []; }
    if (!Array.isArray(w.wordFamily)){ w.wordFamily = []; }
    if (!Array.isArray(w.sentences)) { w.sentences = []; }
    if (!Array.isArray(w.confusables)){ w.confusables = []; }
    if (!Array.isArray(w.quizOptions)) { w.quizOptions = []; }
    if (!w.quizCorrect)                  { w.quizCorrect = ''; }
  });
  if (migrated) saveWords();

  checkStreak(); checkDaily();
  currentDeck=[...words];
  restoreFilterUI();
  // Restore AI engine toggle
  document.querySelectorAll('.ai-engine-btn').forEach(function(b) {
    b.classList.toggle('ai-btn-active', b.dataset.engine === activeAI);
  });
  rebuildExamPills(); updateHome(); renderWords(); qmUpdateHint();
  updateFilterSummary();
  setupDropZone();
  // Setup swipe once at init — it re-attaches each time startMode/studyOne calls setupSwipe()
  // Also add a direct click fallback on the card for guaranteed flip
  const fc = document.getElementById('fc');
  if (fc) {
    fc.addEventListener('click', e => {
      // Do not flip if the click originated from any interactive element inside the card
      if (e.target.closest('button,a,[onclick],input,select,textarea')) return;
      flipCard();
    });
  }
  setupSwipe();
  if(!words.length){
    document.getElementById('wordsList').innerHTML=`<div class="empty"><div class="empty-icon">🌟</div><div class="empty-title">Start Your Journey</div><div style="font-size:13px;color:var(--textMuted);margin-top:4px">Add your first word using AI</div><button class="btn btn-gold" style="margin-top:14px" onclick="showScreen('wordsScreen',document.querySelector('.nb:nth-child(2)'));openAddFromFilter()">✨ Add First Word</button></div>`;
  }
  // Mark app as fully initialized — allows vm_pullFromCloud to refresh UI on sync
  window._appReady = true;
  // Restore enrich paused state
  _enrichPaused = localStorage.getItem('vm_enrich_paused') === '1';

  // Start background enrichment after a short delay (let UI render first)
  setTimeout(scheduleAutoEnrich, 3000);
}
// ============================================================
// ── SCAN TAB (Image/Camera OCR + AI Word Extraction) ──
// ============================================================

let scanExam = 'SSC CGL', scanType = 'Synonyms';
let scanImageBase64 = null;
let scanImageMime = 'image/jpeg';

function selScanExam(exam, el) {
  scanExam = exam;
  document.querySelectorAll('#scanExamRow .imp-pill').forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
}
function selScanType(type, el) {
  scanType = type;
  document.querySelectorAll('#scanTypeRow .imp-pill').forEach(e => e.classList.remove('sel'));
  el.classList.add('sel');
}

function setInstruction(el) {
  const val = el.getAttribute('data-val');
  document.getElementById('scanInstruction').value = val;
  // Highlight active chip
  el.closest('div').querySelectorAll('[data-val]').forEach(c => {
    c.style.background = 'var(--card2)';
    c.style.borderColor = 'var(--border)';
    c.style.color = 'var(--textSub)';
  });
  el.style.background = 'rgba(245,200,66,.15)';
  el.style.borderColor = 'var(--gold)';
  el.style.color = 'var(--gold)';
}

function handleScanImage(input) {
  const file = input.files[0];
  if (!file) return;
  scanImageMime = file.type || 'image/jpeg';

  const reader = new FileReader();
  reader.onload = function(e) {
    const dataUrl = e.target.result;
    scanImageBase64 = dataUrl.split(',')[1]; // base64 only

    // Show preview
    document.getElementById('scanPreviewImg').src = dataUrl;
    document.getElementById('scanPreviewWrap').style.display = 'block';
    document.getElementById('scanInstructBox').style.display = 'block';
    document.getElementById('scanExtractBtn').style.display = 'flex';
    document.getElementById('scanResultWrap').style.display = 'none';
    document.getElementById('scanAddResult').textContent = '';
    document.getElementById('scanStatus').style.display = 'none';
  };
  reader.readAsDataURL(file);
}

function clearScanImage() {
  scanImageBase64 = null;
  document.getElementById('scanPreviewWrap').style.display = 'none';
  document.getElementById('scanInstructBox').style.display = 'none';
  document.getElementById('scanExtractBtn').style.display = 'none';
  document.getElementById('scanResultWrap').style.display = 'none';
  document.getElementById('scanStatus').style.display = 'none';
  document.getElementById('scanInstruction').value = '';
  document.getElementById('scanCameraInput').value = '';
  document.getElementById('scanGalleryInput').value = '';
}

async function runScanExtract() {
  if (!scanImageBase64) { showToast('No image selected'); return; }

  const statusEl = document.getElementById('scanStatus');
  const statusText = document.getElementById('scanStatusText');
  const pFill = document.getElementById('scanPFill');
  const extractBtn = document.getElementById('scanExtractBtn');

  statusEl.style.display = 'block';
  extractBtn.disabled = true;
  extractBtn.style.opacity = '0.5';

  // Step 1: OCR via Tesseract.js
  statusText.textContent = 'Reading text from image…';
  pFill.style.width = '10%';

  let rawText = '';
  let _scanAiText = '';
  try {
    // Load Tesseract if not already loaded
    if (typeof Tesseract === 'undefined') {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.1.1/tesseract.min.js';
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }
    pFill.style.width = '20%';
    statusText.textContent = 'Running OCR on image…';

    const worker = await Tesseract.createWorker('eng', 1, {
      logger: m => {
        if (m.status === 'recognizing text') {
          const pct = 20 + Math.round(m.progress * 40);
          pFill.style.width = pct + '%';
        }
      }
    });
    const result = await worker.recognize('data:' + scanImageMime + ';base64,' + scanImageBase64);
    rawText = result.data.text;
    await worker.terminate();
  } catch(e) {
    console.error('OCR error:', e);
    statusText.textContent = 'OCR failed, trying AI extraction directly…';
    rawText = '';
  }

  pFill.style.width = '65%';
  statusText.textContent = 'AI is identifying vocabulary words…';

  // Step 2: Use Pollinations AI to extract clean vocabulary word list from OCR text (or raw image description)
  let extractedWords = [];
  try {
    const userInstruction = (document.getElementById('scanInstruction').value || '').trim();
    const instrNote = userInstruction ? ` IMPORTANT USER INSTRUCTION: ${userInstruction}.` : '';
    let prompt;
    if (rawText && rawText.trim().length > 20) {
      prompt = `From the following OCR text extracted from an image, identify and return ONLY the English vocabulary/dictionary words (one per line, lowercase). Skip page numbers, punctuation, headers, and common filler words.${instrNote} Return ONLY the word list, one per line, nothing else:

${rawText.slice(0, 2000)}`;
    } else {
      prompt = `List any English vocabulary words visible in this text (one per line, lowercase).${instrNote} Return ONLY the word list, nothing else.`;
    }

    const resp = await vmAI(prompt);
    const _scanAiText = await resp.text();
    pFill.style.width = '90%';

    // Parse word list from AI response
    extractedWords = aiText
      .split(/\n/)
      .map(l => l.replace(/^[\d\-\.\*•]+\s*/, '').trim().toLowerCase())
      .filter(l => l.length >= 3 && l.length <= 40 && /^[a-z][a-z\s\-']*$/.test(l) && !['the','and','for','from','with','this','that','are','was','were','have','been'].includes(l));
    
    // Remove duplicates
    extractedWords = [...new Set(extractedWords)];
  } catch(e) {
    console.error('AI extract error:', e);
    // Fallback: just parse OCR text for multi-letter words
    if (rawText) {
      const wordRe = /\b([a-zA-Z]{4,})\b/g;
      const common = new Set(['this','that','with','from','they','their','have','been','will','were','also','when','what','which','there','about','would','could','should','these','those','than','then','into','only','some','more','such','very','each','over','after','most','make','like','time','just','know','take','year','good','much','come','through','back','well','even','here','give','most','tell','does','best','being','need','right','still','people','before']);
      const found = new Set();
      let m;
      while ((m = wordRe.exec(rawText)) !== null) {
        const w = m[1].toLowerCase();
        if (!common.has(w)) found.add(w);
      }
      extractedWords = [...found].slice(0, 50);
    }
  }

  pFill.style.width = '100%';

  if (!extractedWords.length) {
    statusEl.style.display = 'none';
    showToast('⚠️ No words found — try a clearer image');
    extractBtn.disabled = false;
    extractBtn.style.opacity = '1';
    return;
  }

  statusEl.style.display = 'none';
  extractBtn.disabled = false;
  extractBtn.style.opacity = '1';

  document.getElementById('scanExtractedWords').value = extractedWords.join('\n');
  document.getElementById('scanResultWrap').style.display = 'block';
  showToast('✅ ' + extractedWords.length + ' words extracted!');
}

async function doScanBulkAdd() {
  const raw = document.getElementById('scanExtractedWords').value;
  const wordList = raw.split('\n').map(w => w.trim().toLowerCase()).filter(w => w.length >= 2);
  if (!wordList.length) { showToast('No words to add'); return; }

  const year = new Date().getFullYear().toString();
  const aiEnrich = document.getElementById('scanAiEnrich').checked;
  const resultEl = document.getElementById('scanAddResult');
  const progressEl = document.getElementById('scanEnrichProgress');

  let added = 0, skipped = 0;
  const toEnrich = [];

  wordList.forEach(word => {
    if (words.find(w => w.word === word)) { skipped++; return; }
    const newWord = {
      id: uid(), word, pos: 'other', hindi: '—', hindiPhonetic: '',
      definition: '—', example: '', synonyms: [], antonyms: [],
      mnemonic: '', imagePrompt: word, imageUrl: '', imgSeed: 0,
      roots: [], wordFamily: [], sentences: [], confusables: [], quizOptions: [], quizCorrect: '',
      examCategory: scanExam, wordType: scanType, year,
      collection: '', strength: 'weak', reviewCount: 0,
      nextReview: Date.now(), addedAt: Date.now()
    };
    words.unshift(newWord);
    toEnrich.push(newWord);
    added++;
  });

  saveWords();
  resultEl.style.color = 'var(--green)';
  resultEl.textContent = `✅ Added ${added} words${skipped ? ' · ' + skipped + ' already existed' : ''}`;
  confetti();

  if (aiEnrich && toEnrich.length) {
    progressEl.style.display = 'block';
    await runAIEnrich(toEnrich, 'scanEnrichProgress', 'scanAddResult');
    progressEl.style.display = 'none';
  }

  renderWords(); updateHome();
}


// ── QUIZ SESSION DETAIL EXPANDER ──
// Global registry: avoids JSON-in-onclick issues entirely
window._qhsAnswerReg = {};

function expandQuizSession(si) {
  const s = quizHistory[si];
  const detailEl = document.getElementById('qhs-detail-' + si);
  const btn = document.getElementById('qhs-btn-' + si);
  if (!detailEl || !s || !s.answers) return;

  if (detailEl.style.display !== 'none') {
    detailEl.style.display = 'none';
    if (btn) btn.textContent = '🔍 Review All Answers';
    return;
  }
  detailEl.style.display = 'block';
  if (btn) btn.textContent = '▲ Hide Answers';

  // Store all answers for this session in registry by key "si_ai"
  s.answers.forEach((a, ai) => { window._qhsAnswerReg[si + '_' + ai] = a; });

  const tabs = ['all','correct','wrong','skipped'];
  const tabLabels = ['All', '✓ Correct', '✗ Wrong', '⏩ Skipped'];
  const tabColors = ['var(--text)','var(--green)','var(--red)','var(--orange)'];
  let activeTab = s.wrong > 0 ? 'wrong' : 'all';

  function renderAnswers(filter) {
    const answers = s.answers || [];
    const rows = filter === 'all' ? answers : answers.filter(a => a.status === filter);
    if (!rows.length) return '<div style="text-align:center;padding:14px;font-size:12px;color:var(--textMuted)">Nothing here 🎉</div>';

    return rows.map((a) => {
      const ai = s.answers.indexOf(a);
      const regKey = si + '_' + ai;
      const isWrong = a.status === 'wrong' || a.status === 'skipped';
      const statusColor = a.status==='correct'?'var(--green)':a.status==='wrong'?'var(--red)':'var(--orange)';
      const statusIcon  = a.status==='correct'?'✓':a.status==='wrong'?'✗':'⏩';
      const answerLine = a.status === 'correct'
        ? '<span style="color:var(--green);font-weight:700">✓ ' + (a.chosen||a.correct) + '</span>'
        : '<div style="color:var(--red);font-weight:600">✗ You: ' + (a.chosen||'(skipped)') + '</div>' +
          '<div style="color:var(--green);font-weight:700;margin-top:2px">✓ Correct: ' + a.correct + '</div>';
      const expHtml = a.exp ? '<div style="font-size:10px;color:var(--textMuted);margin-top:6px;padding:6px 8px;background:var(--card2);border-radius:6px;line-height:1.5">💡 ' + a.exp + '</div>' : '';
      const aiBtn = isWrong
        ? '<button onclick="askAIforWrongKey(\'' + regKey + '\')" style="margin-top:8px;width:100%;padding:8px;border-radius:8px;border:1.5px solid rgba(124,106,247,.4);background:rgba(124,106,247,.1);color:var(--accent2);font-size:11px;font-weight:700;cursor:pointer;-webkit-tap-highlight-color:transparent">✨ Ask AI — Why is this wrong?</button>'
        : '';
      return '<div style="background:var(--card);border-radius:10px;padding:11px 12px;border:1.5px solid ' + (isWrong?'rgba(248,113,113,.2)':'rgba(52,211,153,.15)') + ';margin-bottom:6px">' +
        '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">' +
          '<span style="font-size:10px;font-weight:800;color:' + statusColor + ';padding:2px 8px;border-radius:50px;background:' + statusColor + '22">' + statusIcon + ' ' + a.status.toUpperCase() + '</span>' +
          (a.tag ? '<span style="font-size:9px;color:var(--textMuted);font-weight:600">' + (a.tag||'').toUpperCase() + '</span>' : '') +
        '</div>' +
        '<div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:6px;line-height:1.4">' + (a.q||'') + '</div>' +
        '<div style="font-size:11px;line-height:1.5">' + answerLine + '</div>' +
        expHtml + aiBtn +
      '</div>';
    }).join('');
  }

  function drawTabs() {
    const listEl = document.getElementById('qhsa-' + si);
    const tabsEl = document.getElementById('qhstabs-' + si);
    if (tabsEl) {
      tabsEl.querySelectorAll('[data-tab]').forEach(el => {
        const t = el.getAttribute('data-tab');
        el.style.background = t===activeTab ? 'rgba(245,200,66,.15)' : 'var(--card2)';
        el.style.borderColor = t===activeTab ? 'var(--gold)' : 'var(--border)';
        el.style.color = t===activeTab ? 'var(--gold)' : 'var(--textSub)';
      });
    }
    if (listEl) listEl.innerHTML = renderAnswers(activeTab);
  }

  const tabsHtml = '<div id="qhstabs-' + si + '" style="display:flex;gap:4px;margin-bottom:8px;overflow-x:auto;padding-bottom:2px;scrollbar-width:none">' +
    tabs.map((t,i) => {
      const cnt = t==='all' ? s.answers.length : s.answers.filter(a=>a.status===t).length;
      return '<div data-tab="' + t + '" data-si="' + si + '" onclick="qhsTab(parseInt(this.getAttribute(\\"data-si\\")),this.getAttribute(\\"data-tab\\"))" style="padding:5px 10px;border-radius:50px;font-size:10px;font-weight:700;cursor:pointer;white-space:nowrap;flex-shrink:0;background:var(--card2);border:1.5px solid var(--border);color:var(--textSub)">' + tabLabels[i] + ' (' + cnt + ')</div>';
    }).join('') +
  '</div>';

  detailEl.innerHTML = tabsHtml + '<div id="qhsa-' + si + '" style="display:flex;flex-direction:column;gap:0"></div>';

  window['_qhsDraw_' + si] = drawTabs;
  window['_qhsActive_' + si] = () => activeTab;
  window['_qhsSetActive_' + si] = t => { activeTab = t; };
  drawTabs();
}

function qhsTab(si, t) {
  if (window['_qhsSetActive_' + si]) window['_qhsSetActive_' + si](t);
  if (window['_qhsDraw_' + si]) window['_qhsDraw_' + si]();
}

// Lookup answer by registry key and call askAIforWrong
function askAIforWrongKey(key) {
  const a = window._qhsAnswerReg[key];
  if (a) askAIforWrong(a);
}

function askAIforWrongIdx(idx) {
  const a = (window._qmAnswerReg || [])[idx];
  if (a) askAIforWrong(a);
}

// ── ASK AI FOR WRONG ANSWERS ──
// Uses the qmAiPopup bottom-sheet — shows question context + live AI explanation
function askAIforWrong(a) {
  const question = a.q     || '';
  const correct  = a.correct || '';
  const chosen   = a.chosen  || '(skipped)';
  const exp      = a.exp     || '';
  const opts     = a.opts    || [];

  const popup  = document.getElementById('qmAiPopup');
  const body   = document.getElementById('qmAiPopupBody');
  const titleEl = document.getElementById('qmAiPopupTitle');
  if (!popup || !body) return;

  // Title
  titleEl.innerHTML = '✨ AI — <b style="color:var(--gold);font-family:\'Playfair Display\',serif">Why is this wrong?</b>';

  // Build options HTML if available
  const optsHtml = opts.length
    ? '<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">' +
        opts.map((o, i) => {
          const isCorrect = o.trim().toLowerCase() === correct.trim().toLowerCase();
          const isChosen  = o.trim().toLowerCase() === chosen.trim().toLowerCase();
          const bg   = isCorrect ? 'rgba(52,211,153,.12)'  : (isChosen ? 'rgba(248,113,113,.12)' : 'var(--card2)');
          const bd   = isCorrect ? 'var(--green)'           : (isChosen ? 'var(--red)'            : 'var(--border)');
          const col  = isCorrect ? 'var(--green)'           : (isChosen ? 'var(--red)'            : 'var(--text)');
          const icon = isCorrect ? '✓' : (isChosen ? '✗' : ['A','B','C','D'][i]);
          return `<div style="padding:9px 12px;border-radius:9px;border:2px solid ${bd};background:${bg};font-size:13px;color:${col};display:flex;gap:10px;align-items:center">
            <span style="width:22px;height:22px;border-radius:50%;background:${bd === 'var(--border)' ? 'var(--card)' : bd + '33'};border:1.5px solid ${bd};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;flex-shrink:0;color:${col === 'var(--text)' ? 'var(--textMuted)' : col}">${icon}</span>
            <span style="flex:1">${o}</span>
            ${isChosen && !isCorrect ? '<span style="font-size:9px;font-weight:800;color:var(--red);white-space:nowrap">YOUR ANSWER</span>' : ''}
            ${isCorrect ? '<span style="font-size:9px;font-weight:800;color:var(--green);white-space:nowrap">CORRECT</span>' : ''}
          </div>`;
        }).join('')
      + '</div>'
    : `<div style="display:flex;flex-direction:column;gap:5px;margin-bottom:12px">
        <div style="padding:8px 12px;border-radius:8px;border:1.5px solid rgba(248,113,113,.4);background:rgba(248,113,113,.1);font-size:13px;color:var(--red)"><b>✗ You chose:</b> ${chosen}</div>
        <div style="padding:8px 12px;border-radius:8px;border:1.5px solid rgba(52,211,153,.4);background:rgba(52,211,153,.1);font-size:13px;color:var(--green)"><b>✓ Correct:</b> ${correct}</div>
      </div>`;

  // Build the popup body with question card + loading AI area
  body.innerHTML =
    // Question card
    `<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:13px;margin-bottom:14px">
      <div style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--textMuted);margin-bottom:7px">📋 QUESTION</div>
      <div style="font-size:14px;font-weight:600;line-height:1.6;color:var(--text);margin-bottom:12px">${question}</div>
      ${optsHtml}
      ${exp ? `<div style="font-size:11px;line-height:1.65;color:var(--textSub);padding:8px 10px;background:var(--card2);border-radius:7px;border-left:3px solid var(--gold)">💡 ${exp}</div>` : ''}
    </div>` +
    // AI explanation area
    `<div style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--textMuted);margin-bottom:8px">✨ AI EXPLANATION</div>
    <div id="wrongAiOut" style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:13px;min-height:60px">
      <div class="cq-loading"><div class="spin" style="width:18px;height:18px;border-width:2px;flex-shrink:0"></div><span style="font-size:12px;color:var(--textSub)">AI is analysing your answer…</span></div>
    </div>` +
    // Custom follow-up input — NO question/correct in onclick (breaks on apostrophes/quotes)
    // Context is stored in window._wrongAiCtx below
    `<div style="display:flex;gap:8px;margin-top:12px">
      <input id="wrongAiFollowInp" class="qm-ai-custom-inp" placeholder="Ask a follow-up question…" onkeydown="if(event.key==='Enter')wrongAiFollowUp()">
      <button class="qm-ai-custom-btn" onclick="wrongAiFollowUp()">Ask →</button>
    </div>`;

  // Store context globally so follow-up can access it without string-in-onclick escaping
  window._wrongAiCtx = { question, correct, chosen, exp };

  popup.classList.add('open');

  // Auto-fire AI call
  const prompt = `An Indian competitive exam (SSC/Bank PO) student got this question wrong.\n\nQuestion: "${question}"\nStudent chose: "${chosen}"\nCorrect answer: "${correct}"\n${exp ? 'Hint: ' + exp + '\n' : ''}\nPlease:\n1. Clearly explain why "${correct}" is the correct answer (2-3 sentences)\n2. Explain why "${chosen}" is wrong (1-2 sentences)\n3. Give a memory trick or mnemonic to remember the correct answer\n4. Give 1 exam-style example sentence using the correct concept\n\nBe concise and helpful for a competitive exam student.`;

  _wrongAiCall(prompt);
}

async function _wrongAiCall(prompt) {
  const out = document.getElementById('wrongAiOut');
  if (!out) return;
  if (!isOnline) {
    out.innerHTML = '<div style="text-align:center;padding:10px"><div style="font-size:22px;margin-bottom:6px">📵</div><div style="font-size:12px;color:var(--textMuted)">You are offline. Connect to use AI.</div></div>';
    return;
  }
  try {
    const res = await vmAI(prompt);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = (await res.text()).trim();
    out.innerHTML = '<div style="font-size:13px;color:var(--text);line-height:1.8;white-space:pre-wrap">' +
      text.replace(/\*\*(.*?)\*\*/g, '<b style="color:var(--gold)">$1</b>')
          .replace(/\*(.*?)\*/g, '<i style="color:var(--accent2)">$1</i>')
          .replace(/^(\d+\.)/gm, '<span style="color:var(--gold);font-weight:700">$1</span>') +
      '</div>';
  } catch(e) {
    out.innerHTML = '<div style="color:var(--red);font-size:12px;text-align:center;padding:8px">❌ AI failed. Check your connection and <button onclick="_wrongAiCall()" style="color:var(--accent2);background:none;border:none;cursor:pointer;font-size:12px;text-decoration:underline">try again</button></div>';
  }
}

async function wrongAiFollowUp() {
  const inp = document.getElementById('wrongAiFollowInp');
  const followQ = inp ? inp.value.trim() : '';
  if (!followQ) return;
  const out = document.getElementById('wrongAiOut');
  if (out) out.innerHTML = '<div class="cq-loading"><div class="spin" style="width:18px;height:18px;border-width:2px;flex-shrink:0"></div><span style="font-size:12px;color:var(--textSub)">AI thinking…</span></div>';
  if (inp) inp.value = '';
  // Use globally stored context — avoids broken string-in-onclick escaping
  const ctx = window._wrongAiCtx || {};
  const question = ctx.question || '';
  const correct  = ctx.correct  || '';
  const chosen   = ctx.chosen   || '';
  const exp      = ctx.exp      || '';
  const prompt = `Context — Exam question: "${question}" | Student chose: "${chosen}" | Correct answer: "${correct}"${exp ? ' | Hint: ' + exp : ''}.\n\nStudent follow-up question: ${followQ}\n\nAnswer clearly in 3-4 sentences for an Indian competitive exam student.`;
  await _wrongAiCall(prompt);
}

// ── LEGACY stubs kept so nothing crashes ──
function openAskAIForWord(w, prefillPrompt) {
  // Route to the generic Ask AI modal for word-based queries
  const modal = document.getElementById('askAiModal');
  if (!modal) return;
  const lbl = document.getElementById('askAiWordLabel');
  if (lbl) lbl.innerHTML = 'About: <b style="color:var(--text);font-family:\'Playfair Display\',serif;font-size:15px">' + w.word + '</b>';
  window._askAiWord = w;
  const resp = document.getElementById('askAiResponse');
  if (resp) resp.style.display = 'block';
  modal.classList.add('open');
  setTimeout(() => { if (prefillPrompt) _legacyFireAI(prefillPrompt, w); }, 300);
}

function openAskAIGeneric(prompt) {
  const modal = document.getElementById('askAiModal');
  if (!modal) return;
  const lbl = document.getElementById('askAiWordLabel');
  if (lbl) lbl.textContent = '🎯 Quiz Analysis';
  window._askAiWord = null;
  const resp = document.getElementById('askAiResponse');
  if (resp) resp.style.display = 'block';
  modal.classList.add('open');
  setTimeout(() => { if (prompt) _legacyFireAI(prompt, null); }, 300);
}

async function _legacyFireAI(prompt, w) {
  // Writes into the Ask AI modal's response area (#askAiResponseInner / #askAiResponse)
  const out = document.getElementById('askAiResponseInner');
  if (!out) return;
  const respEl = document.getElementById('askAiResponse');
  if (respEl) respEl.style.display = 'block';
  out.innerHTML = '<div class="cq-loading"><div class="spin" style="width:18px;height:18px;border-width:2px"></div> <span>AI is analysing…</span></div>';
  try {
    const context = w ? `Word: "${w.word}", definition: "${w.definition}", synonyms: ${(w.synonyms||[]).join(', ')}. ` : '';
    const res = await vmAI(context + prompt);
    const text = (await res.text()).trim();
    out.innerHTML = `<div style="font-size:13px;color:var(--text);line-height:1.75;white-space:pre-wrap">${text.replace(/\*\*(.*?)\*\*/g,'<b style="color:var(--gold)">$1</b>').replace(/\*(.*?)\*/g,'<i>$1</i>')}</div>`;
  } catch(e) {
    out.innerHTML = '<div style="color:var(--red);font-size:12px">AI failed — please try again</div>';
  }
}

// fireAskAICustom — called from Ask AI modal chips (mnemonic, story, quiz etc.)
async function fireAskAICustom(prompt, w) {
  const out = document.getElementById('askAiResponseInner');  // FIXED: was #askAiOutput (doesn't exist)
  if (!out) return;
  const respEl = document.getElementById('askAiResponse');
  if (respEl) respEl.style.display = 'block';
  out.innerHTML = '<div class="cq-loading"><div class="spin" style="width:18px;height:18px;border-width:2px"></div> <span>AI is thinking…</span></div>';
  try {
    const context = w ? `Context about the word "${w.word}": definition="${w.definition}", synonyms=${(w.synonyms||[]).join(', ')}, mnemonic="${w.mnemonic||''}". ` : '';
    const resp = await vmAI(context + prompt);
    const text = (await resp.text()).trim();
    out.innerHTML = `<div style="font-size:13px;color:var(--text);line-height:1.75;white-space:pre-wrap">${text.replace(/\*\*(.*?)\*\*/g,'<b style="color:var(--gold)">$1</b>').replace(/\*(.*?)\*/g,'<i>$1</i>')}</div>`;
  } catch(e) {
    out.innerHTML = '<div style="color:var(--red);font-size:12px">AI failed — please try again</div>';
  }
}


// init() is now called by vm_doLogin() after successful cloud authentication.
// Do NOT call init() here directly.

// ══════════════════════════════════════════════════════════════
// VOCAB SHARE SYSTEM
// ══════════════════════════════════════════════════════════════

// ── Inject Share + Notification UI styles & HTML ──────────────
(function vm_buildShareUI(){
  const style = document.createElement('style');
  style.textContent = `
/* ── Share Modal ── */
#vmShareModal{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;
  align-items:flex-end;justify-content:center;z-index:99997;font-family:'DM Sans',sans-serif}
#vmShareModal.open{display:flex}
#vmShareSheet{background:#141420;border:1px solid rgba(124,106,247,.4);
  border-radius:22px 22px 0 0;width:100%;max-width:480px;
  max-height:88vh;overflow-y:auto;padding:20px 20px 40px}
#vmShareSheet::-webkit-scrollbar{display:none}
.vms-handle{width:36px;height:4px;background:rgba(255,255,255,.12);border-radius:2px;margin:0 auto 16px}
.vms-title{font-size:17px;font-weight:700;color:#f0eff8;margin-bottom:4px}
.vms-sub{font-size:12px;color:#9898b8;margin-bottom:16px}
.vms-section{margin-bottom:14px}
.vms-lbl{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:#7c6af7;margin-bottom:8px}
.vms-filter-row{display:flex;gap:6px;flex-wrap:wrap}
.vms-pill{padding:6px 14px;border-radius:50px;border:1.5px solid rgba(255,255,255,.1);
  font-size:11px;font-weight:700;cursor:pointer;color:#9898b8;background:#1e1e30;
  transition:all .2s;white-space:nowrap}
.vms-pill.sel{background:rgba(124,106,247,.2);border-color:#7c6af7;color:#a78bfa}
.vms-pill.sel-exam{background:rgba(245,200,66,.15);border-color:#f5c842;color:#f5c842}
.vms-pill.sel-year{background:rgba(96,165,250,.15);border-color:#60a5fa;color:#60a5fa}
.vms-pill.sel-type{background:rgba(52,211,153,.15);border-color:#34d399;color:#34d399}
.vms-preview{background:#1e1e30;border:1px solid rgba(255,255,255,.07);border-radius:10px;
  padding:10px 14px;margin-bottom:14px;font-size:12px;color:#9898b8;text-align:center}
.vms-preview b{color:#f5c842;font-size:16px}
.vms-id-inp{width:100%;padding:14px;border-radius:12px;border:2px solid rgba(124,106,247,.4);
  background:#0e0e14;color:#f0eff8;font-size:20px;text-align:center;letter-spacing:5px;
  box-sizing:border-box;outline:none;font-family:'DM Sans',sans-serif;transition:border-color .2s;margin-bottom:8px}
.vms-id-inp:focus{border-color:#f5c842}
.vms-id-inp::placeholder{color:#5a5a78;letter-spacing:2px;font-size:13px}
.vms-err{color:#f87171;font-size:12px;min-height:18px;margin-bottom:8px;text-align:center}
.vms-send-btn{width:100%;padding:14px;background:linear-gradient(135deg,#7c6af7,#a78bfa);
  color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;
  cursor:pointer;font-family:'DM Sans',sans-serif;transition:opacity .2s}
.vms-send-btn:hover{opacity:.88} .vms-send-btn:disabled{opacity:.4;cursor:default}
.vms-cancel{width:100%;padding:11px;margin-top:8px;background:none;
  border:1px solid rgba(255,255,255,.1);border-radius:12px;color:#9898b8;
  font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif}

/* ── Incoming Share Notification ── */
#vmShareNotif{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;
  align-items:flex-end;justify-content:center;z-index:999996;font-family:'DM Sans',sans-serif}
#vmShareNotif.open{display:flex}
#vmShareNotifSheet{background:#141420;border:2px solid rgba(245,200,66,.35);
  border-radius:22px 22px 0 0;width:100%;max-width:480px;padding:24px 20px 40px}
.vsn-icon{font-size:44px;text-align:center;margin-bottom:10px}
.vsn-title{font-size:17px;font-weight:700;color:#f0eff8;text-align:center;margin-bottom:4px}
.vsn-from{font-size:13px;color:#9898b8;text-align:center;margin-bottom:16px}
.vsn-from b{color:#f5c842}
.vsn-preview{background:#1e1e30;border-radius:12px;border:1px solid rgba(255,255,255,.07);
  padding:14px;margin-bottom:16px}
.vsn-label{font-size:11px;font-weight:700;color:#7c6af7;text-transform:uppercase;
  letter-spacing:.6px;margin-bottom:8px}
.vsn-wordlist{display:flex;flex-wrap:wrap;gap:5px;max-height:120px;overflow:hidden}
.vsn-word{padding:3px 10px;border-radius:50px;background:rgba(245,200,66,.1);
  border:1px solid rgba(245,200,66,.25);color:#f5c842;font-size:11px;font-weight:600}
.vsn-more{padding:3px 10px;border-radius:50px;background:rgba(255,255,255,.07);
  color:#9898b8;font-size:11px}
.vsn-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.vsn-accept{padding:14px;background:linear-gradient(135deg,#34d399,#059669);
  color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;
  cursor:pointer;font-family:'DM Sans',sans-serif}
.vsn-reject{padding:14px;background:rgba(248,113,113,.12);
  border:1.5px solid rgba(248,113,113,.3);color:#f87171;border-radius:12px;
  font-size:15px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif}
.vsn-skip{width:100%;padding:10px;margin-top:8px;background:none;
  border:1px solid rgba(255,255,255,.08);border-radius:10px;color:#5a5a78;
  font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif}
`;
  document.head.appendChild(style);

  // ── Share Modal ────────────────────────────────────────────
  const shareModal = document.createElement('div');
  shareModal.id = 'vmShareModal';
  shareModal.onclick = e => { if(e.target===shareModal) vm_closeShare(); };
  shareModal.innerHTML = `
<div id="vmShareSheet">
  <div class="vms-handle"></div>
  <div class="vms-title">🔗 Share Vocab List</div>
  <div class="vms-sub">Send your words to another user's 10-digit ID</div>

  <div class="vms-section">
    <div class="vms-lbl">📚 Select Exam</div>
    <div class="vms-filter-row" id="vmsExamRow">
      <div class="vms-pill sel sel-exam" data-val="all" onclick="vm_selShareFilter('exam','all',this)">📚 All Exams</div>
      <div class="vms-pill" data-val="SSC CGL" onclick="vm_selShareFilter('exam','SSC CGL',this)">SSC CGL</div>
      <div class="vms-pill" data-val="SSC CHSL" onclick="vm_selShareFilter('exam','SSC CHSL',this)">SSC CHSL</div>
      <div class="vms-pill" data-val="SSC STENO" onclick="vm_selShareFilter('exam','SSC STENO',this)">SSC STENO</div>
      <div class="vms-pill" data-val="SSC CPO" onclick="vm_selShareFilter('exam','SSC CPO',this)">SSC CPO</div>
      <div class="vms-pill" data-val="SSC MTS" onclick="vm_selShareFilter('exam','SSC MTS',this)">SSC MTS</div>
      <div class="vms-pill" data-val="SSC GD" onclick="vm_selShareFilter('exam','SSC GD',this)">SSC GD</div>
      <div class="vms-pill" data-val="RRB NTPC" onclick="vm_selShareFilter('exam','RRB NTPC',this)">RRB NTPC</div>
      <div class="vms-pill" data-val="Bank PO" onclick="vm_selShareFilter('exam','Bank PO',this)">Bank PO</div>
      <div class="vms-pill" data-val="Railway" onclick="vm_selShareFilter('exam','Railway',this)">Railway</div>
    </div>
  </div>

  <div class="vms-section" id="vmsYearSection" style="display:none">
    <div class="vms-lbl">📅 Select Year</div>
    <div class="vms-filter-row" id="vmsYearRow">
      <div class="vms-pill sel sel-year" data-val="all" onclick="vm_selShareFilter('year','all',this)">All Years</div>
      <div class="vms-pill" data-val="2025" onclick="vm_selShareFilter('year','2025',this)">2025</div>
      <div class="vms-pill" data-val="2024" onclick="vm_selShareFilter('year','2024',this)">2024</div>
      <div class="vms-pill" data-val="2023" onclick="vm_selShareFilter('year','2023',this)">2023</div>
      <div class="vms-pill" data-val="2022" onclick="vm_selShareFilter('year','2022',this)">2022</div>
      <div class="vms-pill" data-val="2021" onclick="vm_selShareFilter('year','2021',this)">2021</div>
      <div class="vms-pill" data-val="2020" onclick="vm_selShareFilter('year','2020',this)">2020</div>
    </div>
  </div>

  <div class="vms-section" id="vmsTypeSection" style="display:none">
    <div class="vms-lbl">🏷️ Select Type</div>
    <div class="vms-filter-row" id="vmsTypeRow">
      <div class="vms-pill sel sel-type" data-val="all" onclick="vm_selShareFilter('type','all',this)">All Types</div>
      <div class="vms-pill" data-val="Synonyms" onclick="vm_selShareFilter('type','Synonyms',this)">Synonyms</div>
      <div class="vms-pill" data-val="Antonyms" onclick="vm_selShareFilter('type','Antonyms',this)">Antonyms</div>
      <div class="vms-pill" data-val="Idioms &amp; Phrases" onclick="vm_selShareFilter('type','Idioms & Phrases',this)">Idioms &amp; Phrases</div>
      <div class="vms-pill" data-val="One Word Substitution" onclick="vm_selShareFilter('type','One Word Substitution',this)">One Word Sub.</div>
      <div class="vms-pill" data-val="Homonyms" onclick="vm_selShareFilter('type','Homonyms',this)">Homonyms</div>
    </div>
  </div>

  <div class="vms-preview" id="vmsPreview">
    Showing <b id="vmsCount">0</b> words to share
  </div>

  <div class="vms-section">
    <div class="vms-lbl">👤 Recipient's 10-Digit ID</div>
    <input class="vms-id-inp" id="vmsRecipientInp" type="tel" maxlength="10"
      placeholder="Enter their User ID"
      oninput="this.value=this.value.replace(/\\D/g,'').slice(0,10)" />
    <div class="vms-err" id="vmsErr"></div>
  </div>

  <button class="vms-send-btn" id="vmsSendBtn" onclick="vm_sendShare()">📤 Send Vocab List</button>
  <button class="vms-cancel" onclick="vm_closeShare()">Cancel</button>
</div>`;
  document.body.appendChild(shareModal);

  // ── Incoming Notification ──────────────────────────────────
  const notifEl = document.createElement('div');
  notifEl.id = 'vmShareNotif';
  notifEl.innerHTML = `
<div id="vmShareNotifSheet">
  <div class="vsn-icon">📨</div>
  <div class="vsn-title">Incoming Vocab Share!</div>
  <div class="vsn-from" id="vsnFrom">Someone wants to share their list</div>
  <div class="vsn-preview">
    <div class="vsn-label" id="vsnLabel">Words</div>
    <div class="vsn-wordlist" id="vsnWordList"></div>
  </div>
  <div class="vsn-btns">
    <button class="vsn-accept" onclick="vm_acceptShare()">✅ Accept</button>
    <button class="vsn-reject" onclick="vm_rejectShare()">❌ Reject</button>
  </div>
  <button class="vsn-skip" onclick="vm_skipShare()">⏭ Decide Later</button>
</div>`;
  document.body.appendChild(notifEl);
})();

// ── Share filter state ────────────────────────────────────────
let _shareExam = 'all', _shareYear = 'all', _shareType = 'all';
let _pendingShares = [];   // queue of incoming shares to show
let _currentShare  = null; // share being reviewed right now

function vm_openShare(){
  if(!vm_userId){ showToast('Please log in first!'); return; }
  _shareExam = 'all'; _shareYear = 'all'; _shareType = 'all';
  vm_updateSharePreview();
  document.getElementById('vmsErr').textContent = '';
  document.getElementById('vmsRecipientInp').value = '';
  document.getElementById('vmsSendBtn').disabled = false;
  document.getElementById('vmsSendBtn').textContent = '📤 Send Vocab List';
  // Reset pills
  ['vmsExamRow','vmsYearRow','vmsTypeRow'].forEach(rowId => {
    const row = document.getElementById(rowId);
    if(!row) return;
    row.querySelectorAll('.vms-pill').forEach(p => {
      p.classList.remove('sel','sel-exam','sel-year','sel-type');
      if(p.dataset.val === 'all') p.classList.add('sel', rowId.includes('Exam')?'sel-exam':rowId.includes('Year')?'sel-year':'sel-type');
    });
  });
  document.getElementById('vmsYearSection').style.display = 'none';
  document.getElementById('vmsTypeSection').style.display = 'none';
  document.getElementById('vmShareModal').classList.add('open');
}
function vm_closeShare(){ document.getElementById('vmShareModal').classList.remove('open'); }

function vm_selShareFilter(kind, val, el){
  const rowIds = {exam:'vmsExamRow', year:'vmsYearRow', type:'vmsTypeRow'};
  const selClass = {exam:'sel-exam', year:'sel-year', type:'sel-type'};
  const row = document.getElementById(rowIds[kind]);
  if(!row) return;
  row.querySelectorAll('.vms-pill').forEach(p => p.classList.remove('sel', selClass[kind]));
  el.classList.add('sel', selClass[kind]);
  if(kind==='exam'){
    _shareExam = val;
    document.getElementById('vmsYearSection').style.display = val!=='all' ? 'block' : 'none';
    document.getElementById('vmsTypeSection').style.display = val!=='all' ? 'block' : 'none';
    _shareYear = 'all'; _shareType = 'all';
    // reset year/type pills
    ['vmsYearRow','vmsTypeRow'].forEach(rid => {
      const r = document.getElementById(rid);
      if(!r) return;
      r.querySelectorAll('.vms-pill').forEach((p,i) => {
        p.classList.remove('sel','sel-year','sel-type');
        if(i===0) p.classList.add('sel', rid.includes('Year')?'sel-year':'sel-type');
      });
    });
  } else if(kind==='year'){ _shareYear = val; }
  else { _shareType = val; }
  vm_updateSharePreview();
}

function vm_getShareWords(){
  return words.filter(w => {
    const me = _shareExam==='all' || (w.examCategory||'')===_shareExam;
    const my = _shareYear==='all' || (w.year||'')===_shareYear;
    const mt = _shareType==='all' || (w.wordType||'')===_shareType;
    return me && my && mt;
  });
}

function vm_updateSharePreview(){
  const filtered = vm_getShareWords();
  const cntEl = document.getElementById('vmsCount');
  const prevEl = document.getElementById('vmsPreview');
  if(cntEl) cntEl.textContent = filtered.length;
  const parts = [];
  if(_shareExam!=='all') parts.push(_shareExam);
  if(_shareYear!=='all') parts.push(_shareYear);
  if(_shareType!=='all') parts.push(_shareType);
  const label = parts.length ? parts.join(' · ') : 'All Words';
  if(prevEl) prevEl.innerHTML = `Sharing <b>${filtered.length}</b> words &nbsp;·&nbsp; <span style="color:#9898b8;font-size:11px">${label}</span>`;
}

async function vm_sendShare(){
  const recipientId = document.getElementById('vmsRecipientInp').value.trim();
  const errEl = document.getElementById('vmsErr');
  const btn   = document.getElementById('vmsSendBtn');

  if(!/^\d{10}$/.test(recipientId)){
    errEl.textContent = '⚠️ Enter exactly 10 digits.'; return;
  }
  if(recipientId === vm_userId){
    errEl.textContent = '⚠️ You cannot share with yourself!'; return;
  }

  const wordsToSend = vm_getShareWords();
  if(!wordsToSend.length){
    errEl.textContent = '⚠️ No words match this filter!'; return;
  }

  errEl.textContent = '';
  btn.disabled = true;
  btn.textContent = '⏳ Sending…';

  try{
    const parts = [];
    if(_shareExam!=='all') parts.push(_shareExam);
    if(_shareYear!=='all') parts.push(_shareYear);
    if(_shareType!=='all') parts.push(_shareType);
    const label = parts.length ? parts.join(' · ') : 'All Words';

    const payload = {
      fromId:   vm_userId,
      fromName: vm_userName || vm_userId,
      words:    wordsToSend,
      label,
      sentAt:   new Date().toISOString(),
      shareId:  Date.now().toString()
    };

    const res  = await fetch(`${VM_API}/api/share/${recipientId}`, {
      method:  'POST',
      headers: {'Content-Type':'application/json'},
      body:    JSON.stringify(payload)
    });
    const json = await res.json();

    if(json.success){
      vm_closeShare();
      showToast(`✅ Sent ${wordsToSend.length} words to ${recipientId}!`);
    } else {
      errEl.textContent = '❌ ' + (json.error || 'Send failed');
      btn.disabled = false;
      btn.textContent = '📤 Send Vocab List';
    }
  } catch(e){
    errEl.textContent = '❌ Connection failed. Try again.';
    btn.disabled = false;
    btn.textContent = '📤 Send Vocab List';
  }
}

// ── Check for incoming shares on login ───────────────────────
async function vm_checkIncomingShares(){
  if(!vm_userId) return;
  try{
    const res  = await fetch(`${VM_API}/api/shares/${vm_userId}`);
    const data = await res.json();
    if(data.shares && data.shares.length > 0){
      _pendingShares = data.shares;
      vm_showNextShare();
    }
  } catch(e){ /* silent fail */ }
}

function vm_showNextShare(){
  if(!_pendingShares.length) return;
  _currentShare = _pendingShares[0];
  const s = _currentShare;

  document.getElementById('vsnFrom').innerHTML =
    `<b>${s.fromName || s.fromId}</b> (ID: ${s.fromId}) wants to share<br>
     <span style="color:#f5c842;font-weight:700">${s.label || 'their word list'}</span>`;

  document.getElementById('vsnLabel').textContent =
    `${s.words.length} words · ${s.label || 'All Words'}`;

  const wList = document.getElementById('vsnWordList');
  const show  = s.words.slice(0, 20);
  const more  = s.words.length - show.length;
  wList.innerHTML = show.map(w => `<span class="vsn-word">${w.word}</span>`).join('') +
    (more > 0 ? `<span class="vsn-more">+${more} more</span>` : '');

  document.getElementById('vmShareNotif').classList.add('open');
}

async function vm_acceptShare(){
  if(!_currentShare) return;
  const s = _currentShare;
  // Merge words — skip duplicates
  let added = 0;
  s.words.forEach(w => {
    if(!words.find(x => x.word === w.word)){
      // Reset personal progress fields for received words
      w.srRating    = null;
      w.strength    = 'weak';
      w.reviewCount = 0;
      w.nextReview  = Date.now();
      w.addedAt     = Date.now();
      w.remembered  = false;
      words.unshift(w);
      added++;
    }
  });
  saveWords(); rebuildExamPills(); updateHome(); renderWords();
  document.getElementById('vmShareNotif').classList.remove('open');
  showToast(`✅ Added ${added} new words to your list!`);
  _pendingShares.shift();
  setTimeout(vm_showNextShare, 600);
}

async function vm_rejectShare(){
  if(!_currentShare) return;
  await vm_deleteShare(_currentShare.shareId);
  document.getElementById('vmShareNotif').classList.remove('open');
  showToast('❌ Share rejected.');
  _currentShare = null;
  _pendingShares.shift();
  setTimeout(vm_showNextShare, 400);
}

function vm_skipShare(){
  document.getElementById('vmShareNotif').classList.remove('open');
  _currentShare = null;
  // Keep in queue — will show again next session
}

async function vm_deleteShare(shareId){
  try{
    await fetch(`${VM_API}/api/share/${vm_userId}/${shareId}`, { method:'DELETE' });
  } catch(e){ /* silent */ }
}

// ═══════════════════════════════════════════════════════════════
// UNDO LAST RATING
// ═══════════════════════════════════════════════════════════════
function showUndoBtn() {
  const btn = document.getElementById('undoBtn');
  if (!btn) return;
  clearTimeout(_undoTimer);
  btn.style.opacity = '1';
  btn.style.pointerEvents = 'all';
  btn.style.transform = 'translateX(-50%) translateY(0)';
  _undoTimer = setTimeout(hideUndoBtn, 4000);
}
function hideUndoBtn() {
  const btn = document.getElementById('undoBtn');
  if (!btn) return;
  btn.style.opacity = '0';
  btn.style.pointerEvents = 'none';
  btn.style.transform = 'translateX(-50%) translateY(80px)';
  _lastRatedSnapshot = null;
}
function undoLastRating() {
  if (!_lastRatedSnapshot) return;
  const { wordId, deckIdx, oldWord, sessionStats } = _lastRatedSnapshot;
  const idx = words.findIndex(x => x.id === wordId);
  if (idx !== -1) {
    Object.assign(words[idx], oldWord); // restore all old SM-2 values
    saveWords(); renderWords();
  }
  // Restore session stats
  _sessionStats = { ...sessionStats };
  // Go back to that card
  currentIdx = deckIdx;
  isFlipped = false;
  const fc = document.getElementById('fc');
  if (fc) fc.classList.remove('flipped');
  document.getElementById('rrow').style.display = 'none';
  renderCard();
  hideUndoBtn();
  showToast('↩️ Rating undone!');
}

// ── RESTORE FILTER UI ON PAGE LOAD ───────────────────────────────────────────
function restoreFilterUI() {
  // Restore exam pill
  if (wExam !== 'all') {
    document.querySelectorAll('#wExamRow .wfpill').forEach(el => {
      if (el.textContent.trim() === wExam) el.classList.add('active-exam');
      else el.classList.remove('active-exam');
    });
    document.getElementById('wYearBlock').style.display = 'block';
    document.getElementById('wTypeBlock').style.display = 'block';
  }
  // Restore year pill
  if (wYear !== 'all') {
    document.querySelectorAll('#wYearRow .wfpill').forEach(el => {
      const match = el.textContent.trim() === wYear || (el.textContent.includes('All') && wYear === 'all');
      el.classList.toggle('active-year', match);
    });
  }
  // Restore type pill
  if (wType !== 'all') {
    document.querySelectorAll('#wTypeRow .wfpill').forEach(el => {
      const t = el.textContent.trim();
      const match = t === wType || (t === 'One Word Sub.' && wType === 'One Word Substitution');
      el.classList.toggle('active-type', match);
    });
  }
  // Restore mem filter style
  if (wMem !== 'all') {
    const memEl = document.getElementById(wMem === 'remembered' ? 'memPillYes' : 'memPillNo');
    if (memEl) {
      const isRem = wMem === 'remembered';
      memEl.style.background   = isRem ? 'rgba(52,211,153,.2)'  : 'rgba(248,113,113,.2)';
      memEl.style.borderColor  = isRem ? 'var(--green)' : 'var(--red)';
      memEl.style.color        = isRem ? 'var(--green)' : 'var(--red)';
      // reset All pill
      const allPill = document.getElementById('memPillAll');
      if (allPill) { allPill.style.background=''; allPill.style.borderColor=''; allPill.style.color=''; }
    }
  }
  // Restore sort select
  const sortSel = document.getElementById('wSortSel');
  if (sortSel) sortSel.value = wSortBy;
}
// ─────────────────────────────────────────────────────────────────────────────

// ═══════════════════════════════════════════════════════════════
// MEMORY TRICK — image + refresh (flashcard & detail modal)
// ═══════════════════════════════════════════════════════════════

function loadMnemImg(w) {
  const inner = document.getElementById('cMnemImgInner');
  if (!inner) return;
  const prompt = w.imagePrompt || (w.word + ' meaning ' + (w.definition || ''));
  const seed = Math.floor(Math.random() * 99999);
  const url = aiImageUrl(prompt + ' colorful funny cartoon illustration', { width: 400, height: 200, seed: seed });
  inner.innerHTML = '<div class="spin" style="width:22px;height:22px;margin:28px auto;border-width:2px"></div>';
  const img = new Image();
  img.onload = () => { inner.innerHTML = '<img src="' + url + '" style="width:100%;height:auto;max-height:180px;object-fit:cover;display:block;border-radius:10px" alt="">'; };
  img.onerror = () => { inner.innerHTML = '<div style="font-size:28px;padding:20px;opacity:.2">🖼️</div>'; };
  img.src = url;
}

// Selected mnemonic style on card
let _mnemStyle = 'bollywood';
function selectMnemStyle(el, style) {
  _mnemStyle = style;
  document.querySelectorAll('.mnem-style-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function renderMnemHistory(w) {
  const histWrap = document.getElementById('cMnemHistoryWrap');
  const histEl   = document.getElementById('cMnemHistory');
  if (!histWrap || !histEl) return;
  const history = w.mnemHistory || [];
  if (history.length < 2) { histWrap.style.display = 'none'; return; }
  histWrap.style.display = 'block';
  histEl.innerHTML = history.slice().reverse().map((h, i) => `
    <div class="mnem-history-item ${h === w.mnemonic ? 'selected' : ''}" onclick="restoreMnem(${i}, '${String(w.id)}')" title="Tap to use this trick">
      <div class="mnem-history-lbl">${h === w.mnemonic ? '✅ Current' : '📜 Previous'}</div>
      ${h}
    </div>`).join('');
}

function restoreMnem(reversedIdx, wordId) {
  const w = currentDeck[currentIdx];
  if (!w || String(w.id) !== wordId) return;
  const history = (w.mnemHistory || []).slice().reverse();
  const selected = history[reversedIdx];
  if (!selected) return;
  w.mnemonic = selected;
  const wObj = words.find(x => String(x.id) === String(w.id));
  if (wObj) wObj.mnemonic = selected;
  saveWords();
  const mn = document.getElementById('cMnem');
  if (mn) { mn.textContent = selected; mn.style.animation = 'none'; void mn.offsetHeight; mn.style.animation = 'mnemPop .4s ease'; }
  loadMnemImg(w);
  renderMnemHistory(w);
  showToast('✅ Memory trick restored!');
}

async function refreshMnemonic() {
  const w = currentDeck[currentIdx];
  if (!w) return;
  const mn   = document.getElementById('cMnem');
  const wrap = document.getElementById('cMnemWrap');
  const load = document.getElementById('cMnemLoading');
  const btn  = document.getElementById('cMnemRefreshBtn');
  if (!mn) return;

  mn.style.opacity = '0';
  if (load) load.style.display = 'block';
  if (btn)  { btn.disabled = true; btn.textContent = '⏳'; }

  const styleMap = {
    bollywood: 'a hilarious Bollywood movie scene with dramatic dialogue',
    cricket:   'a funny cricket match or IPL scenario',
    rhyme:     'a catchy rhyme or rap verse',
    desi:      'a desi chai/street food analogy with Indian context',
    meme:      'a popular internet meme format Indians will recognise',
    story:     'a very short 2-line funny story',
  };
  const styleKey = _mnemStyle || 'bollywood';
  const styleDesc = styleMap[styleKey] || styleMap.bollywood;
  const prompt = 'Create ONE super funny memorable mnemonic for an Indian competitive exam student to remember the word "' + w.word + '" (meaning: ' + (w.definition||'') + '). Style: ' + styleDesc + '. Under 3 sentences. Use emojis. Make it impossible to forget!';

  try {
    const res  = await aiText(prompt);
    const text = (await res.text()).trim().replace(/^["']|["']$/g, '');
    // Save to history
    if (!w.mnemHistory) w.mnemHistory = [];
    if (w.mnemonic && !w.mnemHistory.includes(w.mnemonic)) w.mnemHistory.push(w.mnemonic);
    w.mnemonic = text;
    if (!w.mnemHistory.includes(text)) w.mnemHistory.push(text);
    if (w.mnemHistory.length > 6) w.mnemHistory = w.mnemHistory.slice(-6); // keep last 6
    const wObj = words.find(x => String(x.id) === String(w.id));
    if (wObj) { wObj.mnemonic = text; wObj.mnemHistory = w.mnemHistory; }
    saveWords();
    mn.textContent = text;
    wrap.style.display = 'block';
    mn.style.animation = 'none'; void mn.offsetHeight; mn.style.animation = 'mnemPop .4s ease';
    mn.style.opacity = '1';
    loadMnemImg(w);
    renderMnemHistory(w);
  } catch(e) {
    mn.textContent = w.mnemonic || 'Could not load trick. Check connection!';
    mn.style.opacity = '1';
  } finally {
    if (load) load.style.display = 'none';
    if (btn)  { btn.disabled = false; btn.textContent = '🎲 New'; }
  }
}

function loadDetailMnemImg(wordId, prompt) {
  const imgDiv = document.getElementById('detailMnemImg_' + wordId);
  if (!imgDiv) return;
  const seed = Math.floor(Math.random() * 99999);
  const url = aiImageUrl((prompt || wordId) + ' colorful funny cartoon illustration memory trick', { width: 400, height: 180, seed: seed });
  imgDiv.innerHTML = '<div class="spin" style="width:18px;height:18px;border-width:2px"></div>';
  const img = new Image();
  img.onload = () => { imgDiv.innerHTML = '<img src="' + url + '" style="width:100%;height:auto;max-height:160px;object-fit:cover;display:block;border-radius:10px" alt="">'; };
  img.onerror = () => { imgDiv.style.display = 'none'; };
  img.src = url;
}

async function refreshDetailMnem(wordId) {
  const w = words.find(function(x){ return String(x.id) === String(wordId); });
  if (!w) return;
  const textEl = document.getElementById('detailMnemText_' + wordId);
  const imgDiv = document.getElementById('detailMnemImg_' + wordId);
  if (!textEl) return;

  textEl.innerHTML = '<div class="spin" style="width:16px;height:16px;border-width:2px;margin:4px auto"></div>';
  if (imgDiv) imgDiv.innerHTML = '<div class="spin" style="width:18px;height:18px;border-width:2px"></div>';

  const styles = ['a hilarious Bollywood reference','a funny cricket scenario','a ridiculous rhyme','a desi chai/street food analogy','a WhatsApp uncle forward joke','a popular meme format'];
  const style = styles[Math.floor(Math.random() * styles.length)];
  const prompt = 'Create ONE super funny memorable mnemonic for an Indian student to remember the word "' + w.word + '" (meaning: ' + (w.definition||'') + '). Style: ' + style + '. Under 3 sentences. Use emojis.';
  try {
    const res  = await aiText(prompt);
    const text = (await res.text()).trim().replace(/^["']|["']$/g, '');
    textEl.textContent = '🧠 ' + text;
    w.mnemonic = text;
    saveWords();
    textEl.style.animation = 'none'; void textEl.offsetHeight; textEl.style.animation = 'mnemPop .4s ease';
    loadDetailMnemImg(wordId, w.imagePrompt || w.word);
  } catch(e) {
    textEl.textContent = w.mnemonic ? '🧠 ' + w.mnemonic : '❌ Failed. Check connection!';
    if (imgDiv) imgDiv.style.display = 'none';
  }
}
async function generateConfusables() {
  const w = currentDeck[currentIdx];
  if (!w) return;
  const confEl   = document.getElementById('cConf');
  const loadEl   = document.getElementById('cConfLoading');
  const genBtn   = document.getElementById('cConfGenBtn');
  if (!confEl) return;

  if (loadEl) loadEl.style.display = 'block';
  if (genBtn) { genBtn.disabled = true; genBtn.textContent = '⏳ Loading…'; }

  const existing = (w.confusables||[]).map(c=>c.word).join(', ');
  const prompt = `List 4 words that are commonly confused with "${w.word}" (meaning: ${w.definition||''}).
${existing ? 'Exclude these already shown: ' + existing + '.' : ''}
For each confused word, clearly explain the difference with a short example sentence showing correct usage.
Return ONLY a raw JSON array. No markdown, no backticks. Format:
[{"word":"confusedword","difference":"clear 1-2 sentence difference with example"},...]`;

  try {
    const res  = await aiText(prompt);
    let raw = (await res.text()).trim();
    raw = raw.replace(/```json|```/g,'').trim();
    const start = raw.indexOf('['), end = raw.lastIndexOf(']');
    if (start === -1 || end === -1) throw new Error('bad json');
    const newConf = JSON.parse(raw.slice(start, end+1));
    // Merge with existing, dedupe by word
    const existingWords = new Set((w.confusables||[]).map(c=>c.word.toLowerCase()));
    const toAdd = newConf.filter(c => c.word && !existingWords.has(c.word.toLowerCase()));
    w.confusables = [...(w.confusables||[]), ...toAdd];
    const wObj = words.find(x => String(x.id) === String(w.id));
    if (wObj) wObj.confusables = w.confusables;
    saveWords();
    // Re-render
    confEl.innerHTML = w.confusables.map(c=>`
      <div class="conf-item">
        <div class="conf-vs-row">
          <span class="conf-vs-pill main">${w.word}</span>
          <span class="conf-vs-divider">vs</span>
          <span class="conf-vs-pill confused">⚡ ${c.word||''}</span>
        </div>
        <div class="conf-diff">${c.difference||''}</div>
      </div>`).join('');
    showToast(`⚠️ ${toAdd.length} new confusion alerts added!`, 3000);
  } catch(e) {
    showToast('Could not generate. Check connection!');
  } finally {
    if (loadEl) loadEl.style.display = 'none';
    if (genBtn) { genBtn.disabled = false; genBtn.textContent = '✨ More'; }
  }
}

// ═══════════════════════════════════════════════════════════════
// AI HEALTH CHECK
// ═══════════════════════════════════════════════════════════════
const AI_ENGINES_LIST = [
  { key: 'worker', icon: '⚡', name: 'Default',   model: 'llama-3.1-8b-instant',         fn: (p) => aiWorker(p) },
  { key: 'groq',   icon: '🚀', name: 'Llama 3.1', model: 'llama-3.1-8b-instant',         fn: (p) => aiGroq(p)   },
  { key: 'groq3',  icon: '🦙', name: 'Llama 4',   model: 'llama-4-maverick-17b',         fn: (p) => aiGroq3(p)  },
  { key: 'groq2',  icon: '🧠', name: 'GPT-OSS',   model: 'openai/gpt-oss-120b',          fn: (p) => aiGroq2(p)  },
  { key: 'qwen',   icon: '🐉', name: 'Qwen3-32B', model: 'qwen/qwen3-32b',               fn: (p) => aiQwen(p)   },
  { key: 'kimi',   icon: '🌙', name: 'Kimi K2',   model: 'moonshotai/kimi-k2-instruct',  fn: (p) => aiKimi(p)   },
  { key: 'gemini', icon: '✨', name: 'Gemini',     model: 'gemini-2.5-flash',             fn: (p) => aiGemini(p) },
];

function showAIHealthCheck() {
  const existing = document.getElementById('aiHealthModal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'aiHealthModal';
  modal.className = 'moverlay open';
  modal.innerHTML = `
    <div class="msheet" style="max-height:88vh">
      <div class="mhandle"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div style="font-family:'Playfair Display',serif;font-size:19px;font-weight:700">🔍 AI Engine Status</div>
        <button class="btn btn-ghost btn-sm" onclick="this.closest('.moverlay').remove()">✕</button>
      </div>
      <div style="font-size:12px;color:var(--textSub);margin-bottom:12px;line-height:1.5">Tests each AI with a quick ping. Shows response time and working status.</div>
      <div class="ai-health-row" id="aiHealthList">
        ${AI_ENGINES_LIST.map(e => `
          <div class="ai-health-item" id="ahi_${e.key}">
            <div class="ai-health-left">
              <div class="ai-health-icon">${e.icon}</div>
              <div>
                <div class="ai-health-name">${e.name}</div>
                <div class="ai-health-model">${e.model}</div>
                <div class="ai-health-latency" id="ahl_${e.key}"></div>
              </div>
            </div>
            <div class="ai-health-status ai-hs-idle" id="ahs_${e.key}">⏳ Waiting</div>
          </div>`).join('')}
      </div>
      <div style="display:flex;gap:8px;margin-top:14px">
        <button class="btn btn-gold" style="flex:1" id="aiHealthRunBtn" onclick="runAIHealthCheck()">▶ Test All</button>
        <button class="btn btn-ghost" onclick="this.closest('.moverlay').remove()">Close</button>
      </div>
    </div>`;
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  document.body.appendChild(modal);
  setTimeout(runAIHealthCheck, 200);
}

async function runAIHealthCheck() {
  const btn = document.getElementById('aiHealthRunBtn');
  if (btn) { btn.disabled = true; btn.textContent = '⏳ Testing…'; }

  AI_ENGINES_LIST.forEach(e => {
    const s = document.getElementById('ahs_' + e.key);
    const l = document.getElementById('ahl_' + e.key);
    const i = document.getElementById('ahi_' + e.key);
    if (s) { s.className = 'ai-health-status ai-hs-testing'; s.textContent = '⟳ Testing…'; }
    if (l) l.textContent = '';
    if (i) i.style.borderColor = '';
  });

  const testPrompt = 'Reply with exactly one word: OK';

  await Promise.all(AI_ENGINES_LIST.map(async (engine) => {
    const statusEl  = document.getElementById('ahs_' + engine.key);
    const latencyEl = document.getElementById('ahl_' + engine.key);
    const itemEl    = document.getElementById('ahi_'  + engine.key);
    const t0 = Date.now();
    try {
      await engine.fn(testPrompt);
      const ms = Date.now() - t0;
      if (statusEl)  { statusEl.className = 'ai-health-status ai-hs-ok'; statusEl.textContent = '✅ Working'; }
      if (latencyEl) latencyEl.textContent = ms + 'ms';
      if (itemEl)    itemEl.style.borderColor = 'rgba(46,204,138,.35)';
    } catch(e) {
      const ms   = Date.now() - t0;
      const msg  = e.message || 'Error';
      const isRL = msg.includes('RATE_LIMIT') || msg.includes('429');
      if (statusEl)  { statusEl.className = 'ai-health-status ai-hs-fail'; statusEl.textContent = isRL ? '⚠️ Rate limit' : '❌ Failed'; }
      if (latencyEl) latencyEl.textContent = isRL ? 'Try again later' : msg.replace(/RATE_LIMIT\|\d+\|/,'').slice(0,45);
      if (itemEl)    itemEl.style.borderColor = 'rgba(240,110,110,.3)';
    }
  }));

  if (btn) { btn.disabled = false; btn.textContent = '🔄 Test Again'; }
}

const THEMES = {
  dark:     { orb:'🌙', bg:'#0c0c1e', label:'Dark Gold',      grad:'linear-gradient(135deg,#1a1640 0%,#251a50 50%,#182040)' },
  midnight: { orb:'🌌', bg:'#06090f', label:'Midnight Steel', grad:'linear-gradient(135deg,#0a1830 0%,#0d2040 50%,#081228)' },
  navypro:  { orb:'🔵', bg:'#080e1c', label:'Navy Intel',     grad:'linear-gradient(135deg,#0c1c34 0%,#102240 50%,#081428)' },
  light:    { orb:'☀️', bg:'#f5f5f5', label:'Arctic Light',   grad:'linear-gradient(180deg,#ffffff 0%,#f5f5f5 100%)' },
  white:    { orb:'⬜', bg:'#ffffff', label:'Pure White',     grad:'linear-gradient(180deg,#ffffff 0%,#fafafa 100%)' },
  black:    { orb:'⬛', bg:'#000000', label:'Clean Black',    grad:'linear-gradient(180deg,#1a1a1a 0%,#000000 100%)' },
  gray:     { orb:'◻️', bg:'#1e1e1e', label:'Soft Gray',      grad:'linear-gradient(180deg,#2d2d2d 0%,#1e1e1e 100%)' },
  blue:     { orb:'💙', bg:'#0d47a1', label:'Ocean Blue',     grad:'linear-gradient(180deg,#1565c0 0%,#0d47a1 100%)' },
};
let _currentTheme = localStorage.getItem('vm_theme') || 'dark';

function applyTheme(name, el) {
  _currentTheme = name;
  localStorage.setItem('vm_theme', name);
  const t = THEMES[name] || THEMES.dark;

  document.documentElement.setAttribute('data-theme', name === 'dark' ? '' : name);

  const orb = document.getElementById('themeOrb');
  if (orb) {
    orb.textContent = t.orb;
    orb.classList.remove('orb-pop');
    void orb.offsetWidth;
    orb.classList.add('orb-pop');
    orb.style.background = `radial-gradient(circle at 40% 40%, color-mix(in srgb, ${t.bg} 0%, #444), ${t.bg})`;
  }

  const tc = document.getElementById('themeColorMeta');
  if (tc) tc.content = t.bg;
  injectManifest(t.bg);

  document.querySelectorAll('.theme-opt').forEach(o => o.classList.remove('active'));
  const target = el || document.getElementById('topt-' + name);
  if (target) target.classList.add('active');

  const drawer = document.getElementById('themeDrawer');
  if (drawer) drawer.classList.remove('open');

  const hero = document.querySelector('.hero');
  if (hero) hero.style.background = t.grad;

  showToast('🎨 ' + t.label + ' theme applied!');
}

function toggleThemeDrawer(e) {
  e.stopPropagation();
  const drawer = document.getElementById('themeDrawer');
  const btn = document.getElementById('themeToggleBtn');
  if (!drawer || !btn) return;
  const isOpen = drawer.classList.contains('open');
  if (!isOpen) {
    const rect = btn.getBoundingClientRect();
    const drawerW = 240;
    let left = rect.right - drawerW;
    if (left < 8) left = 8;
    if (left + drawerW > window.innerWidth - 8) left = window.innerWidth - drawerW - 8;
    let top = rect.bottom + 8;
    const maxH = window.innerHeight - top - 12;
    drawer.style.top = top + 'px';
    drawer.style.left = left + 'px';
    drawer.style.maxHeight = maxH + 'px';
    drawer.style.overflowY = maxH < 420 ? 'auto' : 'visible';
  }
  drawer.classList.toggle('open', !isOpen);
}

document.addEventListener('click', function(e) {
  const wrap = document.getElementById('themeToggleBtn');
  const drawer = document.getElementById('themeDrawer');
  if (drawer && wrap && !wrap.contains(e.target) && !drawer.contains(e.target)) {
    drawer.classList.remove('open');
  }
});

// Init theme on load
(function initTheme() {
  const saved = localStorage.getItem('vm_theme') || 'dark';
  applyTheme(saved, null);
})();

// ═══════════════════════════════════════════════════════════════
// ████  SM-2 STATS DISPLAY  ████
// Shows real interval/EF on card back + dynamic rate button previews
// ═══════════════════════════════════════════════════════════════

// Ensure every word has SM-2 fields when loaded
function ensureSM2Fields(w) {
  if (typeof w.ef       !== 'number') w.ef       = 2.5;
  if (typeof w.interval !== 'number') w.interval = 0;
  if (typeof w.reps     !== 'number') w.reps     = 0;
  if (!w.nextReview)                  w.nextReview = Date.now();
  return w;
}

function renderSM2Panel(w) {
  if (!w) return;
  ensureSM2Fields(w);

  const panel = document.getElementById('sm2Panel');
  if (!panel) return;
  panel.style.display = 'grid';

  // Next review date
  const nextDate = new Date(w.nextReview || Date.now());
  const today    = new Date();
  const diffDays = Math.ceil((nextDate - today) / 86400000);
  const nextStr  = diffDays <= 0 ? '⏰ Due Now!'
                 : diffDays === 1 ? 'Tomorrow'
                 : `In ${diffDays} days`;
  const nextEl = document.getElementById('sm2NextReview');
  if (nextEl) {
    nextEl.textContent = nextStr;
    nextEl.style.color = diffDays <= 0 ? 'var(--red)' : diffDays <= 3 ? 'var(--orange)' : 'var(--green)';
  }

  // Interval
  const ivEl = document.getElementById('sm2Interval');
  if (ivEl) ivEl.textContent = (w.interval || 0) === 0 ? 'New' : `${w.interval}d`;

  // Ease Factor (1.3 - 4.0 range)
  const ef     = typeof w.ef === 'number' ? w.ef : 2.5;
  const efEl   = document.getElementById('sm2EF');
  if (efEl) {
    efEl.textContent = ef.toFixed(2);
    efEl.style.color = ef >= 2.8 ? 'var(--green)' : ef >= 2.0 ? 'var(--gold)' : 'var(--red)';
  }

  // Repetitions
  const repEl = document.getElementById('sm2Reps');
  if (repEl) repEl.textContent = (w.reps || 0) + ' ×';

  // EF bar (1.3 min, 4.0 max)
  const barFill = document.getElementById('sm2EFBar');
  if (barFill) barFill.style.width = Math.round(((ef - 1.3) / (4.0 - 1.3)) * 100) + '%';
}

function updateRateButtonPreviews(w) {
  if (!w) return;
  ensureSM2Fields(w);

  function intervalLabel(days) {
    if (days <= 1) return 'Tomorrow';
    if (days < 7)  return `In ${days} days`;
    if (days < 30) return `In ${Math.round(days/7)}w`;
    return `In ${Math.round(days/30)}mo`;
  }

  const hardSM = sm2(w, 1); // Hard
  const medSM  = sm2(w, 3); // Medium
  const easySM = sm2(w, 5); // Easy

  const hEl = document.getElementById('rbtnHardNext');
  const mEl = document.getElementById('rbtnMedNext');
  const eEl = document.getElementById('rbtnEasyNext');

  if (hEl) hEl.textContent = intervalLabel(hardSM.interval);
  if (mEl) mEl.textContent = intervalLabel(medSM.interval);
  if (eEl) eEl.textContent = intervalLabel(easySM.interval);
}

// Migrate existing words to ensure SM-2 fields
setTimeout(() => {
  let migrated = false;
  if (typeof words !== 'undefined') {
    words.forEach(w => {
      const before = JSON.stringify({ ef: w.ef, interval: w.interval, reps: w.reps });
      ensureSM2Fields(w);
      if (JSON.stringify({ ef: w.ef, interval: w.interval, reps: w.reps }) !== before) migrated = true;
    });
    if (migrated && typeof saveWords === 'function') saveWords();
  }
}, 2000);

// ═══════════════════════════════════════════════════════════════
// ████  PWA — Service Worker + Manifest + Install Banner  ████
// ═══════════════════════════════════════════════════════════════
let _pwaPrompt = null;

function injectManifest(themeColor) {
  const tc = themeColor || '#0e0e14';
  const manifest = {
    name: 'VocabMaster Pro',
    short_name: 'VocabMaster',
    description: 'AI-powered vocabulary learning for Indian competitive exams',
    start_url: './',
    display: 'standalone',
    background_color: tc,
    theme_color: tc,
    orientation: 'portrait',
    icons: [
      { src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect width="192" height="192" rx="36" fill="%230e0e14"/><text y="130" x="96" font-size="120" text-anchor="middle">📚</text></svg>', sizes: '192x192', type: 'image/svg+xml' },
      { src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="96" fill="%230e0e14"/><text y="360" x="256" font-size="320" text-anchor="middle">📚</text></svg>', sizes: '512x512', type: 'image/svg+xml' }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
  const url  = URL.createObjectURL(blob);
  const link = document.getElementById('pwaManifest');
  if (link) {
    if (link._prevUrl) URL.revokeObjectURL(link._prevUrl);
    link.href = url;
    link._prevUrl = url;
    link.rel = 'manifest';
  }
}

// ── PWA Note ──────────────────────────────────────────────────
// Service Workers cannot be registered from blob: or file: URLs —
// they require a real HTTP/HTTPS origin. Since VocabMaster is a
// single HTML file, the SW is skipped here. The manifest + install
// prompt still work on Android Chrome when saved to a web server.
// For true offline support, host this file on any static host
// (GitHub Pages, Netlify, Cloudflare Pages) and a SW will work.
// ──────────────────────────────────────────────────────────────

// Listen for install prompt (Android Chrome / Edge — fires automatically on eligible pages)
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  _pwaPrompt = e;
  // Show banner after 4s (let user settle in first)
  setTimeout(() => {
    if (!localStorage.getItem('vm_pwa_dismissed')) showPWABanner();
  }, 4000);
});

window.addEventListener('appinstalled', () => {
  _pwaPrompt = null;
  const banner = document.getElementById('pwaBanner');
  if (banner) banner.style.display = 'none';
  showToast('🎉 VocabMaster installed! Find it on your home screen.');
  localStorage.setItem('vm_pwa_dismissed', '1');
});

function showPWABanner() {
  const banner = document.getElementById('pwaBanner');
  if (!banner) return;
  // Detect device for subtitle
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const sub = document.getElementById('pwaBannerSub');
  if (sub) {
    sub.textContent = isIOS
      ? 'Tap Share → "Add to Home Screen"'
      : 'Add to home screen · Works like a native app';
  }
  banner.style.display = 'flex';
}

function triggerPWAInstall() {
  // Case 1: Browser install prompt available (Android Chrome/Edge)
  if (_pwaPrompt) {
    _pwaPrompt.prompt();
    _pwaPrompt.userChoice.then(r => {
      if (r.outcome === 'accepted') showToast('🎉 Installing VocabMaster...');
      _pwaPrompt = null;
      const banner = document.getElementById('pwaBanner');
      if (banner) banner.style.display = 'none';
    });
    return;
  }

  // Case 2: iOS Safari — show step-by-step guide
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

  // Show install guide modal
  showInstallGuide(isIOS && isSafari ? 'ios' : 'generic');
}

function showInstallGuide(type) {
  const existing = document.getElementById('pwaGuideModal');
  if (existing) existing.remove();

  const isIOS = type === 'ios';
  const steps = isIOS ? [
    { icon: '🌐', text: 'Make sure you\'re using <b>Safari</b> browser' },
    { icon: '📤', text: 'Tap the <b>Share button</b> (box with arrow) at the bottom' },
    { icon: '➕', text: 'Scroll down and tap <b>"Add to Home Screen"</b>' },
    { icon: '✅', text: 'Tap <b>"Add"</b> — VocabMaster appears on your home screen!' },
  ] : [
    { icon: '🌐', text: 'Open this page in <b>Chrome</b> or <b>Edge</b> on Android' },
    { icon: '⋮', text: 'Tap the <b>3-dot menu</b> (top right)' },
    { icon: '➕', text: 'Tap <b>"Add to Home screen"</b> or <b>"Install app"</b>' },
    { icon: '✅', text: 'Tap <b>"Install"</b> — VocabMaster is now on your home screen!' },
  ];

  const modal = document.createElement('div');
  modal.id = 'pwaGuideModal';
  modal.className = 'moverlay open';
  modal.innerHTML = `
<div class="msheet" style="max-height:80vh">
  <div class="mhandle"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <div style="font-family:'Playfair Display',serif;font-size:19px;font-weight:700">📱 Install App</div>
    <button class="btn btn-ghost btn-sm" onclick="this.closest('.moverlay').remove()">✕</button>
  </div>
  <div style="background:linear-gradient(135deg,rgba(124,106,247,.12),rgba(96,165,250,.08));border:1px solid rgba(124,106,247,.3);border-radius:12px;padding:12px 14px;margin-bottom:14px">
    <div style="font-size:12px;color:var(--textSub);line-height:1.6">
      ${isIOS
        ? '📱 <b style="color:var(--text)">iOS Safari detected</b> — follow these steps to add VocabMaster to your home screen:'
        : '🤖 <b style="color:var(--text)">Android/Desktop</b> — follow these steps to install VocabMaster:'}
    </div>
  </div>
  <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:18px">
    ${steps.map((s, i) => `
      <div style="display:flex;align-items:flex-start;gap:12px;padding:10px 12px;background:var(--card);border-radius:10px;border:1px solid var(--border)">
        <div style="width:28px;height:28px;border-radius:50%;background:rgba(245,200,66,.15);border:1.5px solid rgba(245,200,66,.3);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">${s.icon}</div>
        <div>
          <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.6px;color:var(--textMuted);margin-bottom:3px">Step ${i + 1}</div>
          <div style="font-size:13px;color:var(--text);line-height:1.5">${s.text}</div>
        </div>
      </div>`).join('')}
  </div>
  <div style="background:rgba(52,211,153,.07);border:1px solid rgba(52,211,153,.2);border-radius:10px;padding:10px 12px;margin-bottom:14px">
    <div style="font-size:11px;color:var(--green);line-height:1.6">✅ Once installed, VocabMaster works just like a native app — full screen, no browser bar, fast launch!</div>
  </div>
  <button class="btn btn-gold" style="width:100%;padding:13px" onclick="this.closest('.moverlay').remove()">Got it!</button>
</div>`;
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  document.body.appendChild(modal);

  // Also dismiss the banner
  const banner = document.getElementById('pwaBanner');
  if (banner) banner.style.display = 'none';
}

function dismissPWA() {
  const banner = document.getElementById('pwaBanner');
  if (banner) banner.style.display = 'none';
  localStorage.setItem('vm_pwa_dismissed', '1');
}

// Init manifest on page load
injectManifest(THEMES[_currentTheme]?.bg || '#0e0e14');

// ═══════════════════════════════════════════════════════════════

</script>

<script>
/**
 * Iframe 元素高亮注入脚本
 * 需要在目标网站中引入此脚本来支持跨域 iframe 高亮功能
 *
 * 使用方法：
 * 1. 将此脚本添加到目标网站的 HTML 中
 * 2. 或通过浏览器扩展、用户脚本等方式注入
 */

(function () {
  "use strict";

  // 检查是否在 iframe 中
  if (window.self === window.top) {
    return; // 不在 iframe 中，不执行
  }

  // 检查是否已经初始化过
  if (window.__iframeHighlightInitialized) {
    return;
  }
  window.__iframeHighlightInitialized = true;
  console.log("Iframe 高亮脚本已加载");

  // 创建高亮覆盖层
  var overlay = document.createElement("div");
  overlay.id = "iframe-highlight-overlay";
  overlay.style.cssText = "\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    pointer-events: none;\n    z-index: 999999;\n    overflow: hidden;\n  ";

  // 创建悬停高亮框（虚线边框）
  var highlightBox = document.createElement("div");
  highlightBox.id = "iframe-highlight-box";
  highlightBox.style.cssText = "\n    position: absolute;\n    border: 2px dashed #007AFF;\n    background: rgba(0, 122, 255, 0.08);\n    pointer-events: none;\n    display: none;\n    transition: all 0.1s ease;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8);\n    border-radius: 2px;\n  ";

  // 创建选中节点的常驻高亮框（实线边框）
  var selectedBox = document.createElement("div");
  selectedBox.id = "iframe-selected-box";
  selectedBox.style.cssText = "\n    position: absolute;\n    border: 2px solid #007AFF;\n    pointer-events: none;\n    display: none;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.9), 0 0 8px rgba(255, 107, 53, 0.4);\n    border-radius: 2px;\n    z-index: 1000000;\n  ";

  // 创建悬停标签显示
  var tagLabel = document.createElement("div");
  tagLabel.id = "iframe-tag-label";
  tagLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 2px 6px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 2px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000001;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n    font-weight: 500;\n  ";

  // 创建选中节点标签
  var selectedLabel = document.createElement("div");
  selectedLabel.id = "iframe-selected-label";
  selectedLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 3px 8px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 3px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000002;\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);\n    font-weight: 600;\n  ";
  overlay.appendChild(highlightBox);
  overlay.appendChild(selectedBox);
  overlay.appendChild(tagLabel);
  overlay.appendChild(selectedLabel);
  document.body.appendChild(overlay);

  // 存储当前选中的元素
  var selectedElement = null;
  var highlightEnabled = false;

  // 更新选中元素的高亮显示
  function updateSelectedHighlight(element) {
    console.log("updateSelectedHighlight called with:", element);
    if (!element) {
      selectedBox.style.display = "none";
      selectedLabel.style.display = "none";
      selectedElement = null;
      console.log("Cleared selected highlight");
      return;
    }
    selectedElement = element;
    var rect = element.getBoundingClientRect();
    console.log("Selected element rect:", rect);

    // 更新选中高亮框位置
    selectedBox.style.display = "block";
    selectedBox.style.left = "".concat(rect.left - 2, "px");
    selectedBox.style.top = "".concat(rect.top - 2, "px");
    selectedBox.style.width = "".concat(rect.width + 4, "px");
    selectedBox.style.height = "".concat(rect.height + 4, "px");

    // 更新选中标签位置和内容
    selectedLabel.style.display = "block";
    selectedLabel.textContent = "\u2713 <".concat(element.tagName.toLowerCase(), ">");

    // 计算标签位置，确保不超出视窗
    var labelTop = rect.top - 28;
    var labelLeft = rect.left;

    // 如果标签会超出顶部，显示在元素下方
    if (labelTop < 5) {
      labelTop = rect.bottom + 5;
    }

    // 如果标签会超出右侧，向左调整
    var labelWidth = selectedLabel.offsetWidth || 100; // 预估宽度
    if (labelLeft + labelWidth > window.innerWidth - 10) {
      labelLeft = window.innerWidth - labelWidth - 10;
    }
    selectedLabel.style.left = "".concat(Math.max(5, labelLeft), "px");
    selectedLabel.style.top = "".concat(labelTop, "px");
    console.log("Selected highlight positioned at:", {
      left: selectedBox.style.left,
      top: selectedBox.style.top,
      width: selectedBox.style.width,
      height: selectedBox.style.height
    });
  }
  function getElementSelector(element) {
    if (!(element instanceof Element)) throw new Error('Argument must be a DOM element');
    var segments = [];
    var current = element;
    while (current !== document.documentElement) {
      var selector = '';
      // 优先检查唯一ID
      if (current.id && document.querySelectorAll("#".concat(current.id)).length === 1) {
        segments.unshift("#".concat(current.id));
        break; // ID唯一，无需继续向上
      }

      // 生成类名选择器（取第一个有效类名）
      var classes = Array.from(current.classList).filter(function (c) {
        return !c.startsWith('js-');
      });
      var className = classes.length > 0 ? ".".concat(classes[0]) : '';

      // 生成位置索引（nth-child）
      var tag = current.tagName.toLowerCase();
      if (!className) {
        var siblings = Array.from(current.parentNode.children);
        var index = siblings.findIndex(function (el) {
          return el === current;
        }) + 1;
        selector = "".concat(tag, ":nth-child(").concat(index, ")");
      } else {
        selector = className;
      }
      segments.unshift(selector);
      current = current.parentElement;
    }

    // 处理根元素
    if (current === document.documentElement) {
      segments.unshift('html');
    }
    return segments.join(' > ');
  }

  // 获取元素文本内容
  function getElementText(element) {
    var _element$textContent;
    if (element.tagName === "INPUT") {
      return element.value || element.placeholder || "";
    }
    if (element.tagName === "TEXTAREA") {
      return element.value || element.placeholder || "";
    }
    var text = ((_element$textContent = element.textContent) === null || _element$textContent === void 0 ? void 0 : _element$textContent.trim()) || "";
    return text.length > 50 ? text.substring(0, 50) + "..." : text;
  }

  // 获取元素属性信息
  function getElementAttributes(element) {
    var attrs = {};
    for (var i = 0; i < element.attributes.length; i++) {
      var attr = element.attributes[i];
      attrs[attr.name] = attr.value;
    }
    return attrs;
  }

  // 鼠标悬停事件处理
  function handleMouseOver(e) {
    if (!highlightEnabled) return;
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // 避免高亮 html 和 body 元素
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // 如果是已选中的元素，不显示悬停高亮
    if (target === selectedElement) {
      highlightBox.style.display = "none";
      tagLabel.style.display = "none";
      return;
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);

    // 更新悬停高亮框位置
    highlightBox.style.display = "block";
    highlightBox.style.left = "".concat(rect.left - 2, "px");
    highlightBox.style.top = "".concat(rect.top - 2, "px");
    highlightBox.style.width = "".concat(rect.width + 4, "px");
    highlightBox.style.height = "".concat(rect.height + 4, "px");

    // 更新标签位置和内容
    tagLabel.style.display = "block";
    tagLabel.textContent = "<".concat(target.tagName.toLowerCase(), ">");

    // 计算标签位置，确保不超出视窗
    var labelTop = rect.top - 22;
    var labelLeft = rect.left;

    // 如果标签会超出顶部，显示在元素下方
    if (labelTop < 0) {
      labelTop = rect.bottom + 5;
    }

    // 如果标签会超出右侧，向左调整
    if (labelLeft + tagLabel.offsetWidth > window.innerWidth) {
      labelLeft = window.innerWidth - tagLabel.offsetWidth - 5;
    }
    tagLabel.style.left = "".concat(Math.max(0, labelLeft), "px");
    tagLabel.style.top = "".concat(labelTop, "px");

    // 发送消息到父窗口
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 鼠标离开事件处理
  function handleMouseOut(e) {
    if (!highlightEnabled) return;
    var relatedTarget = e.relatedTarget;

    // 如果鼠标移动到高亮相关元素上，不隐藏高亮
    if (relatedTarget && (relatedTarget === highlightBox || relatedTarget === tagLabel || relatedTarget === overlay || relatedTarget === selectedBox || relatedTarget === selectedLabel)) {
      return;
    }
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: null,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 点击事件处理
  function handleClick(e) {
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // 避免处理 html 和 body 元素
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // 检查是否是交互元素，这些元素需要保留默认行为
    var isInteractiveElement = ['input', 'textarea', 'select', 'button', 'a'].includes(target.tagName.toLowerCase());

    // 如果高亮功能启用，对于非交互元素阻止默认行为和事件传播
    if (highlightEnabled) {
      e.preventDefault();
      e.stopPropagation();
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);
    console.log("Element clicked:", {
      tagName: target.tagName,
      selector: selector,
      rect: rect
    });

    // 立即更新选中高亮
    updateSelectedHighlight(target);

    // 隐藏悬停高亮，因为现在是选中状态
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-click",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 监听来自父窗口的消息
  function handleParentMessage(event) {
    console.log("Received message from parent:", event.data);
    if (event.data.type === "iframe-highlight-toggle") {
      var enabled = event.data.enabled;
      console.log("Highlight toggle:", enabled);
      if (enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "enable-iframe-highlight") {
      console.log("Enable iframe highlight");
      enableHighlight();
    } else if (event.data.type === "disable-iframe-highlight") {
      console.log("Disable iframe highlight");
      disableHighlight();
    } else if (event.data.type === "toggle-iframe-highlight") {
      var _enabled = event.data.enabled !== undefined ? event.data.enabled : !highlightEnabled;
      console.log("Toggle iframe highlight to:", _enabled);
      if (_enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "update-selected-element") {
      var selector = event.data.selector;
      console.log("Update selected element with selector:", selector);
      if (selector) {
        try {
          var element = document.querySelector(selector);
          console.log("Found element by selector:", element);
          updateSelectedHighlight(element);
        } catch (error) {
          console.warn("Failed to select element:", error);
          updateSelectedHighlight(null);
        }
      } else {
        updateSelectedHighlight(null);
      }
    } else if (event.data.type === "clear-selected-element") {
      console.log("Clear selected element");
      updateSelectedHighlight(null);
    }
  }

  // 启用高亮功能
  function enableHighlight() {
    console.log("Enabling highlight");
    document.addEventListener("mouseover", handleMouseOver, true);
    document.addEventListener("mouseout", handleMouseOut, true);
    document.addEventListener("click", handleClick, true);
    highlightEnabled = true;
    overlay.style.display = "block";
  }

  // 禁用高亮功能
  function disableHighlight() {
    console.log("Disabling highlight");
    highlightEnabled = false;
    // 保持事件监听器，但通过 highlightEnabled 变量控制行为
    // 这样可以保留选中状态的显示
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    // 不隐藏 selectedBox 和 selectedLabel，保留选中状态
  }

  // 完全禁用高亮功能（移除所有监听器）
  function fullyDisableHighlight() {
    console.log("Fully disabling highlight");
    highlightEnabled = false;
    document.removeEventListener("mouseover", handleMouseOver, true);
    document.removeEventListener("mouseout", handleMouseOut, true);
    document.removeEventListener("click", handleClick, true);
    overlay.style.display = "none";
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    selectedBox.style.display = "none";
    selectedLabel.style.display = "none";
  }

  // 添加事件监听
  enableHighlight();
  window.addEventListener("message", handleParentMessage);

  // 暴露全局函数供外部调用
  window.__iframeHighlightControl = {
    enable: enableHighlight,
    disable: disableHighlight,
    fullyDisable: fullyDisableHighlight,
    isEnabled: function isEnabled() {
      return highlightEnabled;
    },
    getSelectedElement: function getSelectedElement() {
      return selectedElement;
    },
    updateSelected: updateSelectedHighlight,
    // 通过消息发送开关控制
    sendToggleMessage: function sendToggleMessage(enabled) {
      window.parent.postMessage({
        type: 'iframe-highlight-status',
        enabled: enabled || highlightEnabled,
        source: 'iframe-highlight-injector'
      }, '*');
    }
  };

  // 通知父窗口脚本已加载
  try {
    window.parent.postMessage({
      type: "iframe-highlight-ready",
      data: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now()
      },
      source: "iframe-highlight-injector"
    }, "*");
  } catch (error) {
    console.warn("无法发送就绪消息到父窗口:", error);
  }

  // 清理函数
  window.__iframeHighlightCleanup = function () {
    fullyDisableHighlight();
    window.removeEventListener("message", handleParentMessage);
    if (overlay.parentElement) {
      overlay.parentElement.removeChild(overlay);
    }
    delete window.__iframeHighlightInitialized;
    delete window.__iframeHighlightCleanup;
  };
})();

</script>

<script>
/**
 * Iframe 元素高亮注入脚本
 * 需要在目标网站中引入此脚本来支持跨域 iframe 高亮功能
 *
 * 使用方法：
 * 1. 将此脚本添加到目标网站的 HTML 中
 * 2. 或通过浏览器扩展、用户脚本等方式注入
 */

(function () {
  "use strict";

  // 检查是否在 iframe 中
  if (window.self === window.top) {
    return; // 不在 iframe 中，不执行
  }

  // 检查是否已经初始化过
  if (window.__iframeHighlightInitialized) {
    return;
  }
  window.__iframeHighlightInitialized = true;
  console.log("Iframe 高亮脚本已加载");

  // 创建高亮覆盖层
  var overlay = document.createElement("div");
  overlay.id = "iframe-highlight-overlay";
  overlay.style.cssText = "\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    pointer-events: none;\n    z-index: 999999;\n    overflow: hidden;\n  ";

  // 创建悬停高亮框（虚线边框）
  var highlightBox = document.createElement("div");
  highlightBox.id = "iframe-highlight-box";
  highlightBox.style.cssText = "\n    position: absolute;\n    border: 2px dashed #007AFF;\n    background: rgba(0, 122, 255, 0.08);\n    pointer-events: none;\n    display: none;\n    transition: all 0.1s ease;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8);\n    border-radius: 2px;\n  ";

  // 创建选中节点的常驻高亮框（实线边框）
  var selectedBox = document.createElement("div");
  selectedBox.id = "iframe-selected-box";
  selectedBox.style.cssText = "\n    position: absolute;\n    border: 2px solid #007AFF;\n    pointer-events: none;\n    display: none;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.9), 0 0 8px rgba(255, 107, 53, 0.4);\n    border-radius: 2px;\n    z-index: 1000000;\n  ";

  // 创建悬停标签显示
  var tagLabel = document.createElement("div");
  tagLabel.id = "iframe-tag-label";
  tagLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 2px 6px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 2px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000001;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n    font-weight: 500;\n  ";

  // 创建选中节点标签
  var selectedLabel = document.createElement("div");
  selectedLabel.id = "iframe-selected-label";
  selectedLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 3px 8px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 3px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000002;\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);\n    font-weight: 600;\n  ";
  overlay.appendChild(highlightBox);
  overlay.appendChild(selectedBox);
  overlay.appendChild(tagLabel);
  overlay.appendChild(selectedLabel);
  document.body.appendChild(overlay);

  // 存储当前选中的元素
  var selectedElement = null;
  var highlightEnabled = false;

  // 更新选中元素的高亮显示
  function updateSelectedHighlight(element) {
    console.log("updateSelectedHighlight called with:", element);
    if (!element) {
      selectedBox.style.display = "none";
      selectedLabel.style.display = "none";
      selectedElement = null;
      console.log("Cleared selected highlight");
      return;
    }
    selectedElement = element;
    var rect = element.getBoundingClientRect();
    console.log("Selected element rect:", rect);

    // 更新选中高亮框位置
    selectedBox.style.display = "block";
    selectedBox.style.left = "".concat(rect.left - 2, "px");
    selectedBox.style.top = "".concat(rect.top - 2, "px");
    selectedBox.style.width = "".concat(rect.width + 4, "px");
    selectedBox.style.height = "".concat(rect.height + 4, "px");

    // 更新选中标签位置和内容
    selectedLabel.style.display = "block";
    selectedLabel.textContent = "\u2713 <".concat(element.tagName.toLowerCase(), ">");

    // 计算标签位置，确保不超出视窗
    var labelTop = rect.top - 28;
    var labelLeft = rect.left;

    // 如果标签会超出顶部，显示在元素下方
    if (labelTop < 5) {
      labelTop = rect.bottom + 5;
    }

    // 如果标签会超出右侧，向左调整
    var labelWidth = selectedLabel.offsetWidth || 100; // 预估宽度
    if (labelLeft + labelWidth > window.innerWidth - 10) {
      labelLeft = window.innerWidth - labelWidth - 10;
    }
    selectedLabel.style.left = "".concat(Math.max(5, labelLeft), "px");
    selectedLabel.style.top = "".concat(labelTop, "px");
    console.log("Selected highlight positioned at:", {
      left: selectedBox.style.left,
      top: selectedBox.style.top,
      width: selectedBox.style.width,
      height: selectedBox.style.height
    });
  }
  function getElementSelector(element) {
    if (!(element instanceof Element)) throw new Error('Argument must be a DOM element');
    var segments = [];
    var current = element;
    while (current !== document.documentElement) {
      var selector = '';
      // 优先检查唯一ID
      if (current.id && document.querySelectorAll("#".concat(current.id)).length === 1) {
        segments.unshift("#".concat(current.id));
        break; // ID唯一，无需继续向上
      }

      // 生成类名选择器（取第一个有效类名）
      var classes = Array.from(current.classList).filter(function (c) {
        return !c.startsWith('js-');
      });
      var className = classes.length > 0 ? ".".concat(classes[0]) : '';

      // 生成位置索引（nth-child）
      var tag = current.tagName.toLowerCase();
      if (!className) {
        var siblings = Array.from(current.parentNode.children);
        var index = siblings.findIndex(function (el) {
          return el === current;
        }) + 1;
        selector = "".concat(tag, ":nth-child(").concat(index, ")");
      } else {
        selector = className;
      }
      segments.unshift(selector);
      current = current.parentElement;
    }

    // 处理根元素
    if (current === document.documentElement) {
      segments.unshift('html');
    }
    return segments.join(' > ');
  }

  // 获取元素文本内容
  function getElementText(element) {
    var _element$textContent;
    if (element.tagName === "INPUT") {
      return element.value || element.placeholder || "";
    }
    if (element.tagName === "TEXTAREA") {
      return element.value || element.placeholder || "";
    }
    var text = ((_element$textContent = element.textContent) === null || _element$textContent === void 0 ? void 0 : _element$textContent.trim()) || "";
    return text.length > 50 ? text.substring(0, 50) + "..." : text;
  }

  // 获取元素属性信息
  function getElementAttributes(element) {
    var attrs = {};
    for (var i = 0; i < element.attributes.length; i++) {
      var attr = element.attributes[i];
      attrs[attr.name] = attr.value;
    }
    return attrs;
  }

  // 鼠标悬停事件处理
  function handleMouseOver(e) {
    if (!highlightEnabled) return;
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // 避免高亮 html 和 body 元素
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // 如果是已选中的元素，不显示悬停高亮
    if (target === selectedElement) {
      highlightBox.style.display = "none";
      tagLabel.style.display = "none";
      return;
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);

    // 更新悬停高亮框位置
    highlightBox.style.display = "block";
    highlightBox.style.left = "".concat(rect.left - 2, "px");
    highlightBox.style.top = "".concat(rect.top - 2, "px");
    highlightBox.style.width = "".concat(rect.width + 4, "px");
    highlightBox.style.height = "".concat(rect.height + 4, "px");

    // 更新标签位置和内容
    tagLabel.style.display = "block";
    tagLabel.textContent = "<".concat(target.tagName.toLowerCase(), ">");

    // 计算标签位置，确保不超出视窗
    var labelTop = rect.top - 22;
    var labelLeft = rect.left;

    // 如果标签会超出顶部，显示在元素下方
    if (labelTop < 0) {
      labelTop = rect.bottom + 5;
    }

    // 如果标签会超出右侧，向左调整
    if (labelLeft + tagLabel.offsetWidth > window.innerWidth) {
      labelLeft = window.innerWidth - tagLabel.offsetWidth - 5;
    }
    tagLabel.style.left = "".concat(Math.max(0, labelLeft), "px");
    tagLabel.style.top = "".concat(labelTop, "px");

    // 发送消息到父窗口
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 鼠标离开事件处理
  function handleMouseOut(e) {
    if (!highlightEnabled) return;
    var relatedTarget = e.relatedTarget;

    // 如果鼠标移动到高亮相关元素上，不隐藏高亮
    if (relatedTarget && (relatedTarget === highlightBox || relatedTarget === tagLabel || relatedTarget === overlay || relatedTarget === selectedBox || relatedTarget === selectedLabel)) {
      return;
    }
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: null,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 点击事件处理
  function handleClick(e) {
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // 避免处理 html 和 body 元素
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // 检查是否是交互元素，这些元素需要保留默认行为
    var isInteractiveElement = ['input', 'textarea', 'select', 'button', 'a'].includes(target.tagName.toLowerCase());

    // 如果高亮功能启用，对于非交互元素阻止默认行为和事件传播
    if (highlightEnabled) {
      e.preventDefault();
      e.stopPropagation();
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);
    console.log("Element clicked:", {
      tagName: target.tagName,
      selector: selector,
      rect: rect
    });

    // 立即更新选中高亮
    updateSelectedHighlight(target);

    // 隐藏悬停高亮，因为现在是选中状态
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-click",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 监听来自父窗口的消息
  function handleParentMessage(event) {
    console.log("Received message from parent:", event.data);
    if (event.data.type === "iframe-highlight-toggle") {
      var enabled = event.data.enabled;
      console.log("Highlight toggle:", enabled);
      if (enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "enable-iframe-highlight") {
      console.log("Enable iframe highlight");
      enableHighlight();
    } else if (event.data.type === "disable-iframe-highlight") {
      console.log("Disable iframe highlight");
      disableHighlight();
    } else if (event.data.type === "toggle-iframe-highlight") {
      var _enabled = event.data.enabled !== undefined ? event.data.enabled : !highlightEnabled;
      console.log("Toggle iframe highlight to:", _enabled);
      if (_enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "update-selected-element") {
      var selector = event.data.selector;
      console.log("Update selected element with selector:", selector);
      if (selector) {
        try {
          var element = document.querySelector(selector);
          console.log("Found element by selector:", element);
          updateSelectedHighlight(element);
        } catch (error) {
          console.warn("Failed to select element:", error);
          updateSelectedHighlight(null);
        }
      } else {
        updateSelectedHighlight(null);
      }
    } else if (event.data.type === "clear-selected-element") {
      console.log("Clear selected element");
      updateSelectedHighlight(null);
    }
  }

  // 启用高亮功能
  function enableHighlight() {
    console.log("Enabling highlight");
    document.addEventListener("mouseover", handleMouseOver, true);
    document.addEventListener("mouseout", handleMouseOut, true);
    document.addEventListener("click", handleClick, true);
    highlightEnabled = true;
    overlay.style.display = "block";
  }

  // 禁用高亮功能
  function disableHighlight() {
    console.log("Disabling highlight");
    highlightEnabled = false;
    // 保持事件监听器，但通过 highlightEnabled 变量控制行为
    // 这样可以保留选中状态的显示
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    // 不隐藏 selectedBox 和 selectedLabel，保留选中状态
  }

  // 完全禁用高亮功能（移除所有监听器）
  function fullyDisableHighlight() {
    console.log("Fully disabling highlight");
    highlightEnabled = false;
    document.removeEventListener("mouseover", handleMouseOver, true);
    document.removeEventListener("mouseout", handleMouseOut, true);
    document.removeEventListener("click", handleClick, true);
    overlay.style.display = "none";
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    selectedBox.style.display = "none";
    selectedLabel.style.display = "none";
  }

  // 添加事件监听
  enableHighlight();
  window.addEventListener("message", handleParentMessage);

  // 暴露全局函数供外部调用
  window.__iframeHighlightControl = {
    enable: enableHighlight,
    disable: disableHighlight,
    fullyDisable: fullyDisableHighlight,
    isEnabled: function isEnabled() {
      return highlightEnabled;
    },
    getSelectedElement: function getSelectedElement() {
      return selectedElement;
    },
    updateSelected: updateSelectedHighlight,
    // 通过消息发送开关控制
    sendToggleMessage: function sendToggleMessage(enabled) {
      window.parent.postMessage({
        type: 'iframe-highlight-status',
        enabled: enabled || highlightEnabled,
        source: 'iframe-highlight-injector'
      }, '*');
    }
  };

  // 通知父窗口脚本已加载
  try {
    window.parent.postMessage({
      type: "iframe-highlight-ready",
      data: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now()
      },
      source: "iframe-highlight-injector"
    }, "*");
  } catch (error) {
    console.warn("无法发送就绪消息到父窗口:", error);
  }

  // 清理函数
  window.__iframeHighlightCleanup = function () {
    fullyDisableHighlight();
    window.removeEventListener("message", handleParentMessage);
    if (overlay.parentElement) {
      overlay.parentElement.removeChild(overlay);
    }
    delete window.__iframeHighlightInitialized;
    delete window.__iframeHighlightCleanup;
  };
})();

</script>
</body>
</html>
